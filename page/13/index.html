<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Joe Huang"><meta name="copyright" content="Joe Huang"><title>Awaken Desparado</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-180692466-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Joe Huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">401</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">26</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">70</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Awaken Desparado</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Awaken Desparado</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/11/13/BigData_java/2020-11-13%20Pokemon%20Go!%20in%20Spark/">BigData_java/2020-11-13 Pokemon Go! in Spark</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-13</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/BigData-java/">BigData_java</a></span><div class="content"><h2 id="前情"><a href="#前情" class="headerlink" title="前情"></a>前情</h2><ul>
<li>Spark VS. Flync, 阿里promote、ckin</li>
<li>Spark’s RDD<ul>
<li>partitioning</li>
<li>lazy evaluation<ul>
<li>不需直接全塞進 memory</li>
</ul>
</li>
<li>lazy initilization 讀檔</li>
</ul>
</li>
<li>Persistence – 因為知道它會被多次利用，所以不要殺了</li>
<li>Immutability - 不能修改，只能被重創建</li>
<li>Failure recovery – 不需要多設置</li>
<li>Transformation<ul>
<li>Narrow</li>
<li>Wide – 多個分區間的data轉移跟交換<ul>
<li>RDD往回找dependency 之間的關係</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="Pokemon-Go"><a href="#Pokemon-Go" class="headerlink" title="Pokemon Go!"></a>Pokemon Go!</h1><h2 id="RDD-vs-Dataset-vs-DataFrame"><a href="#RDD-vs-Dataset-vs-DataFrame" class="headerlink" title="RDD vs. Dataset vs. DataFrame"></a>RDD vs. Dataset vs. DataFrame</h2><h3 id="RDD"><a href="#RDD" class="headerlink" title="RDD"></a>RDD</h3><ul>
<li>data每一row是個黑盒，具體的row裡的schema的info是被藏起來的<ul>
<li>對於Spark也是個黑盒，不只對我而言</li>
<li>Spark 讀RDD只能按位置讀data, 性能、可讀性都不好</li>
<li>當想get col時只能row.get()然後用index去看</li>
</ul>
</li>
</ul>
<h3 id="DataFrame"><a href="#DataFrame" class="headerlink" title="DataFrame"></a>DataFrame</h3><ul>
<li>Catalyst可以捨棄data, spark內部執行分析的method，去優化query、filter掉 col 之類</li>
<li>有schema，可以更好優化</li>
<li>Partition 一定以row作劃分，十萬row分到三個機器上去<ul>
<li>col 的概念，分叫sharding或schema也可以</li>
</ul>
</li>
<li>當type錯時，因為非強關係型的full structural data, 所以讀進來時dataframe無法去辨認的，問題會在read、iterate時<ul>
<li>在 foreach每一個row時，在parse long時，要是讀到個string，會RE</li>
</ul>
</li>
<li>半結構化的數據，允許只在精靈第一代存在，第二代卻不存在了的問題</li>
<li>支持 SparkSQL 的訪問</li>
<li>in memory當data很大很大時，很占資源, job就跑得慢</li>
</ul>
<h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a6ojgvqj20xe0k0tdl.jpg" alt="image-20201114095137792" style="zoom:50%;" />





<h5 id="Type-issue-when-Error-–-Semi-Structural"><a href="#Type-issue-when-Error-–-Semi-Structural" class="headerlink" title="Type issue when Error – Semi-Structural"></a>Type issue when Error – Semi-Structural</h5><p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkoh4qznu9j313i0jetn9.jpg" alt="image-20201114100533902"></p>
<h4 id="DF"><a href="#DF" class="headerlink" title="DF"></a>DF</h4><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkohau8ub1j315g0mo1av.jpg" alt="image-20201114101124260" style="zoom:50%;" />

<ul>
<li>Catalyst 幫處理了DAG上的路徑、DF裡的議題</li>
</ul>
<h4 id="DF-VS-RDD"><a href="#DF-VS-RDD" class="headerlink" title="DF VS. RDD"></a>DF VS. RDD</h4><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkohd0z53mj30si09s41x.jpg" alt="image-20201114101332175" style="zoom:50%;" />



<ul>
<li>★★ DF裡的info 我們可以直接去select某一個column，因為它知道這個table裡有幾個Column; 但是，當我去select這個table的如第一row當下，想去得到這個row的某個value也只能用index 了，就是也還是得去解析了。。</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkohj1l8amj30d803m74u.jpg" alt="image-20201114101918675" style="zoom: 50%;" />。</p>
<h5 id="Delimiter-的-‘-’-在讀進來時已經分好了"><a href="#Delimiter-的-‘-’-在讀進來時已經分好了" class="headerlink" title="Delimiter 的 ‘,’ 在讀進來時已經分好了"></a>Delimiter 的 ‘,’ 在讀進來時已經分好了</h5><h4 id="SQL-Table-其實更像-View"><a href="#SQL-Table-其實更像-View" class="headerlink" title="SQL Table, 其實更像 View"></a>SQL Table, 其實更像 View</h4><ul>
<li><p>因為只有abstraction layer of view, 讓別人在access時覺得是個table, 只是data都存成了schema的database的型式</p>
</li>
<li><p>String of query much EASIER than cascade of APIs</p>
</li>
<li><p>易有人為失誤</p>
</li>
</ul>
<h4 id="DF-VS-Dataset"><a href="#DF-VS-Dataset" class="headerlink" title="DF VS. Dataset"></a>DF VS. Dataset</h4><ul>
<li>Dataset讀進來時已經是個Pokemon class 的obj了；DF讀進來時是個Row class 的obj</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a6thisuj20s40go0u6.jpg" alt="image-20201114103553415" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a6vt75hj20vk0ao759.jpg" alt="image-20201114104120385" style="zoom:50%;" />



<h5 id="DF-RE-vs-Dataset-Compiling-Error"><a href="#DF-RE-vs-Dataset-Compiling-Error" class="headerlink" title="DF RE vs. Dataset Compiling Error"></a>DF RE vs. Dataset Compiling Error</h5><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkoi7nfn3jj313e0e2ds9.jpg" alt="image-20201114104257475" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkoi8du8f2j30hm03igm5.jpg" alt="image-20201114104340363" style="zoom: 50%;" />

<ul>
<li>方法名錯就叫不了，因為class裡沒定義</li>
<li>但readability 強</li>
</ul>
<h3 id="Sum"><a href="#Sum" class="headerlink" title="Sum"></a>Sum</h3><ul>
<li>RDD for 完全沒結構化時的好工具</li>
<li>DSet 缺點 不希望code base存幾十種不同的class且還要去跟遠程access</li>
<li>DF 可能比較平均<ul>
<li>如果data不是很raw，已被先處理過了有很強的schema的了，已sanitize了的schema存儲，那read-in的data就不用去擔心型態問題，只是這個col對應到的val可能是個NA的問題，DF既不用自定義一堆class 又有Catalyst的優化</li>
</ul>
</li>
</ul>
<h2 id="DF-APIs"><a href="#DF-APIs" class="headerlink" title="DF APIs"></a>DF APIs</h2><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a70hh71j20xy0iw411.jpg" alt="image-20201114105806698" style="zoom:50%;" />



<h6 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h6><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkoips6ol5j30xk04otaj.jpg" alt="image-20201114110022848" style="zoom:50%;" />



<h3 id="Union-vs-Join"><a href="#Union-vs-Join" class="headerlink" title="Union vs Join"></a>Union vs Join</h3><h4 id="Union"><a href="#Union" class="headerlink" title="Union"></a>Union</h4><ul>
<li>when identical schema btw diff tables</li>
<li>append tableB to the tail of tableA</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkoj13vebwj30w007kwhp.jpg" alt="image-20201114111115758" style="zoom:50%;" />



<h6 id="先-filter-or-先-sort"><a href="#先-filter-or-先-sort" class="headerlink" title="先 filter or 先 sort()?"></a>先 filter or 先 sort()?</h6><ul>
<li>Spark 會做優化，先filter了後好，所以就算我寫反，也沒差</li>
</ul>
<h4 id="Intersection"><a href="#Intersection" class="headerlink" title="Intersection"></a>Intersection</h4><p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkq6ht80x9j317g0bwgs3.jpg" alt="image-20201115212831583"></p>
<h3 id="Shuffle"><a href="#Shuffle" class="headerlink" title="Shuffle"></a>Shuffle</h3><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkq78xf644j311s0jygt7.jpg" alt="image-20201115215442243" style="zoom:50%;" />





<h3 id="Transformation"><a href="#Transformation" class="headerlink" title="Transformation"></a>Transformation</h3><h4 id="Coalesce"><a href="#Coalesce" class="headerlink" title="Coalesce"></a>Coalesce</h4><ul>
<li>寫出時候變少</li>
<li>以挪動最小的數據為代價，幫把partition個數降低，會以平均的方式挪過去</li>
</ul>
<h4 id="Repartition"><a href="#Repartition" class="headerlink" title="Repartition"></a>Repartition</h4><ul>
<li>會嘗試以平均分配的方式，把當前的partition全部進行重新分配</li>
</ul>
<h3 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h3></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/11/06/BigData_java/2020-11-6%20Spark%20Architecture%20&amp;%20Exercise%20on%20AWS/">BigData_java/2020-11-6 Spark Architecture &amp; Exercise on AWS</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-06</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/BigData-java/">BigData_java</a></span><div class="content"><h1 id="Spark-Architecture"><a href="#Spark-Architecture" class="headerlink" title="Spark Architecture"></a>Spark Architecture</h1><h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><ul>
<li>Data processing, <strong>distributed (多台圍毆)</strong> framework(工具包)</li>
<li>framework vs computation model(單台)</li>
<li>Batch processing (offline)全存去hdfs or hive, or Hive, VS. real-time</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a59ewfjj20o20icq4v.jpg" alt="image-20201107102121833" style="zoom: 33%;" />



<ul>
<li><p>LinkedIn – java</p>
</li>
<li><p>FB – php</p>
</li>
<li><p>Scala 特性方便 compiling &amp; runtime就是較快</p>
</li>
</ul>
<h4 id="Q-Hadoop-MR-計算框架存在什麼問題？"><a href="#Q-Hadoop-MR-計算框架存在什麼問題？" class="headerlink" title="Q: Hadoop MR 計算框架存在什麼問題？"></a>Q: Hadoop MR 計算框架存在什麼問題？</h4><ul>
<li><p>太多硬盤讀寫 –&gt; I/O 太多時間，每次data的讀寫。。。所以速度慢</p>
<ul>
<li>多開機器超浪費，才幾10個GB又要我多開。。</li>
</ul>
</li>
<li><p>所以 Spark 出現了 –&gt; 省了很多錢</p>
<ul>
<li>好的computation engine 可省很多錢</li>
<li>分布式內存</li>
</ul>
</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkges06cu8j30qe09mdib.jpg" alt="image-20201107103936335" style="zoom: 33%;" />



<h4 id="Q-出現的第一個原因-Spark處理大數據很快，實時性很高"><a href="#Q-出現的第一個原因-Spark處理大數據很快，實時性很高" class="headerlink" title="Q: 出現的第一個原因: Spark處理大數據很快，實時性很高"></a>Q: 出現的第一個原因: Spark處理大數據很快，實時性很高</h4><h4 id="Q-第二個原因-幫助管理分布式機器和流程"><a href="#Q-第二個原因-幫助管理分布式機器和流程" class="headerlink" title="Q: 第二個原因: 幫助管理分布式機器和流程"></a>Q: 第二個原因: 幫助管理分布式機器和流程</h4><h2 id="Data-pipelin-in-Spark"><a href="#Data-pipelin-in-Spark" class="headerlink" title="Data pipelin in Spark"></a>Data pipelin in Spark</h2><ol>
<li>1 如讀了國家公園的data，讀入後，對於spark生成的不是 list of string,<br>而是 RDD, 就是個集合，包含源頭的所有數據。</li>
<li>2 RDD會被partition了後的；分區的標準非常明確</li>
<li>3 不可變的, immutable</li>
</ol>
<ul>
<li>對於數據的操作行為的當時狀態的copy；非內存地址的延用，而是真實<br>數據的操作</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkgg18ccvsj30sq0b2dme.jpg" alt="image-20201107112304043" style="zoom:50%;" />





<h2 id="Basics-in-Spark"><a href="#Basics-in-Spark" class="headerlink" title="Basics in Spark"></a>Basics in Spark</h2><ul>
<li>更快</li>
<li>可realtime, 是map-reduce做不了的</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a5fbkucj20t40d80tk.jpg" alt="image-20201108210653409" style="zoom: 33%;" />



<ul>
<li>當新的RDD被生成，過程就是一條數據被讀進來，filter操作後，看這條data是不是contain California<ul>
<li>Narrow - 未涉及別的RDD的變形<ul>
<li>這row不會依賴別row</li>
</ul>
</li>
<li>Wide - 可以對當前的data進行計算。如知道當前每個park, state分別有多少個park?  –&gt; GroupBy, ReduceBy, Union，跳躍於不同的RDD上的加和的動作。會對當前的record作紀錄<ul>
<li>沒人能保證多條Record在同個RDD, except we use kayhash for partition, otherwise, across RDD</li>
</ul>
</li>
</ul>
</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a5i5o7yj212c084ab0.jpg" alt="image-20201108213059139" style="zoom: 33%;" />



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a5krkb9j212q0r4q64.jpg" alt="image-20201108215941456" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gki48xejm4j314y0cywl5.jpg" alt="image-20201108220623119" style="zoom:50%;" />





<h1 id="Exercise-Spark-on-AWS"><a href="#Exercise-Spark-on-AWS" class="headerlink" title="Exercise: Spark on AWS"></a>Exercise: Spark on AWS</h1><h5 id="EMR-elasitc-map-reduce"><a href="#EMR-elasitc-map-reduce" class="headerlink" title="EMR - elasitc map reduce"></a>EMR - elasitc map reduce</h5><h2 id="Create-Spark-Cluster-on-AWS"><a href="#Create-Spark-Cluster-on-AWS" class="headerlink" title="Create Spark Cluster on AWS"></a>Create Spark Cluster on AWS</h2><h3 id="1-SW"><a href="#1-SW" class="headerlink" title="1 SW"></a>1 SW</h3><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gknc61jr2qj30w50u0jyw.jpg" alt="image-20201113102815402" style="zoom:50%;" />



<ul>
<li>step 是和運行的code緊密相關的，可以code寫完後再設</li>
</ul>
<h3 id="2-HW"><a href="#2-HW" class="headerlink" title="2 HW"></a>2 HW</h3><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a5pm9egj20mp0riwh4.jpg" alt="image-20210305163613883" style="zoom:50%;" />

<p>​        Task 没有 data node在run，相當只是對core的輔助，沒什麼必要，對大理解沒improvement</p>
<ul>
<li><p>SPOT </p>
<ul>
<li>會去看現在的usage的情況，假設我半夜去開cluster，如果還是launch在US-eash，那時大家都在睡，我去開spot就可以很快；但如果是尖峰時，那現在available 的便宜機器就沒了，就會等待下一個available的機器來給我用；我很可能去等，但那台一直都沒得出現，cluster creation就會被浪費了; 反正我選c4large便宜點</li>
</ul>
</li>
<li><p>core: Data node; num core ↑; concurrency ↑</p>
<ul>
<li>Data node的機器</li>
</ul>
</li>
<li><p>task: 沒有 data node 的demo在run</p>
</li>
</ul>
<h3 id="3-General-Cluster-Setting"><a href="#3-General-Cluster-Setting" class="headerlink" title="3 General Cluster Setting"></a>3 General Cluster Setting</h3><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkndakrzqjj31d90u0wit.jpg" alt="image-20201113110702038" style="zoom:50%;" />

<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gltgondf2sj30tc0eomyj.jpg" alt="image-20201219205815163" style="zoom:50%;" />



<h5 id="最後也是需要個認證的-xxx-pem"><a href="#最後也是需要個認證的-xxx-pem" class="headerlink" title="最後也是需要個認證的 xxx.pem"></a>最後也是需要個認證的 xxx.pem</h5><h3 id="4-Security"><a href="#4-Security" class="headerlink" title="4 Security"></a>4 Security</h3><p>just next step</p>
<h2 id="Tools-for-AWS-Spark"><a href="#Tools-for-AWS-Spark" class="headerlink" title="Tools for AWS Spark"></a>Tools for AWS Spark</h2><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkndfn8bvgj30yn0u0k0l.jpg" alt="image-20201113111204862" style="zoom:50%;" />



<ul>
<li>Hadoop is the environvent base, for Spark and Hive, so not an Application</li>
<li></li>
</ul>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a5vbe15j211v0u0wil.jpg" alt="image-20201120202325880" style="zoom:33%;" />





<h2 id="S3’s-Usage"><a href="#S3’s-Usage" class="headerlink" title="S3’s Usage"></a>S3’s Usage</h2><h4 id="Create-Bucket"><a href="#Create-Bucket" class="headerlink" title="Create Bucket"></a>Create Bucket</h4><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gl6honxensj30u00vwq9e.jpg" alt="image-20201130000449672" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a5yk6p0j20u70u00vz.jpg" alt="image-20201120205035722" style="zoom: 50%;" />



<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkvxisc3p5j317c05sjz5.jpg" alt="image-20201120205135528" style="zoom:50%;" />



<h4 id="IAM"><a href="#IAM" class="headerlink" title="IAM"></a>IAM</h4><h5 id="My-Access-Key"><a href="#My-Access-Key" class="headerlink" title="My Access Key"></a>My Access Key</h5><p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkvxlbix3qj319g0u0dr1.jpg" alt="image-20201120205359035"></p>
<h2 id="Run-Spark-Application"><a href="#Run-Spark-Application" class="headerlink" title="Run Spark Application"></a>Run Spark Application</h2><h3 id="Add-Step"><a href="#Add-Step" class="headerlink" title="Add Step"></a>Add Step</h3><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a6bnr3oj211m0lo765.jpg" alt="image-20201126195711764" style="zoom:50%;" />

<ul>
<li>Cluster – 可以把Code deploy 到 data node 上 ，也就是slave node上面去執行</li>
<li><strong>Client – 放在 Master上面去執行。當放到 Master時，它可以把任務分給其他的nodes!</strong></li>
</ul>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a638tshj219q0oin0g.jpg" alt="image-20201126200139523" style="zoom:50%;" />



<h3 id="Pending…"><a href="#Pending…" class="headerlink" title="Pending…"></a>Pending…</h3><p>需要去蒐集資源，Spark需要在集群去找哪些機器可用，可設哪些參數呀？找到機器後就會進入Starting</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gl2ttdcyb4j319o0fo785.jpg" alt="image-20201126200220489"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/11/01/BigData_java/2020-11-1%20Twitter%20on%20AWS/">BigData_java/2020-11-1 Twitter on AWS</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-01</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/BigData-java/">BigData_java</a></span><div class="content"><h1 id="Twitter-on-AWS"><a href="#Twitter-on-AWS" class="headerlink" title="Twitter on AWS"></a>Twitter on AWS</h1><ul>
<li><p>Kafka </p>
</li>
<li><p>Best: Consumer == Broker amount</p>
</li>
<li><p>Broker - 分布式存、topic, partition, offsets給consumer去讀msg的</p>
</li>
<li><p>consumer間獨立的</p>
</li>
</ul>
<ul>
<li>earlist – default是這個，就是說當前的consuer要是還沒有消費過任何一個topic，它是第一次去run, 我默認的是consumer從最早的開始讀起</li>
<li>Group_id, 作LB的，這個topic有三個partition，告訴kfk我們有三個不同的consumer要來消費你，所以kfk會讓每個partition被一一對應；有多個不同的consumer的組織，如果我們都定義的是同個group_id，那</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a3j0zixj20wi0as3zg.jpg" alt="image-20201101212643942" style="zoom: 67%;" />

<ul>
<li><p>Twitter client幫做了很多事</p>
</li>
<li><p>hbc-core dependency in pom.xml, to know client APIs</p>
<ul>
<li>Twitter hbc client –&gt; 當前的 hbc repo</li>
<li>功能型的dependency就知道「怎麼用」<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gka0e9a4uaj30rg0gaaib.jpg" alt="image-20201101214836345" style="zoom:50%;" />



</li>
</ul>
</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a3nbjsqj20te0m8acd.jpg" alt="image-20201101214946756" style="zoom: 33%;" />

<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a3qyfu8j20vk0iu3zp.jpg" alt="image-20201101215206525" style="zoom: 33%;" />

<ul>
<li><p>BlockingQ - 內存裡的buffer，邊寫邊抓；寫的時候不能寫太多</p>
<ul>
<li>Producer受不了</li>
<li>亂碼呢？－－＞沒data來，要丟出exception嗎</li>
<li>Throttle 限行它，等producer拿出寫去kfk</li>
</ul>
</li>
<li><p>ACK all – data存在所有的 broker上</p>
</li>
<li><p>kfk 1.1 大的改變</p>
<ul>
<li><p>retries 由三個組成</p>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a3w3kfbj20sa06c0tb.jpg" alt="image-20201101224346503" style="zoom:50%;" />

<p>120秒後就丟了它</p>
</li>
<li><p>Backoff</p>
<ul>
<li>你現在很忙，我不一直催你，我等個100ms, 回頭再去敲你，讓你error有恢復的時間</li>
</ul>
</li>
<li><p>這些都是producer已經define好的參數</p>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gka28kbi1ej30ue0ia112.jpg" alt="image-20201101225220312" style="zoom:50%;" />

<ul>
<li>當非 idempotent 會有問題</li>
<li>so, enable.idempotence = true</li>
</ul>
</li>
</ul>
</li>
<li><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gka2um85ntj30x80ck79l.jpg" alt="image-20201101231332090" style="zoom:50%;" />

<ul>
<li><p>linger、batch 就是做了個 Cache裡的概念</p>
<ul>
<li>當前的cache不可能無限等待，當我設計等待的時間，當我的數據超超超兇來，我受不了，所以我還會設一個batch_size</li>
<li>不能等太久，也不能太大還不沖出去</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gka2xrc4yuj30ra03k77q.jpg" alt="image-20201101231633429"></p>
</li>
<li><p>kfk存的是 compressed後的 data<br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gka2z2l5qwj315s07o79r.jpg" alt="image-20201101231749281"></p>
</li>
<li><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a44qtgyj21n00twdop.jpg" alt="image-20201101231825564" style="zoom:67%;" />

<ul>
<li>RT – ReTweet</li>
</ul>
</li>
<li><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a48d8nzj21mg0kodkg.jpg" alt="image-20201101232022395" style="zoom:67%;" />
</li>
<li><p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gka328tq0oj316s0a80z7.jpg" alt="image-20201101232052099"></p>
</li>
</ul>
</li>
</ul>
<h4 id="Home-Settings"><a href="#Home-Settings" class="headerlink" title="Home Settings"></a>Home Settings</h4><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a4cystij21c80mqgqu.jpg" alt="image-20201105165148390" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a4elwupj21ms0u0gup.jpg" alt="image-20201105183429254" style="zoom:67%;" />



<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkeiftxhk1j319m0u0e82.jpg" alt="image-20201105191508324"></p>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a4k2n0xj211q0u0wjn.jpg" alt="image-20201105191524424" style="zoom:50%;" />



<h2 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h2><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkgcojtgy9j30zc0ru153.jpg" alt="image-20201107092704795" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkgdbvo4njj317q0340y5.jpg" alt="image-20201107094930303" style="zoom:50%;" />

<ul>
<li>三次握手</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkgdeh3easj314y02g40g.jpg" alt="image-20201107095200584" style="zoom:50%;" />



<ul>
<li>mvn clean; mvn compile; man exec:java </li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkgdkl4fl7j31700aee2f.jpg" alt="image-20201107095752042" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkgdm4ak2lj317g046n10.jpg" alt="image-20201107095921677" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a4xka01j216u0nak0p.jpg" alt="image-20201107100122141" style="zoom:50%;" />



<h2 id="Issues-on-my-current-analysis"><a href="#Issues-on-my-current-analysis" class="headerlink" title="Issues on my current analysis"></a>Issues on my current analysis</h2><p>未五句話全用權重，只用了最長的</p>
<h2 id="Producer-Elegancys"><a href="#Producer-Elegancys" class="headerlink" title="Producer Elegancys"></a>Producer Elegancys</h2><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkgdvdmjlmj30us0pwk1d.jpg" alt="image-20201107100814465" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a50t6e1j215q03wt9m.jpg" alt="image-20201107100847304" style="zoom:50%;" />

<ul>
<li>存著</li>
<li>可能還有人沒寫出，所以要shundown hook，先flush(), 再去 close()了</li>
</ul>
<h1 id="Twitter-Developers-amp-APIs"><a href="#Twitter-Developers-amp-APIs" class="headerlink" title="Twitter Developers &amp; APIs"></a>Twitter Developers &amp; APIs</h1><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkeapu2012j310z0u0tfs.jpg" alt="image-20201105144800175" style="zoom:50%;" />

<h4 id="1-In-your-words"><a href="#1-In-your-words" class="headerlink" title="1 In your words"></a>1 In your words</h4><p>In English, please describe how you plan to use Twitter data and/or APIs. The more detailed the response, the easier it is to review and approve.</p>
<h4 id="2-The-specifics"><a href="#2-The-specifics" class="headerlink" title="2 The specifics"></a>2 The specifics</h4><p>Please answer each of the following with as much detail and accuracy as possible. Failure to do so could result in delays to your access to the Twitter developer platform or rejected applications.</p>
<hr>
<p>Are you planning to analyze Twitter data?</p>
<p>Yes</p>
<p><strong>Please describe how you will analyze Twitter data including any analysis of Tweets or Twitter users.</strong></p>
<h4 id="3"><a href="#3" class="headerlink" title="3"></a>3</h4><p>Will your app use Tweet, Retweet, like, follow, or Direct Message functionality?</p>
<p>Yes</p>
<p><strong>Please describe your planned use of these features.</strong></p>
<h4 id="4"><a href="#4" class="headerlink" title="4"></a>4</h4><p>Do you plan to display Tweets or aggregate data about Twitter content outside of Twitter?</p>
<p>No</p>
<hr>
<h4 id="5"><a href="#5" class="headerlink" title="5"></a>5</h4><p>Will your product, service or analysis make Twitter content or derived information available to a government entity?</p>
<p>No</p>
<p>In general, schools, colleges, and universities <strong>do not</strong> fall under this category.</p>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkebd5r9hxj30om0dyjsj.jpg" alt="image-20201105151024914" style="zoom: 33%;" />



<h3 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h3><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkec3hn4czj30uz0u04a8.jpg" alt="image-20201105153542746" style="zoom:50%;" />



<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkec5pulxaj31170u0796.jpg" alt="image-20201105153752201"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/10/24/BigData_java/2020-10-24%20BigData%20side-projects%20in%20Java/">BigData_java/2020-10-24 BigData side-projects in Java</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-10-24</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/BigData-java/">BigData_java</a></span><div class="content"><h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h2><p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk04dmxpk5j3102032di4.jpg" alt="image-20201024083045739" style="zoom:50%;" /><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk04idtk1hj30zw0480vt.jpg" alt="image-20201024083519950"></p>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk04j5lnuhj30zg0b8k1x.jpg" alt="image-20201024083605168" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk04jvx04vj30zm04wte3.jpg" alt="image-20201024083647240" style="zoom:50%;" />



<h3 id="Demo-創建一個-Topic"><a href="#Demo-創建一個-Topic" class="headerlink" title="Demo: 創建一個 Topic"></a>Demo: 創建一個 Topic</h3><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a1rd9iij20vm05emyc.jpg" alt="image-20201024085524024" style="zoom: 50%;" />

<ul>
<li>未發送 key，按默認的 round-robin</li>
<li>Offset 就是個 id，跟 訊息長短沒關</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk056hkxnkj30vu03gacf.jpg" alt="image-20201024085829960" style="zoom:50%;" />



<h3 id="Back-door-我可優化的"><a href="#Back-door-我可優化的" class="headerlink" title="Back-door 我可優化的"></a>Back-door 我可優化的</h3><p>Kafka 其中一台掛了怎辦？備份</p>
<ul>
<li>兩個放在同個機房(rack) –&gt; latency不會過大</li>
<li>另一個在不同城市，我要replicate的時候比較慢，但ok</li>
<li>所以在latency、reliability找了平衡</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk05k9xsnfj30vi0f8wpp.jpg" alt="image-20201024091144456" style="zoom:67%;" />



<ul>
<li>TERMs: ack、latency、Throughput</li>
</ul>
<h3 id="On-IntelliJ"><a href="#On-IntelliJ" class="headerlink" title="On IntelliJ"></a>On IntelliJ</h3><ul>
<li>Zookeeper要先在背后起来</li>
<li>機器之間一定是通過network，network時就只能序列化變一個個地byte，<ul>
<li>int serializer</li>
<li>string serializer.  –&gt; 大多數情況都是這傢伙</li>
</ul>
</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk0735ftpqj30xs06c79h.jpg" alt="image-20201024100429381" style="zoom:50%;" />

<ul>
<li>producer.flush() – 會幫把數據直接沖到kafka queue裡去<ul>
<li>存在問題! </li>
<li>只是個blocking call，但不是同步</li>
<li>就跟你这个info绑定了，要是你没跟我说你成功，我就会有个线程，一是在盯你，我一直浪费</li>
</ul>
</li>
<li>Producer.send(recordNoKey) 一定是 Async的</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a1unxh2j219e0esjuf.jpg" alt="image-20201024101109235" style="zoom:50%;" />

<ul>
<li>Producer 自己就是個 client之一</li>
<li>三次握手也不需我們實現不然太蝦</li>
</ul>
<ul>
<li>那个是partition id，不是replica 的id</li>
</ul>
<h4 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h4><p>軟體管理工具 – FB、Uber都有用</p>
<p>項目管理工具</p>
<h4 id="Producer-Keyhash"><a href="#Producer-Keyhash" class="headerlink" title="Producer Keyhash"></a>Producer Keyhash</h4><ul>
<li>key如果被detect到是有東西，就會有hash去hash 去決定把這個partition發送到哪個 broker上面去；否則就是 round-robin</li>
</ul>
<h4 id="Producer-onCompletion"><a href="#Producer-onCompletion" class="headerlink" title="Producer onCompletion"></a>Producer onCompletion</h4><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a1yw56xj20zs0l840w.jpg" alt="image-20201025230649208" style="zoom: 67%;" />

<ul>
<li>production 不要用! 會變單線程<ul>
<li>難道因為一個人的login失敗了，我就要stop整個producer嗎？</li>
<li>我要做的事應該是producer不傻</li>
</ul>
</li>
<li>一般是async時也過陣子來查看</li>
<li>一般在prod不需要知道發去了哪裡，在roundrobin裡不需要知道<ul>
<li>如果想知道話，也不是好奇；而是假設consumer的處理性特殊 – groupby key – 要是roundrobin就會分到10台機器，現在的shuffle洗牌才能把它們放到一台機器上去；要是很常，我的處理就意味不高效! 為了高效，我就會不再roundrobin，而是hashbykey!<ul>
<li>所有的bigdata key 都在一台機器上，就不再要洗牌，雖然是全局的groupby；一旦沒有全局的groupby，我就很快</li>
<li>即然我指定了我的key，我就可以很有信心知道這條要去哪台機器，因為kafka會去handle</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h4><ul>
<li>比 producer 的設置裡多了一個 GroupID</li>
</ul>
<h3 id="Kafka-再論"><a href="#Kafka-再論" class="headerlink" title="Kafka 再論"></a>Kafka 再論</h3><ul>
<li><p>Kafka 啟動時會設定這個cluster要幾台機器組成</p>
</li>
<li><p>Kafka 是個 Pull 模型，因為</p>
<ul>
<li><p>Scalibility : 它是個很好的decouple的作用，把 producer、consumer很好地分開了；各自壞了不會影響到對方。</p>
<ul>
<li>如果這個Topic很多下游在訂閱，kafka要是push的話，它會忙死，而且下游搞不好還沒要你這更新</li>
<li>它忙壞了，根本無法 scale-up</li>
</ul>
</li>
<li><p>Diversity : – LEVERAGE &amp; STALIBILITY</p>
<ul>
<li><p>每個consumer都有自己的配置、自己的處理方式和節奏，kafka應該把處理信息的能動性(Leverage) 給 consumer。</p>
</li>
<li><p>要是這個組比較窮，或他們的priority低，他們處理數據不來，而且也沒budget；或許可以48hr再生一個結果就好。</p>
<p>consumer可更穩定 (STALIBILITY)</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>每次我的好友建tweet時，該pull or push？</p>
</li>
<li><p>consumer 跟 partition有綁定的關係！只會給一個consumer去讀</p>
<ul>
<li>consumer去監聽partition</li>
<li>平行就一定會有race condition<ol>
<li>第 0 條該誰去讀？consumer0還是consumer4?</li>
<li>假設真的通過層層複雜的設計，各自讀一條<ul>
<li>我讀完時我要是早處理完時？</li>
<li>我讀0時你讀1，你又不去commit，一方面在race了，一台機器上是idempotency，跨機器時呢？consumer不知道1號partition有沒有被讀成，怎辦？那consumer0跟consumer4還要有一個交流的體系</li>
<li>交替讀的時候還是會出現問題</li>
</ul>
</li>
</ol>
</li>
<li>所以沒必要多台consumer監聽一個partion的必要</li>
<li>系統裡不是最快就是最好的，當數據小時沒差。要是平行時的overhead大時，開一台就ok啦</li>
</ul>
</li>
<li><p>中轉，一週後刪了；它的作用就不是保持數據的，才能scalible<br>往上強堆機器又要花錢!</p>
</li>
<li><p>問題就是: 工程師寫consumer會處理錯</p>
</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk1yqkmwomj30rq0agwks.jpg" alt="image-20201025224640508" style="zoom: 67%;" />



<h1 id="AWS"><a href="#AWS" class="headerlink" title="AWS"></a>AWS</h1><h2 id="Charging"><a href="#Charging" class="headerlink" title="Charging"></a>Charging</h2><p>MSK: <a href="https://aws.amazon.com/msk/pricing/" target="_blank" rel="noopener">https://aws.amazon.com/msk/pricing/</a><br> EC2: <a href="https://aws.amazon.com/ec2/pricing/on-demand/" target="_blank" rel="noopener">https://aws.amazon.com/ec2/pricing/on-demand/</a></p>
<h2 id="AWS-Create-Kafka-Producer"><a href="#AWS-Create-Kafka-Producer" class="headerlink" title="AWS, Create Kafka Producer"></a>AWS, Create Kafka Producer</h2><h3 id="Amazon-MSK"><a href="#Amazon-MSK" class="headerlink" title="Amazon MSK"></a>Amazon MSK</h3><p>service - MSK</p>
<ul>
<li>2.2.1 (recommended)</li>
</ul>
<h4 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h4><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a21llf0j20mw0p6n0d.jpg" alt="image-20201030211156060" style="zoom: 33%;" />

<h4 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h4><ul>
<li>被建在網路集群中</li>
<li>VPC – vertual private cloud 虛擬的網路環境<ol>
<li>一個具有安全性的網路集群，跟外界隔離<ul>
<li>如果通過amazon別的service或我自己的電腦要去訪問其中的節點是做不到的，因為不屬於 security network的。</li>
</ul>
</li>
<li>cluster裡的所有機器之間可以進行「安全」的相互通信，是有保證的</li>
</ol>
</li>
</ul>
<ol start="3">
<li><p>VPC 會有個默認的</p>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a23uydbj20bq04l0st.jpg" alt="image-20210303154906134" style="zoom: 50%;" /></li>
</ol>
<ul>
<li><p>Number of Availability Zones</p>
<ul>
<li>Seattle, Australia, … </li>
<li>假設我的機器集群活躍在兩個地方，SF斷電了，Seattle還可以提供服務</li>
<li>其實<strong>２</strong>就很夠了，AWS不會掛的啦。。人家大公司</li>
</ul>
</li>
<li><p>Zones &amp; Subnet</p>
<ul>
<li><p>就直接選吧</p>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a25s6ydj20l90iaq40.jpg" alt="image-20210303155659042" style="zoom:50%;" />



</li>
</ul>
</li>
</ul>
<h4 id="Brokers"><a href="#Brokers" class="headerlink" title="Brokers"></a>Brokers</h4><ul>
<li><p>對於 kafka一定是要多台機器來組成多線程的一個機器群體，所以在當前的kafa cluster裡，一定有多台機器。每台都被稱作broker，多台在一起就是brokers。</p>
</li>
<li><p>我在cluster裡，這個instance要有多大？如果預測每台都比較累，就是選大的</p>
</li>
<li><p>kafka.t3.small，ok了，可做小實驗</p>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk7oycisrej30vo09agmw.jpg" alt="image-20201030214136615" style="zoom:50%;" />
</li>
<li><p>共四台目前在兩個不同的區域上</p>
</li>
</ul>
<h4 id="Tag"><a href="#Tag" class="headerlink" title="Tag"></a>Tag</h4><p>好區分名而已</p>
<h4 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h4><ul>
<li>1000GB 很很夠了</li>
</ul>
<h4 id="Encryption"><a href="#Encryption" class="headerlink" title="Encryption"></a>Encryption</h4><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a291fvrj20ny06edgg.jpg" alt="image-20201030214316835" style="zoom:50%;" />

<ul>
<li>這次懶得加密也OK啦. 所以選擇了Both</li>
</ul>
<h4 id="Encrypt-data-at-rest"><a href="#Encrypt-data-at-rest" class="headerlink" title="Encrypt data at rest"></a>Encrypt data at rest</h4><p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk7p0wno8zj313a09k40f.jpg" alt="image-20201030214403963"></p>
<h4 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h4><p>暫時還不需要</p>
<h4 id="Monitoring"><a href="#Monitoring" class="headerlink" title="Monitoring"></a>Monitoring</h4><h5 id="CloudWatch"><a href="#CloudWatch" class="headerlink" title="CloudWatch"></a>CloudWatch</h5><ul>
<li><p>監測系統</p>
</li>
<li><p>會把當前在Amazon雲上所run的每一個服務，幫單獨地拽出來，幫分析</p>
<ul>
<li><p>traffic</p>
</li>
<li><p>throughput</p>
</li>
<li><p>input/outputs</p>
</li>
<li><p>弄成一張很美美的圖表，知做了什麼事，在哪些時間做了事</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>Basic Monitoring</p>
</li>
<li><p>Broker 可能有多個 Topic, 各自的Topic有它們自己的partition</p>
<ul>
<li>可知道每個Topic都 go through了什麼數據</li>
</ul>
</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a2bffr1j20r60aedh6.jpg" alt="image-20201030214910491" style="zoom:50%;" />





<h5 id="Broker-log-delivery"><a href="#Broker-log-delivery" class="headerlink" title="Broker log delivery"></a>Broker log delivery</h5><ul>
<li><p>當我們在run服務時，每個操作都會發個log給我；如發送數據了、發送成功了、consumer去讀了、consumer讀成功了，它話超多的！如果我一天發幾百萬條，一定是存log不能全念給我聽。透過log來分析的，找「10分鐘前發來，我在９分鐘前就該收到，但到了現在都還沒有收到」，這時候，我需要去找log才能分析，需要地方存我的 log</p>
<ol>
<li><p>CloudWatch</p>
<ul>
<li><p>有自己的 log group</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk7p99b9w0j31co0oan2e.jpg" alt="image-20201030215205786"></p>
</li>
<li><p>好處就是當我的這些log我可以直接搜索，類似grep！</p>
</li>
</ul>
<h5 id="Log-Group"><a href="#Log-Group" class="headerlink" title="Log Group"></a>Log Group</h5><ul>
<li>足夠強了，一般而言, 我可以去蒐當時的這個log<br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk7pfwi9gsj313o0e8dm5.jpg" alt="image-20201030215829133"></li>
</ul>
</li>
<li><p>S3 -文件系統</p>
<ul>
<li>大批量</li>
<li>好處是S3大，可以dump去離線如本地的大批量處理，去做bulk分析</li>
</ul>
</li>
<li><p>Data Firehouse</p>
<ul>
<li>可以對數據轉化，最後再發去 elasticsearch, 讓我作更細化的分析</li>
<li>太 overkill</li>
</ul>
</li>
</ol>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk7pi4vbcvj312k0lo3zz.jpg" alt="image-20201030220038315" style="zoom:33%;" />

</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk7pihdpfhj315k0h475n.jpg" alt="image-20201030220058590" style="zoom:33%;" />

<ul>
<li>data warehouse - 每天數據進來了，如用戶的post進來了，觸發API到FB去。只是個concept都收進到寫到<strong>HDFS</strong>，有些已有結構化了，如手機上的SDK已定義好了schema (這已經比較像 Data Lake了)、<strong>hive</strong> table</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk7pk4nilvj31j60lktc7.jpg" alt="image-20201030220232929" style="zoom: 50%;" />



<h6 id="CloudWatch-Log"><a href="#CloudWatch-Log" class="headerlink" title="CloudWatch Log"></a>CloudWatch Log</h6><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a2dw2vpj20oh0nnacn.jpg" alt="image-20210303165153271" style="zoom:50%;" />



<h4 id="Create-cluster"><a href="#Create-cluster" class="headerlink" title="Create cluster!"></a>Create cluster!</h4><h2 id="AWS-建EC2-還缺新的機器做P-amp-C-So-create-another-client"><a href="#AWS-建EC2-還缺新的機器做P-amp-C-So-create-another-client" class="headerlink" title="AWS - 建EC2, 還缺新的機器做P &amp; C, So, create another client"></a>AWS - 建EC2, 還缺新的機器做P &amp; C, So, create another client</h2><ul>
<li>還缺 producer, consumer去做事！需要創建他們！</li>
</ul>
<h3 id="EC2-Service"><a href="#EC2-Service" class="headerlink" title="EC2 Service"></a>EC2 Service</h3><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a2gmm8oj210n0u0793.jpg" alt="image-20201030220808970" style="zoom:50%;" />    



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a2jdvjnj20zc0ct76r.jpg" alt="image-20210303172849633" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a2lrp50j21g40tktdp.jpg" alt="image-20201030221432582" style="zoom: 67%;" />





<h4 id="Access-遠程的EC2機器"><a href="#Access-遠程的EC2機器" class="headerlink" title="Access 遠程的EC2機器"></a>Access 遠程的EC2機器</h4><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1go6ukkgr91j20wf0u04qp.jpg" alt="image-20201030222232631" style="zoom:50%;" />

<ul>
<li>通信，得要去找kafka的代理產生的，kafka的client就是這個代理<ul>
<li>要下載 kafka client代理的包</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-172-31-16-188 ~]$ curl https://downloads.apache.org/kafka/2.3.1/kafka_2.12-2.3.1.tgz -o kafka.tgz</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 59.4M  100 59.4M    0     0  11.0M      0  0:00:05  0:00:05 --:--:-- 12.6M</span><br><span class="line">[ec2-user@ip-172-31-16-188 ~]$ targ -xvzf kafka.tgz</span><br><span class="line">-bash: targ: <span class="built_in">command</span> not found</span><br><span class="line">[ec2-user@ip-172-31-16-188 ~]$ tar -xvzf kafka.tgz</span><br></pre></td></tr></table></figure>

<h5 id="bin-sh-都是好練習"><a href="#bin-sh-都是好練習" class="headerlink" title="bin/*.sh, 都是好練習"></a>bin/*.sh, 都是好練習</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-172-31-16-188 bin]$ <span class="built_in">pwd</span></span><br><span class="line">/home/ec2-user/kafka_2.12-2.3.1/bin</span><br><span class="line">[ec2-user@ip-172-31-16-188 bin]$ ls</span><br><span class="line">connect-distributed.sh               kafka-reassign-partitions.sh</span><br><span class="line">connect-standalone.sh                kafka-replica-verification.sh</span><br><span class="line">kafka-acls.sh                        kafka-run-class.sh</span><br><span class="line">kafka-broker-api-versions.sh         kafka-server-start.sh</span><br><span class="line">kafka-configs.sh                     kafka-server-stop.sh</span><br><span class="line">kafka-console-consumer.sh            kafka-streams-application-reset.sh</span><br><span class="line">kafka-console-producer.sh            kafka-topics.sh</span><br><span class="line">kafka-consumer-groups.sh             kafka-verifiable-consumer.sh</span><br><span class="line">kafka-consumer-perf-test.sh          kafka-verifiable-producer.sh</span><br><span class="line">kafka-delegation-tokens.sh           trogdor.sh</span><br><span class="line">kafka-delete-records.sh              windows</span><br><span class="line">kafka-dump-log.sh                    zookeeper-security-migration.sh</span><br><span class="line">kafka-log-dirs.sh                    zookeeper-server-start.sh</span><br><span class="line">kafka-mirror-maker.sh                zookeeper-server-stop.sh</span><br><span class="line">kafka-preferred-replica-election.sh  zookeeper-shell.sh</span><br><span class="line">kafka-producer-perf-test.sh</span><br></pre></td></tr></table></figure>

<ul>
<li>要記得下載dependency</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-172-31-16-188 bin]$ sudo yum install java</span><br></pre></td></tr></table></figure>





<h2 id="MSK-Go"><a href="#MSK-Go" class="headerlink" title="MSK, Go!"></a>MSK, Go!</h2><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a2rmlolj21fg0tgtd4.jpg" alt="image-20201030223315509" style="zoom:50%;" />

<h4 id="EC2-connects-to-MSK"><a href="#EC2-connects-to-MSK" class="headerlink" title="EC2 connects to MSK"></a>EC2 connects to MSK</h4><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a2v6y0mj20u00u278k.jpg" alt="image-20201030223418415" style="zoom:50%;" />

<ul>
<li><p>當前這麼多kafka機器的地址、端口分別是多少，有四個ip address</p>
</li>
<li><p>我任選一個</p>
</li>
<li><p>先簡單跟Kafka cluster talk一下，問他當前機器有幾個topic呢？</p>
<h6 id="TIMEOUT-ISSUE"><a href="#TIMEOUT-ISSUE" class="headerlink" title="TIMEOUT ISSUE"></a>TIMEOUT ISSUE</h6><ul>
<li><p>為何超超超慢，卡了？</p>
<ul>
<li><p>不是Kafka cluster有問題，也不是client 機器有問題</p>
</li>
<li><p>問題在哪？</p>
<ul>
<li>vpc 內可以自由通信，但地外的沒資格進行對話！– 在創建 MSK時的事！MSK裡的VPC可以幫完成當前的集群四台機器無阻的要求。</li>
<li>後來的EC2，是地外的機器，是沒資格作交流的！so, timeout</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-172-31-16-188 bin]$ ./kafka-topics.sh --bootstrap-server b-3.testkafka.dt6pwu.c2.kafka.us-east-2.amazonaws.com:9092 --list</span><br><span class="line">Error <span class="keyword">while</span> executing topic <span class="built_in">command</span> : org.apache.kafka.common.errors.TimeoutException: Timed out waiting <span class="keyword">for</span> a node assignment.</span><br><span class="line">[2020-10-30 14:42:15,234] ERROR java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.TimeoutException: Timed out waiting <span class="keyword">for</span> a node assignment.</span><br><span class="line">	at org.apache.kafka.common.internals.KafkaFutureImpl.wrapAndThrow(KafkaFutureImpl.java:45)</span><br><span class="line">	at org.apache.kafka.common.internals.KafkaFutureImpl.access<span class="variable">$000</span>(KafkaFutureImpl.java:32)</span><br><span class="line">	at org.apache.kafka.common.internals.KafkaFutureImpl<span class="variable">$SingleWaiter</span>.await(KafkaFutureImpl.java:89)</span><br><span class="line">	at org.apache.kafka.common.internals.KafkaFutureImpl.get(KafkaFutureImpl.java:260)</span><br><span class="line">	at kafka.admin.TopicCommand<span class="variable">$AdminClientTopicService</span>.getTopics(TopicCommand.scala:272)</span><br><span class="line">	at kafka.admin.TopicCommand<span class="variable">$AdminClientTopicService</span>.listTopics(TopicCommand.scala:197)</span><br><span class="line">	at kafka.admin.TopicCommand$.main(TopicCommand.scala:64)</span><br><span class="line">	at kafka.admin.TopicCommand.main(TopicCommand.scala)</span><br><span class="line">Caused by: org.apache.kafka.common.errors.TimeoutException: Timed out waiting <span class="keyword">for</span> a node assignment.</span><br><span class="line"> (kafka.admin.TopicCommand$)</span><br></pre></td></tr></table></figure>
</li>
<li><p>也要允許 EC2 過來！加額外的 permission</p>
</li>
</ul>
</li>
<li><p>改變 kafka 的 default Security Group 所允許的網路的traffic!<br><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk7qu5kgboj31la0gsjuy.jpg" alt="image-20201030224646396"></p>
<ul>
<li><strong>加到 inbound, 這樣EC2的request 才能夠進去到 MSK</strong></li>
<li>outbound: 我想出去</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk7qyreomij317g0u0jw3.jpg" alt="image-20201030225110743" style="zoom:67%;" />





</li>
</ul>
</li>
</ul>
<ul>
<li><p>重 run 剛剛的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-172-31-16-188 bin]$ ./kafka-topics.sh --bootstrap-server b-3.testkafka.dt6pwu.c2.kafka.us-east-2.amazonaws.com:9092 --list</span><br><span class="line"></span><br><span class="line">[ec2-user@ip-172-31-16-188 bin]$</span><br></pre></td></tr></table></figure>

<ul>
<li>連結上了！！！</li>
</ul>
</li>
</ul>
<ul>
<li><p>創建 Topic!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-172-31-16-188 bin]$ ./kafka-topics.sh --bootstrap-server b-3.testkafka.dt6pwu.c2.kafka.us-east-2.amazonaws.com:9092 --create --topic <span class="built_in">test</span>-kafka --partition 4 --replication-factor 2</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> joptsimple.UnrecognizedOptionException: partition is not a recognized option</span><br><span class="line">	at joptsimple.OptionException.unrecognizedOption(OptionException.java:108)</span><br><span class="line">	at joptsimple.OptionParser.handleLongOptionToken(OptionParser.java:510)</span><br><span class="line">	at joptsimple.OptionParserState<span class="variable">$2</span>.handleArgument(OptionParserState.java:56)</span><br><span class="line">	at joptsimple.OptionParser.parse(OptionParser.java:396)</span><br><span class="line">	at kafka.admin.TopicCommand<span class="variable">$TopicCommandOptions</span>.&lt;init&gt;(TopicCommand.scala:578)</span><br><span class="line">	at kafka.admin.TopicCommand$.main(TopicCommand.scala:49)</span><br><span class="line">	at kafka.admin.TopicCommand.main(TopicCommand.scala)</span><br><span class="line">[ec2-user@ip-172-31-16-188 bin]$ ./kafka-topics.sh --bootstrap-server b-3.testkafka.dt6pwu.c2.kafka.us-east-2.amazonaws.com:9092 --create --topic <span class="built_in">test</span>-kafka --partitions 4 --replication-factor 2</span><br><span class="line">[ec2-user@ip-172-31-16-188 bin]$ ./kafka-topics.sh --bootstrap-server b-3.testkafka.dt6pwu.c2.kafka.us-east-2.amazonaws.com:9092 --list</span><br><span class="line"><span class="built_in">test</span>-kafka</span><br><span class="line">[ec2-user@ip-172-31-16-188 bin]$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----</span><br><span class="line">[ec2-user@ip-172-31-37-109 bin]$ ./kafka-topics.sh --bootstrap-server b-1.bigdata-msk-0305.e95lct.c3.kafka.us-east-2.amazonaws.com:9092 --list</span><br><span class="line">__amazon_msk_canary</span><br><span class="line">__consumer_offsets</span><br><span class="line">[ec2-user@ip-172-31-37-109 bin]$ ./kafka-topics.sh --bootstrap-server b-1.bigdata-msk-0305.e95lct.c3.kafka.us-east-2.amazonaws.com:9092 --create --topic <span class="built_in">test</span>-kafka-0305 --partitions 4 --replication-factor 2</span><br><span class="line">[ec2-user@ip-172-31-37-109 bin]$ ./kafka-topics.sh --bootstrap-server b-1.bigdata-msk-0305.e95lct.c3.kafka.us-east-2.amazonaws.com:9092 --list</span><br><span class="line">__amazon_msk_canary</span><br><span class="line">__consumer_offsets</span><br><span class="line"><span class="built_in">test</span>-kafka-0305</span><br></pre></td></tr></table></figure>

<p>​    </p>
</li>
</ul>
<h2 id="Producer-Send-msg-amp-Consumer-Read-msg"><a href="#Producer-Send-msg-amp-Consumer-Read-msg" class="headerlink" title="Producer Send msg &amp; Consumer Read msg"></a>Producer Send msg &amp; Consumer Read msg</h2><p>如何來模擬 producer &amp; consumer</p>
<ul>
<li>先基於腳本作操作就 OK</li>
<li>–producer-props 指的是 producer的 properties 最重要的就是我得告诉他我要發送data的cluster它的IP或地址，它得知道bootstrap.servers地址、選ack機制</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-172-31-16-188 bin]$ ./kafka-producer-perf-test.sh --topic <span class="built_in">test</span>-kafka --num-records 10 --throughput 10 --producer-props bootstrap.servers=b-3.testkafka.dt6pwu.c2.kafka.us-east-2.amazonaws.com:9092 acks=all --record-size 128</span><br><span class="line">10 records sent, 10.741139 records/sec (0.00 MB/sec), 163.70 ms avg latency, 483.00 ms max latency, 181 ms 50th, 483 ms 95th, 483 ms 99th, 483 ms 99.9th.</span><br><span class="line">[ec2-user@ip-172-31-16-188 bin]$ ./kafka-consumer-perf-test.sh --broker-list b-3.testkafka.dt6pwu.c2.kafka.us-east-2.amazonaws.com:9092 --messages 10 --<span class="built_in">print</span>-metrics --show-detailed-stats --topic <span class="built_in">test</span>-kafka</span><br><span class="line">time, threadId, data.consumed.in.MB, MB.sec, data.consumed.in.nMsg, nMsg.sec, rebalance.time.ms, fetch.time.ms, fetch.MB.sec, fetch.nMsg.sec</span><br><span class="line"></span><br><span class="line">Metric Name                                                                                             Value</span><br><span class="line">consumer-coordinator-metrics:assigned-partitions:&#123;client-id=consumer-1&#125;                               : 4.000</span><br><span class="line">consumer-coordinator-metrics:commit-latency-avg:&#123;client-id=consumer-1&#125;                                : 31.000</span><br><span class="line">consumer-coordinator-metrics:commit-latency-max:&#123;client-id=consumer-1&#125;                                : 31.000</span><br><span class="line">consumer-coordinator-metrics:commit-rate:&#123;client-id=consumer-1&#125;                                       : 0.033</span><br><span class="line">consumer-coordinator-metrics:commit-total:&#123;client-id=consumer-1&#125;                                      : 1.000</span><br><span class="line">consumer-coordinator-metrics:heartbeat-rate:&#123;client-id=consumer-1&#125;                                    : 0.000</span><br><span class="line">consumer-coordinator-metrics:heartbeat-response-time-max:&#123;client-id=consumer-1&#125;                       : NaN</span><br><span class="line">consumer-coordinator-metrics:heartbeat-total:&#123;client-id=consumer-1&#125;                                   : 0.000</span><br><span class="line">consumer-coordinator-metrics:join-rate:&#123;client-id=consumer-1&#125;                                         : 0.033</span><br><span class="line">consumer-coordinator-metrics:join-time-avg:&#123;client-id=consumer-1&#125;                                     : 3034.000</span><br><span class="line">consumer-coordinator-metrics:join-time-max:&#123;client-id=consumer-1&#125;                                     : 3034.000</span><br><span class="line">consumer-coordinator-metrics:join-total:&#123;client-id=consumer-1&#125;                                        : 1.000</span><br><span class="line">consumer-coordinator-metrics:last-heartbeat-seconds-ago:&#123;client-id=consumer-1&#125;                        : 1604070397.000</span><br><span class="line">consumer-coordinator-metrics:sync-rate:&#123;client-id=consumer-1&#125;                                         : 0.033</span><br><span class="line">consumer-coordinator-metrics:sync-time-avg:&#123;client-id=consumer-1&#125;                                     : 57.000</span><br><span class="line">consumer-coordinator-metrics:sync-time-max:&#123;client-id=consumer-1&#125;                                     : 57.000</span><br><span class="line">consumer-coordinator-metrics:sync-total:&#123;client-id=consumer-1&#125;                                        : 1.000</span><br><span class="line">consumer-fetch-manager-metrics:bytes-consumed-rate:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka&#125;           : 45.415</span><br><span class="line">consumer-fetch-manager-metrics:bytes-consumed-rate:&#123;client-id=consumer-1&#125;                             : 45.412</span><br><span class="line">consumer-fetch-manager-metrics:bytes-consumed-total:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka&#125;          : 1371.000</span><br><span class="line">consumer-fetch-manager-metrics:bytes-consumed-total:&#123;client-id=consumer-1&#125;                            : 1371.000</span><br><span class="line">consumer-fetch-manager-metrics:fetch-latency-avg:&#123;client-id=consumer-1&#125;                               : 21.750</span><br><span class="line">consumer-fetch-manager-metrics:fetch-latency-max:&#123;client-id=consumer-1&#125;                               : 32.000</span><br><span class="line">consumer-fetch-manager-metrics:fetch-rate:&#123;client-id=consumer-1&#125;                                      : 0.132</span><br><span class="line">consumer-fetch-manager-metrics:fetch-size-avg:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka&#125;                : 342.750</span><br><span class="line">consumer-fetch-manager-metrics:fetch-size-avg:&#123;client-id=consumer-1&#125;                                  : 342.750</span><br><span class="line">consumer-fetch-manager-metrics:fetch-size-max:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka&#125;                : 412.000</span><br><span class="line">consumer-fetch-manager-metrics:fetch-size-max:&#123;client-id=consumer-1&#125;                                  : 412.000</span><br><span class="line">consumer-fetch-manager-metrics:fetch-throttle-time-avg:&#123;client-id=consumer-1&#125;                         : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:fetch-throttle-time-max:&#123;client-id=consumer-1&#125;                         : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:fetch-total:&#123;client-id=consumer-1&#125;                                     : 4.000</span><br><span class="line">consumer-fetch-manager-metrics:records-consumed-rate:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka&#125;         : 0.331</span><br><span class="line">consumer-fetch-manager-metrics:records-consumed-rate:&#123;client-id=consumer-1&#125;                           : 0.331</span><br><span class="line">consumer-fetch-manager-metrics:records-consumed-total:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka&#125;        : 10.000</span><br><span class="line">consumer-fetch-manager-metrics:records-consumed-total:&#123;client-id=consumer-1&#125;                          : 10.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag-avg:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=0&#125;  : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag-avg:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=1&#125;  : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag-avg:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=2&#125;  : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag-avg:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=3&#125;  : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag-max:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=0&#125;  : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag-max:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=1&#125;  : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag-max:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=2&#125;  : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag-max:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=3&#125;  : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag-max:&#123;client-id=consumer-1&#125;                                 : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=0&#125;      : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=1&#125;      : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=2&#125;      : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lag:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=3&#125;      : 0.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead-avg:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=0&#125; : 2.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead-avg:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=1&#125; : 3.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead-avg:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=2&#125; : 3.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead-avg:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=3&#125; : 2.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead-min:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=0&#125; : 2.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead-min:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=1&#125; : 3.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead-min:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=2&#125; : 3.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead-min:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=3&#125; : 2.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead-min:&#123;client-id=consumer-1&#125;                                : 2.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=0&#125;     : 2.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=1&#125;     : 3.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=2&#125;     : 3.000</span><br><span class="line">consumer-fetch-manager-metrics:records-lead:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka, partition=3&#125;     : 2.000</span><br><span class="line">consumer-fetch-manager-metrics:records-per-request-avg:&#123;client-id=consumer-1, topic=<span class="built_in">test</span>-kafka&#125;       : 2.500</span><br><span class="line">consumer-fetch-manager-metrics:records-per-request-avg:&#123;client-id=consumer-1&#125;                         : 2.500</span><br><span class="line">kafka-metrics-count:count:&#123;client-id=consumer-1&#125;                                                      : 64.000</span><br><span class="line">[ec2-user@ip-172-31-16-188 bin]$</span><br></pre></td></tr></table></figure>

<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a2zlnw2j20z10u0wn6.jpg" alt="image-20201030231046314" style="zoom: 50%;" />

<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a335dbsj21830u0k3a.jpg" alt="image-20201030231059776" style="zoom:67%;" />



<h2 id="Check-Metrics-amp-Close-machines"><a href="#Check-Metrics-amp-Close-machines" class="headerlink" title="Check Metrics &amp; Close machines"></a>Check Metrics &amp; Close machines</h2><h4 id="CloudWatch-1"><a href="#CloudWatch-1" class="headerlink" title="CloudWatch"></a>CloudWatch</h4><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a36ygn5j213f0u00ye.jpg" alt="image-20201030231615009" style="zoom:67%;" />





<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gk7rrtvyaoj31c60boq5s.jpg" alt="image-20201030231908873" style="zoom:67%;" />



<h5 id="Mine"><a href="#Mine" class="headerlink" title="Mine:"></a>Mine:</h5><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1glt8qicv2cj314l0u0qd2.jpg" alt="image-20201219162312374" style="zoom:50%;" />



<h6 id="kafka-–-can-only-be-deleted-and-then-reconfigured-next-time"><a href="#kafka-–-can-only-be-deleted-and-then-reconfigured-next-time" class="headerlink" title="kafka – can only be deleted, and then reconfigured next time"></a>kafka – can only be deleted, and then reconfigured next time</h6><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1glt8yk8kuyj31f40fkdlf.jpg" alt="image-20201219163057742" style="zoom:50%;" />



<h2 id="Qs"><a href="#Qs" class="headerlink" title="Qs"></a>Qs</h2></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/10/23/BigData_java/2020-10-23%20Kafka%20Infrastructure%20&amp;%20Details/">BigData_java/2020-10-23 Kafka Infrastructure &amp; Details</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-10-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/BigData-java/">BigData_java</a></span><div class="content"><h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h2><h3 id="My-Installation"><a href="#My-Installation" class="headerlink" title="My Installation"></a>My Installation</h3><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">10882* brew cask install java</span><br><span class="line">10885* /bin/bash -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)</span>"</span>\n</span><br><span class="line">10886* <span class="built_in">echo</span> <span class="string">'PATH="/usr/local/bin:$PATH"'</span> &gt;&gt; ~/.bash_profile</span><br><span class="line">10896* brew cask install homebrew/cask-versions/adoptopenjdk8</span><br><span class="line">10897* brew install kafka</span><br><span class="line">10904* java -version</span><br><span class="line">10905* vim /usr/<span class="built_in">local</span>/etc/kafka/server.properties		↓ </span><br><span class="line">															uncomment <span class="string">"listeners=PLAINTEXT://:9092"</span></span><br></pre></td></tr></table></figure>



<h3 id="Servers-of-Zookeeper-amp-Kafka"><a href="#Servers-of-Zookeeper-amp-Kafka" class="headerlink" title="Servers of Zookeeper &amp; Kafka"></a>Servers of Zookeeper &amp; Kafka</h3><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10906* zookeeper-server-start /usr/<span class="built_in">local</span>/etc/kafka/zookeeper.properties</span><br><span class="line">10907* kafka-server-start /usr/<span class="built_in">local</span>/etc/kafka/server.properties</span><br></pre></td></tr></table></figure>

<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gjzkxdfcs3j31xk0ng7dc.jpg" alt="image-20201023211741754" style="zoom:67%;" />



<h3 id="Topics"><a href="#Topics" class="headerlink" title="Topics"></a>Topics</h3><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">10909* kafka-topics --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic <span class="built_in">test</span></span><br><span class="line">	&gt;&gt; Created topic <span class="built_in">test</span>.</span><br><span class="line">	</span><br><span class="line">10911* kafka-topics --list --bootstrap-server localhost:9092</span><br><span class="line">	&gt;&gt; <span class="built_in">test</span></span><br><span class="line">	</span><br><span class="line">10913* kafka-topics --describe --topic <span class="built_in">test</span> --bootstrap-server localhost:9092</span><br><span class="line">	&gt;&gt; Topic: <span class="built_in">test</span>	PartitionCount: 1	ReplicationFactor: 1	Configs: segment.bytes=1073741824</span><br><span class="line">					Topic: <span class="built_in">test</span>	Partition: 0	Leader: 0	Replicas: 0	Isr: 0</span><br><span class="line"></span><br><span class="line">10914* kafka-run-class kafka.tools.GetOffsetShell --broker-list localhost:9092 --topic <span class="built_in">test</span></span><br><span class="line">	&gt;&gt; <span class="built_in">test</span>:0:0</span><br></pre></td></tr></table></figure>



<h3 id="Producer-amp-Consumer"><a href="#Producer-amp-Consumer" class="headerlink" title="Producer &amp; Consumer"></a>Producer &amp; Consumer</h3><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10915* kafka-console-producer --broker-list localhost:9092 --topic <span class="built_in">test</span></span><br><span class="line">10916* kafka-console-consumer --bootstrap-server localhost:9092 --topic <span class="built_in">test</span></span><br><span class="line">10918* kafka-console-consumer --bootstrap-server localhost:9092 --topic <span class="built_in">test</span> --from-beginning</span><br></pre></td></tr></table></figure>

<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a1fowkwj220m0n2n1g.jpg" alt="image-20201023212415260" style="zoom:67%;" />





<h2 id="Maven-Proj"><a href="#Maven-Proj" class="headerlink" title="Maven Proj"></a>Maven Proj</h2><ul>
<li>⌘ + N – Generate</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a1i4boaj21870u0dlv.jpg" alt="image-20201024003840912" style="zoom:50%;" />





<h3 id=""><a href="#" class="headerlink" title=""></a></h3></div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/12/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/81/">81</a><a class="extend next" rel="next" href="/page/14/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By Joe Huang</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>