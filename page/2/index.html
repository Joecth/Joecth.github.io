<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Joe Huang"><meta name="copyright" content="Joe Huang"><title>Awaken Desparado</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.1.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Joe Huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">286</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">25</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">41</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Awaken Desparado</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Awaken Desparado</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/03/15/System-Design/9p/2020-03-15-System%20Design%20-%20Seckill%20&amp;%20Booling%20System/">System-Design/9p/2020-03-15-System Design - Seckill &amp; Booling System</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/System/">System</a></span><div class="content"><h1 id="秒殺"><a href="#秒殺" class="headerlink" title="秒殺"></a>秒殺</h1><ul>
<li>0點開始</li>
<li>限量100台</li>
<li>一人限購一台</li>
<li>如：搶紅包、搶火車票、搶手機</li>
</ul>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200824202003669.png" alt="image-20200824202003669" style="zoom: 50%;" />



<h3 id="QPS分析"><a href="#QPS分析" class="headerlink" title="QPS分析"></a>QPS分析</h3><ul>
<li>平日每秒1000人訪問這頁面。秒殺時每秒數十萬人訪問該頁面，QPS增加100倍以上。</li>
</ul>
<h2 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h2><h3 id="商品購買和下單流程"><a href="#商品購買和下單流程" class="headerlink" title="商品購買和下單流程"></a>商品購買和下單流程</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi26516fedj30xi0g6gp6.jpg" alt="image-20200824202207414"></p>
<ul>
<li>付完錢才是完成，如果沒有按時付錢，庫存是會被放開的</li>
</ul>
<h3 id="需要解決的問題們"><a href="#需要解決的問題們" class="headerlink" title="需要解決的問題們"></a>需要解決的問題們</h3><h4 id="瞬間大流量高併發"><a href="#瞬間大流量高併發" class="headerlink" title="瞬間大流量高併發"></a>瞬間大流量高併發</h4><p>server、db能承載的QPS有限，如db一般是單機 1000 QPS，需要根據業務預估併發量</p>
<h4 id="有限庫存，不能超賣"><a href="#有限庫存，不能超賣" class="headerlink" title="有限庫存，不能超賣"></a>有限庫存，不能超賣</h4><p>庫存是有限的，需要精準地保證，就是賣掉了N個商品。不能超賣，當然也不能少賣</p>
<h4 id="黃牛惡意請求"><a href="#黃牛惡意請求" class="headerlink" title="黃牛惡意請求"></a>黃牛惡意請求</h4><p>使用腳本模擬用戶購買，模擬出10幾萬個請求去搶購</p>
<h4 id="固定時間開啟"><a href="#固定時間開啟" class="headerlink" title="固定時間開啟"></a>固定時間開啟</h4><p>時間到了才能購買，提前一秒都不可以 (以商家的時間為準)</p>
<h4 id="嚴格限購"><a href="#嚴格限購" class="headerlink" title="嚴格限購"></a>嚴格限購</h4><p>一個商家只能買固定數量個</p>
<h3 id="需求拆解"><a href="#需求拆解" class="headerlink" title="需求拆解"></a>需求拆解</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi26c7mxc1j30sq0ck40q.jpg" alt="image-20200824202903828"></p>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><h3 id="服務結構設計"><a href="#服務結構設計" class="headerlink" title="服務結構設計"></a>服務結構設計</h3><h4 id="單體"><a href="#單體" class="headerlink" title="單體"></a>單體</h4><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi26fynt3uj30zo0gk11x.jpg" alt="image-20200824203239695" style="zoom:67%;" />



<h4 id="微服務"><a href="#微服務" class="headerlink" title="微服務"></a>微服務</h4><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi26i5p40mj30zs0e211l.jpg" alt="image-20200824203446425" style="zoom:67%;" />



<h2 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h2><h3 id="寫"><a href="#寫" class="headerlink" title="寫"></a>寫</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi26m08ptzj30y00e8wil.jpg" alt="image-20200824203827977"></p>
<h4 id="Q-如何添加索引"><a href="#Q-如何添加索引" class="headerlink" title="Q: 如何添加索引?"></a>Q: 如何添加索引?</h4><ul>
<li><p>商品表: 沒有關聯其他表，所以就主鍵就ok了</p>
</li>
<li><p>秒殺表: 綁定了商品，所以 commodity_id 可以作索引查起來快</p>
</li>
<li><p>庫存表: 綁了商品、以及活動 id，要保證同一個商品跟活動 id 要綁定作唯一鍵</p>
</li>
<li><p>訂單表: 商品、活動以及用戶可以綁一起作唯一鍵</p>
</li>
</ul>
<h4 id="數據流"><a href="#數據流" class="headerlink" title="數據流"></a>數據流</h4><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi26tz811sj31460fa77r.jpg" alt="image-20200824204607333"></p>
<ul>
<li>紅框那個很重要，因為最重要的就是去搶庫存，所以那個要更新</li>
<li>一般不作外鍵，慢</li>
<li>建立索引有原則的</li>
</ul>
<h4 id="Q-解決超賣-秒殺操作-扣減庫存"><a href="#Q-解決超賣-秒殺操作-扣減庫存" class="headerlink" title="Q: 解決超賣: 秒殺操作 - 扣減庫存"></a>Q: 解決超賣: 秒殺操作 - 扣減庫存</h4><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi26z4b2plj30ja0eaq7l.jpg" alt="image-20200824205104211" style="zoom: 33%;" />



<h5 id="解法一-X-事務-FOR-UPDATE-但效率低"><a href="#解法一-X-事務-FOR-UPDATE-但效率低" class="headerlink" title="解法一(X) : 事務, FOR UPDATE, 但效率低"></a>解法一(X) : 事務, FOR UPDATE, 但效率低</h5><p>就是說我要去更新它，所以告訴SQL鎖住</p>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi270rmakwj30p00fgn23.jpg" alt="image-20200824205239608" style="zoom: 33%;" />



<h5 id="解法二-V-用-UPDATE-語句自帶的行鎖"><a href="#解法二-V-用-UPDATE-語句自帶的行鎖" class="headerlink" title="解法二(V): 用 UPDATE 語句自帶的行鎖"></a>解法二(V): 用 UPDATE 語句自帶的行鎖</h5><p>這個是透過MySQL本身的機制來保證的</p>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200824205433454.png" alt="image-20200824205433454" style="zoom:33%;" />

<h4 id="Q-大量請求都訪問-MySQL-導致-MySQL-崩潰。"><a href="#Q-大量請求都訪問-MySQL-導致-MySQL-崩潰。" class="headerlink" title="Q: 大量請求都訪問 MySQL, 導致 MySQL 崩潰。"></a>Q: 大量請求都訪問 MySQL, 導致 MySQL 崩潰。</h4><ul>
<li>對於搶購活動來說，可能幾十萬人搶100台iphone, 實際大部分請求都是無效的，不需要下沉到MySQL</li>
</ul>
<h5 id="解法一-庫存預熱-by-Redis"><a href="#解法一-庫存預熱-by-Redis" class="headerlink" title="解法一: 庫存預熱 by Redis"></a>解法一: 庫存預熱 by Redis</h5><ul>
<li><p>秒殺的本質，就是對庫存的搶奪。</p>
</li>
<li><p>每個秒殺的用戶來都去DFB校驗庫存，然後扣減庫存，會導致DB崩潰</p>
</li>
<li><p>MySQL DB單點能支撐 1000 QPS, 但 Redis 單點能支撐 10萬 QPS，可以考慮將庫存信息加載到 Redis中。</p>
</li>
<li><p><strong>直接通過 Redis 來判斷並扣減庫存。</strong></p>
<h5 id="Redis"><a href="#Redis" class="headerlink" title="Redis:"></a>Redis:</h5><ul>
<li>kv pair, 也可持久化</li>
<li>支持<ul>
<li>string</li>
<li>hash</li>
<li>list</li>
<li>set</li>
<li>zset</li>
</ul>
</li>
<li>單線程的數據庫，沒有併發的問題。通過IO多路復用實現併發，大家進來就是一個個排隊</li>
<li>主持主備容災 (Disaster Tolerance) 存儲，主掛了，小弟會趕緊頂上去</li>
<li>所有單個指令操作都是原子的，要麼完全ok或失敗。</li>
<li>多個指令可以通過 Lua 腳本實現原子性</li>
<li>因為所有操作都在 內存中，所以性能極高，單機一般可以到10萬數量級</li>
<li>可作為Cache、DB、MQ</li>
</ul>
</li>
<li><p>提前放到Redis預熱，它來判斷庫存</p>
</li>
</ul>
<h4 id="Q-何時預熱"><a href="#Q-何時預熱" class="headerlink" title="Q: 何時預熱?"></a>Q: 何時預熱?</h4><ul>
<li>活動前呀!</li>
</ul>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200824210846277.png" alt="image-20200824210846277" style="zoom:50%;" />

<ul>
<li><strong>開始通過redis 減庫存</strong></li>
</ul>
<p>現在直接去讀redis庫存，如果庫存小於0就結束；一個redis是單線程的，不會有併發的問題。創了訂單才會去DB扣庫存；</p>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi27khniyyj312k0feaia.jpg" alt="image-20200824211136832" style="zoom:50%;" />

<h4 id="Q-使用Redis-的問題-–-仍有超賣問題，超賣在redis也要解決"><a href="#Q-使用Redis-的問題-–-仍有超賣問題，超賣在redis也要解決" class="headerlink" title="Q: 使用Redis 的問題 – 仍有超賣問題，超賣在redis也要解決"></a>Q: 使用Redis 的問題 – 仍有超賣問題，超賣在redis也要解決</h4><h5 id="方案一-–-仍有放行的問題"><a href="#方案一-–-仍有放行的問題" class="headerlink" title="方案一 – 仍有放行的問題:"></a>方案一 – 仍有放行的問題:</h5><img src="/Users/joe/Library/Application Support/typora-user-images/image-20200824211410268.png" alt="image-20200824211410268" style="zoom:50%;" />

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi27o0eo75j311c0ek42p.jpg" alt="image-20200824211500506" style="zoom:50%;" />



<h5 id="方案二-通過-Lua-腳本執行原子操作，redis-2-6版後"><a href="#方案二-通過-Lua-腳本執行原子操作，redis-2-6版後" class="headerlink" title="方案二: 通過 Lua 腳本執行原子操作，redis 2.6版後"></a>方案二: 通過 Lua 腳本執行原子操作，redis 2.6版後</h5><p>就是把剛剛redis的 GET 跟 DECR 合而為一了，在一個事務裡去操作</p>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200824211654764.png" alt="image-20200824211654764" style="zoom:50%;" />

<p>現在redis對於DB就只放給它100而已，性能也夠了。但現在會有的問題是：</p>
<h4 id="Q-如果秒殺量是1萬台、10萬台呢？-gt-MySQL仍撐不了"><a href="#Q-如果秒殺量是1萬台、10萬台呢？-gt-MySQL仍撐不了" class="headerlink" title="Q: 如果秒殺量是1萬台、10萬台呢？==&gt; MySQL仍撐不了"></a>Q: 如果秒殺量是1萬台、10萬台呢？==&gt; MySQL仍撐不了</h4><p>可通過MQ去削峰，讓量慢慢地放過去</p>
<ul>
<li><p>點了商品，他會讓我等一、兩秒，讓redis(一秒十萬個)慢慢去找MySQL(集群，所以也是可以一秒一萬個)</p>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200824212243509.png" alt="image-20200824212243509" style="zoom:50%;" />



</li>
</ul>
<h5 id="MQ"><a href="#MQ" class="headerlink" title="MQ"></a>MQ</h5><ul>
<li>如去星巴克取餐這類，步調不一致的問題解決</li>
<li>解耦和async的操作</li>
<li>mq一般是帶有重試能力</li>
</ul>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200824212727568.png" alt="image-20200824212727568" style="zoom: 33%;" />

<h5 id="q-如果極端之下MQ出現部份投遞失敗怎辦？"><a href="#q-如果極端之下MQ出現部份投遞失敗怎辦？" class="headerlink" title="q: 如果極端之下MQ出現部份投遞失敗怎辦？"></a>q: 如果極端之下MQ出現部份投遞失敗怎辦？</h5><p>RabbitMQ, Kafka, RocketMQ</p>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi283k35tvj314o0g8tdo.jpg" alt="image-20200824212957025" style="zoom: 50%;" />

<ul>
<li>沒長度限制的</li>
<li>redis是集群的；剛剛講的10萬是單機的</li>
<li>失敗可能是網路原因</li>
</ul>
<h3 id="讀"><a href="#讀" class="headerlink" title="讀"></a>讀</h3></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/03/03/SQL/T/">SQL/T</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-03</time><div class="content"><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gcg1afg4rdj30jg0hkdgt.jpg" alt="image-20200303001005931" style="zoom:50%;" />

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> tmp</span><br><span class="line"><span class="keyword">AS</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> *</span><br><span class="line">	<span class="keyword">FROM</span> Campaigns</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> Campaign_id</span><br><span class="line">			,<span class="keyword">min</span>(<span class="built_in">DATE</span>) <span class="keyword">AS</span> earliest_date</span><br><span class="line">			,Spend_amount_USD</span><br><span class="line">		<span class="keyword">FROM</span> Spend</span><br><span class="line">		<span class="keyword">GROUP</span> <span class="keyword">BY</span> Campaign_id</span><br><span class="line">		) ss <span class="keyword">ON</span> Campaigns.Campaign_id = ss.Campaign_id</span><br><span class="line">	)</span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> tmp</span><br></pre></td></tr></table></figure>





<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> Campaigns</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> s1.Campaign_id</span><br><span class="line">		,s1.DATE</span><br><span class="line">		,Spend_amount_USD</span><br><span class="line">	<span class="keyword">FROM</span> Spend <span class="keyword">AS</span> s1</span><br><span class="line">	<span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> Campaign_id</span><br><span class="line">			,<span class="keyword">min</span>(<span class="built_in">DATE</span>) <span class="keyword">AS</span> earliest_date</span><br><span class="line">		<span class="keyword">FROM</span> Spend</span><br><span class="line">		<span class="keyword">GROUP</span> <span class="keyword">BY</span> Campaign_id</span><br><span class="line">		) tmp <span class="keyword">ON</span> s1.Campaign_id = tmp.Campaign_id</span><br><span class="line">		<span class="keyword">AND</span> s1.DATE = tmp.earliest_date</span><br><span class="line">	) ss <span class="keyword">ON</span> Campaigns.Campaign_id = ss.Campaign_id</span><br></pre></td></tr></table></figure>

<p>left join 因為，可能 Spend裡找不到235這活動，但是他的確是Account_id２辦過的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> cs</span><br><span class="line"><span class="keyword">AS</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> *</span><br><span class="line">	<span class="keyword">FROM</span> Campaigns</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> Campaign_id</span><br><span class="line">			,<span class="keyword">min</span>(<span class="built_in">DATE</span>) <span class="keyword">AS</span> earliest_date</span><br><span class="line">			,Spend_amount_USD</span><br><span class="line">		<span class="keyword">FROM</span> Spend</span><br><span class="line">		<span class="keyword">GROUP</span> <span class="keyword">BY</span> Campaign_id</span><br><span class="line">		) ss <span class="keyword">ON</span> Campaigns.Campaign_id = ss.Campaign_id</span><br><span class="line">	)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> cs <span class="keyword">AS</span> c1</span><br><span class="line"><span class="keyword">WHERE</span> c1.earliest_date = (</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="keyword">min</span>(c2.earliest_date)</span><br><span class="line">		<span class="keyword">FROM</span> cs <span class="keyword">AS</span> c2</span><br><span class="line">		<span class="keyword">WHERE</span> c2.Account_id = c2.Account_id</span><br><span class="line">		)</span><br><span class="line">	<span class="keyword">OR</span> c1.earliest_date <span class="keyword">IS</span> <span class="literal">NULL</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> account_id</span><br></pre></td></tr></table></figure>





<table>
<thead>
<tr>
<th>ID</th>
<th>Account_id</th>
<th>Campaign_id</th>
<th>Campaign_type</th>
<th>Campaign_id:1</th>
<th>earliest_date</th>
<th>Spend_amount_USD</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>123</td>
<td>Promoted Trend</td>
<td>123</td>
<td>2017-08-01</td>
<td>200.0</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>234</td>
<td>Promoted Account</td>
<td>234</td>
<td>2017-08-01</td>
<td>500.0</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>235</td>
<td>Promoted Tweet</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>1</td>
<td>456</td>
<td>Promoted Trend</td>
<td>456</td>
<td>2017-08-01</td>
<td>200.0</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
<td>999</td>
<td>NONO</td>
<td>999</td>
<td>2017-08-11</td>
<td>1000.0</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>ID</th>
<th>Account_id</th>
<th>Campaign_id</th>
<th>Campaign_type</th>
<th>Campaign_id:1</th>
<th>earliest_date</th>
<th>Spend_amount_USD</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>123</td>
<td>Promoted Trend</td>
<td>123</td>
<td>2017-08-01</td>
<td>200.0</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>234</td>
<td>Promoted Account</td>
<td>234</td>
<td>2017-08-01</td>
<td>500.0</td>
</tr>
<tr>
<td>4</td>
<td>1</td>
<td>456</td>
<td>Promoted Trend</td>
<td>456</td>
<td>2017-08-01</td>
<td>200.0</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>235</td>
<td>Promoted Tweet</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> cs</span><br><span class="line"><span class="keyword">AS</span> (</span><br><span class="line">	<span class="keyword">SELECT</span> *</span><br><span class="line">	<span class="keyword">FROM</span> Campaigns</span><br><span class="line">	<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> Campaign_id</span><br><span class="line">			,<span class="keyword">min</span>(<span class="built_in">DATE</span>) <span class="keyword">AS</span> earliest_date</span><br><span class="line">			,<span class="keyword">SUM</span>(Spend_amount_USD)</span><br><span class="line">		<span class="keyword">FROM</span> Spend</span><br><span class="line">		<span class="keyword">GROUP</span> <span class="keyword">BY</span> Campaign_id</span><br><span class="line">		) ss <span class="keyword">ON</span> Campaigns.Campaign_id = ss.Campaign_id</span><br><span class="line">	)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> cs <span class="keyword">AS</span> c1</span><br><span class="line"><span class="keyword">WHERE</span> c1.earliest_date = (</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="keyword">min</span>(c2.earliest_date)</span><br><span class="line">		<span class="keyword">FROM</span> cs <span class="keyword">AS</span> c2</span><br><span class="line">		<span class="keyword">WHERE</span> c1.Account_id = c2.Account_id</span><br><span class="line">		)</span><br><span class="line">	<span class="keyword">OR</span> c1.earliest_date <span class="keyword">IS</span> <span class="literal">NULL</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> account_id</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/03/03/System-Design/2020-03-03-System%20Design-BigTiger-G_Sheet/">System-Design/2020-03-03-System Design-BigTiger-G_Sheet</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-03</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SystemDesign/">SystemDesign</a></span><div class="content"><p>The coaching habit</p>
<h1 id="Design-G-Sheet"><a href="#Design-G-Sheet" class="headerlink" title="Design G-Sheet"></a>Design G-Sheet</h1><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvybcu4prj313u0ja7c4.jpg" alt="image-20200819111802026"></p>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvy9lckzhj30em0eugo8.jpg" alt="image-20200819111621876" style="zoom:50%;" />



<h2 id="DataStucture"><a href="#DataStucture" class="headerlink" title="DataStucture"></a>DataStucture</h2><h3 id="How-to-store-the-content-of-a-sheet"><a href="#How-to-store-the-content-of-a-sheet" class="headerlink" title="How to store the content of a sheet?"></a>How to store the content of a sheet?</h3><ul>
<li>Array</li>
<li>LinkedList</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvydeljqpj30wo0eite8.jpg" alt="image-20200819112000244" style="zoom:80%;" />

<ul>
<li>B花的空間大一些</li>
<li>B的複雜度要討論 = =……</li>
<li><strong>update 一定是主要操作!!</strong>，insert 慢，怎弄都ok，都會「ref」</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvyfqu5g6j30z80lgwld.jpg" alt="image-20200819112216095" style="zoom:67%;" />



<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvyi3504rj314k0eygrr.jpg" alt="image-20200819112431102"></p>
<h2 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h2><h4 id="Question-循環依賴"><a href="#Question-循環依賴" class="headerlink" title="Question: 循環依賴"></a>Question: 循環依賴</h4><ul>
<li>#REF!</li>
</ul>
<p>怎麼找：</p>
<ul>
<li>Topo</li>
<li>快慢指針</li>
<li>UF</li>
</ul>
<h3 id="How-many-memory-does-one-cell-need"><a href="#How-many-memory-does-one-cell-need" class="headerlink" title="How many memory does one cell need?"></a>How many memory does one cell need?</h3><ul>
<li>8k?!</li>
</ul>
<h3 id="What’s-the-max-number-of-cells"><a href="#What’s-the-max-number-of-cells" class="headerlink" title="What’s the max number of cells?"></a>What’s the max number of cells?</h3><ul>
<li><h2 id="2000000個-為何？"><a href="#2000000個-為何？" class="headerlink" title="2000000個? 為何？"></a>2000000個? 為何？</h2></li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvyrs2tymj30o00f8dj3.jpg" alt="image-20200819113348574"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghrwtppkl4j30tu0to7ai.jpg" alt="image-20200815232403114"></p>
<h2 id="Conflic"><a href="#Conflic" class="headerlink" title="Conflic"></a>Conflic</h2><p>Acquire Mutex</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghrwvw0octj316s0r4ak6.jpg" alt="image-20200815232555601"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghvg8idhebj312s0j27ai.jpg" alt="image-20200819005225841"></p>
<h2 id="Computer-Network"><a href="#Computer-Network" class="headerlink" title="Computer Network"></a>Computer Network</h2><h3 id="Latency-VS-Consistency"><a href="#Latency-VS-Consistency" class="headerlink" title="Latency VS Consistency"></a>Latency VS Consistency</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvwp7sod5j312s0icn21.jpg" alt="image-20200819102208942"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvwqli121j312k0k0aeu.jpg" alt="image-20200819102329411"></p>
<ul>
<li>實現複雜，因為要預測</li>
<li>時間戳</li>
</ul>
<h2 id="Software-Engineering"><a href="#Software-Engineering" class="headerlink" title="Software Engineering"></a>Software Engineering</h2><h3 id="How-to-design-the-System"><a href="#How-to-design-the-System" class="headerlink" title="How to design the System?"></a>How to design the System?</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvwtkkiijj313m0lyadq.jpg" alt="image-20200819102620406"></p>
<h2 id="Design-Thinking"><a href="#Design-Thinking" class="headerlink" title="Design Thinking"></a>Design Thinking</h2><h3 id="How-to-avoid-conflicts"><a href="#How-to-avoid-conflicts" class="headerlink" title="How to avoid conflicts?"></a>How to avoid conflicts?</h3><ul>
<li>不同人看到不同顏色，從產品出發</li>
</ul>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvwv9lrauj314e0i80yx.jpg" alt="image-20200819102758903"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/03/02/Books/2020-03-02%20%E9%9D%9E%E6%9A%B4%E5%8A%9B%E6%BA%9D%E9%80%9A-NonViolent%20Communication/">Books/2020-03-02 非暴力溝通-NonViolent Communication</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-02</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/Books/">Books</a></span><div class="content"><h5 id=""><a href="#" class="headerlink" title=""></a></h5><h2 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h2><h3 id="暴力溝通四種模式："><a href="#暴力溝通四種模式：" class="headerlink" title="暴力溝通四種模式："></a>暴力溝通四種模式：</h3><p>Four modes of violent communication:</p>
<p>道德批判、進行比較、迴避責任、強人所難。</p>
<p>Ethical criticism, comparison, avoidance of responsibility, and tough people.</p>
<h3 id="非暴力溝通模式-–-觀察對方和自己的需要"><a href="#非暴力溝通模式-–-觀察對方和自己的需要" class="headerlink" title="非暴力溝通模式 – 觀察對方和自己的需要"></a>非暴力溝通模式 – 觀察對方和自己的需要</h3><p>Non-violent communication mode – Observe the needs of others and yourself</p>
<h4 id="e-g"><a href="#e-g" class="headerlink" title="e.g."></a>e.g.</h4><p>和幾個同事在一個小組，需要共同完成一項工作。可有一位同事被大家認為沒有團隊精神，喜”單打獨鬥”。如果我們們用非暴力的思維去思考他的行為，就會發現他喜歡單打獨鬥的背後，一定有他的需要，可能他搞長難度更高的工作、可能他特別渴望獲得尊重。這個時候，我們可以平和引導他說出，他喜歡單打獨鬥的原因，然後綜合大家的需求，找到滿足雙方需求的方法，而不是用道德判斷的暴力溝通方式，覺得他價值觀有問題而去疏遠他。</p>
<p>In a small group with several colleagues, you need to complete a job together. However, one colleague was considered to have no team spirit and liked “single fight alone.” If we use non-violent thinking to think about his behavior, we will find that he likes to fight alone and there must be his needs. Maybe he has a more difficult job. Maybe he is particularly eager to get respect. At this time, we can calmly guide him to explain why he likes to fight alone, and then integrate everyone’s needs to find a way to meet the needs of both parties, instead of using violent communication methods based on moral judgment, and feel alienated in his values he.</p>
<h4 id="觀察、感受、需要、請求"><a href="#觀察、感受、需要、請求" class="headerlink" title="觀察、感受、需要、請求,"></a>觀察、感受、需要、請求,</h4><h4 id="Observe-feel-need-request"><a href="#Observe-feel-need-request" class="headerlink" title="Observe, feel, need, request"></a>Observe, feel, need, request</h4><p>比如，一位下屬沒有按時提交報表，如果是非暴力溝通的上級，可能會這樣和他交流：</p>
<p>上次的報表應該上週就完成的，可是你在昨天才給到我，我感到有點擔心，因為整體的工作進度可能會被擔誤，我不確定是不是你手頭上的工作太多，還是說你家裡有事情。我希望能幫助你更有效率地工作，可以告訴我你最近有什麼困難嗎？</p>
<p>For example, a subordinate did not submit a report on time. If he is a superior who communicates nonviolently, he may communicate with him like this:</p>
<p>The last report should have been completed last week, but you only gave it to me yesterday. I am a bit worried because the overall work progress may be burdened. I am not sure if you have too much work on hand, or Say you have something at home. I hope to help you work more efficiently. Can you tell me about any recent difficulties?</p>
<h2 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h2><h3 id="區分觀察-vs-評論-Distinguish-observation-vs-comments"><a href="#區分觀察-vs-評論-Distinguish-observation-vs-comments" class="headerlink" title="區分觀察 vs 評論 Distinguish observation vs comments"></a>區分觀察 vs 評論 Distinguish observation vs comments</h3><p>評論為絕對化的；觀察式的不會有反感，要避免絕對化的評論。</p>
<p>觀察結果的表述 – 加上絕對的時間跟地點</p>
<p>Comments are absolute; observations are not objectionable. Avoid absolute comments. Representation of observations – together w/ absolute time and place</p>
<h3 id="體會表達感受-Express-feelings"><a href="#體會表達感受-Express-feelings" class="headerlink" title="體會表達感受  Express feelings"></a>體會表達感受  Express feelings</h3><p>Thnks about the roots behind feelings</p>
<h3 id="找到並表達需求-Find-and-express-needs"><a href="#找到並表達需求-Find-and-express-needs" class="headerlink" title="找到並表達需求 Find and express needs"></a>找到並表達需求 Find and express needs</h3><h3 id="學會表達請求-Learn-to-express-requests"><a href="#學會表達請求-Learn-to-express-requests" class="headerlink" title="學會表達請求 Learn to express requests"></a>學會表達請求 Learn to express requests</h3><p>Refine goals with requests when expressing</p>
<h5 id="例１-E-g-1"><a href="#例１-E-g-1" class="headerlink" title="例１ E.g.1"></a>例１ E.g.1</h5><p>”我覺得這項工作我做得不是很好” – 僅想法，未表達感受</p>
<p>”這項工作沒做好，我很愧疚” – 表達感受；且適當示弱有助於溝通，是一種有效緩解對立情緒、解決衝突的方法。</p>
<p>“I don’t think I did a good job with this job” – only thoughts, no feelings </p>
<p>“This job is not done well, I feel guilty” – expressing feelings; BTW, showing weakness appropriately helps communication, which is an effective way to alleviate conflicts and resolve conflicts.</p>
<h5 id="例２-E-g-2"><a href="#例２-E-g-2" class="headerlink" title="例２ E.g.2"></a>例２ E.g.2</h5><p>看到下屬將機密文件隨便放到了辦公桌上，於是對他說：「你將機密文件放到辦公桌上，沒有及時鎖起來，這讓我特別緊張。」</p>
<p>接著，要繼續說「因為我不想讓機密文件存在任何洩密隱患」，這句話，挑明了”需求”。</p>
<p>「那麼，請你下次注意將文件第一時間收到保險箱裡，好嗎？」，這句話，則提出了我們的”請求”。</p>
<p>When seeing my subordinates placing confidential documents on the desk, and said to him, “You placed the confidential documents on the desk and did not lock them in time, which made me particularly nervous.</p>
<p>Then, to continue to say “because I don’t want any hidden dangers of confidential documents”, this sentence clarifies the “need”.</p>
<p>“Then, please pay attention to the documents once after being received and put in the safe as soon as possible, okay?” In this sentence, we made our “request”.</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/28/ML/2019-03-27-Time%20Series%20Analysis/">ML/2019-03-27-Time Series Analysis</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-28</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/M/">M</a></span><div class="content"><h2 id="時間數據的特徵工程"><a href="#時間數據的特徵工程" class="headerlink" title="時間數據的特徵工程"></a>時間數據的特徵工程</h2><p>可展開成年、月、日、星期幾、週末、月的哪部分，一年當中第幾天、第幾個月、月初還是月末、節日</p>
<p>上中下旬用數字不OK, 所以可用one-hot encoding，用很多個bool表示其中那個用1, 2, 3表示的上中下旬。</p>
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd8c7zt08dj30w20bg75q.jpg" alt="image-20200327114411681" style="zoom:67%;" />



<p>pd.get_dummies 做 one-hot- encoding</p>
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd8cgz308wj314g0iq411.jpg" alt="image-20200327115247759" style="zoom:80%;" />

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd8ccnwq2gj310409k757.jpg" alt="image-20200327114837591" style="zoom:67%;" />

<p>用10個維度表示其中的10年</p>
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd8cbtiq38j310o096aam.jpg" alt="image-20200327114753055" style="zoom:67%;" />





<p>然後整理數據集</p>
<p>Linear regression, 多項式迴歸、嶺迴歸、Lasso regression 需要　X_dummy , with one-hot-encoding, 成72維度</p>
<p>DT、RF不需要 one-hot-encoding，用 X_before_dummy</p>
<h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><p>MSE, RMSE, MAbsoluteE, R Square</p>
<h4 id="線性迴歸"><a href="#線性迴歸" class="headerlink" title="線性迴歸"></a>線性迴歸</h4><p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd8cqzb6j7j312u0huh1c.jpg" alt="image-20200327120233707"></p>
<p>我們看到的是72維在2D平面的投影</p>
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd8ct2bdltj313m02mdgg.jpg" alt="image-20200327120425110" style="zoom:80%;" />



<h4 id="多項式迴歸"><a href="#多項式迴歸" class="headerlink" title="多項式迴歸"></a>多項式迴歸</h4><p>二次、三次</p>
<h4 id="嶺迴歸"><a href="#嶺迴歸" class="headerlink" title="嶺迴歸"></a>嶺迴歸</h4><ul>
<li>線性加了L1正則</li>
</ul>
<h4 id="Lasso迴歸"><a href="#Lasso迴歸" class="headerlink" title="Lasso迴歸"></a>Lasso迴歸</h4><ul>
<li>線性加了L2正則</li>
</ul>
<h4 id="RF"><a href="#RF" class="headerlink" title="RF"></a>RF</h4><ul>
<li>bagging 子集建各樹、考慮最大的特徵數，作Cross Validation</li>
</ul>
<h2 id="模型比較"><a href="#模型比較" class="headerlink" title="模型比較"></a>模型比較</h2><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd8df910hwj31eu0m8n1b.jpg" alt="image-20200327122545346" style="zoom:67%;" />

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd8dfjtqpej315o0gk4cq.jpg" alt="image-20200327122605413" style="zoom:67%;" /></div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/58/">58</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Joe Huang</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>