<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Joe Huang"><meta name="copyright" content="Joe Huang"><title>Awaken Desparado</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.1.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Joe Huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">258</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">25</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">35</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Awaken Desparado</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Awaken Desparado</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2019/06/25/FFmpeg/2019-06-25-ffmpeg-cmds/">ffmpeg_cmds!</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-06-25</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/ffmpeg/">ffmpeg</a></span><div class="content"><h2 id="rm-black-sides"><a href="#rm-black-sides" class="headerlink" title="rm black sides"></a>rm black sides</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">╰─○ ffplay -i vn_hflip.mp4 -t 5 -vf cropdetect</span><br><span class="line">╰─○ ffplay -i vn_hflip.mp4 -t 5 -vf crop=1280:528:0:96</span><br></pre></td></tr></table></figure>

<h2 id="save-to-json"><a href="#save-to-json" class="headerlink" title="save to json"></a>save to json</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffprobe -hide_banner -print_format json -show_streams -i vn_hflip.mp4 &gt; vn_json_streams.log</span><br></pre></td></tr></table></figure>

<h2 id="check-error"><a href="#check-error" class="headerlink" title="check error"></a>check error</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffprobe -show_frames vn_hflip.mp4 &gt; vn_show_frames.log</span><br></pre></td></tr></table></figure>

<h2 id="video-to-pics"><a href="#video-to-pics" class="headerlink" title="video to pics"></a>video to pics</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i vn_hflip.mp4 -r 40 -f image2         -t 1 my%d.jpg        <span class="comment">## 跟下一行比會多了幾張重覆的，因為比來的video就25fps而已</span></span><br><span class="line"><span class="string">""</span><span class="string">"2938"</span><span class="string">""</span>  ffmpeg -i vn_hflip.mp4 -r 25 -f image2 -t 1 my25_%d.jpg <span class="comment">## 跟上一行几乎一样，就是正常的25 rate</span></span><br><span class="line">ffmpeg -i vn_hflip.mp4 -vcodec mjpeg -ss 0:0:2 -t 0:0:1 0m%04d.jpg  <span class="comment">## 跟上面比主要就是从第二秒开始</span></span><br><span class="line"></span><br><span class="line">2937  ffmpeg -i vn_hflip.mp4 -r 40 -f image2 -t 1 my25_%d.jpg</span><br><span class="line">★★★ -r, -ss, -t  本来的video要变成的rate，开始、抓多久</span><br><span class="line"></span><br><span class="line">ffmpeg -i vn_hflip.mp4 -ss 00:00:14.435 -vframes 1 out.png</span><br><span class="line">★★★ -vframes 抓几张</span><br></pre></td></tr></table></figure>

<h2 id="pics-to-video"><a href="#pics-to-video" class="headerlink" title="pics to video"></a>pics to video</h2><p>把多个图像文件使用h264编码封装成avi文件，如有my0.jpg, my1.jpg … my99.jpg</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i my%d.jpg  -vcodec h264 my.avi</span><br></pre></td></tr></table></figure>



<p>-r 选项的用法：</p>
<p>预设是</p>
<p>以25FPS读入所有图片，所以len(Images[])会是输出的video的duration. </p>
<p>作出25FPS的video, 所以如果 -r加在 output前面，会进行插帧、删帧。</p>
<p>如果-r加在 input前面，就是每秒读进来几张图片</p>
<p>如果　ffmpeg -r 10 -i z-%5d.jpeg -vcodec h264 -r 60 out10in60out.mp4</p>
<p>那么因为每秒读进来10张而已，硬做成60fps的video，也是没用，因为中间只是内插成了60fps</p>
<h2 id="video-to-gif"><a href="#video-to-gif" class="headerlink" title="video to gif"></a>video to gif</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i vn_hflip.mp4 -ss 0 -r 1 -vframes 6 vn.gif</span><br><span class="line">ffmpeg -i vn_hflip.mp4 -ss 0 -vf fps=1 -vframes 6 vn_fps.gif <span class="comment"># 这个似乎比上面的好一些</span></span><br></pre></td></tr></table></figure>




<p>##EXTRACTION !!!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> 2999  ffmpeg -i ../vn_hflip.mp4 -ss 00:00:00 -t 10 -vf fps=1 fps1_%d.png</span><br><span class="line">(joe_py36) ┌─[joe@JoeMBP2] - [~/Movies/exp/tmp] - [3003]</span><br><span class="line">└─[$] <span class="built_in">history</span> | grep r1                                                                                                                                                                           [22:06:04]</span><br><span class="line"> 2975  ffmpeg -i ../vn_hflip.mp4 -r 1 r1_%d.png</span><br><span class="line"> 2977  ffmpeg -i ../vn_hflip.mp4 -r 1 -vframes 6 r1_vframes_%d.png</span><br></pre></td></tr></table></figure>







<h2 id="add-logo"><a href="#add-logo" class="headerlink" title="add logo"></a>add logo</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i vn_hflip.mp4 -i ~/Pictures/Sackboy_0.jpeg -filter_complex overlay=W-w:H-h vn_logo.avi</span><br><span class="line">    如右下角: ffmpeg -i God.rm -i logo.png -filter_complex overlay=W-w:H-h my.avi</span><br><span class="line">    如居中:  ffmpeg -i God.rm -i logo.png -filter_complex overlay=W/2-w/2:H/2-h/2 my.avi</span><br></pre></td></tr></table></figure>



</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/06/07/Web/2019-06-07-Requests'%20secret:%20pool_connections%20and%20pool_maxsize/">Web/2019-06-07-Requests' secret: pool_connections and pool_maxsize</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-06-07</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/Web/">Web</a></span><div class="content"><p>from: <a href="https://www.cnblogs.com/pengyusong/p/5802929.html" target="_blank" rel="noopener">https://www.cnblogs.com/pengyusong/p/5802929.html</a></p>
<p>and <a href="https://laike9m.com/blog/requests-secret-pool_connections-and-pool_maxsize,89/" target="_blank" rel="noopener">https://laike9m.com/blog/requests-secret-pool_connections-and-pool_maxsize,89/</a></p>
<h1 id="Requests’-secret-pool-connections-and-pool-maxsize"><a href="#Requests’-secret-pool-connections-and-pool-maxsize" class="headerlink" title="Requests’ secret: pool_connections and pool_maxsize"></a><strong>Requests’ secret: pool_connections and pool_maxsize</strong></h1><p><a href="http://docs.python-requests.org/en/latest/" target="_blank" rel="noopener">Requests</a> 是一个python开发者众所周知的第三方库。因其简单的API和高性能，大多数人倾向于使用requests而不是urllib2作为访问http的标准库。然而很多使用requests库的人可能不知道内部原因，今天我就来解释以下俩个概念: <code>pool_connections</code> 和<code>pool_maxsize</code>.</p>
<p>从 <code>Session 开始</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">s.get(<span class="string">'https://www.google.com'</span>)</span><br></pre></td></tr></table></figure>

<p>这很简单，你可能知道requests’ <code>Session</code> 持有cookie. 但你知道 <code>Session</code> 有一个 <a href="http://docs.python-requests.org/en/latest/api/#requests.Session.mount" target="_blank" rel="noopener"><code>mount</code></a> 方法吗?</p>
<blockquote>
<p><code>mount(prefix, adapter)</code><br>Registers a connection adapter to a prefix.<br>Adapters are sorted in descending order by key length.</p>
</blockquote>
<p>不知道？很好，实际上你已经使用了这个方法当你初始化一个session对象时:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span><span class="params">(SessionRedirectMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment"># Default connection adapters.</span></span><br><span class="line">        self.adapters = OrderedDict()</span><br><span class="line">        self.mount(<span class="string">'https://'</span>, HTTPAdapter())</span><br><span class="line">        self.mount(<span class="string">'http://'</span>, HTTPAdapter())</span><br></pre></td></tr></table></figure>

<p>现在，到了有趣的部分。如果你阅读过 Ian Cordasco’s 文章 <a href="http://www.coglib.com/~icordasc/blog/2014/12/retries-in-requests.html" target="_blank" rel="noopener">Retries in Requests</a>, 你应该知道 <code>HTTPAdapter</code> 可以提供重试功能. 但一个 <code>HTTPAdapter</code> 真实是什么? Quoted from <a href="http://docs.python-requests.org/en/latest/api/#requests.adapters.HTTPAdapter" target="_blank" rel="noopener">doc</a>:</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">requests</span>.<span class="title">adapters</span>.<span class="title">HTTPAdapter</span><span class="params">(pool_connections=<span class="number">10</span>, pool_maxsize=<span class="number">10</span>, max_retries=<span class="number">0</span>, pool_block=False)</span></span></span><br></pre></td></tr></table></figure>

<p>The built-in HTTP Adapter for urllib3.</p>
<p>Provides a general-case interface for Requests sessions to contact HTTP and HTTPS urls by implementing the Transport Adapter interface. This class will usually be created by the Session class under the covers.</p>
<p>Parameters:</p>
<ul>
<li><code>pool_connections</code> – The number of urllib3 connection pools to cache.</li>
<li><code>pool_maxsize</code> – The maximum number of connections to save in the pool.</li>
<li><code>max_retries(int)</code> – The maximum number of retries each connection should attempt. Note, this applies only to failed DNS lookups, socket connections and connection timeouts, never to requests where data has made it to the server. By default, Requests does not retry failed connections. If you need granular control over the conditions under which we retry a request, import urllib3’s Retry class and pass that instead.</li>
<li><code>pool_block</code> – Whether the connection pool should block for connections. Usage:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; <span class="keyword">import</span> requests</span><br><span class="line">&gt;&gt; s = requests.Session()</span><br><span class="line">&gt;&gt; a = requests.adapters.HTTPAdapter(max_retries=<span class="number">3</span>)</span><br><span class="line">&gt;&gt; s.mount(<span class="string">'http://'</span>, a)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>如果上面的文档使你迷惑，这里是我的解释: HTTP Adapter 所做的就是：根据不同的目标url，对每个不同的请求提供不同的配置，还记得上面的代码吗？</p>
<p>　　　　what HTTP Adapter does is simply <strong>providing different configurations for different requests according to target url</strong>. Remember the code above?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.mount(<span class="string">'https://'</span>, HTTPAdapter())</span><br><span class="line">self.mount(<span class="string">'http://'</span>, HTTPAdapter())</span><br></pre></td></tr></table></figure>

<p>它创建了俩个 <code>HTTPAdapter</code> 对象使用默认的参数：<code>pool_connections=10, pool_maxsize=10, max_retries=0, pool_block=False</code>, 并且挂载到 <code>https://</code> 和 <code>http:// 相对路径</code>, 意思是第一个配置在你访问 <code>http://xxx 会使用到， 第二个会在你访问 ``https://xxx</code>. 尽管上面俩个配置是相同的，请求http和https仍然是隔离的。我们会在下面看到说明。</p>
<p>就像我说的，这篇文章的目的主要是解释 <code>pool_connections</code> and <code>pool_maxsize</code>.</p>
<p>首先，让我们看看 <code>pool_connections</code>. 昨天我在stackoverflow提出了一个问题：<a href="http://stackoverflow.com/questions/34837026/whats-the-meaning-of-pool-connections-in-requests-adapters-httpadapter" target="_blank" rel="noopener">question</a> ，因为我不确定我是否理解正确，这个问题的回答消除了我的不确定性。HTTP，众所周知，是基于TCP协议，一个HTTP连接也是一个TCP连接，它是由一个五元组唯一标识:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&lt;protocol&gt;, &lt;src addr&gt;, &lt;src port&gt;, &lt;dest addr&gt;, &lt;dest port&gt;)</span><br></pre></td></tr></table></figure>

<p>就是说，你针对 <code>www.example.com 建立了一个HTTP/TCP连接</code>, 假设服务器支持 <code>Keep-Alive</code>, 下一次你发送请求到 <code>www.example.com/a</code> or <code>www.example.com/b</code>, 你可以使用相同的连接，因为五元组没有改变. 实际上, <a href="http://docs.python-requests.org/en/latest/user/advanced/#keep-alive" target="_blank" rel="noopener">requests’ Session 自动会帮你处理</a> 并且重用连接，只要它能.</p>
<p>这个问题是，什么决定了你是否可以重用老的连接？是的，就是 <code>pool_connections</code>!</p>
<blockquote>
<p>pool_connections – The number of urllib3 connection pools to cache.</p>
</blockquote>
<p>我知道，我知道，我也不想引入很多术语, 这是最后一个，我发誓. 简单的理解它， 一个host对应的一个连接池：<strong>one connection pool corresponds to one host</strong>, 嗯，就是这个意思.</p>
<p>这是一个例子，无关的行已被忽略:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">s = requests.Session()</span><br><span class="line">s.mount(<span class="string">'https://'</span>, HTTPAdapter(pool_connections=1))</span><br><span class="line">s.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line">s.get(<span class="string">'https://www.zhihu.com'</span>)</span><br><span class="line">s.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">""</span><span class="string">"output</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.baidu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 None</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.zhihu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 2621</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.baidu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 None</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>

<p><code>HTTPAdapter(pool_connections=1)</code> 被映射到 <code>https://</code>, 他意思是在同一时间仅有一个连接池. 在调用 <code>s.get(&#39;https://www.baidu.com&#39;)</code>, 缓存的连接池是 <code>connectionpool(&#39;https://www.baidu.com&#39;)</code>. 现在 <code>s.get(&#39;https://www.zhihu.com&#39;)</code> 来了，这个session发现他不能使用缓存的连接，因为他不是相同的host(one connection pool corresponds to one host, remember?). 因此session不得不创建一个新的连接池. 因为 <code>pool_connections=1</code>, session不能在同一时间持有俩个连接池, 因此他丢弃了旧的连接池： <code>connectionpool(&#39;https://www.baidu.com&#39;)</code> 并且保存了新的：<code>connectionpool(&#39;https://www.zhihu.com&#39;)</code>. 下一次get同样如此Next <code>get</code> is the same. 这就是我们看见三个 <code>Starting new HTTPS connection</code> 日志行的原因</p>
<p>如果我们设置 <code>pool_connections</code> 为 2:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">s = requests.Session()</span><br><span class="line">s.mount(<span class="string">'https://'</span>, HTTPAdapter(pool_connections=2))</span><br><span class="line">s.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line">s.get(<span class="string">'https://www.zhihu.com'</span>)</span><br><span class="line">s.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line"><span class="string">""</span><span class="string">"output</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.baidu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 None</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.zhihu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 2623</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 None</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>很好，现在我们可以创建连接俩次了并且保持连接活跃</p>
<p>最后, <code>pool_maxsize</code>.</p>
<p>首先, 仅当你在多线程环境下使用session，你才应该关心 <code>pool_maxsize</code> , 例如，从多个线程使用同一个session发出并发请求.</p>
<p>实际上，<code>pool_maxsize</code> 是一个用来初始化urllib3’s <code>HTTPConnectionPool的参数</code>, 它才是真正含义上的连接池. <code>HTTPConnectionPool</code> 是一个容器，针对于特定的host保存连接的集合, 且 <code>pool_maxsize</code> 是这个集合的最大值. 如果你运行你的代码在同一个线程，它是不可能针对多个主机创建多个连接的，因为 requests library 是阻塞的, 因此HTTP请求总是一个接着一个发送.</p>
<p>如果使用多线程就会不一样.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">def thread_get(url):</span><br><span class="line">    s.get(url)</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">s.mount(<span class="string">'https://'</span>, HTTPAdapter(pool_connections=1, pool_maxsize=2))</span><br><span class="line">t1 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com'</span>,))</span><br><span class="line">t2 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/36612174'</span>,))</span><br><span class="line">t1.start();t2.start()</span><br><span class="line">t1.join();t2.join()</span><br><span class="line">t3 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/39420364'</span>,))</span><br><span class="line">t4 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/21362402'</span>,))</span><br><span class="line">t3.start();t4.start()</span><br><span class="line"><span class="string">""</span><span class="string">"output</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.zhihu.com</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (2): www.zhihu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/36612174 HTTP/1.1<span class="string">" 200 21906</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 2606</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/21362402 HTTP/1.1<span class="string">" 200 57556</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/39420364 HTTP/1.1<span class="string">" 200 28739</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>看见了吗? 它为相同的host建立了俩个连接： <code>www.zhihu.com</code>, 就像我说的, 这个仅发生在多线程环境下. 在这个例子中，我们创建了一个连接池，使用了参数 <code>pool_maxsize=2</code>, 发现同一时间不会超过俩个连接，因此这是足够的，我们看到<code>t3</code> 和 <code>t4</code> 没有创建新的连接，他们重用了就的连接.</p>
<p>如果没有足够的大小呢?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">s = requests.Session()</span><br><span class="line">s.mount(<span class="string">'https://'</span>, HTTPAdapter(pool_connections=1, pool_maxsize=1))</span><br><span class="line">t1 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com'</span>,))</span><br><span class="line">t2 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/36612174'</span>,))</span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br><span class="line">t1.join();t2.join()</span><br><span class="line">t3 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/39420364'</span>,))</span><br><span class="line">t4 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/21362402'</span>,))</span><br><span class="line">t3.start();t4.start()</span><br><span class="line">t3.join();t4.join()</span><br><span class="line"><span class="string">""</span><span class="string">"output</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.zhihu.com</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (2): www.zhihu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/36612174 HTTP/1.1<span class="string">" 200 21906</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 2606</span></span><br><span class="line"><span class="string">WARNING:requests.packages.urllib3.connectionpool:Connection pool is full, discarding connection: www.zhihu.com</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (3): www.zhihu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/39420364 HTTP/1.1<span class="string">" 200 28739</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/21362402 HTTP/1.1<span class="string">" 200 57556</span></span><br><span class="line"><span class="string">WARNING:requests.packages.urllib3.connectionpool:Connection pool is full, discarding connection: www.zhihu.com</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>现在, <code>pool_maxsize=1</code>，会打印警告日志如下，就像下面的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection pool is full, discarding connection: www.zhihu.com</span><br></pre></td></tr></table></figure>

<p>可以注意到仅有一个连接被保存在连接池中, 为t3或者t4创建一个新的连接. 很明显这是不够的. 这就是为什么在 urllib3’s 文档中说明如下:</p>
<blockquote>
<p>如果你计划在连接池环境下使用一个连接池, 你应该设置连接池最大数量为一个比较高的值，例如和线程的数量相同.</p>
</blockquote>
<p>最后, <code>HTTPAdapter</code> 实例映射到不同的前缀是相互独立的.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">s = requests.Session()</span><br><span class="line">s.mount(<span class="string">'https://'</span>, HTTPAdapter(pool_connections=1, pool_maxsize=2))</span><br><span class="line">s.mount(<span class="string">'https://baidu.com'</span>, HTTPAdapter(pool_connections=1, pool_maxsize=1))</span><br><span class="line">t1 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com'</span>,))</span><br><span class="line">t2 =Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/36612174'</span>,))</span><br><span class="line">t1.start();t2.start()</span><br><span class="line">t1.join();t2.join()</span><br><span class="line">t3 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/39420364'</span>,))</span><br><span class="line">t4 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/21362402'</span>,))</span><br><span class="line">t3.start();t4.start()</span><br><span class="line">t3.join();t4.join()</span><br><span class="line"><span class="string">""</span><span class="string">"output</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.zhihu.com</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (2): www.zhihu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/36612174 HTTP/1.1<span class="string">" 200 21906</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 2623</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/39420364 HTTP/1.1<span class="string">" 200 28739</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/21362402 HTTP/1.1<span class="string">" 200 57669</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>上面的代码很容易，不需要再次解释了.</p>
<p>就这样了，希望这篇文章帮助你更好的理解requests库. 顺便说一下，我创建了一个gist <a href="https://gist.github.com/laike9m/ead19c65a416c7022c00" target="_blank" rel="noopener">here</a> 这里包含这篇文章的测试代码. 随便下载并尝试吧</p>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><ol>
<li><p>For https, requests uses urllib3’s <a href="http://urllib3.readthedocs.org/en/latest/pools.html#urllib3.connectionpool.HTTPSConnectionPool" target="_blank" rel="noopener">HTTPSConnectionPool</a>, but it’s pretty much the same as HTTPConnectionPool so I didn’t differeniate them in this article.</p>
</li>
<li><p><code>Session</code>‘s <code>mount</code> method ensures the longest prefix gets matched first. Its implementation is pretty interesting so I posted it here.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mount</span><span class="params">(self, prefix, adapter)</span>:</span></span><br><span class="line">    <span class="string">"""Registers a connection adapter to a prefix.</span></span><br><span class="line"><span class="string">    Adapters are sorted in descending order by key length."""</span></span><br><span class="line">    self.adapters[prefix] = adapter</span><br><span class="line">    keys_to_move = [k <span class="keyword">for</span> k <span class="keyword">in</span> self.adapters <span class="keyword">if</span> len(k) &lt; len(prefix)]</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> keys_to_move:</span><br><span class="line">        self.adapters[key] = self.adapters.pop(key)</span><br></pre></td></tr></table></figure>

<p>Note that <code>self.adapters</code> is an <code>OrderedDict</code>.</p>
</li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/05/03/LC/2019-05-03-Remove-Element/">LC/2019-05-03-Remove-Element</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-05-03</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/LC/">LC</a></span><div class="content"><p>RemoveElement</p>
<p>​</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/23/System-Design/9p/2019-04-23-Crawler%20&amp;%20Typeahead%20Design/">System-Design/9p/2019-04-23-Crawler &amp; Typeahead Design</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SystemDesign/">SystemDesign</a></span><div class="content"><h1 id="General"><a href="#General" class="headerlink" title="General"></a>General</h1><ul>
<li><p>打擂台算法 - 就topk</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secondMax</span><span class="params">(self, nums)</span>:</span></span><br><span class="line">	first = <span class="literal">None</span></span><br><span class="line">  second = <span class="literal">None</span></span><br><span class="line">  <span class="keyword">for</span> num <span class="keyword">in</span> nums:</span><br><span class="line">    <span class="keyword">if</span> first <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> first &lt; num:</span><br><span class="line">      second = first</span><br><span class="line">      first = num</span><br><span class="line">    <span class="keyword">elif</span> second <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> second &lt; num:</span><br><span class="line">      second = num</span><br><span class="line">    <span class="keyword">return</span> second</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>DB Engines, kv strorage persistence  – , as Hash on Disk</p>
<ul>
<li>Redis 常駐內存</li>
<li>DynamoDB</li>
<li>MemcacheD – 斷電就沒了</li>
<li>RocksDB</li>
<li>Cassandra - Sharding(row) &amp; Range Query(col)</li>
</ul>
</li>
<li><p>MapReduce</p>
<ul>
<li><p>Word Count</p>
<ul>
<li><p>不是所有都可以進內存</p>
</li>
<li><p>單進程單機性能問題</p>
</li>
<li><p>單詞算哈希然後模機器數，同個單詞一定在同一台機器上。</p>
</li>
<li><pre><code class="python"><span class="class"><span class="keyword">class</span> <span class="title">WordCount</span>:</span>
  <span class="function"><span class="keyword">def</span> <span class="title">mapper</span><span class="params">(self, _, line)</span>:</span>
    <span class="keyword">for</span> word <span class="keyword">in</span> line.split():
      <span class="keyword">yield</span> word, <span class="number">1</span>

  <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self, key, values)</span>:</span>
    <span class="keyword">yield</span> key, sum(values)
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- intersection of 2 arrays, too easy</span><br><span class="line"></span><br><span class="line">  &#96;&#96;&#96;python</span><br><span class="line">  from collections import Counter </span><br><span class="line">  </span><br><span class="line">  class Solution:</span><br><span class="line">      &quot;&quot;&quot;</span><br><span class="line">      @param nums1: an integer array</span><br><span class="line">      @param nums2: an integer array</span><br><span class="line">      @return: an integer array</span><br><span class="line">      &quot;&quot;&quot;</span><br><span class="line">  </span><br><span class="line">      def intersection(self, nums1, nums2):</span><br><span class="line">          s1 &#x3D; Counter(nums1)</span><br><span class="line">          s2 &#x3D; Counter(nums2)</span><br><span class="line">  </span><br><span class="line">          ans &#x3D; []</span><br><span class="line">          for k in s1.keys():</span><br><span class="line">              # n &#x3D; min(s1[k], s2.get(k, 0))</span><br><span class="line">              # for _ in range(n):</span><br><span class="line">              if k in s2.keys():        </span><br><span class="line">                  ans.append(k)</span><br><span class="line">          return ans</span><br></pre></td></tr></table></figure>


</code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>WordBreak</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wordBreak</span><span class="params">(self, s: str, wordDict: List[str])</span> -&gt; bool:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> s:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">          </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> wordDict:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">          </span><br><span class="line">        ws = set(wordDict) <span class="comment"># wordSet</span></span><br><span class="line">        dp = [<span class="literal">False</span>] * len(s)   <span class="comment"># means states</span></span><br><span class="line">        <span class="comment"># abcde</span></span><br><span class="line">        dp[<span class="number">0</span>] = s[<span class="number">0</span>] <span class="keyword">in</span> ws</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(dp)):</span><br><span class="line">            <span class="comment"># print(i)</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> s[:i+<span class="number">1</span>] <span class="keyword">in</span> ws:</span><br><span class="line">                dp[i] = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">continue</span> </span><br><span class="line">            <span class="comment"># print(dp)            </span></span><br><span class="line">            start = i</span><br><span class="line">            </span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            dp[1] =     s[1:1+1] in ws and dp[0]    # s[1] in ws and dp[0]  </span></span><br><span class="line"><span class="string">                        or </span></span><br><span class="line"><span class="string">                        s[0:1+1] in ws                     </span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            dp[2] =     s[2:2+1] in ws and dp[1]    ## s[2]</span></span><br><span class="line"><span class="string">                        or </span></span><br><span class="line"><span class="string">                        s[1:2+1] in ws and dp[0] </span></span><br><span class="line"><span class="string">                        or </span></span><br><span class="line"><span class="string">                        s[0:2+1] in ws</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">            <span class="keyword">while</span> start &gt;= <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># if s[start:i+1] in ws and dp[start-1]:</span></span><br><span class="line">                <span class="keyword">if</span> dp[start<span class="number">-1</span>] <span class="keyword">and</span> s[start:i+<span class="number">1</span>] <span class="keyword">in</span> ws:</span><br><span class="line">                    dp[i] = <span class="literal">True</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                start -= <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> dp[<span class="number">-1</span>]</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="Web-Crawler"><a href="#Web-Crawler" class="headerlink" title="Web Crawler"></a>Web Crawler</h1><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge8kxuh73nj30qu0b2jtu.jpg" alt="image-20200427200540662" style="zoom:50%;" />

<blockquote>
<ul>
<li>除了中文分词，英文搜索是不是也要分词？<ul>
<li>英文搜索不用分词。你不会跟人说：hellonicetomeetyou 的。</li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>为了对网页进行分析，解析出链接信息，标题信息等，我们是需要保存整张网页的，而不只是纯文本内容。</li>
<li>搜索引擎的相关技术每一个都是一个深坑，慎入！在系统设计的面试中考得最多的当然还是 Web Crawler。另外关于倒排索引（Inverted Index）和 分词（Word Segmentation）的技术最好也是要知道的。</li>
</ul>
</blockquote>
<h2 id="Inverted-Index"><a href="#Inverted-Index" class="headerlink" title="Inverted Index"></a>Inverted Index</h2><ul>
<li>從 word 指向 doc id list 的索引 (index)</li>
<li>反過來就是 forward index (doc id -&gt; list of words)</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge8l2imdk0j30z80b8gwi.jpg" alt="image-20200427201034185" style="zoom:67%;" />

<blockquote>
<ul>
<li>当用户搜索 Hello World 的时候，搜索引擎会去倒排索引中检索 Hello 和 World 共同出现的文档有哪些，并且求出交集。</li>
</ul>
</blockquote>
<h2 id="Chinese-Word-Segmentation"><a href="#Chinese-Word-Segmentation" class="headerlink" title="Chinese Word Segmentation"></a>Chinese Word Segmentation</h2><p>中文分詞字字間沒有區分 e.g.化妝和服妝</p>
<ul>
<li>Viterbi Algorithm</li>
<li>Word-break</li>
<li>早期 G廠在中國沒做所以有一陣子時被B超過</li>
</ul>
<h1 id="Design-Crawler"><a href="#Design-Crawler" class="headerlink" title="Design Crawler"></a>Design Crawler</h1><h2 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h2><ul>
<li><p>全抓下並建 inverted index</p>
</li>
<li><p>網頁間存在指向的anchor關係</p>
</li>
<li><p>節點 &amp; 有向邊</p>
</li>
<li><p>Google 立身之本- ”page rank” 看各網頁被引用的高低</p>
<ul>
<li>被更多其他網頁指向的網頁，具有更高的價值</li>
</ul>
</li>
</ul>
<h3 id="開始爬的網頁"><a href="#開始爬的網頁" class="headerlink" title="開始爬的網頁"></a>開始爬的網頁</h3><ul>
<li>as seed urls</li>
<li>新聞網站作起點很好、Alexa(Amazon下的做的看流量排名)也可以</li>
</ul>
<h3 id="Producer-Consumer"><a href="#Producer-Consumer" class="headerlink" title="Producer/Consumer"></a>Producer/Consumer</h3><ul>
<li>BFS爬，在有向圖上爬</li>
</ul>
<blockquote>
<h5 id="单选题-Web-Crawler-一般可以使用哪种算法？"><a href="#单选题-Web-Crawler-一般可以使用哪种算法？" class="headerlink" title="[单选题]Web Crawler 一般可以使用哪种算法？"></a>[单选题]Web Crawler 一般可以使用哪种算法？</h5><p>A.深度优先搜索 DFS20.53% 选择</p>
<p>B.宽度优先搜索 BFS79.47% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p>互联网上的网页所构成的图巨大无比，如果使用 DFS 的话，深度太深也不易加入并行化的处理。使用 BFS 比较直观和方便。</p>
</blockquote>
<ul>
<li>DFS會讓我在抓時一個網站都還沒抓多少就跳走了。</li>
<li>解析快；抓慢</li>
</ul>
<h3 id="多進程抓"><a href="#多進程抓" class="headerlink" title="多進程抓"></a>多進程抓</h3><blockquote>
<h5 id="单选题-单进程-single-process-模型的爬虫的瓶颈是什么？"><a href="#单选题-单进程-single-process-模型的爬虫的瓶颈是什么？" class="headerlink" title="[单选题]单进程(single process)模型的爬虫的瓶颈是什么？"></a>[单选题]单进程(single process)模型的爬虫的瓶颈是什么？</h5><p>A.解析网页的速度太慢18.17% 选择</p>
<p>B.网络请求慢，单进程大部分时候处于闲置(idle)状态81.83% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
</blockquote>
<blockquote>
<h5 id="单选题-开-2000-个进程是否可以做到每秒钟下载-1000-个网页？"><a href="#单选题-开-2000-个进程是否可以做到每秒钟下载-1000-个网页？" class="headerlink" title="[单选题]开 2000 个进程是否可以做到每秒钟下载 1000 个网页？"></a>[单选题]开 2000 个进程是否可以做到每秒钟下载 1000 个网页？</h5><p>A.可以10.21% 选择</p>
<p>B.不可以89.79% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p>下载效率还受限于 CPU 个数和带宽。2000 个进程会导致大量的进程上下文切换（Context Switch），从而导致代码运行效率下降。</p>
</blockquote>
<p>所以10個核的話啟100個process</p>
<blockquote>
<ul>
<li>nonblocking IO呢？<ul>
<li>non-blocking IO可以在一定程度上解决这个问题，不过单机的并发数始终还是有瓶颈的，当并发的IO数目达到一定数量时还是需要向distributed的方案转变。</li>
</ul>
</li>
<li>请问多process和threading的区别是？<ul>
<li>多process不共享同一片内存，多 thread 共享同一片内存。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h2><h3 id="網頁存儲"><a href="#網頁存儲" class="headerlink" title="網頁存儲"></a>網頁存儲</h3><blockquote>
<h5 id="单选题-爬虫抓取下来的网页存在哪儿？"><a href="#单选题-爬虫抓取下来的网页存在哪儿？" class="headerlink" title="[单选题]爬虫抓取下来的网页存在哪儿？"></a>[单选题]爬虫抓取下来的网页存在哪儿？</h5><p>A.爬虫这台机器上8.22% 选择</p>
<p>B.分布式文件系统中（Distributed File System）91.78% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
</blockquote>
<p>這個文件系統還需要給indexer作inverted index，所以不放給爬蟲，</p>
<p>這樣一人作兩角會破壞爬蟲自己的是stateless的思想。</p>
<p>爬蟲要不怕掛，就重啟，跟數據庫不一樣；愈多stateless的系統愈穩定。</p>
<blockquote>
<h5 id="多选题-下列哪些东西是-Stateless-的？"><a href="#多选题-下列哪些东西是-Stateless-的？" class="headerlink" title="[多选题]下列哪些东西是 Stateless 的？"></a>[多选题]下列哪些东西是 Stateless 的？</h5><p>A.Web Server34.37% 选择</p>
<p>B.NoSQL Database9.55% 选择</p>
<p>C.SQL Database5.26% 选择</p>
<p>D.Memcached18.27% 选择</p>
<p>E.Async task worker (message queue consumer)32.55% 选择</p>
<p><strong>正确答案:</strong>AE</p>
<p><strong>解析:</strong></p>
<p>任何存储数据的服务器都是 stateful 的。只执行代码不存储数据的一般是 stateless 的如 Web Server, Async task worker</p>
</blockquote>
<h3 id="BFS中的Queue以及HashSet怎麼存的？"><a href="#BFS中的Queue以及HashSet怎麼存的？" class="headerlink" title="BFS中的Queue以及HashSet怎麼存的？"></a>BFS中的Queue以及HashSet怎麼存的？</h3><h4 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h4><ul>
<li><p>linkedlist in java</p>
</li>
<li><p>hash for visited</p>
</li>
</ul>
<blockquote>
<h5 id="单选题-BFS算法中使用到的-Queue-存在什么地方？"><a href="#单选题-BFS算法中使用到的-Queue-存在什么地方？" class="headerlink" title="[单选题]BFS算法中使用到的 Queue 存在什么地方？"></a>[单选题]BFS算法中使用到的 Queue 存在什么地方？</h5><p>A.在内存里直接开一个 Queue5.85% 选择</p>
<p>B.使用消息队列（Message Queue）74.03% 选择</p>
<p>C.使用 Memcached20.12% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
</blockquote>
<p>放內存就要擔心斷電的問題。</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h4><blockquote>
<h5 id="单选题-BFS-中的-HashSet-在系统设计中适合使用什么来存储？"><a href="#单选题-BFS-中的-HashSet-在系统设计中适合使用什么来存储？" class="headerlink" title="[单选题]BFS 中的 HashSet 在系统设计中适合使用什么来存储？"></a>[单选题]BFS 中的 HashSet 在系统设计中适合使用什么来存储？</h5><p>A.内存中开一个哈希表3.14% 选择</p>
<p>B.Memcached21.68% 选择</p>
<p>C.SQL Database4.26% 选择</p>
<p>D.NoSQL Database (Key-value Storage)70.92% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是D</p>
<p><strong>正确答案:</strong>D</p>
</blockquote>
<blockquote>
<ul>
<li>message queue是不是stateful的？<ul>
<li>是的</li>
</ul>
</li>
<li>为啥这里不用sql数据库存hashset，如果是多线程并发，要先查set中是否已经存在，然后不存在的话，写入，这是一个事务操作<ul>
<li>从这业务分析，我们可以知道是对每一个domain（域名）中的所有url进行耙取的，而url与其domain的关系1：n的关系，所以，我们在选择NoSQL的数据中，其存储结构是key-value的简单关系结构(key是domain-name，value是List[url])，而且NoSQL系统，其所对应的是Map的结构，而不是Set的结构。如果是多线程。我们要有一个类似信号量的控制访问数据库的锁（如Java.util.concurrent.ReentryLock的使用），即可，不需要事务，事务花销更大，而且大多数NoSQL不支持事务。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="可行解"><a href="#可行解" class="headerlink" title="可行解"></a>可行解</h2><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge9sne1pgkj30wy0h2wng.jpg" alt="image-20200428211834537" style="zoom:67%;" />

<ul>
<li>注意第７行不是用recursive的，而是讓它去排隊，避免stack overflow</li>
</ul>
<h3 id="Robot-協解"><a href="#Robot-協解" class="headerlink" title="Robot 協解"></a>Robot 協解</h3><p>爬蟲協議。</p>
<blockquote>
<ul>
<li>请问robot协议算是CORS的一种吗<ul>
<li>robot协议是针对爬虫的，告知爬虫对本网站数据的爬取规则。<br>CORS(Cross-Origin Resource Sharing)跨域资源共享是访问跨域资源时，浏览器与服务器应该如何沟通。是为了解决浏览器的<a href="https://en.wikipedia.org/wiki/Same-origin_policy" target="_blank" rel="noopener">同源禁止访问策略</a>。<br>CORS背后的基本思想就是使用自定义的HTTP头部让浏览器与服务器进行沟通，从而决定请求或响应是应该成功还是失败。</li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<p>这是知乎的 robots 协议：<a href="https://www.zhihu.com/robots.txt" target="_blank" rel="noopener">https://www.zhihu.com/robots.txt</a><br>更多的关于 robots 协议的规则感兴趣的话可以看看 <a href="https://baike.baidu.com/item/robots/5243374?fr=aladdin" target="_blank" rel="noopener">https://baike.baidu.com/item/robots/5243374?fr=aladdin</a></p>
</blockquote>
<h3 id="限制爬蟲的頻率"><a href="#限制爬蟲的頻率" class="headerlink" title="限制爬蟲的頻率"></a>限制爬蟲的頻率</h3><p>Queue 裡可能對同一個站同時抓太多次。</p>
<p><strong><em>让 Crawler 只做 Consumer，不负责产生新的抓取任务 新增一个 Scheduler (Producer) 负责调度和生产抓取任务 在 Database 中记录每个网站下一次可以友好抓取的时间</em></strong></p>
<blockquote>
<ul>
<li>实际应用中是不是爬虫都有这个scheduler，并不是consumer和producer都爬虫自己做<ul>
<li>是的，一般实用的爬虫框架都会有单独的scheduler，如果对实际的爬虫框架感兴趣的话可以看一下这两个开源的python爬虫框架：pyspider, scrapy</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="更可靠的解"><a href="#更可靠的解" class="headerlink" title="更可靠的解"></a>更可靠的解</h2><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge9v4lect4j310e0gytgt.jpg" alt="image-20200428221447375" style="zoom:67%;" />



<h3 id="表單內容和偽代碼"><a href="#表單內容和偽代碼" class="headerlink" title="表單內容和偽代碼"></a>表單內容和偽代碼</h3><blockquote>
<ul>
<li>课程里说这个UrlInf value里的status代表有没有抓过，有什么用吗？感觉结合后面反复抓取的情况，可能存的是抓取是不是成功的信息，这样可以计算下次抓取的时间（backoff)。不知这样理解对不对？<ul>
<li>一般数据库里我们 status 是最常用的一个 field，用来表示一个事情的进展。 URL 在抓取的过程中，有很多的中间状态的 status，比如抓取成功，抓取失败，正在抓取，还没有抓取过。没有被抓取过的意义是，你可以知道现在有多少网页正在抓取，多少发现了还没抓取，多少已经抓下来了，多少可能是坏链接。这对于监控爬虫的正常工作情况有重大意义。</li>
</ul>
</li>
<li>为什么候选的UrlList要单独放张表，不可以作为DomainInfo的value 的一个Field吗？<ul>
<li>你可以尝试使用一下 MySQL 之类的数据库，你会发现并不能找到一个 List 类型的 field。原因是 List 类型作为普通 MysQL 数据库的的 Field 的话，插入和删除都是 O(N) 的。因此为了更好的支持这种 key to list 的增删查改，要么在 SQL 数据库里用一个张单独的表单，以二元组的形式存储，如 <code>&lt;domain1, url1&gt;</code> <code>&lt;domain1, url2&gt;</code>，要么放在 redis 这种 value 支持 list 的数据库里。总之无论如何，都无法直接和 DomainInfo 放在一起，且数据的含义上，UrlList 也不属于一个 Domain 的 info。info 一般指一些 metadata 之类的信息。</li>
</ul>
</li>
</ul>
</blockquote>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge9v4yins0j30uo0kgnbr.jpg" alt="image-20200428224429124" style="zoom:67%;" />



<h3 id="分地區的爬蟲"><a href="#分地區的爬蟲" class="headerlink" title="分地區的爬蟲"></a>分地區的爬蟲</h3><h3 id="處理更新抓取與失效"><a href="#處理更新抓取與失效" class="headerlink" title="處理更新抓取與失效"></a>處理更新抓取與失效</h3><p>BFS裡會有HashSet看抓過沒。但會有更新，怎辦？</p>
<p>可 Exponential Backoff去試，搭配邊界。</p>
<blockquote>
<ul>
<li>怎么处理不存在的老的链接呢？<ul>
<li>总是抓取失败的话，就在 UrlInfo 里标记抓取失败，且下次要抓取的时间通过 Exponential Backoff 会慢慢变得很长，比如30天抓一次这种。</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li>可md5 16字節看是否一樣，放在url表單裡。</li>
</ul>
<blockquote>
<ul>
<li>如果一个网页变化了，有URL链接的变化怎么处理？是不是把原来存的DomainInfo和UrlInfo都更新（删掉老的数据）？<ul>
<li>比如 <a href="http://www.jiuzhang.com" target="_blank" rel="noopener">www.jiuzhang.com</a> 对应的网页变化了，只需要更新这个 URL 下的网页内容。DomainInfo 和 URLInfo 做一些相应的更新，比如 webpage md5之类的。这个跟这个网页里的 Url 链接是否发生变化没有什么关系。网页里如果发现了新的 URL 就再加到数据库和待抓取列表里即可。</li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<p>指数补偿(Exponential Backoff)指的是，在执行事件时，通过反馈，逐渐降低某个过程的速率，从而最终找到一个合适的速率（来处理事件）。</p>
<p>指数补偿通常用于网络和传输协议，比如在进行网络连接时，如果第一次请求失败，那么可以等待 <em>t1</em> 秒之后重试，如果再次请求还是失败，那么等待 <em>t2</em> 秒之后重试。重试可以一直继续下去，直到等待次数或等待时间超过特定值为止。</p>
<p>等待的时间 <em>ti</em> 是可以自由指定的，常用 1, 2, 4, 8 这样的指数序列，因此叫指数补偿。</p>
<p>类似的用到了指数补偿思想的场景还有动态数组（C++ 里的vector，Java 里的 ArrayList，Python 里的 list），动态数组之所以支持你不断的往里加入新元素，就是因为当一个数组满了以后，会再创建一个新的两倍元原来大小的数组来替换掉旧数组。</p>
</blockquote>
<blockquote>
<p>这个文章的作者用 20 台 AWS 的机器在 40 小时内抓取了 2.5亿篇网页，只花了 580$。</p>
<p><a href="http://www.michaelnielsen.org/ddi/how-to-crawl-a-quarter-billion-webpages-in-40-hours/" target="_blank" rel="noopener">http://www.michaelnielsen.org/ddi/how-to-crawl-a-quarter-billion-webpages-in-40-hours/</a></p>
<p>这篇文章中很多的内容是值得参考的比如如何拆分爬取任务的部分，作者的目的是单纯的抓取网页，和我们今天所设计的爬虫相比自然是我们课上讲的架构会更加适合一个真正的爬虫系统。</p>
</blockquote>
<h1 id="Design-TypeAhead-v-s-Google-Suggestion"><a href="#Design-TypeAhead-v-s-Google-Suggestion" class="headerlink" title="Design TypeAhead v.s. Google Suggestion"></a>Design TypeAhead v.s. Google Suggestion</h1><p>兩種不同類型的</p>
<ol>
<li>Typeahead.js </li>
<li>Google Suggestion</li>
</ol>
<ul>
<li>Trie - Re<strong>trie</strong>val</li>
</ul>
<h3 id="Front-End"><a href="#Front-End" class="headerlink" title="Front End"></a>Front End</h3><h3 id="Back-End"><a href="#Back-End" class="headerlink" title="Back End"></a>Back End</h3><ul>
<li>QPS issue</li>
</ul>
<h2 id="Scenario-1"><a href="#Scenario-1" class="headerlink" title="Scenario"></a>Scenario</h2><ul>
<li><p>返回被其他人蒐得多的 Top10 queries</p>
</li>
<li><p>個性化算法的架構</p>
</li>
<li><p>推算QPS ==&gt; 要練心算速推</p>
</li>
</ul>
<blockquote>
<h5 id="单选题-Google-Suggestion-API-主要是读还是写？"><a href="#单选题-Google-Suggestion-API-主要是读还是写？" class="headerlink" title="[单选题]Google Suggestion API 主要是读还是写？"></a>[单选题]Google Suggestion API 主要是读还是写？</h5><p>A.读96.80% 选择</p>
<p>B.写3.20% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是A</p>
</blockquote>
<ul>
<li>當讀多寫少時，就是用Cache進行優化</li>
</ul>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>提供Top10Query 查詢</p>
<ul>
<li>QueryService</li>
<li>CollectionService (敲了Enter後)</li>
</ul>
<blockquote>
<h5 id="多选题-为什么我们不让-QueryService-直接请求-CollectionService-获得结果？"><a href="#多选题-为什么我们不让-QueryService-直接请求-CollectionService-获得结果？" class="headerlink" title="[多选题]为什么我们不让 QueryService 直接请求 CollectionService 获得结果？"></a>[多选题]为什么我们不让 QueryService 直接请求 CollectionService 获得结果？</h5><p>A.因为用户很难感知数据是否是最实时的，有一点延迟没有关系36.79% 选择</p>
<p>B.因为 QueryService 请求 CollectionService 实时计算的话，会比较慢43.16% 选择</p>
<p>C.QueryService 请求 CollectionService 的服务器间通信比较慢20.05% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是AB</p>
<p><strong>正确答案:</strong>AB</p>
<p><strong>解析:</strong></p>
<p>服务器间通信是很快的。慢的是计算。</p>
</blockquote>
<blockquote>
<ul>
<li>这里CollectionService提供给QueryService信息是用的push模式吗？<ul>
<li>Yes</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Storage-1"><a href="#Storage-1" class="headerlink" title="Storage"></a>Storage</h2><h3 id="for-Query-Service"><a href="#for-Query-Service" class="headerlink" title="for Query Service"></a>for Query Service</h3><blockquote>
<h5 id="单选题-是否有支持-Trie-的数据库？"><a href="#单选题-是否有支持-Trie-的数据库？" class="headerlink" title="[单选题]是否有支持 Trie 的数据库？"></a>[单选题]是否有支持 Trie 的数据库？</h5><p>A.没有63.90% 选择</p>
<p>B.有36.10% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是A</p>
<p><strong>正确答案:</strong>A</p>
</blockquote>
<ul>
<li><p>沒有現成的數據庫，也不大可能自己去寫一套。</p>
<p>替代品就是kv storage，如RocksDB, Redis</p>
<p>kv在空間大一些，但就是系數上的大而已</p>
</li>
</ul>
<p>當Collection Service拿到 apple, </p>
<p>就要新增 a, ap, app … 等的 key，讓他們都append 一次apple，然後打擂台映射到top10的list </p>
<blockquote>
<ul>
<li>Trie的工程上应用意思是什么呢？实际工作中用吗？<ul>
<li>Trie在工程上用得很多，Trie的优势是O(字符串长度)的查找时间和良好的空间性能，相同的前缀只会存一份，因此适合在需要对大量字符串进行存储和查询（尤其是前缀查询）的场景。实际工作中有很多使用Trie及其变形的例子，像这里讲的search suggestion，还有IDE的auto complete, 浏览器的url历史补全，编辑器的spell checkers都可能会用到trie.</li>
</ul>
</li>
<li>”如果某个prefix已经存在了被搜索次数更多的其他10个 queries，就无需再加入了“。两个问题，1）怎么知道是被搜索次数更多的？加入的条件不是一样的吗，比如这里的1b 2) 更新一下是不是更好，因为是更新的结果。<ul>
<li>query 的搜索次数是会被 collection service 记录下来的。比较的时候是带着次数一起比较的。prefix -&gt; top 10 的记录格式是 <code>[{&quot;ap&quot;: {&quot;query&quot;: &quot;app&quot;, &quot;count&quot;: 100}...}]</code></li>
<li>更新 Top 10。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="for-Collection-Service"><a href="#for-Collection-Service" class="headerlink" title="for Collection Service"></a>for Collection Service</h3><p>蒐集每個Query 被蒐的次數</p>
<h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, is_end=False)</span>:</span></span><br><span class="line">        <span class="comment"># self.val = val</span></span><br><span class="line">        <span class="comment"># self.next = None</span></span><br><span class="line">        self.children = &#123;&#125;</span><br><span class="line">        self.is_end = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Trie</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># do intialization if necessary</span></span><br><span class="line">        <span class="comment"># self.children = &#123;&#125;</span></span><br><span class="line">        self.head = Node(<span class="string">'$'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: word: a word</span></span><br><span class="line"><span class="string">    @return: nothing</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, word)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        node = self.head</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> word:</span><br><span class="line">            <span class="comment"># print(ch)</span></span><br><span class="line">            <span class="keyword">if</span> ch <span class="keyword">not</span> <span class="keyword">in</span> node.children:</span><br><span class="line">                node.children[ch] = Node()</span><br><span class="line">            node = node.children[ch]</span><br><span class="line">        node.is_end = <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: word: A string</span></span><br><span class="line"><span class="string">    @return: if the word is in the trie.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(self, word)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        node = self.head</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> word:</span><br><span class="line">            <span class="comment"># if ch not in self.children:</span></span><br><span class="line">            <span class="keyword">if</span> ch <span class="keyword">not</span> <span class="keyword">in</span> node.children:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            node = node.children[ch]</span><br><span class="line">        <span class="keyword">return</span> node.is_end</span><br><span class="line">        </span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: prefix: A string</span></span><br><span class="line"><span class="string">    @return: if there is any word in the trie that starts with the given prefix.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">startsWith</span><span class="params">(self, prefix)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        node = self.head</span><br><span class="line">        <span class="comment"># print(self.children)</span></span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> prefix:</span><br><span class="line">            <span class="keyword">if</span> ch <span class="keyword">not</span> <span class="keyword">in</span> node.children:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            node = node.children[ch]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>



<h2 id="Scale"><a href="#Scale" class="headerlink" title="Scale"></a>Scale</h2><h3 id="優化-prefix-gt-Top10的構建-with-Probability"><a href="#優化-prefix-gt-Top10的構建-with-Probability" class="headerlink" title="優化 (prefix =&gt; Top10的構建) with Probability　"></a>優化 (prefix =&gt; Top10的構建) with Probability　</h3><p>不是每條過來的query都有機會成為 top10</p>
<p>萬分之一去命中再把計數加一</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueryService</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">should_log</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">return</span> random.randint(<span class="number">0</span>, <span class="number">9999</span>) == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">log_query</span><span class="params">(cls, query)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> cls.should_log():</span><br><span class="line">            database.query_count_plus_one(query)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<p>prefix =&gt; Top10的構建</p>
<h3 id="打擂台太慢，可以改MapReduce"><a href="#打擂台太慢，可以改MapReduce" class="headerlink" title="打擂台太慢，可以改MapReduce"></a>打擂台太慢，可以改MapReduce</h3><h3 id="用戶打字太快怎辦？"><a href="#用戶打字太快怎辦？" class="headerlink" title="用戶打字太快怎辦？"></a>用戶打字太快怎辦？</h3><p>跳過去！前端等待延時後再發請求。QPS一下可降3~5倍</p>
<h3 id="後端-Backend-Cache-優化"><a href="#後端-Backend-Cache-優化" class="headerlink" title="後端 Backend Cache 優化"></a>後端 Backend Cache 優化</h3><p>100M+ QPS的優化：</p>
<ul>
<li>Backend Cache, 每次更新prefix to top10 去主動更新，PUSH 的方法。</li>
<li>不要懶惰加載</li>
</ul>
<h3 id="前端-Frontend-Cache-優化"><a href="#前端-Frontend-Cache-優化" class="headerlink" title="前端 Frontend Cache 優化"></a>前端 Frontend Cache 優化</h3><ul>
<li>用戶可能常敲一敲再回刪</li>
<li>前端本地直接拿肯定更快</li>
<li>可再加設有效期 (小時、天為單位)</li>
</ul>
<h3 id="預加載"><a href="#預加載" class="headerlink" title="預加載"></a>預加載</h3><p>兩層次的預測加載，如ap的時候，就把app的top10也拉出來了 (因為對於ap而言，app比第二名的高)，就也是一種偷跑。</p>
<p>系統內的通信比用戶的前端跟後端的通信</p>
<blockquote>
<p>refetch 之前的 http response 可能是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;prefix&quot;: &quot;ap&quot;,</span><br><span class="line">  &quot;top10&quot;: [</span><br><span class="line">    &quot;app store&quot;,</span><br><span class="line">    &quot;apple&quot;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了 prefetch 以后，http response 可能就是这样的：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">  <span class="attr">"prefix"</span>: <span class="string">"ap"</span>,</span><br><span class="line">  <span class="attr">"top10"</span>: [</span><br><span class="line">    <span class="string">"app store"</span>,</span><br><span class="line">    <span class="string">"apple"</span>,</span><br><span class="line">    <span class="string">"amazon"</span>,</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">"prefix"</span>: <span class="string">"app"</span>,</span><br><span class="line">  <span class="attr">"top10"</span>: [</span><br><span class="line">    <span class="string">"app store"</span>,</span><br><span class="line">    <span class="string">"apple"</span>,</span><br><span class="line">    <span class="string">"apple id"</span>,</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">&#125;, ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="實時熱門的-Top10"><a href="#實時熱門的-Top10" class="headerlink" title="實時熱門的 Top10"></a>實時熱門的 Top10</h2><p>Prefix=&gt;top10要是每天一次的更新，趕不上突發事件。</p>
<p>怎麼把熱門的也加進去？這過程是比較慢的，因為量大</p>
<p>＝＞處理最近兩小時的Query Logs ，數據量小甚至不用map reduce, 直接for就ok</p>
<p>也不打機率打折扣</p>
<p>跟過去一年或更久的作權重分配合併。</p>
<h1 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h1><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge8kucucubj30ke0to40t.jpg" alt="image-20200427200250304" style="zoom:50%;" />

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge8kyowkhij30kg0o40uz.jpg" alt="image-20200427200706721" style="zoom:50%;" /></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/18/System-Design/9p/2019-04-18-MapReuce/">System-Design/9p/2019-04-18-MapReuce</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SystemDesign/">SystemDesign</a></span><div class="content"><h1 id="General"><a href="#General" class="headerlink" title="General"></a>General</h1><h1 id="Map-Reduce"><a href="#Map-Reduce" class="headerlink" title="Map Reduce"></a>Map Reduce</h1><blockquote>
<p>Map<br> • 机器1，2 只负责把文章拆分为一个一个的单词</p>
<p>Reduce<br> • 机器3，4各负责一部分word的合并</p>
</blockquote>
<p>95%是在使用；　5%是在設計Map Reduce</p>
<p>只要大數據就該還是來了解</p>
<h2 id="統計單詞詞頻"><a href="#統計單詞詞頻" class="headerlink" title="統計單詞詞頻"></a>統計單詞詞頻</h2><ol>
<li>for + hash</li>
</ol>
<blockquote>
<h5 id="多选题-使用-For-循环统计单词个数有什么问题？"><a href="#多选题-使用-For-循环统计单词个数有什么问题？" class="headerlink" title="[多选题]使用 For 循环统计单词个数有什么问题？"></a>[多选题]使用 For 循环统计单词个数有什么问题？</h5><p>A.执行速度慢，单台机器要遍历所有单词50.47% 选择</p>
<p>B.耗费空间大，所有单词都要存储在 Hash 里进行计数统计47.48% 选择</p>
<p>C.编程复杂，代码实现难度高2.05% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是AB</p>
<p><strong>正确答案:</strong> AB</p>
</blockquote>
<ol start="2">
<li>多台機器平行統計，該怎麼切？</li>
</ol>
<blockquote>
<h5 id="单选题-按照内容存储顺序拆分统计，然后合并在一起的算法问题在哪儿？"><a href="#单选题-按照内容存储顺序拆分统计，然后合并在一起的算法问题在哪儿？" class="headerlink" title="[单选题]按照内容存储顺序拆分统计，然后合并在一起的算法问题在哪儿？"></a>[单选题]按照内容存储顺序拆分统计，然后合并在一起的算法问题在哪儿？</h5><p>A.无法做到均匀拆分26.18% 选择</p>
<p>B.机器的并行效率不高4.71% 选择</p>
<p>C.合并的时候太慢，会成为瓶颈69.11% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是C</p>
<p><strong>正确答案:</strong> C</p>
</blockquote>
<h3 id="合併的時候是Bottle-Neck"><a href="#合併的時候是Bottle-Neck" class="headerlink" title="合併的時候是Bottle Neck!"></a>合併的時候是Bottle Neck!</h3><p>是不是也可以平行？以什麼為標準來劃分？機器or Key?</p>
<blockquote>
<h5 id="单选题-合并的时候以什么作为划分依据？"><a href="#单选题-合并的时候以什么作为划分依据？" class="headerlink" title="[单选题]合并的时候以什么作为划分依据？"></a>[单选题]合并的时候以什么作为划分依据？</h5><p>A.机器25.45% 选择</p>
<p>B.Key74.55% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong> B</p>
<p><strong>解析:</strong> </p>
<p>以Key作为划分，设计简单，没有层次依赖性</p>
</blockquote>
<p>用機器的話會有層次、依賴性問題而拖慢整體速度。</p>
<h1 id="Map-Reduce-框架流程"><a href="#Map-Reduce-框架流程" class="headerlink" title="Map Reduce 框架流程"></a>Map Reduce 框架流程</h1><p>Map Reduce是一個分布式系統，整個都是由Master來控制的。</p>
<p>map的時候並沒有做合併aggregation的操作。</p>
<blockquote>
<h5 id="单选题-Word-Count-为什么没有在-Map-的时候做聚合（Aggregation）？"><a href="#单选题-Word-Count-为什么没有在-Map-的时候做聚合（Aggregation）？" class="headerlink" title="[单选题]Word Count 为什么没有在 Map 的时候做聚合（Aggregation）？"></a>[单选题]Word Count 为什么没有在 Map 的时候做聚合（Aggregation）？</h5><p>A.因为会使得编程复杂度提高15.39% 选择</p>
<p>B.因为聚合所需时间复杂度较高31.53% 选择</p>
<p>C.因为 Map Reduce 的框架会帮你实现41.83% 选择</p>
<p>D.因为 Map 的机器内存可能不够11.25% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是D</p>
<p><strong>正确答案:</strong> D</p>
</blockquote>
<p>不能在任何一個機器中開這個一樣哈希map。這裡不開的話，那麼整個系統都可以不開的。</p>
<h1 id="MR-的使用"><a href="#MR-的使用" class="headerlink" title="MR 的使用"></a>MR 的使用</h1><blockquote>
<p><strong>[LintCode 编程题]**</strong>[LintCode] Word Count (Map Reduce)**</p>
</blockquote>
<blockquote>
<h5 id="单选题-在-Reduce-函数中，为什么-values-要用-Iterator-而不是简单的用一个数组？"><a href="#单选题-在-Reduce-函数中，为什么-values-要用-Iterator-而不是简单的用一个数组？" class="headerlink" title="[单选题]在 Reduce 函数中，为什么 values 要用 Iterator 而不是简单的用一个数组？"></a>[单选题]在 Reduce 函数中，为什么 values 要用 Iterator 而不是简单的用一个数组？</h5><p>A.因为作者偏好使用 Iterator0.87% 选择</p>
<p>B.因为数组有可能在内存中会放不下，而 Iterator 具体实现的时候可能是从文件里分批次读取84.87% 选择</p>
<p>C.因为 Iterator 的读取效率比较快4.24% 选择</p>
<p>D.因为 Iterator 是一个接口，可以用数组来实现10.01% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong> B</p>
</blockquote>
<h2 id="Word-Count"><a href="#Word-Count" class="headerlink" title="Word Count"></a>Word Count</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WordCount</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param &#123;str&#125; line a text, for example "Bye Bye see you next"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mapper</span><span class="params">(self, _, line)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value'</span></span><br><span class="line">        <span class="keyword">for</span> w <span class="keyword">in</span> line.split():</span><br><span class="line">            <span class="keyword">yield</span> w, <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param key is from mapper</span></span><br><span class="line">    <span class="comment"># @param values is a set of value with the same key</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self, key, values)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value'</span></span><br><span class="line">        <span class="keyword">yield</span> key, sum(values)</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Map</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(String key, String value, OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, int value);</span></span><br><span class="line">            StringTokenizer tokenizer = <span class="keyword">new</span> StringTokenizer(value);</span><br><span class="line">            <span class="keyword">while</span> (tokenizer.hasMoreTokens()) &#123;</span><br><span class="line">                String outputKey = tokenizer.nextToken();</span><br><span class="line">                output.collect(outputKey, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Reduce</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(String key, Iterator&lt;Integer&gt; values,</span></span></span><br><span class="line"><span class="function"><span class="params">                           OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, int value);</span></span><br><span class="line">            <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (values.hasNext()) &#123;</span><br><span class="line">                sum += values.next();</span><br><span class="line">            &#125;</span><br><span class="line">            output.collect(key, sum);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="傳輸整理-shuffle"><a href="#傳輸整理-shuffle" class="headerlink" title="傳輸整理 -  shuffle"></a>傳輸整理 -  shuffle</h1><ul>
<li>Partition sort  +  Fetch&amp;Merge</li>
</ul>
<p>當map完怎麼傳給其他機器做reduce?</p>
<ol>
<li>把結果以為key作分組，master有個一致性哈希去作分組。</li>
<li>對組內部作硬盤上的外排序。以key為第一關鍵字，value為第二關鍵字。</li>
<li>３號會再作k路merge，把這些文件合成一個reduce的輸入</li>
</ol>
<blockquote>
<ul>
<li>请问，这里的K路归并需要使用hashmap吗？如果不用的话是如何实现的？如果用的话不是说内存装不下吗？<ul>
<li>k路归并不需要使用hashmap，可以只用少量的内存完成。方法是：每次选取k路中最小的元素，将其放入存放结果的队列，然后重复执行以上两步。存放结果的队列可以直接在硬盘上</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="Practice-1"><a href="#Practice-1" class="headerlink" title="Practice 1."></a>Practice 1.</h1><p>Inverted Index as Search Engine</p>
<blockquote>
<ul>
<li>一个key占一个reducer吗？还是可以多个key放一个reducer？<ul>
<li>多个key放一个reducer。<br>假设有R个Reducer，map函数产生的key-value pair会被一个hash function(原paper里叫partition function)分成R份，哈希值相同的key会被归到同一个Reducer里，然后Reducer会把这些key-value pair分组，同一个key的value拼在一起之后传给用户编写的reduce函数。</li>
</ul>
</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Definition of Document</span></span><br><span class="line"><span class="string">class Document:</span></span><br><span class="line"><span class="string">    def __init__(self, id, cotent):</span></span><br><span class="line"><span class="string">        self.id = id</span></span><br><span class="line"><span class="string">        self.content = content</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvertedIndex</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param &#123;Document&#125; value is a document</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mapper</span><span class="params">(self, _, value)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="comment"># for word in range(value.content.split()):</span></span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> value.content.split(): </span><br><span class="line">            <span class="keyword">yield</span> word, value.id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param key is from mapper</span></span><br><span class="line">    <span class="comment"># @param values is a set of value with the same key</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self, key, values)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="comment"># res = []</span></span><br><span class="line">        <span class="comment"># # print(type(values))</span></span><br><span class="line">        <span class="comment"># for val in values:</span></span><br><span class="line">        <span class="comment">#     res.append(val)  </span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">yield</span> key, sorted(list(set(values)))</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition of OutputCollector:</span></span><br><span class="line"><span class="comment"> * class OutputCollector&lt;K, V&gt; &#123;</span></span><br><span class="line"><span class="comment"> *     public void collect(K key, V value);</span></span><br><span class="line"><span class="comment"> *         // Adds a key/value pair to the output buffer</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * Definition of Document:</span></span><br><span class="line"><span class="comment"> * class Document &#123;</span></span><br><span class="line"><span class="comment"> *     public int id;</span></span><br><span class="line"><span class="comment"> *     public String content;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvertedIndex</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Map</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(String _, Document value,</span></span></span><br><span class="line"><span class="function"><span class="params">                        OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, int value);</span></span><br><span class="line">            <span class="keyword">int</span> id = value.id;</span><br><span class="line">            StringTokenizer tokenizer = <span class="keyword">new</span> StringTokenizer(value.content);</span><br><span class="line">            <span class="keyword">while</span> (tokenizer.hasMoreTokens()) &#123;</span><br><span class="line">                String word = tokenizer.nextToken();</span><br><span class="line">                output.collect(word, id);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Reduce</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(String key, Iterator&lt;Integer&gt; values,</span></span></span><br><span class="line"><span class="function"><span class="params">                           OutputCollector&lt;String, List&lt;Integer&gt;&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, List&lt;Integer&gt; value);</span></span><br><span class="line">            List&lt;Integer&gt; results = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">            <span class="keyword">int</span> previous = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (values.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">int</span> now = values.next();</span><br><span class="line">                <span class="keyword">if</span>(previous != now) &#123;</span><br><span class="line">                    results.add(now);</span><br><span class="line">                &#125;</span><br><span class="line">                previous = now;</span><br><span class="line">            &#125;</span><br><span class="line">            output.collect(key, results);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Practice-2"><a href="#Practice-2" class="headerlink" title="Practice 2."></a>Practice 2.</h1><p>Anagram grouping</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Anagram</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param &#123;str&#125; line a text, for example "Bye Bye see you next"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mapper</span><span class="params">(self, _, line)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> line.split():</span><br><span class="line">            <span class="comment"># print(word)</span></span><br><span class="line">            <span class="keyword">yield</span> <span class="string">''</span>.join(sorted(word)), word</span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param key is from mapper</span></span><br><span class="line">    <span class="comment"># @param values is a set of value with the same key</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self, key, values)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="comment"># res = []</span></span><br><span class="line">        <span class="keyword">yield</span> key, list(values)</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition of OutputCollector:</span></span><br><span class="line"><span class="comment"> * class OutputCollector&lt;K, V&gt; &#123;</span></span><br><span class="line"><span class="comment"> *     public void collect(K key, V value);</span></span><br><span class="line"><span class="comment"> *         // Adds a key/value pair to the output buffer</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Anagram</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Map</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(String key, String value, OutputCollector&lt;String, String&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, String value);</span></span><br><span class="line">            StringTokenizer tokenizer = <span class="keyword">new</span> StringTokenizer(value);</span><br><span class="line">            <span class="keyword">while</span> (tokenizer.hasMoreTokens()) &#123;</span><br><span class="line">                String word = tokenizer.nextToken();</span><br><span class="line">                String original = word;</span><br><span class="line">                <span class="keyword">char</span>[] chars = original.toCharArray();</span><br><span class="line">                Arrays.sort(chars);</span><br><span class="line">                String sorted = <span class="keyword">new</span> String(chars);</span><br><span class="line">                output.collect(sorted, word);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Reduce</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(String key, Iterator&lt;String&gt; values, OutputCollector&lt;String, List&lt;String&gt;&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, List&lt;String&gt; value);</span></span><br><span class="line">            List&lt;String&gt; results = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">            <span class="keyword">while</span> (values.hasNext()) &#123;</span><br><span class="line">                results.add(values.next());</span><br><span class="line">            &#125;</span><br><span class="line">            output.collect(key, results);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Map’s"><a href="#Map’s" class="headerlink" title="Map’s"></a>Map’s</h3><ul>
<li><p>Key: 經內部字母排序後的單詞 (會一樣)</p>
</li>
<li><p>Value : 未經排序的</p>
</li>
</ul>
<blockquote>
<ul>
<li><p>map结果传输给reducer是不是要通过网络传输？这样的速度够用吗</p>
<ul>
<li>map结果是通过网络传给reducer，map和reducer一般同在一个内网，网速够用</li>
</ul>
</li>
<li><p>mapReduce中master机器不会用于管理所有数据的metadata吗？</p>
<ul>
<li><p>master不负责中间计算结果的相关数据。</p>
</li>
<li><p>再补充几个常见的 QA:</p>
<p>Q: Reduce 之后各个key还是可能会在不同地方，那么怎么再把这些 reducer 的结果 sort 并放在一起呢？<br>A: Reducer 的结果在全局是不 sort 的。因为很多计算场景下计算结果不需要 sort。如果有 sort 的需求，可以使用外排序算法（External Sorting）进行排序即可。</p>
</li>
<li><p>Q: 系统设计中 map reduce 的问题会以什么形式问？<br>A: 90% 的概率会问使用 map reduce 来解决比较重的计算问题。10% 的概率会问 map reduce 的原理是怎么样的。所以好好做今天的编程题作业非常重要！</p>
</li>
<li><p>Q: Reduce 的过程全部都在内存里么？是否会装不下？<br>A: 不是的。Reduce 的过程，key 是在内存里的，value list 通常在代码中是一个 iterator 的形式，也就意味着，有可能是从文件里读进来的。很显然全部放在内存肯定是放不下的，特别是对一些很 hot 的 key。</p>
</li>
<li></li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="Practice-3-K-frequent-words"><a href="#Practice-3-K-frequent-words" class="headerlink" title="Practice 3 K-frequent words"></a>Practice 3 K-frequent words</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Definition of Document</span></span><br><span class="line"><span class="string">class Document:</span></span><br><span class="line"><span class="string">    def __init__(self, id, content):</span></span><br><span class="line"><span class="string">        self.id = id</span></span><br><span class="line"><span class="string">        self.content = content</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">from</span> Mr_tools <span class="keyword">import</span> Document</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopKFrequentWords</span>:</span></span><br><span class="line">    <span class="comment"># @param &#123;Document&#125; value is a document and value have two attributes(id and content)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mapper</span><span class="params">(self, _, value)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="comment"># key is word and value is 1</span></span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> value.content.split():</span><br><span class="line">            <span class="keyword">yield</span> word, <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param key is from mapper</span></span><br><span class="line">    <span class="comment"># @param values is a list of document</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self, key, values)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="comment"># key is word, value is count</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># yield key, reversed(sorted(values))</span></span><br><span class="line">        <span class="keyword">yield</span> key, values   <span class="comment"># 框架天生就已经照 DESC 排好了</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition of OutputCollector:</span></span><br><span class="line"><span class="comment"> * class OutputCollector&lt;K, V&gt; &#123;</span></span><br><span class="line"><span class="comment"> *     public void collect(K key, V value);</span></span><br><span class="line"><span class="comment"> *         // Adds a key/value pair to the output buffer</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * Definition of Document:</span></span><br><span class="line"><span class="comment"> * class Document &#123;</span></span><br><span class="line"><span class="comment"> *     public int id;</span></span><br><span class="line"><span class="comment"> *     public String content;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pair</span> </span>&#123;</span><br><span class="line">    String key;</span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">    </span><br><span class="line">    Pair(String key, <span class="keyword">int</span> value) &#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopKFrequentWords</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Map</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(String _, Document value,</span></span></span><br><span class="line"><span class="function"><span class="params">                        OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, int value);</span></span><br><span class="line">            <span class="keyword">int</span> id = value.id;</span><br><span class="line">            String content = value.content;</span><br><span class="line">            String[] words = content.split(<span class="string">" "</span>);</span><br><span class="line">            <span class="keyword">for</span> (String word : words)</span><br><span class="line">                <span class="keyword">if</span> (word.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    output.collect(word, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Reduce</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> PriorityQueue&lt;Pair&gt; Q = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> k;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Comparator&lt;Pair&gt; pairComparator = <span class="keyword">new</span> Comparator&lt;Pair&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Pair left, Pair right)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (left.value != right.value) &#123;</span><br><span class="line">                    <span class="keyword">return</span> left.value - right.value;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> right.key.compareTo(left.key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// initialize your data structure here</span></span><br><span class="line">            <span class="keyword">this</span>.k = k;</span><br><span class="line">            Q = <span class="keyword">new</span> PriorityQueue&lt;Pair&gt;(k, pairComparator);</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(String key, Iterator&lt;Integer&gt; values)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (values.hasNext()) &#123;</span><br><span class="line">                    sum += values.next();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Pair pair = <span class="keyword">new</span> Pair(key, sum);</span><br><span class="line">            <span class="keyword">if</span> (Q.size() &lt; k) &#123;</span><br><span class="line">                Q.add(pair);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Pair peak = Q.peek();</span><br><span class="line">                <span class="keyword">if</span> (pairComparator.compare(pair, peak) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    Q.poll();</span><br><span class="line">                    Q.add(pair);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">(OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Output the top k pairs &lt;word, times&gt; into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, Integer value);</span></span><br><span class="line">            List&lt;Pair&gt; pairs = <span class="keyword">new</span> ArrayList&lt;Pair&gt;();</span><br><span class="line">            <span class="keyword">while</span> (!Q.isEmpty()) &#123;</span><br><span class="line">                pairs.add(Q.poll());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// reverse result</span></span><br><span class="line">            <span class="keyword">int</span> n = pairs.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = n - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">                Pair pair = pairs.get(i);</span><br><span class="line">                output.collect(pair.key, pair.value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="N-gram"><a href="#N-gram" class="headerlink" title="N-gram"></a>N-gram</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NGram</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; n a integer</span></span><br><span class="line">    <span class="comment"># @param &#123;str&#125; string a string</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mapper</span><span class="params">(self, _, n, string)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="keyword">for</span> start <span class="keyword">in</span> range(len(string)-n+<span class="number">1</span>):</span><br><span class="line">            word = string[start:start+n]</span><br><span class="line">            <span class="keyword">yield</span> word, <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param key is from mapper</span></span><br><span class="line">    <span class="comment"># @param values is a set of value with the same key</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self, key, values)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="keyword">yield</span> key, sum(values)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition of OutputCollector:</span></span><br><span class="line"><span class="comment"> * class OutputCollector&lt;K, V&gt; &#123;</span></span><br><span class="line"><span class="comment"> *     public void collect(K key, V value);</span></span><br><span class="line"><span class="comment"> *         // Adds a key/value pair to the output buffer</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NGram</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Map</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(String _, <span class="keyword">int</span> n, String str,</span></span></span><br><span class="line"><span class="function"><span class="params">                        OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, Integer value);</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; str.length() - n + <span class="number">1</span>; ++index) &#123;</span><br><span class="line">                output.collect(str.substring(index, index + n), <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Reduce</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(String key, Iterator&lt;Integer&gt; values,</span></span></span><br><span class="line"><span class="function"><span class="params">                           OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, int value);</span></span><br><span class="line">            <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (values.hasNext()) &#123;</span><br><span class="line">                    sum += values.next();</span><br><span class="line">            &#125;</span><br><span class="line">            output.collect(key, sum);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h1><img src="/Users/joe/Library/Application Support/typora-user-images/image-20200419212810217.png" alt="image-20200419212810217" style="zoom: 50%;" />

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gdzedcrqyjj30k20tyn18.jpg" alt="image-20200419212855454" style="zoom:50%;" />

<blockquote>
<p>1T 的数据很大，通常很难找到内存超过 1T 的电脑。但是内存超过 1G 的还是很容易的。因此 A 肯定是不对的。如果我们能找到一个算法比较均匀的拆分 1T 的数据到 1024 个 1G 的文件的话，每个文件都可以导入内存中进行排序，最后我们再归并排序后的结果即可。这个拆分排序再归并的算法就是外排序算法。</p>
<ul>
<li>选项 B，按照数据的范围进行拆分，会导致分配不均匀，比如大部分的数据都在一个很小的范围内。而且不是所有的数据都有可数范围，如字符串是很难划定范围的。</li>
<li>选项 C，按照 hash 之后的结果进行拆分，也会导致数据拆分不均匀，因而使得某些部分可能依然无法导入内存。</li>
<li>选项 D，按照实际存储位置进行拆分，这样才能够确保每个部分可以导入内存。</li>
</ul>
</blockquote>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200420002016032.png" alt="image-20200420002016032" style="zoom:50%;" />

<blockquote>
<ul>
<li>Map 的机器如果没有全部执行完，任何一台 Reduce 的机器所负责的数据段都有可能还有更新。因此 Reduce 的部分是不可以开始的。但是机器可以先启动执行一些程序的初始化操作是可以的。</li>
</ul>
</blockquote>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gdzjbais4qj30ju0v0429.jpg" alt="image-20200420001955882" style="zoom:50%;" />

<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200420002035928.png" alt="image-20200420002035928" style="zoom:50%;" /></div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/41/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/41/">41</a><span class="page-number current">42</span><a class="page-number" href="/page/43/">43</a><span class="space">&hellip;</span><a class="page-number" href="/page/52/">52</a><a class="extend next" rel="next" href="/page/43/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Joe Huang</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>