<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Joe Huang"><meta name="copyright" content="Joe Huang"><title>Awaken Desparado</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-180692466-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Joe Huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">363</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">25</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">60</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Awaken Desparado</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Awaken Desparado</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/23/System-Design/9p/2019-04-23-Crawler%20&amp;%20Typeahead%20Design/">System-Design/9p/2019-04-23-Crawler &amp; Typeahead Design</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SystemDesign/">SystemDesign</a></span><div class="content"><h1 id="General"><a href="#General" class="headerlink" title="General"></a>General</h1><ul>
<li><p>打擂台算法 - 就topk</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secondMax</span><span class="params">(self, nums)</span>:</span></span><br><span class="line">	first = <span class="literal">None</span></span><br><span class="line">  second = <span class="literal">None</span></span><br><span class="line">  <span class="keyword">for</span> num <span class="keyword">in</span> nums:</span><br><span class="line">    <span class="keyword">if</span> first <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> first &lt; num:</span><br><span class="line">      second = first</span><br><span class="line">      first = num</span><br><span class="line">    <span class="keyword">elif</span> second <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> second &lt; num:</span><br><span class="line">      second = num</span><br><span class="line">    <span class="keyword">return</span> second</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>DB Engines, kv strorage persistence  – , as Hash on Disk</p>
<ul>
<li>Redis 常駐內存</li>
<li>DynamoDB</li>
<li>MemcacheD – 斷電就沒了</li>
<li>RocksDB</li>
<li>Cassandra - Sharding(row) &amp; Range Query(col)</li>
</ul>
</li>
<li><p>MapReduce</p>
<ul>
<li><p>Word Count</p>
<ul>
<li><p>不是所有都可以進內存</p>
</li>
<li><p>單進程單機性能問題</p>
</li>
<li><p>單詞算哈希然後模機器數，同個單詞一定在同一台機器上。</p>
</li>
<li><pre><code class="python"><span class="class"><span class="keyword">class</span> <span class="title">WordCount</span>:</span>
  <span class="function"><span class="keyword">def</span> <span class="title">mapper</span><span class="params">(self, _, line)</span>:</span>
    <span class="keyword">for</span> word <span class="keyword">in</span> line.split():
      <span class="keyword">yield</span> word, <span class="number">1</span>

  <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self, key, values)</span>:</span>
    <span class="keyword">yield</span> key, sum(values)
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- intersection of 2 arrays, too easy</span><br><span class="line"></span><br><span class="line">  &#96;&#96;&#96;python</span><br><span class="line">  from collections import Counter </span><br><span class="line">  </span><br><span class="line">  class Solution:</span><br><span class="line">      &quot;&quot;&quot;</span><br><span class="line">      @param nums1: an integer array</span><br><span class="line">      @param nums2: an integer array</span><br><span class="line">      @return: an integer array</span><br><span class="line">      &quot;&quot;&quot;</span><br><span class="line">  </span><br><span class="line">      def intersection(self, nums1, nums2):</span><br><span class="line">          s1 &#x3D; Counter(nums1)</span><br><span class="line">          s2 &#x3D; Counter(nums2)</span><br><span class="line">  </span><br><span class="line">          ans &#x3D; []</span><br><span class="line">          for k in s1.keys():</span><br><span class="line">              # n &#x3D; min(s1[k], s2.get(k, 0))</span><br><span class="line">              # for _ in range(n):</span><br><span class="line">              if k in s2.keys():        </span><br><span class="line">                  ans.append(k)</span><br><span class="line">          return ans</span><br></pre></td></tr></table></figure>


</code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>WordBreak</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wordBreak</span><span class="params">(self, s: str, wordDict: List[str])</span> -&gt; bool:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> s:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">          </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> wordDict:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">          </span><br><span class="line">        ws = set(wordDict) <span class="comment"># wordSet</span></span><br><span class="line">        dp = [<span class="literal">False</span>] * len(s)   <span class="comment"># means states</span></span><br><span class="line">        <span class="comment"># abcde</span></span><br><span class="line">        dp[<span class="number">0</span>] = s[<span class="number">0</span>] <span class="keyword">in</span> ws</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, len(dp)):</span><br><span class="line">            <span class="comment"># print(i)</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> s[:i+<span class="number">1</span>] <span class="keyword">in</span> ws:</span><br><span class="line">                dp[i] = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">continue</span> </span><br><span class="line">            <span class="comment"># print(dp)            </span></span><br><span class="line">            start = i</span><br><span class="line">            </span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            dp[1] =     s[1:1+1] in ws and dp[0]    # s[1] in ws and dp[0]  </span></span><br><span class="line"><span class="string">                        or </span></span><br><span class="line"><span class="string">                        s[0:1+1] in ws                     </span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            dp[2] =     s[2:2+1] in ws and dp[1]    ## s[2]</span></span><br><span class="line"><span class="string">                        or </span></span><br><span class="line"><span class="string">                        s[1:2+1] in ws and dp[0] </span></span><br><span class="line"><span class="string">                        or </span></span><br><span class="line"><span class="string">                        s[0:2+1] in ws</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">            <span class="keyword">while</span> start &gt;= <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># if s[start:i+1] in ws and dp[start-1]:</span></span><br><span class="line">                <span class="keyword">if</span> dp[start<span class="number">-1</span>] <span class="keyword">and</span> s[start:i+<span class="number">1</span>] <span class="keyword">in</span> ws:</span><br><span class="line">                    dp[i] = <span class="literal">True</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                start -= <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> dp[<span class="number">-1</span>]</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="Web-Crawler"><a href="#Web-Crawler" class="headerlink" title="Web Crawler"></a>Web Crawler</h1><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge8kxuh73nj30qu0b2jtu.jpg" alt="image-20200427200540662" style="zoom:50%;" />

<blockquote>
<ul>
<li>除了中文分词，英文搜索是不是也要分词？<ul>
<li>英文搜索不用分词。你不会跟人说：hellonicetomeetyou 的。</li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>为了对网页进行分析，解析出链接信息，标题信息等，我们是需要保存整张网页的，而不只是纯文本内容。</li>
<li>搜索引擎的相关技术每一个都是一个深坑，慎入！在系统设计的面试中考得最多的当然还是 Web Crawler。另外关于倒排索引（Inverted Index）和 分词（Word Segmentation）的技术最好也是要知道的。</li>
</ul>
</blockquote>
<h2 id="Inverted-Index"><a href="#Inverted-Index" class="headerlink" title="Inverted Index"></a>Inverted Index</h2><ul>
<li>從 word 指向 doc id list 的索引 (index)</li>
<li>反過來就是 forward index (doc id -&gt; list of words)</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge8l2imdk0j30z80b8gwi.jpg" alt="image-20200427201034185" style="zoom:67%;" />

<blockquote>
<ul>
<li>当用户搜索 Hello World 的时候，搜索引擎会去倒排索引中检索 Hello 和 World 共同出现的文档有哪些，并且求出交集。</li>
</ul>
</blockquote>
<h2 id="Chinese-Word-Segmentation"><a href="#Chinese-Word-Segmentation" class="headerlink" title="Chinese Word Segmentation"></a>Chinese Word Segmentation</h2><p>中文分詞字字間沒有區分 e.g.化妝和服妝</p>
<ul>
<li>Viterbi Algorithm</li>
<li>Word-break</li>
<li>早期 G廠在中國沒做所以有一陣子時被B超過</li>
</ul>
<h1 id="Design-Crawler"><a href="#Design-Crawler" class="headerlink" title="Design Crawler"></a>Design Crawler</h1><h2 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h2><ul>
<li><p>全抓下並建 inverted index</p>
</li>
<li><p>網頁間存在指向的anchor關係</p>
</li>
<li><p>節點 &amp; 有向邊</p>
</li>
<li><p>Google 立身之本- ”page rank” 看各網頁被引用的高低</p>
<ul>
<li>被更多其他網頁指向的網頁，具有更高的價值</li>
</ul>
</li>
</ul>
<h3 id="開始爬的網頁"><a href="#開始爬的網頁" class="headerlink" title="開始爬的網頁"></a>開始爬的網頁</h3><ul>
<li>as seed urls</li>
<li>新聞網站作起點很好、Alexa(Amazon下的做的看流量排名)也可以</li>
</ul>
<h3 id="Producer-Consumer"><a href="#Producer-Consumer" class="headerlink" title="Producer/Consumer"></a>Producer/Consumer</h3><ul>
<li>BFS爬，在有向圖上爬</li>
</ul>
<blockquote>
<h5 id="单选题-Web-Crawler-一般可以使用哪种算法？"><a href="#单选题-Web-Crawler-一般可以使用哪种算法？" class="headerlink" title="[单选题]Web Crawler 一般可以使用哪种算法？"></a>[单选题]Web Crawler 一般可以使用哪种算法？</h5><p>A.深度优先搜索 DFS20.53% 选择</p>
<p>B.宽度优先搜索 BFS79.47% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p>互联网上的网页所构成的图巨大无比，如果使用 DFS 的话，深度太深也不易加入并行化的处理。使用 BFS 比较直观和方便。</p>
</blockquote>
<ul>
<li>DFS會讓我在抓時一個網站都還沒抓多少就跳走了。</li>
<li>解析快；抓慢</li>
</ul>
<h3 id="多進程抓"><a href="#多進程抓" class="headerlink" title="多進程抓"></a>多進程抓</h3><blockquote>
<h5 id="单选题-单进程-single-process-模型的爬虫的瓶颈是什么？"><a href="#单选题-单进程-single-process-模型的爬虫的瓶颈是什么？" class="headerlink" title="[单选题]单进程(single process)模型的爬虫的瓶颈是什么？"></a>[单选题]单进程(single process)模型的爬虫的瓶颈是什么？</h5><p>A.解析网页的速度太慢18.17% 选择</p>
<p>B.网络请求慢，单进程大部分时候处于闲置(idle)状态81.83% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
</blockquote>
<blockquote>
<h5 id="单选题-开-2000-个进程是否可以做到每秒钟下载-1000-个网页？"><a href="#单选题-开-2000-个进程是否可以做到每秒钟下载-1000-个网页？" class="headerlink" title="[单选题]开 2000 个进程是否可以做到每秒钟下载 1000 个网页？"></a>[单选题]开 2000 个进程是否可以做到每秒钟下载 1000 个网页？</h5><p>A.可以10.21% 选择</p>
<p>B.不可以89.79% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
<p><strong>解析:</strong></p>
<p>下载效率还受限于 CPU 个数和带宽。2000 个进程会导致大量的进程上下文切换（Context Switch），从而导致代码运行效率下降。</p>
</blockquote>
<p>所以10個核的話啟100個process</p>
<blockquote>
<ul>
<li>nonblocking IO呢？<ul>
<li>non-blocking IO可以在一定程度上解决这个问题，不过单机的并发数始终还是有瓶颈的，当并发的IO数目达到一定数量时还是需要向distributed的方案转变。</li>
</ul>
</li>
<li>请问多process和threading的区别是？<ul>
<li>多process不共享同一片内存，多 thread 共享同一片内存。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h2><h3 id="網頁存儲"><a href="#網頁存儲" class="headerlink" title="網頁存儲"></a>網頁存儲</h3><blockquote>
<h5 id="单选题-爬虫抓取下来的网页存在哪儿？"><a href="#单选题-爬虫抓取下来的网页存在哪儿？" class="headerlink" title="[单选题]爬虫抓取下来的网页存在哪儿？"></a>[单选题]爬虫抓取下来的网页存在哪儿？</h5><p>A.爬虫这台机器上8.22% 选择</p>
<p>B.分布式文件系统中（Distributed File System）91.78% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
</blockquote>
<p>這個文件系統還需要給indexer作inverted index，所以不放給爬蟲，</p>
<p>這樣一人作兩角會破壞爬蟲自己的是stateless的思想。</p>
<p>爬蟲要不怕掛，就重啟，跟數據庫不一樣；愈多stateless的系統愈穩定。</p>
<blockquote>
<h5 id="多选题-下列哪些东西是-Stateless-的？"><a href="#多选题-下列哪些东西是-Stateless-的？" class="headerlink" title="[多选题]下列哪些东西是 Stateless 的？"></a>[多选题]下列哪些东西是 Stateless 的？</h5><p>A.Web Server34.37% 选择</p>
<p>B.NoSQL Database9.55% 选择</p>
<p>C.SQL Database5.26% 选择</p>
<p>D.Memcached18.27% 选择</p>
<p>E.Async task worker (message queue consumer)32.55% 选择</p>
<p><strong>正确答案:</strong>AE</p>
<p><strong>解析:</strong></p>
<p>任何存储数据的服务器都是 stateful 的。只执行代码不存储数据的一般是 stateless 的如 Web Server, Async task worker</p>
</blockquote>
<h3 id="BFS中的Queue以及HashSet怎麼存的？"><a href="#BFS中的Queue以及HashSet怎麼存的？" class="headerlink" title="BFS中的Queue以及HashSet怎麼存的？"></a>BFS中的Queue以及HashSet怎麼存的？</h3><h4 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h4><ul>
<li><p>linkedlist in java</p>
</li>
<li><p>hash for visited</p>
</li>
</ul>
<blockquote>
<h5 id="单选题-BFS算法中使用到的-Queue-存在什么地方？"><a href="#单选题-BFS算法中使用到的-Queue-存在什么地方？" class="headerlink" title="[单选题]BFS算法中使用到的 Queue 存在什么地方？"></a>[单选题]BFS算法中使用到的 Queue 存在什么地方？</h5><p>A.在内存里直接开一个 Queue5.85% 选择</p>
<p>B.使用消息队列（Message Queue）74.03% 选择</p>
<p>C.使用 Memcached20.12% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong>B</p>
</blockquote>
<p>放內存就要擔心斷電的問題。</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h4><blockquote>
<h5 id="单选题-BFS-中的-HashSet-在系统设计中适合使用什么来存储？"><a href="#单选题-BFS-中的-HashSet-在系统设计中适合使用什么来存储？" class="headerlink" title="[单选题]BFS 中的 HashSet 在系统设计中适合使用什么来存储？"></a>[单选题]BFS 中的 HashSet 在系统设计中适合使用什么来存储？</h5><p>A.内存中开一个哈希表3.14% 选择</p>
<p>B.Memcached21.68% 选择</p>
<p>C.SQL Database4.26% 选择</p>
<p>D.NoSQL Database (Key-value Storage)70.92% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是D</p>
<p><strong>正确答案:</strong>D</p>
</blockquote>
<blockquote>
<ul>
<li>message queue是不是stateful的？<ul>
<li>是的</li>
</ul>
</li>
<li>为啥这里不用sql数据库存hashset，如果是多线程并发，要先查set中是否已经存在，然后不存在的话，写入，这是一个事务操作<ul>
<li>从这业务分析，我们可以知道是对每一个domain（域名）中的所有url进行耙取的，而url与其domain的关系1：n的关系，所以，我们在选择NoSQL的数据中，其存储结构是key-value的简单关系结构(key是domain-name，value是List[url])，而且NoSQL系统，其所对应的是Map的结构，而不是Set的结构。如果是多线程。我们要有一个类似信号量的控制访问数据库的锁（如Java.util.concurrent.ReentryLock的使用），即可，不需要事务，事务花销更大，而且大多数NoSQL不支持事务。</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="可行解"><a href="#可行解" class="headerlink" title="可行解"></a>可行解</h2><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge9sne1pgkj30wy0h2wng.jpg" alt="image-20200428211834537" style="zoom:67%;" />

<ul>
<li>注意第７行不是用recursive的，而是讓它去排隊，避免stack overflow</li>
</ul>
<h3 id="Robot-協解"><a href="#Robot-協解" class="headerlink" title="Robot 協解"></a>Robot 協解</h3><p>爬蟲協議。</p>
<blockquote>
<ul>
<li>请问robot协议算是CORS的一种吗<ul>
<li>robot协议是针对爬虫的，告知爬虫对本网站数据的爬取规则。<br>CORS(Cross-Origin Resource Sharing)跨域资源共享是访问跨域资源时，浏览器与服务器应该如何沟通。是为了解决浏览器的<a href="https://en.wikipedia.org/wiki/Same-origin_policy" target="_blank" rel="noopener">同源禁止访问策略</a>。<br>CORS背后的基本思想就是使用自定义的HTTP头部让浏览器与服务器进行沟通，从而决定请求或响应是应该成功还是失败。</li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<p>这是知乎的 robots 协议：<a href="https://www.zhihu.com/robots.txt" target="_blank" rel="noopener">https://www.zhihu.com/robots.txt</a><br>更多的关于 robots 协议的规则感兴趣的话可以看看 <a href="https://baike.baidu.com/item/robots/5243374?fr=aladdin" target="_blank" rel="noopener">https://baike.baidu.com/item/robots/5243374?fr=aladdin</a></p>
</blockquote>
<h3 id="限制爬蟲的頻率"><a href="#限制爬蟲的頻率" class="headerlink" title="限制爬蟲的頻率"></a>限制爬蟲的頻率</h3><p>Queue 裡可能對同一個站同時抓太多次。</p>
<p><strong><em>让 Crawler 只做 Consumer，不负责产生新的抓取任务 新增一个 Scheduler (Producer) 负责调度和生产抓取任务 在 Database 中记录每个网站下一次可以友好抓取的时间</em></strong></p>
<blockquote>
<ul>
<li>实际应用中是不是爬虫都有这个scheduler，并不是consumer和producer都爬虫自己做<ul>
<li>是的，一般实用的爬虫框架都会有单独的scheduler，如果对实际的爬虫框架感兴趣的话可以看一下这两个开源的python爬虫框架：pyspider, scrapy</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="更可靠的解"><a href="#更可靠的解" class="headerlink" title="更可靠的解"></a>更可靠的解</h2><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge9v4lect4j310e0gytgt.jpg" alt="image-20200428221447375" style="zoom:67%;" />



<h3 id="表單內容和偽代碼"><a href="#表單內容和偽代碼" class="headerlink" title="表單內容和偽代碼"></a>表單內容和偽代碼</h3><blockquote>
<ul>
<li>课程里说这个UrlInf value里的status代表有没有抓过，有什么用吗？感觉结合后面反复抓取的情况，可能存的是抓取是不是成功的信息，这样可以计算下次抓取的时间（backoff)。不知这样理解对不对？<ul>
<li>一般数据库里我们 status 是最常用的一个 field，用来表示一个事情的进展。 URL 在抓取的过程中，有很多的中间状态的 status，比如抓取成功，抓取失败，正在抓取，还没有抓取过。没有被抓取过的意义是，你可以知道现在有多少网页正在抓取，多少发现了还没抓取，多少已经抓下来了，多少可能是坏链接。这对于监控爬虫的正常工作情况有重大意义。</li>
</ul>
</li>
<li>为什么候选的UrlList要单独放张表，不可以作为DomainInfo的value 的一个Field吗？<ul>
<li>你可以尝试使用一下 MySQL 之类的数据库，你会发现并不能找到一个 List 类型的 field。原因是 List 类型作为普通 MysQL 数据库的的 Field 的话，插入和删除都是 O(N) 的。因此为了更好的支持这种 key to list 的增删查改，要么在 SQL 数据库里用一个张单独的表单，以二元组的形式存储，如 <code>&lt;domain1, url1&gt;</code> <code>&lt;domain1, url2&gt;</code>，要么放在 redis 这种 value 支持 list 的数据库里。总之无论如何，都无法直接和 DomainInfo 放在一起，且数据的含义上，UrlList 也不属于一个 Domain 的 info。info 一般指一些 metadata 之类的信息。</li>
</ul>
</li>
</ul>
</blockquote>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge9v4yins0j30uo0kgnbr.jpg" alt="image-20200428224429124" style="zoom:67%;" />



<h3 id="分地區的爬蟲"><a href="#分地區的爬蟲" class="headerlink" title="分地區的爬蟲"></a>分地區的爬蟲</h3><h3 id="處理更新抓取與失效"><a href="#處理更新抓取與失效" class="headerlink" title="處理更新抓取與失效"></a>處理更新抓取與失效</h3><p>BFS裡會有HashSet看抓過沒。但會有更新，怎辦？</p>
<p>可 <strong>Exponential Backoff</strong>去試，搭配邊界。</p>
<blockquote>
<ul>
<li>怎么处理不存在的老的链接呢？<ul>
<li>总是抓取失败的话，就在 UrlInfo 里标记抓取失败，且下次要抓取的时间通过 Exponential Backoff 会慢慢变得很长，比如30天抓一次这种。</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li>可md5 16字節看是否一樣，放在url表單裡。</li>
</ul>
<blockquote>
<ul>
<li>如果一个网页变化了，有URL链接的变化怎么处理？是不是把原来存的DomainInfo和UrlInfo都更新（删掉老的数据）？<ul>
<li>比如 <a href="http://www.jiuzhang.com" target="_blank" rel="noopener">www.jiuzhang.com</a> 对应的网页变化了，只需要更新这个 URL 下的网页内容。DomainInfo 和 URLInfo 做一些相应的更新，比如 webpage md5之类的。这个跟这个网页里的 Url 链接是否发生变化没有什么关系。网页里如果发现了新的 URL 就再加到数据库和待抓取列表里即可。</li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<p>指数补偿(Exponential Backoff)指的是，在执行事件时，通过反馈，逐渐降低某个过程的速率，从而最终找到一个合适的速率（来处理事件）。</p>
<p>指数补偿通常用于网络和传输协议，比如在进行网络连接时，如果第一次请求失败，那么可以等待 <em>t1</em> 秒之后重试，如果再次请求还是失败，那么等待 <em>t2</em> 秒之后重试。重试可以一直继续下去，直到等待次数或等待时间超过特定值为止。</p>
<p>等待的时间 <em>ti</em> 是可以自由指定的，常用 1, 2, 4, 8 这样的指数序列，因此叫指数补偿。</p>
<p>类似的用到了指数补偿思想的场景还有动态数组（C++ 里的vector，Java 里的 ArrayList，Python 里的 list），动态数组之所以支持你不断的往里加入新元素，就是因为当一个数组满了以后，会再创建一个新的两倍元原来大小的数组来替换掉旧数组。</p>
</blockquote>
<blockquote>
<p>这个文章的作者用 20 台 AWS 的机器在 40 小时内抓取了 2.5亿篇网页，只花了 580$。</p>
<p><a href="http://www.michaelnielsen.org/ddi/how-to-crawl-a-quarter-billion-webpages-in-40-hours/" target="_blank" rel="noopener">http://www.michaelnielsen.org/ddi/how-to-crawl-a-quarter-billion-webpages-in-40-hours/</a></p>
<p>这篇文章中很多的内容是值得参考的比如如何拆分爬取任务的部分，作者的目的是单纯的抓取网页，和我们今天所设计的爬虫相比自然是我们课上讲的架构会更加适合一个真正的爬虫系统。</p>
</blockquote>
<h1 id="Design-TypeAhead-v-s-Google-Suggestion"><a href="#Design-TypeAhead-v-s-Google-Suggestion" class="headerlink" title="Design TypeAhead v.s. Google Suggestion"></a>Design TypeAhead v.s. Google Suggestion</h1><p>兩種不同類型的</p>
<ol>
<li>Typeahead.js </li>
<li>Google Suggestion</li>
</ol>
<ul>
<li>Trie - Re<strong>trie</strong>val</li>
</ul>
<h3 id="Front-End"><a href="#Front-End" class="headerlink" title="Front End"></a>Front End</h3><h3 id="Back-End"><a href="#Back-End" class="headerlink" title="Back End"></a>Back End</h3><ul>
<li>QPS issue</li>
</ul>
<h2 id="Scenario-1"><a href="#Scenario-1" class="headerlink" title="Scenario"></a>Scenario</h2><ul>
<li><p>返回被其他人蒐得多的 Top10 queries</p>
</li>
<li><p>個性化算法的架構</p>
</li>
<li><p>推算QPS ==&gt; 要練心算速推</p>
</li>
</ul>
<blockquote>
<h5 id="单选题-Google-Suggestion-API-主要是读还是写？"><a href="#单选题-Google-Suggestion-API-主要是读还是写？" class="headerlink" title="[单选题]Google Suggestion API 主要是读还是写？"></a>[单选题]Google Suggestion API 主要是读还是写？</h5><p>A.读96.80% 选择</p>
<p>B.写3.20% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是A</p>
</blockquote>
<ul>
<li>當讀多寫少時，就是用Cache進行優化</li>
</ul>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>提供Top10Query 查詢</p>
<ul>
<li>QueryService</li>
<li>CollectionService (敲了Enter後)</li>
</ul>
<blockquote>
<h5 id="多选题-为什么我们不让-QueryService-直接请求-CollectionService-获得结果？"><a href="#多选题-为什么我们不让-QueryService-直接请求-CollectionService-获得结果？" class="headerlink" title="[多选题]为什么我们不让 QueryService 直接请求 CollectionService 获得结果？"></a>[多选题]为什么我们不让 QueryService 直接请求 CollectionService 获得结果？</h5><p>A.因为用户很难感知数据是否是最实时的，有一点延迟没有关系36.79% 选择</p>
<p>B.因为 QueryService 请求 CollectionService 实时计算的话，会比较慢43.16% 选择</p>
<p>C.QueryService 请求 CollectionService 的服务器间通信比较慢20.05% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是AB</p>
<p><strong>正确答案:</strong>AB</p>
<p><strong>解析:</strong></p>
<p>服务器间通信是很快的。慢的是计算。</p>
</blockquote>
<blockquote>
<ul>
<li>这里CollectionService提供给QueryService信息是用的push模式吗？<ul>
<li>Yes</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="Storage-1"><a href="#Storage-1" class="headerlink" title="Storage"></a>Storage</h2><h3 id="for-Query-Service"><a href="#for-Query-Service" class="headerlink" title="for Query Service"></a>for Query Service</h3><blockquote>
<h5 id="单选题-是否有支持-Trie-的数据库？"><a href="#单选题-是否有支持-Trie-的数据库？" class="headerlink" title="[单选题]是否有支持 Trie 的数据库？"></a>[单选题]是否有支持 Trie 的数据库？</h5><p>A.没有63.90% 选择</p>
<p>B.有36.10% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是A</p>
<p><strong>正确答案:</strong>A</p>
</blockquote>
<ul>
<li><p>沒有現成的數據庫，也不大可能自己去寫一套。</p>
<p>替代品就是kv storage，如RocksDB, Redis</p>
<p>kv在空間大一些，但就是系數上的大而已</p>
</li>
</ul>
<p>當Collection Service拿到 apple, </p>
<p>就要新增 a, ap, app … 等的 key，讓他們都append 一次apple，然後打擂台映射到top10的list </p>
<blockquote>
<ul>
<li>Trie的工程上应用意思是什么呢？实际工作中用吗？<ul>
<li>Trie在工程上用得很多，Trie的优势是O(字符串长度)的查找时间和良好的空间性能，相同的前缀只会存一份，因此适合在需要对大量字符串进行存储和查询（尤其是前缀查询）的场景。实际工作中有很多使用Trie及其变形的例子，像这里讲的search suggestion，还有IDE的auto complete, 浏览器的url历史补全，编辑器的spell checkers都可能会用到trie.</li>
</ul>
</li>
<li>”如果某个prefix已经存在了被搜索次数更多的其他10个 queries，就无需再加入了“。两个问题，1）怎么知道是被搜索次数更多的？加入的条件不是一样的吗，比如这里的1b 2) 更新一下是不是更好，因为是更新的结果。<ul>
<li>query 的搜索次数是会被 collection service 记录下来的。比较的时候是带着次数一起比较的。prefix -&gt; top 10 的记录格式是 <code>[{&quot;ap&quot;: {&quot;query&quot;: &quot;app&quot;, &quot;count&quot;: 100}...}]</code></li>
<li>更新 Top 10。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="for-Collection-Service"><a href="#for-Collection-Service" class="headerlink" title="for Collection Service"></a>for Collection Service</h3><p>蒐集每個Query 被蒐的次數</p>
<h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, is_end=False)</span>:</span></span><br><span class="line">        <span class="comment"># self.val = val</span></span><br><span class="line">        <span class="comment"># self.next = None</span></span><br><span class="line">        self.children = &#123;&#125;</span><br><span class="line">        self.is_end = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Trie</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># do intialization if necessary</span></span><br><span class="line">        <span class="comment"># self.children = &#123;&#125;</span></span><br><span class="line">        self.head = Node(<span class="string">'$'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: word: a word</span></span><br><span class="line"><span class="string">    @return: nothing</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, word)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        node = self.head</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> word:</span><br><span class="line">            <span class="comment"># print(ch)</span></span><br><span class="line">            <span class="keyword">if</span> ch <span class="keyword">not</span> <span class="keyword">in</span> node.children:</span><br><span class="line">                node.children[ch] = Node()</span><br><span class="line">            node = node.children[ch]</span><br><span class="line">        node.is_end = <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: word: A string</span></span><br><span class="line"><span class="string">    @return: if the word is in the trie.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(self, word)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        node = self.head</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> word:</span><br><span class="line">            <span class="comment"># if ch not in self.children:</span></span><br><span class="line">            <span class="keyword">if</span> ch <span class="keyword">not</span> <span class="keyword">in</span> node.children:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            node = node.children[ch]</span><br><span class="line">        <span class="keyword">return</span> node.is_end</span><br><span class="line">        </span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param: prefix: A string</span></span><br><span class="line"><span class="string">    @return: if there is any word in the trie that starts with the given prefix.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">startsWith</span><span class="params">(self, prefix)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        node = self.head</span><br><span class="line">        <span class="comment"># print(self.children)</span></span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> prefix:</span><br><span class="line">            <span class="keyword">if</span> ch <span class="keyword">not</span> <span class="keyword">in</span> node.children:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            node = node.children[ch]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>



<h2 id="Scale"><a href="#Scale" class="headerlink" title="Scale"></a>Scale</h2><h3 id="優化-prefix-gt-Top10的構建-with-Probability"><a href="#優化-prefix-gt-Top10的構建-with-Probability" class="headerlink" title="優化 (prefix =&gt; Top10的構建) with Probability　"></a>優化 (prefix =&gt; Top10的構建) with Probability　</h3><p>不是每條過來的query都有機會成為 top10</p>
<p>萬分之一去命中再把計數加一</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueryService</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">should_log</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">return</span> random.randint(<span class="number">0</span>, <span class="number">9999</span>) == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">log_query</span><span class="params">(cls, query)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> cls.should_log():</span><br><span class="line">            database.query_count_plus_one(query)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<p>prefix =&gt; Top10的構建</p>
<h3 id="打擂台太慢，可以改MapReduce"><a href="#打擂台太慢，可以改MapReduce" class="headerlink" title="打擂台太慢，可以改MapReduce"></a>打擂台太慢，可以改MapReduce</h3><h3 id="用戶打字太快怎辦？"><a href="#用戶打字太快怎辦？" class="headerlink" title="用戶打字太快怎辦？"></a>用戶打字太快怎辦？</h3><p>跳過去！前端等待延時後再發請求。QPS一下可降3~5倍</p>
<h3 id="後端-Backend-Cache-優化"><a href="#後端-Backend-Cache-優化" class="headerlink" title="後端 Backend Cache 優化"></a>後端 Backend Cache 優化</h3><p>100M+ QPS的優化：</p>
<ul>
<li>Backend Cache, 每次更新prefix to top10 去主動更新，PUSH 的方法。</li>
<li>不要懶惰加載</li>
</ul>
<h3 id="前端-Frontend-Cache-優化"><a href="#前端-Frontend-Cache-優化" class="headerlink" title="前端 Frontend Cache 優化"></a>前端 Frontend Cache 優化</h3><ul>
<li>用戶可能常敲一敲再回刪</li>
<li>前端本地直接拿肯定更快</li>
<li>可再加設有效期 (小時、天為單位)</li>
</ul>
<h3 id="預加載"><a href="#預加載" class="headerlink" title="預加載"></a>預加載</h3><p>兩層次的預測加載，如ap的時候，就把app的top10也拉出來了 (因為對於ap而言，app比第二名的高)，就也是一種偷跑。</p>
<p>系統內的通信比用戶的前端跟後端的通信</p>
<blockquote>
<p>refetch 之前的 http response 可能是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;prefix&quot;: &quot;ap&quot;,</span><br><span class="line">  &quot;top10&quot;: [</span><br><span class="line">    &quot;app store&quot;,</span><br><span class="line">    &quot;apple&quot;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了 prefetch 以后，http response 可能就是这样的：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">  <span class="attr">"prefix"</span>: <span class="string">"ap"</span>,</span><br><span class="line">  <span class="attr">"top10"</span>: [</span><br><span class="line">    <span class="string">"app store"</span>,</span><br><span class="line">    <span class="string">"apple"</span>,</span><br><span class="line">    <span class="string">"amazon"</span>,</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">"prefix"</span>: <span class="string">"app"</span>,</span><br><span class="line">  <span class="attr">"top10"</span>: [</span><br><span class="line">    <span class="string">"app store"</span>,</span><br><span class="line">    <span class="string">"apple"</span>,</span><br><span class="line">    <span class="string">"apple id"</span>,</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">&#125;, ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="實時熱門的-Top10"><a href="#實時熱門的-Top10" class="headerlink" title="實時熱門的 Top10"></a>實時熱門的 Top10</h2><p>Prefix=&gt;top10要是每天一次的更新，趕不上突發事件。</p>
<p>怎麼把熱門的也加進去？這過程是比較慢的，因為量大</p>
<p>＝＞處理最近兩小時的Query Logs ，數據量小甚至不用map reduce, 直接for就ok</p>
<p>也不打機率打折扣</p>
<p>跟過去一年或更久的作權重分配合併。</p>
<h1 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h1><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge8kucucubj30ke0to40t.jpg" alt="image-20200427200250304" style="zoom:50%;" />

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge8kyowkhij30kg0o40uz.jpg" alt="image-20200427200706721" style="zoom:50%;" /></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/22/LC/0_note/">LC/0_note</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-22</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/Languages/">Languages</a></span><div class="content"><h4 id="Hard-to-solve"><a href="#Hard-to-solve" class="headerlink" title="Hard, to solve:"></a>Hard, to solve:</h4><pre><code>- 301.remove-invalidparantheses TLE for enumeration w/ backtracking, 
- 140.word-break-ii a)MLE w/ case &quot;a&quot;*n &amp; b)Trie method (Trie not faster for single query, but for multi query in 472.)
- SegmentTree
- BinaryIndexedTree
- Letter Combinatino of A Phone Number</code></pre><table>
<thead>
<tr>
<th></th>
<th>Python3</th>
<th>Cpp</th>
<th>JS</th>
<th>Java</th>
</tr>
</thead>
<tbody><tr>
<td><strong>dict</strong></td>
<td></td>
<td>include <unordered_map>, //Similar to defaultdict() in python3</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>d = {}</td>
<td>unordered_map&lt;Node*&gt; d;</td>
<td>d = {}; new Map();</td>
<td>Map&lt;Node, Node&gt; visited = new HashMap();</td>
</tr>
<tr>
<td></td>
<td>d[k] = v;</td>
<td>d[k] = v;</td>
<td>d[k]=v; map.<strong>set</strong>(0,1)</td>
<td>visited.<strong>put</strong>(k, v)</td>
</tr>
<tr>
<td></td>
<td>d[k]; d.get(k,0)</td>
<td>d[k];</td>
<td>d[k]; map.get(k)</td>
<td>visited.get(cur_O)</td>
</tr>
<tr>
<td></td>
<td>k not in d</td>
<td>(d.find(k)==d.end())</td>
<td>!(nbr_O.val in visited)</td>
<td>!visited.containsKey(nbr_O)</td>
</tr>
<tr>
<td></td>
<td>k in d</td>
<td>(d.find(k)!=d.end())</td>
<td>nbr_O.val in visited; (map.<strong>has</strong>(sum-k))</td>
<td>visited.<strong>containsKey</strong>(nbr_O)</td>
</tr>
<tr>
<td></td>
<td>del d[k]</td>
<td>d.<strong>erase</strong>(key)</td>
<td>this.d.<strong>delete</strong>(key);</td>
<td>this.d.<strong>remove</strong>(key);</td>
</tr>
<tr>
<td></td>
<td>len(d)</td>
<td>size()</td>
<td>d.<strong>size</strong></td>
<td>d.size()</td>
</tr>
<tr>
<td></td>
<td></td>
<td>d.empty()  //true; false</td>
<td></td>
<td></td>
</tr>
<tr>
<td>NotOK</td>
<td></td>
<td></td>
<td>{k:v} in Initialization</td>
<td></td>
</tr>
<tr>
<td>Special APIs</td>
<td></td>
<td>reserve(capacity)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Iterate</td>
<td>for k in d.keys():</td>
<td>for (auto k: d)</td>
<td>for (var key in dict){}</td>
<td>for(char c:  ransomNote.toCharArray()) {</td>
</tr>
<tr>
<td><strong>Ordered_dict</strong></td>
<td>self.od.popitem(last=False)<br /><a href="https://www.pythonf.cn/read/89970" target="_blank" rel="noopener">https://www.pythonf.cn/read/89970</a><br /><a href="https://gist.github.com/joequery/12332f410a05e6c7c949" target="_blank" rel="noopener">https://gist.github.com/joequery/12332f410a05e6c7c949</a></td>
<td></td>
<td>d = new Map(); APIs↑↑ //ref: <a href="https://stackoverflow.com/questions/2798893/ordered-hash-in-javascript" target="_blank" rel="noopener">https://stackoverflow.com/questions/2798893/ordered-hash-in-javascript</a></td>
<td>LinkedHashMap&lt;Integer, Integer&gt; d;<br />this.d = new LinkedHashMap&lt;&gt;();</td>
</tr>
<tr>
<td></td>
<td>first = next(iter(self.od))</td>
<td></td>
<td></td>
<td>Integer first = this.d.keySet().iterator().next();</td>
</tr>
<tr>
<td><strong>queue</strong></td>
<td>from collections import deque</td>
<td>include  <deque></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>deque();</td>
<td>deque&lt;Node*&gt;</td>
<td>let Q = [];</td>
<td>Queue<Node> Q = new LinkedList(); //LinkedList<Node> Q = new LinkedList<Node>(); //雙向</td>
</tr>
<tr>
<td></td>
<td>Q.append(cur); v=Q.popleft()</td>
<td>Q.push_back(cur); v=Q.front(),Q.pop_front()</td>
<td>Q.push(cur); v=Q.shift(); // O(n)</td>
<td>Q.add(nbr_O);//Q.push(nbr_O); Q.poll();</td>
</tr>
<tr>
<td></td>
<td>while d</td>
<td>while (!Q.empty())</td>
<td>while (Q.length != 0)</td>
<td>while (!Q.isEmpty())</td>
</tr>
<tr>
<td><strong>deque</strong></td>
<td></td>
<td></td>
<td></td>
<td>ArrayDeque雙向實現了DEque的interface</td>
</tr>
<tr>
<td><strong>vector</strong></td>
<td></td>
<td>include <vector></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>self.res = []</td>
<td>vector&lt;vector<int>&gt; result;</td>
<td>res = [];</td>
<td>List&lt;List<Integer>&gt; res = new ArrayList&lt;List<Integer>&gt;();</td>
</tr>
<tr>
<td></td>
<td>item.append(nums[idx])</td>
<td>item.push_back(nums[idx]);</td>
<td>item.push(nums[idx]);</td>
<td>item.add(nums[idx]);</td>
</tr>
<tr>
<td></td>
<td>item.pop()</td>
<td>item.pop_back();</td>
<td>item.pop();</td>
<td>item.remove(item.size()-1);</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>l.length; // 注意！跟dict不同，這邊是 length</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>for</td>
<td>for (<strong><em>let</em></strong> i=0; i&lt;l.length; i++)</td>
<td></td>
</tr>
<tr>
<td></td>
<td>l = [False] * 3</td>
<td>vector<bool> dp(3, false);</td>
<td>const dp = new Array(3).fill(false);</td>
<td>List<Boolean> dp = new ArrayList(Collections.nCopies(s.length(), false));</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td>int[] nums;, nums.length</td>
</tr>
<tr>
<td><strong>Doublely LinkedList</strong></td>
<td></td>
<td><strong>std::list</strong><br /><strong>List</strong> stores elements at non contiguous memory location i.e. it internally uses a doubly linked list i.e.</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>back(); front();</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>pop_back(); pop_front();</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>db_ll.erase(d[key])</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>APIs</strong></td>
<td>from collections import Counter<br />Counter(l)</td>
<td>X</td>
<td>_.countBy(l)</td>
<td>X</td>
</tr>
<tr>
<td></td>
<td>max</td>
<td>max</td>
<td>Math.max</td>
<td>Math.max</td>
</tr>
<tr>
<td><strong>String</strong></td>
<td>len(s)</td>
<td>s.length()</td>
<td>s.length</td>
<td>s.length()</td>
</tr>
<tr>
<td></td>
<td>s[i]</td>
<td>s[i]</td>
<td>s[i]</td>
<td>s.charAt(i)</td>
</tr>
<tr>
<td></td>
<td>s[3:5]</td>
<td>token = s.substr(start, i-start+1);</td>
<td>s.slice(3, 5);</td>
<td>s.substring(start, i+1);</td>
</tr>
<tr>
<td><strong>Set</strong></td>
<td>ws = set(wD)</td>
<td>unordered_set<string> ws;<br/>        <br/>        for (auto s: wordDict){<br/>            ws.insert(s);<br/>        }</td>
<td>let ws = new Set(wD)</td>
<td>HashSet<String> ws = new HashSet(wordDict);</td>
</tr>
<tr>
<td></td>
<td>token in ws</td>
<td>ws.find(token) != ws.end()</td>
<td>ws.has(token)</td>
<td>ws.contains(token)</td>
</tr>
<tr>
<td><strong>MAX</strong></td>
<td>float(‘-inf’)</td>
<td>INT_MIN;</td>
<td>-Number.MAX_VALUE;</td>
<td>Integer.MIN_VALUE;</td>
</tr>
<tr>
<td><strong>2D Init</strong></td>
<td>[[0 for j in range(n)] for i in range(m)]</td>
<td></td>
<td></td>
<td>[…Array(3)].map(x=&gt;Array(5).fill(0))</td>
</tr>
<tr>
<td><strong>1D sort</strong></td>
<td>l.sort(reverse=True)</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Node</strong></td>
<td>if not head</td>
<td>if (!head); if (nullputr == head)</td>
<td>if (!root); if (head == null)</td>
<td>if (head == null)</td>
</tr>
</tbody></table>
<h2 id="Special-issues"><a href="#Special-issues" class="headerlink" title="Special issues:"></a>Special issues:</h2><ul>
<li>Java &amp; js</li>
<li><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gegmwb46qaj312a0u0qb1.jpg" alt="image-20200504191823941" style="zoom:67%;" /></li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/18/System-Design/9p/2019-04-18-MapReuce/">System-Design/9p/2019-04-18-MapReuce</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SystemDesign/">SystemDesign</a></span><div class="content"><h1 id="General"><a href="#General" class="headerlink" title="General"></a>General</h1><h1 id="Map-Reduce"><a href="#Map-Reduce" class="headerlink" title="Map Reduce"></a>Map Reduce</h1><blockquote>
<p>Map<br> • 机器1，2 只负责把文章拆分为一个一个的单词</p>
<p>Reduce<br> • 机器3，4各负责一部分word的合并</p>
</blockquote>
<p>95%是在使用；　5%是在設計Map Reduce</p>
<p>只要大數據就該還是來了解</p>
<h2 id="統計單詞詞頻"><a href="#統計單詞詞頻" class="headerlink" title="統計單詞詞頻"></a>統計單詞詞頻</h2><ol>
<li>for + hash</li>
</ol>
<blockquote>
<h5 id="多选题-使用-For-循环统计单词个数有什么问题？"><a href="#多选题-使用-For-循环统计单词个数有什么问题？" class="headerlink" title="[多选题]使用 For 循环统计单词个数有什么问题？"></a>[多选题]使用 For 循环统计单词个数有什么问题？</h5><p>A.执行速度慢，单台机器要遍历所有单词50.47% 选择</p>
<p>B.耗费空间大，所有单词都要存储在 Hash 里进行计数统计47.48% 选择</p>
<p>C.编程复杂，代码实现难度高2.05% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是AB</p>
<p><strong>正确答案:</strong> AB</p>
</blockquote>
<ol start="2">
<li>多台機器平行統計，該怎麼切？</li>
</ol>
<blockquote>
<h5 id="单选题-按照内容存储顺序拆分统计，然后合并在一起的算法问题在哪儿？"><a href="#单选题-按照内容存储顺序拆分统计，然后合并在一起的算法问题在哪儿？" class="headerlink" title="[单选题]按照内容存储顺序拆分统计，然后合并在一起的算法问题在哪儿？"></a>[单选题]按照内容存储顺序拆分统计，然后合并在一起的算法问题在哪儿？</h5><p>A.无法做到均匀拆分26.18% 选择</p>
<p>B.机器的并行效率不高4.71% 选择</p>
<p>C.合并的时候太慢，会成为瓶颈69.11% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是C</p>
<p><strong>正确答案:</strong> C</p>
</blockquote>
<h3 id="合併的時候是Bottle-Neck"><a href="#合併的時候是Bottle-Neck" class="headerlink" title="合併的時候是Bottle Neck!"></a>合併的時候是Bottle Neck!</h3><p>是不是也可以平行？以什麼為標準來劃分？機器or Key?</p>
<blockquote>
<h5 id="单选题-合并的时候以什么作为划分依据？"><a href="#单选题-合并的时候以什么作为划分依据？" class="headerlink" title="[单选题]合并的时候以什么作为划分依据？"></a>[单选题]合并的时候以什么作为划分依据？</h5><p>A.机器25.45% 选择</p>
<p>B.Key74.55% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong> B</p>
<p><strong>解析:</strong> </p>
<p>以Key作为划分，设计简单，没有层次依赖性</p>
</blockquote>
<p>用機器的話會有層次、依賴性問題而拖慢整體速度。</p>
<h1 id="Map-Reduce-框架流程"><a href="#Map-Reduce-框架流程" class="headerlink" title="Map Reduce 框架流程"></a>Map Reduce 框架流程</h1><p>Map Reduce是一個分布式系統，整個都是由Master來控制的。</p>
<p>map的時候並沒有做合併aggregation的操作。</p>
<blockquote>
<h5 id="单选题-Word-Count-为什么没有在-Map-的时候做聚合（Aggregation）？"><a href="#单选题-Word-Count-为什么没有在-Map-的时候做聚合（Aggregation）？" class="headerlink" title="[单选题]Word Count 为什么没有在 Map 的时候做聚合（Aggregation）？"></a>[单选题]Word Count 为什么没有在 Map 的时候做聚合（Aggregation）？</h5><p>A.因为会使得编程复杂度提高15.39% 选择</p>
<p>B.因为聚合所需时间复杂度较高31.53% 选择</p>
<p>C.因为 Map Reduce 的框架会帮你实现41.83% 选择</p>
<p>D.因为 Map 的机器内存可能不够11.25% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是D</p>
<p><strong>正确答案:</strong> D</p>
</blockquote>
<p>不能在任何一個機器中開這個一樣哈希map。這裡不開的話，那麼整個系統都可以不開的。</p>
<h1 id="MR-的使用"><a href="#MR-的使用" class="headerlink" title="MR 的使用"></a>MR 的使用</h1><blockquote>
<p><strong>[LintCode 编程题]**</strong>[LintCode] Word Count (Map Reduce)**</p>
</blockquote>
<blockquote>
<h5 id="单选题-在-Reduce-函数中，为什么-values-要用-Iterator-而不是简单的用一个数组？"><a href="#单选题-在-Reduce-函数中，为什么-values-要用-Iterator-而不是简单的用一个数组？" class="headerlink" title="[单选题]在 Reduce 函数中，为什么 values 要用 Iterator 而不是简单的用一个数组？"></a>[单选题]在 Reduce 函数中，为什么 values 要用 Iterator 而不是简单的用一个数组？</h5><p>A.因为作者偏好使用 Iterator0.87% 选择</p>
<p>B.因为数组有可能在内存中会放不下，而 Iterator 具体实现的时候可能是从文件里分批次读取84.87% 选择</p>
<p>C.因为 Iterator 的读取效率比较快4.24% 选择</p>
<p>D.因为 Iterator 是一个接口，可以用数组来实现10.01% 选择</p>
<p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTM0MTgxMjgxODM5IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM3NjIiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMzIiIGhlaWdodD0iMzIiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTUxOC4xMiA1MTYuMTZtLTQ5MCAwYTQ5MCA0OTAgMCAxIDAgOTgwIDAgNDkwIDQ5MCAwIDEgMC05ODAgMFoiIGZpbGw9IiM1NkI0MzIiIHAtaWQ9IjM3NjMiPjwvcGF0aD48cGF0aCBkPSJNMzkzLjIxMzYxOSA2NjQuMzM1NDk1bTI4LjI4NDI3MS0yOC4yODQyNzFsMjk2Ljk4NDg0OS0yOTYuOTg0ODQ4cTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBsMCAwcTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDJsLTI5Ni45ODQ4NDggMjk2Ljk4NDg0OHEtMjguMjg0MjcxIDI4LjI4NDI3MS01Ni41Njg1NDMgMGwwIDBxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDJaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY0Ij48L3BhdGg+PHBhdGggZD0iTTI4OS40Njk4NCA0NTIuODQ3ODgzbTI4LjI4NDI3MSAyOC4yODQyNzFsMTU1LjU2MzQ5MiAxNTUuNTYzNDkycTI4LjI4NDI3MSAyOC4yODQyNzEgMCA1Ni41Njg1NDNsMCAwcS0yOC4yODQyNzEgMjguMjg0MjcxLTU2LjU2ODU0MyAwbC0xNTUuNTYzNDkxLTE1NS41NjM0OTJxLTI4LjI4NDI3MS0yOC4yODQyNzEgMC01Ni41Njg1NDNsMCAwcTI4LjI4NDI3MS0yOC4yODQyNzEgNTYuNTY4NTQyIDBaIiBmaWxsPSIjRkZGRkZGIiBwLWlkPSIzNzY1Ij48L3BhdGg+PC9zdmc+" alt="img">答对了，您选择的答案是B</p>
<p><strong>正确答案:</strong> B</p>
</blockquote>
<h2 id="Word-Count"><a href="#Word-Count" class="headerlink" title="Word Count"></a>Word Count</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WordCount</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param &#123;str&#125; line a text, for example "Bye Bye see you next"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mapper</span><span class="params">(self, _, line)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value'</span></span><br><span class="line">        <span class="keyword">for</span> w <span class="keyword">in</span> line.split():</span><br><span class="line">            <span class="keyword">yield</span> w, <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param key is from mapper</span></span><br><span class="line">    <span class="comment"># @param values is a set of value with the same key</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self, key, values)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value'</span></span><br><span class="line">        <span class="keyword">yield</span> key, sum(values)</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Map</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(String key, String value, OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, int value);</span></span><br><span class="line">            StringTokenizer tokenizer = <span class="keyword">new</span> StringTokenizer(value);</span><br><span class="line">            <span class="keyword">while</span> (tokenizer.hasMoreTokens()) &#123;</span><br><span class="line">                String outputKey = tokenizer.nextToken();</span><br><span class="line">                output.collect(outputKey, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Reduce</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(String key, Iterator&lt;Integer&gt; values,</span></span></span><br><span class="line"><span class="function"><span class="params">                           OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, int value);</span></span><br><span class="line">            <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (values.hasNext()) &#123;</span><br><span class="line">                sum += values.next();</span><br><span class="line">            &#125;</span><br><span class="line">            output.collect(key, sum);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="傳輸整理-shuffle"><a href="#傳輸整理-shuffle" class="headerlink" title="傳輸整理 -  shuffle"></a>傳輸整理 -  shuffle</h1><ul>
<li>Partition sort  +  Fetch&amp;Merge</li>
</ul>
<p>當map完怎麼傳給其他機器做reduce?</p>
<ol>
<li>把結果以為key作分組，master有個一致性哈希去作分組。</li>
<li>對組內部作硬盤上的外排序。以key為第一關鍵字，value為第二關鍵字。</li>
<li>３號會再作k路merge，把這些文件合成一個reduce的輸入</li>
</ol>
<blockquote>
<ul>
<li>请问，这里的K路归并需要使用hashmap吗？如果不用的话是如何实现的？如果用的话不是说内存装不下吗？<ul>
<li>k路归并不需要使用hashmap，可以只用少量的内存完成。方法是：每次选取k路中最小的元素，将其放入存放结果的队列，然后重复执行以上两步。存放结果的队列可以直接在硬盘上</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="Practice-1"><a href="#Practice-1" class="headerlink" title="Practice 1."></a>Practice 1.</h1><p>Inverted Index as Search Engine</p>
<blockquote>
<ul>
<li>一个key占一个reducer吗？还是可以多个key放一个reducer？<ul>
<li>多个key放一个reducer。<br>假设有R个Reducer，map函数产生的key-value pair会被一个hash function(原paper里叫partition function)分成R份，哈希值相同的key会被归到同一个Reducer里，然后Reducer会把这些key-value pair分组，同一个key的value拼在一起之后传给用户编写的reduce函数。</li>
</ul>
</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Definition of Document</span></span><br><span class="line"><span class="string">class Document:</span></span><br><span class="line"><span class="string">    def __init__(self, id, cotent):</span></span><br><span class="line"><span class="string">        self.id = id</span></span><br><span class="line"><span class="string">        self.content = content</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvertedIndex</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param &#123;Document&#125; value is a document</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mapper</span><span class="params">(self, _, value)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="comment"># for word in range(value.content.split()):</span></span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> value.content.split(): </span><br><span class="line">            <span class="keyword">yield</span> word, value.id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param key is from mapper</span></span><br><span class="line">    <span class="comment"># @param values is a set of value with the same key</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self, key, values)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="comment"># res = []</span></span><br><span class="line">        <span class="comment"># # print(type(values))</span></span><br><span class="line">        <span class="comment"># for val in values:</span></span><br><span class="line">        <span class="comment">#     res.append(val)  </span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">yield</span> key, sorted(list(set(values)))</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition of OutputCollector:</span></span><br><span class="line"><span class="comment"> * class OutputCollector&lt;K, V&gt; &#123;</span></span><br><span class="line"><span class="comment"> *     public void collect(K key, V value);</span></span><br><span class="line"><span class="comment"> *         // Adds a key/value pair to the output buffer</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * Definition of Document:</span></span><br><span class="line"><span class="comment"> * class Document &#123;</span></span><br><span class="line"><span class="comment"> *     public int id;</span></span><br><span class="line"><span class="comment"> *     public String content;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvertedIndex</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Map</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(String _, Document value,</span></span></span><br><span class="line"><span class="function"><span class="params">                        OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, int value);</span></span><br><span class="line">            <span class="keyword">int</span> id = value.id;</span><br><span class="line">            StringTokenizer tokenizer = <span class="keyword">new</span> StringTokenizer(value.content);</span><br><span class="line">            <span class="keyword">while</span> (tokenizer.hasMoreTokens()) &#123;</span><br><span class="line">                String word = tokenizer.nextToken();</span><br><span class="line">                output.collect(word, id);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Reduce</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(String key, Iterator&lt;Integer&gt; values,</span></span></span><br><span class="line"><span class="function"><span class="params">                           OutputCollector&lt;String, List&lt;Integer&gt;&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, List&lt;Integer&gt; value);</span></span><br><span class="line">            List&lt;Integer&gt; results = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">            <span class="keyword">int</span> previous = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (values.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">int</span> now = values.next();</span><br><span class="line">                <span class="keyword">if</span>(previous != now) &#123;</span><br><span class="line">                    results.add(now);</span><br><span class="line">                &#125;</span><br><span class="line">                previous = now;</span><br><span class="line">            &#125;</span><br><span class="line">            output.collect(key, results);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Practice-2"><a href="#Practice-2" class="headerlink" title="Practice 2."></a>Practice 2.</h1><p>Anagram grouping</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Anagram</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param &#123;str&#125; line a text, for example "Bye Bye see you next"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mapper</span><span class="params">(self, _, line)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> line.split():</span><br><span class="line">            <span class="comment"># print(word)</span></span><br><span class="line">            <span class="keyword">yield</span> <span class="string">''</span>.join(sorted(word)), word</span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param key is from mapper</span></span><br><span class="line">    <span class="comment"># @param values is a set of value with the same key</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self, key, values)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="comment"># res = []</span></span><br><span class="line">        <span class="keyword">yield</span> key, list(values)</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition of OutputCollector:</span></span><br><span class="line"><span class="comment"> * class OutputCollector&lt;K, V&gt; &#123;</span></span><br><span class="line"><span class="comment"> *     public void collect(K key, V value);</span></span><br><span class="line"><span class="comment"> *         // Adds a key/value pair to the output buffer</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Anagram</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Map</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(String key, String value, OutputCollector&lt;String, String&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, String value);</span></span><br><span class="line">            StringTokenizer tokenizer = <span class="keyword">new</span> StringTokenizer(value);</span><br><span class="line">            <span class="keyword">while</span> (tokenizer.hasMoreTokens()) &#123;</span><br><span class="line">                String word = tokenizer.nextToken();</span><br><span class="line">                String original = word;</span><br><span class="line">                <span class="keyword">char</span>[] chars = original.toCharArray();</span><br><span class="line">                Arrays.sort(chars);</span><br><span class="line">                String sorted = <span class="keyword">new</span> String(chars);</span><br><span class="line">                output.collect(sorted, word);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Reduce</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(String key, Iterator&lt;String&gt; values, OutputCollector&lt;String, List&lt;String&gt;&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, List&lt;String&gt; value);</span></span><br><span class="line">            List&lt;String&gt; results = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">            <span class="keyword">while</span> (values.hasNext()) &#123;</span><br><span class="line">                results.add(values.next());</span><br><span class="line">            &#125;</span><br><span class="line">            output.collect(key, results);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Map’s"><a href="#Map’s" class="headerlink" title="Map’s"></a>Map’s</h3><ul>
<li><p>Key: 經內部字母排序後的單詞 (會一樣)</p>
</li>
<li><p>Value : 未經排序的</p>
</li>
</ul>
<blockquote>
<ul>
<li><p>map结果传输给reducer是不是要通过网络传输？这样的速度够用吗</p>
<ul>
<li>map结果是通过网络传给reducer，map和reducer一般同在一个内网，网速够用</li>
</ul>
</li>
<li><p>mapReduce中master机器不会用于管理所有数据的metadata吗？</p>
<ul>
<li><p>master不负责中间计算结果的相关数据。</p>
</li>
<li><p>再补充几个常见的 QA:</p>
<p>Q: Reduce 之后各个key还是可能会在不同地方，那么怎么再把这些 reducer 的结果 sort 并放在一起呢？<br>A: Reducer 的结果在全局是不 sort 的。因为很多计算场景下计算结果不需要 sort。如果有 sort 的需求，可以使用外排序算法（External Sorting）进行排序即可。</p>
</li>
<li><p>Q: 系统设计中 map reduce 的问题会以什么形式问？<br>A: 90% 的概率会问使用 map reduce 来解决比较重的计算问题。10% 的概率会问 map reduce 的原理是怎么样的。所以好好做今天的编程题作业非常重要！</p>
</li>
<li><p>Q: Reduce 的过程全部都在内存里么？是否会装不下？<br>A: 不是的。Reduce 的过程，key 是在内存里的，value list 通常在代码中是一个 iterator 的形式，也就意味着，有可能是从文件里读进来的。很显然全部放在内存肯定是放不下的，特别是对一些很 hot 的 key。</p>
</li>
<li></li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="Practice-3-K-frequent-words"><a href="#Practice-3-K-frequent-words" class="headerlink" title="Practice 3 K-frequent words"></a>Practice 3 K-frequent words</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Definition of Document</span></span><br><span class="line"><span class="string">class Document:</span></span><br><span class="line"><span class="string">    def __init__(self, id, content):</span></span><br><span class="line"><span class="string">        self.id = id</span></span><br><span class="line"><span class="string">        self.content = content</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">from</span> Mr_tools <span class="keyword">import</span> Document</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopKFrequentWords</span>:</span></span><br><span class="line">    <span class="comment"># @param &#123;Document&#125; value is a document and value have two attributes(id and content)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mapper</span><span class="params">(self, _, value)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="comment"># key is word and value is 1</span></span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> value.content.split():</span><br><span class="line">            <span class="keyword">yield</span> word, <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param key is from mapper</span></span><br><span class="line">    <span class="comment"># @param values is a list of document</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self, key, values)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="comment"># key is word, value is count</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># yield key, reversed(sorted(values))</span></span><br><span class="line">        <span class="keyword">yield</span> key, values   <span class="comment"># 框架天生就已经照 DESC 排好了</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition of OutputCollector:</span></span><br><span class="line"><span class="comment"> * class OutputCollector&lt;K, V&gt; &#123;</span></span><br><span class="line"><span class="comment"> *     public void collect(K key, V value);</span></span><br><span class="line"><span class="comment"> *         // Adds a key/value pair to the output buffer</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * Definition of Document:</span></span><br><span class="line"><span class="comment"> * class Document &#123;</span></span><br><span class="line"><span class="comment"> *     public int id;</span></span><br><span class="line"><span class="comment"> *     public String content;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pair</span> </span>&#123;</span><br><span class="line">    String key;</span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">    </span><br><span class="line">    Pair(String key, <span class="keyword">int</span> value) &#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopKFrequentWords</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Map</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(String _, Document value,</span></span></span><br><span class="line"><span class="function"><span class="params">                        OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, int value);</span></span><br><span class="line">            <span class="keyword">int</span> id = value.id;</span><br><span class="line">            String content = value.content;</span><br><span class="line">            String[] words = content.split(<span class="string">" "</span>);</span><br><span class="line">            <span class="keyword">for</span> (String word : words)</span><br><span class="line">                <span class="keyword">if</span> (word.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    output.collect(word, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Reduce</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> PriorityQueue&lt;Pair&gt; Q = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> k;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Comparator&lt;Pair&gt; pairComparator = <span class="keyword">new</span> Comparator&lt;Pair&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Pair left, Pair right)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (left.value != right.value) &#123;</span><br><span class="line">                    <span class="keyword">return</span> left.value - right.value;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> right.key.compareTo(left.key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// initialize your data structure here</span></span><br><span class="line">            <span class="keyword">this</span>.k = k;</span><br><span class="line">            Q = <span class="keyword">new</span> PriorityQueue&lt;Pair&gt;(k, pairComparator);</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(String key, Iterator&lt;Integer&gt; values)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (values.hasNext()) &#123;</span><br><span class="line">                    sum += values.next();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Pair pair = <span class="keyword">new</span> Pair(key, sum);</span><br><span class="line">            <span class="keyword">if</span> (Q.size() &lt; k) &#123;</span><br><span class="line">                Q.add(pair);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Pair peak = Q.peek();</span><br><span class="line">                <span class="keyword">if</span> (pairComparator.compare(pair, peak) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    Q.poll();</span><br><span class="line">                    Q.add(pair);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">(OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Output the top k pairs &lt;word, times&gt; into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, Integer value);</span></span><br><span class="line">            List&lt;Pair&gt; pairs = <span class="keyword">new</span> ArrayList&lt;Pair&gt;();</span><br><span class="line">            <span class="keyword">while</span> (!Q.isEmpty()) &#123;</span><br><span class="line">                pairs.add(Q.poll());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// reverse result</span></span><br><span class="line">            <span class="keyword">int</span> n = pairs.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = n - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">                Pair pair = pairs.get(i);</span><br><span class="line">                output.collect(pair.key, pair.value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="N-gram"><a href="#N-gram" class="headerlink" title="N-gram"></a>N-gram</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NGram</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param &#123;int&#125; n a integer</span></span><br><span class="line">    <span class="comment"># @param &#123;str&#125; string a string</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mapper</span><span class="params">(self, _, n, string)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="keyword">for</span> start <span class="keyword">in</span> range(len(string)-n+<span class="number">1</span>):</span><br><span class="line">            word = string[start:start+n]</span><br><span class="line">            <span class="keyword">yield</span> word, <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @param key is from mapper</span></span><br><span class="line">    <span class="comment"># @param values is a set of value with the same key</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self, key, values)</span>:</span></span><br><span class="line">        <span class="comment"># Write your code here</span></span><br><span class="line">        <span class="comment"># Please use 'yield key, value' here</span></span><br><span class="line">        <span class="keyword">yield</span> key, sum(values)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition of OutputCollector:</span></span><br><span class="line"><span class="comment"> * class OutputCollector&lt;K, V&gt; &#123;</span></span><br><span class="line"><span class="comment"> *     public void collect(K key, V value);</span></span><br><span class="line"><span class="comment"> *         // Adds a key/value pair to the output buffer</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NGram</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Map</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(String _, <span class="keyword">int</span> n, String str,</span></span></span><br><span class="line"><span class="function"><span class="params">                        OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, Integer value);</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; str.length() - n + <span class="number">1</span>; ++index) &#123;</span><br><span class="line">                output.collect(str.substring(index, index + n), <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Reduce</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(String key, Iterator&lt;Integer&gt; values,</span></span></span><br><span class="line"><span class="function"><span class="params">                           OutputCollector&lt;String, Integer&gt; output)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Write your code here</span></span><br><span class="line">            <span class="comment">// Output the results into output buffer.</span></span><br><span class="line">            <span class="comment">// Ps. output.collect(String key, int value);</span></span><br><span class="line">            <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (values.hasNext()) &#123;</span><br><span class="line">                    sum += values.next();</span><br><span class="line">            &#125;</span><br><span class="line">            output.collect(key, sum);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h1><img src="/Users/joe/Library/Application Support/typora-user-images/image-20200419212810217.png" alt="image-20200419212810217" style="zoom: 50%;" />

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gdzedcrqyjj30k20tyn18.jpg" alt="image-20200419212855454" style="zoom:50%;" />

<blockquote>
<p>1T 的数据很大，通常很难找到内存超过 1T 的电脑。但是内存超过 1G 的还是很容易的。因此 A 肯定是不对的。如果我们能找到一个算法比较均匀的拆分 1T 的数据到 1024 个 1G 的文件的话，每个文件都可以导入内存中进行排序，最后我们再归并排序后的结果即可。这个拆分排序再归并的算法就是外排序算法。</p>
<ul>
<li>选项 B，按照数据的范围进行拆分，会导致分配不均匀，比如大部分的数据都在一个很小的范围内。而且不是所有的数据都有可数范围，如字符串是很难划定范围的。</li>
<li>选项 C，按照 hash 之后的结果进行拆分，也会导致数据拆分不均匀，因而使得某些部分可能依然无法导入内存。</li>
<li>选项 D，按照实际存储位置进行拆分，这样才能够确保每个部分可以导入内存。</li>
</ul>
</blockquote>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200420002016032.png" alt="image-20200420002016032" style="zoom:50%;" />

<blockquote>
<ul>
<li>Map 的机器如果没有全部执行完，任何一台 Reduce 的机器所负责的数据段都有可能还有更新。因此 Reduce 的部分是不可以开始的。但是机器可以先启动执行一些程序的初始化操作是可以的。</li>
</ul>
</blockquote>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gdzjbais4qj30ju0v0429.jpg" alt="image-20200420001955882" style="zoom:50%;" />

<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200420002035928.png" alt="image-20200420002035928" style="zoom:50%;" /></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/15/System-Design/201-08-08-BigTiger-Big%20Table/">System-Design/201-08-08-BigTiger-Big Table</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SystemDesign/">SystemDesign</a></span><div class="content"><p>存 : sharidng、写、failure</p>
<p>查:</p>
<h1 id="BigTiger"><a href="#BigTiger" class="headerlink" title="BigTiger"></a>BigTiger</h1><p>★ 應該先關注「寫」再來才是「讀」</p>
<h3 id="讀"><a href="#讀" class="headerlink" title="讀"></a>讀</h3><ul>
<li><p>如何在文件作快速查詢？</p>
<ul>
<li><p>對於文件很多數據找到key排序</p>
</li>
<li><p>也是 NoSQL常用的概念</p>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200804230436057.png" alt="image-20200804230436057" style="zoom:50%;" />
</li>
</ul>
</li>
<li><p>大表時怎辦？</p>
<ul>
<li><p>拆成很多個小表，這樣每個小表內部是個排過序的kv串，在底下用元數據保存小表位置</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghfubji1asj315g0kc761.jpg" alt="image-20200804230659530"></p>
</li>
</ul>
</li>
<li><p>超大表呢？</p>
<ul>
<li><p>小表再拆出小小表</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghfubobrjkj316s0nywh0.jpg" alt="image-20200804230812457"></p>
</li>
</ul>
</li>
</ul>
<h3 id="寫"><a href="#寫" class="headerlink" title="寫"></a>寫</h3><p>DB只是負責查詢跟組織的，存是存到FS裡去的。</p>
<ul>
<li>怎麼寫數據？<ul>
<li><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghfubmnyhdj316g0imwfz.jpg" alt="image-20200804231646400"></li>
</ul>
</li>
</ul>
<ul>
<li><p>內存表過大怎辦？</p>
<ul>
<li><p>要是內存寫到64MB就打入DISK</p>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200804231815438.png" alt="image-20200804231815438" style="zoom:50%;" />



</li>
</ul>
</li>
</ul>
<ul>
<li><p>如何避免丟失數據</p>
<ul>
<li><p>Log</p>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200804231938213.png" alt="image-20200804231938213" style="zoom:50%;" />



</li>
</ul>
</li>
</ul>
<ul>
<li>所以現在下面三者構成了一個「小表的數據」<ol>
<li>內存表</li>
<li>一些小小表</li>
<li>Log</li>
</ol>
</li>
</ul>
<ul>
<li>如何讀數據？<ul>
<li>比方要找B了，因為小小表內有序，內存外無序，所以找的時候要找所有的小小表還有內存表，而且disk還要遍歷或二叉找都是很慢的</li>
<li><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghfubnip3yj313i0mwdi9.jpg" alt="image-20200804232415145"></li>
</ul>
</li>
</ul>
<ul>
<li>怎加速呢？<ul>
<li>最好的方式就是建立索引</li>
<li>我們在寫入小小表時，可以固化個索引並預加載到內存</li>
<li><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghfubj6z2sj315g0kc761.jpg" alt="image-20200804233037481"></li>
</ul>
</li>
</ul>
<ul>
<li>继续加速?<ul>
<li>用 Bloom Filter, 有可能在的塊才去找</li>
<li>所以小小表就變成了數據塊、索引、Bloom Filter</li>
</ul>
</li>
</ul>
<ul>
<li>如何將表存入 GFS?<ul>
<li>兩者都是64MB的chunk，可映射上，好管理</li>
<li><img src="/Users/joe/Library/Application Support/typora-user-images/image-20200804233433530.png" alt="image-20200804233433530" style="zoom:50%;" />



</li>
</ul>
</li>
</ul>
<ul>
<li>表的邏輯視圖是什麼？<ul>
<li>身高體重可以變column family</li>
<li><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghfubl4n0ij316m0nyq5x.jpg" alt="image-20200804233540415"></li>
</ul>
</li>
</ul>
<ul>
<li><p>怎麼映射為物理存儲？</p>
<ul>
<li><p>找到key的規則，將行、列、時間戳作為key</p>
</li>
<li><p>都存一起有什麼好處呢？</p>
<ul>
<li><p>可以將相同的key聚合在一起，是NoSQL的經典更有效的作法，所以天然不支援join操作，</p>
<p>也說明了為什麼MySQL在scale天然會出各種問題</p>
</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghfubizt4wj316i0g0abv.jpg" alt="image-20200804233835009"></p>
</li>
</ul>
</li>
</ul>
<ul>
<li>架構是什麼呢？</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghfubk1hk9j31440mkwh9.jpg" alt="image-20200804234021399"></p>
<ul>
<li><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghf8mst00qj30v003smze.jpg" alt="image-20200805002026433" style="zoom: 33%;" />

</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/15/System-Design/9p/2019-04-15-BigTable/">System-Design/9p/2019-04-15-BigTable</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SystemDesign/">SystemDesign</a></span><div class="content"><h1 id="General"><a href="#General" class="headerlink" title="General"></a>General</h1><ul>
<li>NoSQL DB</li>
<li>SS table 的讀跟寫</li>
<li>Bloom Filter</li>
<li>Look up service</li>
<li>Merge K Sorted Arrays</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 486. Merge K Sorted Arrays</span></span><br><span class="line"><span class="comment"># 中文English</span></span><br><span class="line"><span class="comment"># Given k sorted integer arrays, merge them into one sorted array.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line"><span class="comment"># Example 1:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Input: </span></span><br><span class="line"><span class="comment">#   [</span></span><br><span class="line"><span class="comment">#     [1, 3, 5, 7],</span></span><br><span class="line"><span class="comment">#     [2, 4, 6],</span></span><br><span class="line"><span class="comment">#     [0, 8, 9, 10, 11]</span></span><br><span class="line"><span class="comment">#   ]</span></span><br><span class="line"><span class="comment"># Output: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]</span></span><br><span class="line"><span class="comment"># Example 2:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Input:</span></span><br><span class="line"><span class="comment">#   [</span></span><br><span class="line"><span class="comment">#     [1,2,3],</span></span><br><span class="line"><span class="comment">#     [1,2]</span></span><br><span class="line"><span class="comment">#   ]</span></span><br><span class="line"><span class="comment"># Output: [1,1,2,2,3]</span></span><br><span class="line"><span class="comment"># Challenge</span></span><br><span class="line"><span class="comment"># Do it in O(N log k).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># N is the total number of integers.</span></span><br><span class="line"><span class="comment"># k is the number of arrays.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> heapq</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    @param arrays: k sorted integer arrays</span></span><br><span class="line"><span class="string">    @return: a sorted array</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mergekSortedArrays</span><span class="params">(self, arrays)</span>:</span></span><br><span class="line">        <span class="comment"># write your code here</span></span><br><span class="line">        <span class="keyword">return</span> self.helper_heapq(arrays)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">helper_heapq</span><span class="params">(self, arrays)</span>:</span></span><br><span class="line">        hp = []</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> range(len(arrays)):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> arrays[k]: <span class="keyword">continue</span></span><br><span class="line">            heapq.heappush(hp, (arrays[k][<span class="number">0</span>], k, <span class="number">0</span>))</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># print(hp)</span></span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">while</span> hp: </span><br><span class="line">            _, kth, idx = heapq.heappop(hp)</span><br><span class="line">            <span class="comment"># print(val, arrays[kth][idx], kth, idx)</span></span><br><span class="line">            res.append(arrays[kth][idx])</span><br><span class="line">            <span class="keyword">if</span> idx+<span class="number">1</span> &lt;= len(arrays[kth])<span class="number">-1</span>:</span><br><span class="line">                heapq.heappush(hp, (arrays[kth][idx+<span class="number">1</span>], kth, idx+<span class="number">1</span>))</span><br><span class="line">            <span class="comment"># else:</span></span><br><span class="line">            <span class="comment"># 大可以等下一輪拉出來再push那條的下一個元素，不急</span></span><br><span class="line">            <span class="comment">#     # while idx+1 &gt; len(array[kth])-1:</span></span><br><span class="line">            <span class="comment">#     val, kth, idx = heapq.heappop(hp)</span></span><br><span class="line">            <span class="comment">#     res.append(val)</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>

<ul>
<li>Binary Tree Serialization</li>
</ul>
<h1 id="Big-Table"><a href="#Big-Table" class="headerlink" title="Big Table"></a>Big Table</h1><p>Big Table vs GFS</p>
<table>
<thead>
<tr>
<th></th>
<th>GFS</th>
<th>BiGTable</th>
</tr>
</thead>
<tbody><tr>
<td>本質</td>
<td>分布式File System</td>
<td>分布式 NoSQL DB</td>
</tr>
<tr>
<td>開發公司</td>
<td>Google</td>
<td>Google</td>
</tr>
<tr>
<td>是否開源</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td>類似開源產品</td>
<td>HDFS</td>
<td>HBase</td>
</tr>
<tr>
<td>操作</td>
<td>Read &amp; Write</td>
<td>CRUD</td>
</tr>
<tr>
<td>類似什麼</td>
<td>家用電腦的文件系統</td>
<td>大數據版的Excel</td>
</tr>
</tbody></table>
<p>結構化文件可上BigTable終究是存上GFS。</p>
<blockquote>
<ul>
<li>BigTable 和 Dremel 主要有什么区别？<ul>
<li>bigtable是nosql storage system，dremel是query system。</li>
</ul>
</li>
<li></li>
</ul>
</blockquote>
<h2 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h2><ul>
<li>修改 CUD</li>
<li>查找 R</li>
</ul>
<p>後端通常給web server 使用，Scenario比較單一</p>
<h2 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h2><p>數據庫在邏輯上就是kv型式。硬盤不能存表結構，最終都轉成string去存在disk上。</p>
<p>就是要從文件系統的基礎上去思考搭數據庫系統。</p>
<p><strong>Q: 在文件裡怎麼更好支持查詢操作？</strong></p>
<ul>
<li><input disabled="" type="checkbox"> 把文件硬盤全讀到內存，然後在內存作流程管理</li>
<li><input checked="" disabled="" type="checkbox"> 直接在硬盤中對數據作排序 + 硬盤中二分。<ul>
<li>How? 外排序</li>
</ul>
</li>
</ul>
<p><strong>Q: 如果有相應的feature有修改操作了，怎辦？</strong></p>
<ul>
<li><input disabled="" type="checkbox"> 直接在文件裡修改？<strong>==&gt; 大家都要移動</strong></li>
<li><input disabled="" type="checkbox"> 讀整個文件，修改好後，把原文件刪了，重新寫入新文件。<strong>==&gt; 耗時，每次要讀出寫入其他多餘不變的內容</strong></li>
<li><input checked="" disabled="" type="checkbox"> 不修改，直接append操作追加一條紀錄。<strong>V! ==&gt; 特快！</strong><ul>
<li>但…怎麼識別最新的紀錄？<ul>
<li>在<strong>所有數據後面加個時間戳</strong>，時間戳最大的就是真正的我們要找的紀錄</li>
</ul>
</li>
<li>沒順序怎麼二分？<ul>
<li>分塊有序<ul>
<li>每個塊內部有序</li>
<li>寫時候只有最後一塊無序，並且隔一段時間整理成有序。</li>
<li>例：每次寫時就是在最後塊append一條紀錄，for看最後塊有沒有那個值，沒的話就往前一塊作二分查找；每隔時間到就把最後塊給整理成有序下，然後啟新的塊。一個塊是256MB，滿了後就不再寫了。</li>
</ul>
</li>
<li>分塊太多時會有很多重複紀錄啊？如某個feature一直被改改改<ul>
<li>Solution: 把有序塊中作去重，作k路去重merge，如果是根據時間去重，當時間一樣時，</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Big Table 為了寫優化，選了３作。</p>
<blockquote>
<ul>
<li><strong>老师，请问，数据库系统不存储数据，所有数据最终都存储在文件系统当中， 数据库只是负责查询和组织诗句是吗</strong><ul>
<li><strong>是的，大多DB都使用现有的文件系统作为底层存储机制</strong></li>
</ul>
</li>
<li>数据库是不是可以建立在任何的文件系统， 还是要为数据库写一个特殊的文件系统以提高效率？<ul>
<li><strong>一般没有必要</strong>，使用普通的文件系统在性能上已经足够了。</li>
</ul>
</li>
<li>利用数据库系统查询文件系统的时候 是在写入文件时就将文件里的所有表内容 按key-value的形式 再写入数据库么？<ul>
<li>按特定的数据结构存储，正如你说的key-value的形式，然后写入数据库中</li>
</ul>
</li>
<li>这里除去duplicate的k路归并也是全部读到内存中进行么？每一块中可以有duplicate存在么？<ul>
<li>K路归并的方法在后面的拓展视频中有讲到，每一个块中可以有duplicate</li>
</ul>
</li>
<li>我如果想查找k的值，我怎么知道k在哪个文件里？<ul>
<li>每个文件存储的k都是一个范围内的k值，直接二分搜索找到k在哪个范围内就找到了那个文件</li>
</ul>
</li>
<li>append到文件末尾也会增加文件大小啊，怎么避免和其他文件储存的位置冲突？<ul>
<li>如果是基于文件系统上搭建数据库，不必考虑此问题，操作系统会帮你完成；如果是自己直接基于disk搭建数据库，每个数据块初始化的时候就预先开辟适量的disk空间，当写入增加的数据量超过原有分配的空间的时候就需要申请一块更大的disk空间，将它拷贝过去，然后将原有的空间释放即可。（可以看下操作系统书中有关机械磁盘基本原理的介绍）</li>
</ul>
</li>
<li>直接把修改内容append到最后，这个方法，如果修改得太多了，会不会感觉很乱，每次读的时候cost增加，因为一个file可能有三分之一的size是修修改改？需不需要在修改的量超过一个比例的时候处理一下？<ul>
<li>首先要明确一点的是，没有任何一个数据库是生来都适合所有操作和场景的。也就是说，BigTable 本来就不适合修改特别多的场景。另外 BigTable 这类数据库会定期 Merge sstable，从而消除那些中间态的修改记录。</li>
</ul>
</li>
<li>分块是什么意思？<ul>
<li>是指将指定的“filename” 这个文件分成很多块，然后每次存储的时候找该文件编号的最后一块进行写入。如果写满了 是需要在文件系统里追加写入一个新的对应该文件名的块</li>
</ul>
</li>
<li>在讲到“分块有序”时，老师说到每个块之间都是有序的。但是块与块之间是不是有序的呢？也就是说是不是第1个块的 key 值都小于第2块的 key 值，第2块的 key 值都小于第3块的key值？（最后一块除外）<ul>
<li>块与块之间是有序的。这里可以是key-value存储记录块的索引地址；也可以是B+树索引，方便查找修改。</li>
</ul>
</li>
<li>那每次查询都要查询每一个块吗？不能直接锁定就在哪一个块中（例如索引之类的）？<ul>
<li><strong><em>好问题，后面的视频中讲到了索引，带着问题继续学习，棒！</em></strong></li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="One-Work-Solution"><a href="#One-Work-Solution" class="headerlink" title="One Work Solution"></a>One Work Solution</h1><h3 id="寫入過程"><a href="#寫入過程" class="headerlink" title="寫入過程"></a>寫入過程</h3><p>​    一個無序快快寫滿時，就排序然後寫入到FS。</p>
<ul>
<li><input disabled="" type="checkbox"> 讀入到內存作快排 X</li>
<li><input disabled="" type="checkbox"> 外排序 X;  <ul>
<li>每個文件最多就也256M，一個內存完全可放下，完全不需要外排</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> <strong>可不可一開始就放在內存？V!</strong></li>
</ul>
<p>比方，內存會用跳表這個結構，</p>
<h3 id="機器掛了怎辦？"><a href="#機器掛了怎辦？" class="headerlink" title="機器掛了怎辦？"></a>機器掛了怎辦？</h3><p>Write Ahead Log (WAL)，就只是append而已</p>
<p>append寫disk非常快和一般寫不同，打開模式為寫</p>
<p>如果要把最後一個塊放在硬盤的話，它不只要可以append還要可以read的操作；</p>
<p>append和寫不同，打開如果是append模式時，ptr是在尾巴；如果是寫模式，文件原內容會被清楚，ptr會指在文件頭。</p>
<p>所以：</p>
<p>内存排序+1次硬盘统一写入+1次硬盘写Log</p>
<p>Link: <a href="http://www.larsgeorge.com/2010/01/hbase-architecture-101-write-" target="_blank" rel="noopener">http://www.larsgeorge.com/2010/01/hbase-architecture-101-write-</a> ahead-log.html</p>
<blockquote>
<ul>
<li>每个块最大256M，是Google的Big Table自己定义的吗？还是一种通用的标准呢？而且这个“块”的学名是什么呀？谢谢！<ul>
<li>是的，是官方定义。<br>256M 块的大小是google工程师长期实践的一个经验值，统计过这个值比较合理。<br>最后，块的专业名词为：chunk</li>
</ul>
</li>
<li>什么是硬盘外部排序？<ul>
<li>当参加排序的数的量太大，或内存不足以存放时，需要使用外排序。外部排序指的是大文件的排序，即待排序的记录存储在外存储器上，待排序的文件无法一次装入内存，需要在内存和外部存储器之间进行多次数据交换，以达到排序整个文件的目的。</li>
</ul>
</li>
<li>老师，最后一个块是存在内存里的，存满256MB之后再写入硬盘。请问每次append一条数据到块里，是每次利用二分查找来保证这条数据插入到正确位置，还是每次就直接在块的尾部直接添加数据，直到块满了256MB，再排序变为有序啊。<ul>
<li><strong>直接在尾部添加，直到块满就进行排序。</strong></li>
</ul>
</li>
<li>这里的WAL 不是应该 每次有新的数据到内存都要写一次WAL吗？ 为什么说是1次的硬盘写LOG ？<ul>
<li><strong>是的，Write Ahead Log，就是对内存中Sorted Table里，new append data在HDD做一次append的操作。请再认</strong>真听讲，要确认每一个细节，其实再认真听讲是可以找到答案的，老师有讲到此细节。确实有问题了，仔细思考后再提出问题，这样学习深刻。</li>
</ul>
</li>
<li>Write ahead log 为什么是一次， 不应该每次有update 都要写一次吗？<ul>
<li>这块的WAL是多次的数据操作才会触发一次log写操作。这是为了性能的考量，HDD写的速度相比磁头寻道速度还是很快的，不想把太多时间浪费在寻道上，也就是每次写操作就需要寻道一次。</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="讀取優化"><a href="#讀取優化" class="headerlink" title="讀取優化"></a>讀取優化</h1><p>本來是只能在FS上作二分，更好的是建index</p>
<ul>
<li>一個簡單的建index 的方法：<ul>
<li>Key<ul>
<li><strong>就不需要整個文件作二分</strong></li>
<li>把一些Key放入內存作為index</li>
<li>Index有效減少磁盤讀寫次數</li>
</ul>
</li>
</ul>
</li>
<li>B-tree Index</li>
</ul>
<blockquote>
<ul>
<li>所以内存中有无序的存储块，和sorted存储块（sorted list），先用for查找无序没有，再去有内存中sorted list上跳跃查找？<ul>
<li>大体思路是对的，详细流程稍微更正如下：<br>(1)query Master server by the key;<br>(2) tablet server（即SSTable slave server）;<br>(3) check skip list(即跳表，在memory中) in the tablet server（对象没有排序的Sorted List）;<br>(4) check bloom filter(memory) for a SSTable(Sorted String Table)（最好一块有序块）;<br>(5) check index(memory) for a SSTable(查找其key的大致范围);<br>(6) find the value in the SSTable(根据在内存index定位到的小范围，在磁盘中通过二分查找这个key的文件内容).</li>
</ul>
</li>
<li>“看到这里我对于建立index又有些迷茫了。本来一个块中就是有序的，直接二分不就行了。就算是先看index，也是要先对index进行二分，再拿着找到的位置去块本身里找东西。那么index的好处是不是因为index比数据本身的size小，所以在index里二分比在数据里二分块？ “<ul>
<li>index 是在内存里的，你在内存里二分 index 比直接去 disk 上二分要快好几十倍。<strong><em>文件操作远远慢于内存操作</em></strong>。</li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<p>这里是课上提到的 B-Tree / B+ Tree 的一些资料：</p>
<p>Wiki:<br><a href="https://en.wikipedia.org/wiki/B-tree" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/B-tree</a></p>
<p>以B tree和B+ tree的区别来分析mysql索引实现:<br><a href="https://www.jianshu.com/p/0371c9569736" target="_blank" rel="noopener">https://www.jianshu.com/p/0371c9569736</a></p>
<p>这部分的内容只需要了解原理，不需要代码实现。</p>
</blockquote>
<h2 id="Bloom-Filter"><a href="#Bloom-Filter" class="headerlink" title="Bloom Filter"></a>Bloom Filter</h2><h3 id="繼續讀優化"><a href="#繼續讀優化" class="headerlink" title="繼續讀優化"></a>繼續讀優化</h3><p>因為寫的時候我們用的是append, 但就是讀的時候被搞亂了，所以讀就要一直優化。</p>
<p>數組長度自己定。</p>
<ul>
<li>多個 hash fn時，還是一樣同個數組在作mapping作查詢。</li>
<li>是可能會有False Positive的；但就是起了filter的作用</li>
<li>精度跟<ol>
<li>加入的字符串數目</li>
<li>hash個字</li>
<li>array長度。</li>
</ol>
</li>
<li>有誤判率計算公式</li>
</ul>
<p><strong><em>先用bloom filter看這個塊有沒有、有的話再用index找key可能在塊中的範圍，再用二分找這個塊裡的值</em></strong>　當然，在這之前是要先做完對最後那個在內存的塊的線性查找。</p>
<h2 id="SS-Table-amp-Skip-List"><a href="#SS-Table-amp-Skip-List" class="headerlink" title="SS Table &amp; Skip List"></a>SS Table &amp; Skip List</h2><ul>
<li>String is Store in the File. </li>
<li>SSTable = Sorted String Table</li>
<li>Sorted List 用 Skip List 实现</li>
</ul>
<ol>
<li>Skip List<br> Code: <a href="https://github.com/petegoodliffe/skip_list" target="_blank" rel="noopener">https://github.com/petegoodliffe/skip_list</a> Wiki: <a href="http://bit.ly/2g0C29a" target="_blank" rel="noopener">http://bit.ly/2g0C29a</a></li>
<li>SSTable<br> Google SSTable Page: <a href="http://bit.ly/1kqwrFe" target="_blank" rel="noopener">http://bit.ly/1kqwrFe</a></li>
</ol>
<blockquote>
<ul>
<li>“比如如果我用64个hash函数，每个文件按256M算(按每行数据256bytes算就是一百万行)。你这里难道把一百万个key都放在bloom filter里么 “<ul>
<li>是的，bloom filter的基本单位是bit，这里记录的是hash后的数字，不是文件，<strong><em>一个字节8bit，大约10w 字节，就是100kb，也就是0.1mb</em></strong>。（为了精度可能需要大概几mb的内存就够了）</li>
</ul>
</li>
<li>之前一小节讲的查一个key在不在这个块里需要先把这个块的index load到内存中再二分。你load index文件的时候不也是O(n)么？不在硬盘上二分是因为磁头移动的时间？所以宁愿先load一整个index file到内存中<ul>
<li>是的，因为磁头寻道时间开销相对内存来说很大。（可以读下《现代操作系统》 5.4 磁盘臂调度算法）为了减少磁头寻道的开销衍生出的一些算法</li>
</ul>
</li>
<li>“算两次hash值是为了防止collision么？可以扩大bloom filter的array大小，这样hash也不容易碰撞，这样可以么？ “<ul>
<li>多个hash function可以减少误判率，扩大array的大小也可以减少误判率</li>
</ul>
</li>
<li>index是B+ tree对吧，那为什么只能找到范围？最后一步，二分搜索在磁盘上进行，不是会非常慢么？<ul>
<li>对的，因为具体的内容要到块当中去找，块里的内容key是用字典序排列的，因此存在相同字母开头的key，所以只能锁定一个范围。锁定这个范围之后就可以二分了，logn的速度可以接受</li>
</ul>
</li>
<li>之前提到BigTable会定期执行Disk Merge Sort，这样不就可以直接对磁盘Blocks二分了吗? 为什么还要设计Bloom Filter？<ul>
<li>有很多请求是需要判断key是否在文件中，HDD二分查找也是log级别的操作，Bloom Filter来过滤掉很多不必要的HDD操作</li>
</ul>
</li>
<li>对于SSTable来说好像Index和Bloomfilter都是想要做一件事。视频的图中为什么两个都需要建立呢？<ul>
<li>Boom Filter是起到快速筛选的，如果Bloom Filter中key存在，那么就可能在此SSTable中存在，如果不存在那么肯定就不存在此有序列块中。当key经过Bloom Filter确定可能存在后，再通过index确定其所限的查找范围，确定后，再去磁盘中进行二分查找。</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="Scale-Sharding"><a href="#Scale-Sharding" class="headerlink" title="Scale - Sharding"></a>Scale - Sharding</h1><ul>
<li><p>垂直沒那麼好，因為可能也想關心這筆data的其他元素。會增加讀取其他feature的難度。</p>
</li>
<li><h3 id="所以水平-consistent-hashing"><a href="#所以水平-consistent-hashing" class="headerlink" title="所以水平 consistent hashing"></a>所以水平 consistent hashing</h3><ul>
<li>大表被拆成了很多個小表們</li>
</ul>
</li>
</ul>
<h1 id="BigTable的分布式鎖"><a href="#BigTable的分布式鎖" class="headerlink" title="BigTable的分布式鎖"></a>BigTable的分布式鎖</h1><ul>
<li><p>讀寫鎖</p>
<ul>
<li><p>一把鎖，兩種屬性：讀跟寫</p>
<ul>
<li><p>讀鎖：讀的時候上的</p>
</li>
<li><p>寫鎖：寫的時候上的</p>
</li>
<li><p>特性</p>
<ol>
<li><p>線程一加讀鎖成功了，又來了兩個讀線程，可以加鎖成功，可進行讀共享</p>
</li>
<li><p>線程一加寫鎖成功了，又來了兩個讀線程，不能加鎖成功，兩個讀的要block；</p>
<p>寫的時候只允許一個線程對內存作寫操作</p>
</li>
<li><p>線程一加讀鎖成功了，來了寫被block，又來了讀就要被block了；寫的優先級是比較高的，並且線程二來得早線程三就得要等了。</p>
<ol>
<li>讀是共享</li>
<li>寫是獨占</li>
<li>寫的優先級更高</li>
</ol>
</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge0l4p7wsnj30nw0nwte3.jpg" alt="image-20200420195125198" style="zoom:50%;" />

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge0h80fthij30s00j0n0m.jpg" alt="image-20200420195309119"></p>
<ul>
<li><p>鎖服務器：</p>
<ul>
<li>Master的一致性哈希分配小弟也就這邊執行了</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>如果是多台锁服务器，怎么处理并发呢，或者说这么保证对同一个key的上锁操作在同一台锁服务器上进行呢？也是hash吗？map存在web server 上？<ul>
<li>如果锁是一个cluster，<strong><em>多个节点之间会通过一致性协议来保持同步，对外表现得就像是只有一个节点一样，所以不用担心不一致的问题</em></strong>。</li>
</ul>
</li>
<li>这里的图显示 读 和写的都要LOCK 这个KEY，那不是会神慢吗？ 如果KEY LOCKED了后续怎么样呢？ 写一个RETRY吗？ 如果 很多程序同时读这个 KEY，那都得等待了？<ul>
<li>从安全和数据一致性来说，会相对重要些。lock肯定会慢些，但是这不影响总体的运行效率和用户体验。lock本身就是一个信号量互斥的实现机制，也线程间通信的基础， 详阅<a href="https://en.wikipedia.org/wiki/Lock_(computer_science)" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Lock_(computer_science)</a></li>
</ul>
</li>
<li>consistent hash map存在lock server上，那master还有什么作用？<ul>
<li>比如 heatbeat 。还有好多事儿要做呢，除了存储还有计算的工作呀。包括管理很多机器的启动，备份恢复等等。</li>
</ul>
</li>
<li>感觉这个lock server不是distributed lock, 实际上是一个centralized locking service?<ul>
<li>lock service内部是distributed实现的，但对外接口是中心化锁服务。具体使用的是chubby。</li>
</ul>
</li>
<li>如果写入的是一个新key，metadata里面还没有这个key对应的consistent hashing value，这时候的写入过程是什么呢？<ul>
<li>lock server查找有这个key的话锁上-》lock server返回server id-》去tablet server对应id写入-》写入GFS-》成功写入 返回True-》lock server释放锁</li>
</ul>
</li>
<li>请问 summary of write 这张图里的 master， 所以其实没有起到任何作用， master 的功能全部被 lock server代替了么？<ul>
<li>master还是提供分发控制的作用；lock server就是保证数据一致性（同一时间只有一个线程操作）</li>
</ul>
</li>
<li>另外你这个读请求的锁，应该只是block其他的对于这个key的write request吧。如果有很多对这个key的read request怎么办？这种情况下难道不能单机多线程读这个key吗。 虽然这种hot partition的case很多情况下是用户没设计好partition key..<ul>
<li>如果有很多对这个key的read request，系统只能等待，性能确实就会下降很多。如果想提这块的性能，可以使用双指针的方法，数据多份备份，这样这块的性能就会提升，但是数据脏读概率增大了。</li>
</ul>
</li>
<li>读取data这种操作 为何也需要锁 没有锁也没有任何问题吧。<ul>
<li>因为在read的同时可能还有针对同一个对象的updata/delete正在进行，为了防止读数据读到一半数据被删了这种不愉快的事情发生，加锁是必要的。</li>
</ul>
</li>
<li>所以timestamp这个信息是存在lock server上的内存中么？一旦完成了上一个，lock server会向下一个最新的request的server发送消息告诉它，现在unlock了，可以开始处理它的请求了？还是以别的方式做信息交互？<ul>
<li>你说的是对的，不过需要知道的是timestamp在sstable上也会存，便于查找的时候知道哪一个是现在最新的值</li>
</ul>
</li>
<li>如果client 拿到锁之后 还没来得及写就意外挂了， 锁怎么释放？有时间限制吗？<ul>
<li>“A client’s session<br>expires if it is unable to renew its session lease within the<br>lease expiration time. When a client’s session expires, it<br>loses any locks and open handles.” client超时后，会释放锁资源。</li>
</ul>
</li>
<li>Disk 中的 每个SSTable 都有自己的bloomfilter 和 index 吗？ 不同SSTable 的可以不一样吗<ul>
<li>对，这样理解是对的。当TableServer启动后开始服务初始化期间，会读取所有的有序块（SSTable）的Bloom Filer和Index到某个内存区域，以便服务查找。</li>
</ul>
</li>
<li>Lock Server存的metadata的数据来源是哪里呢？从BigTable Master里来的？他们之间怎么交流的呢？<ul>
<li>BigTable Master的key<br>这个系统对外会提供一个接口，接口不可直接操作bigtable master、lock server等，这些操作都是内部同步实现的逻辑<br>通信都是socket，可以考虑之间加上消息队列，直接append提交任务给目标server</li>
</ul>
</li>
<li>the entire process did not involve the master server… are we saying that if we have lock/zookeeper, we dont have to access master when reading and writing?<ul>
<li>only the first time from the a client for request, the master server should handle it, as master server need all the tablet server status for the first time of health-check, later then master server will synchronize/delegate all the tablet server status to locking server for the task hand-over. in that case, master server will move on to focus the health-check only.</li>
</ul>
</li>
<li>分布式锁这里面的“分布式”是什么意思？就是说这个锁适用于处理distributed system里面多台服务器需要对同一个资源进行读写的情形？那么不分布式的锁是怎么回事呢？<ul>
<li>这里的分布式指的是适用于多台服务器试图访问同一资源，相当于多台服务器上的多个进程共享资源。<br>非分布式的锁，就是单机上对资源的访问锁。通常就是线程间的资源共享或者单机上多个进程资源共享，通常使用操作系统提供的基础锁设施就可以完成。</li>
</ul>
</li>
<li>整个write 过程， 那一点是系统最慢的过程？ 同样，整个read 过程哪一点是系统最慢的过程？ 这个分布式锁应该会让系统变慢不少把？<ul>
<li>写的过程中，写满一个SSTable序列化到硬盘的时候相对比较慢，读的时候查引索时相对慢一点。实际在使用时，bigtable会使用一种叫做copy on write(cow)的机制，来保证读写操作的原子性，降低分布式锁对速度的影响</li>
</ul>
</li>
<li>感觉bigtable 这种read 的时候需要一个个SSTable 分别查找的方式不如Cassandra 这种直接一个 consistent hashing ring，一步就能知道data 在哪个node上面快啊？<ul>
<li>bigtable首先会在锁服务器上查一致性哈希表，得到在哪个server上。得知之后，会去那个server上查memtable、bloomfilter、sstable</li>
</ul>
</li>
<li>为什么一开始shard还是要通过master 来进行呢，为什么不能通过Locker 来进行呢<ul>
<li>通过最开始的文件sharding，取得与其负责管辖的tablet servers的建立联系，并且记录其各自的运行情况（alive/not alive）和健康信息。</li>
</ul>
</li>
<li>这里讲的master会shard file是什么意思？以及consistent hashing的map如果是存在 master/lock server的内存里，master/lock挂了怎么办<ul>
<li>shard file是共享文件的意思，就是master所管理的各个node server都可以访问和操作这个文件。<br>以前确出现在master挂掉导致整个集群挂掉的情况，现在master都会加有数据持久化的功能、master备份（主master挂掉，备份master就会启动，基本不影响集群运行）</li>
</ul>
</li>
<li>把metadata放在lock里跟放在master里比有什么优势吗？如果这样做会使系统性能更好，那是为什么呢？<ul>
<li>这里相当于将lock这个服务从master里面拆分了出来，这样肯定好的，master一般就是系统的性能瓶颈，减少master的负载，提高系统性能。</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="Appendixes"><a href="#Appendixes" class="headerlink" title="Appendixes"></a>Appendixes</h1><h2 id="K-sorted-merge"><a href="#K-sorted-merge" class="headerlink" title="K sorted merge"></a>K sorted merge</h2><p>每次找最小的都要O(K), N個下來就要 O(NxK), 用個heap吧 可O(Nxlg(K))</p>
<h2 id="外排序"><a href="#外排序" class="headerlink" title="外排序"></a>外排序</h2><p>一共8G的話，每次load進來2G, 就有四條排好的。可再接用K-sorte merge</p>
<ul>
<li><p>最小可以就維護４個元素</p>
</li>
<li><p>改善heap的效能可用</p>
<ul>
<li><p>敗者樹 可以改善選取最小項的常數項的Ｋ</p>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge0l4pvld7j31460ggwgt.jpg" alt="image-20200420202745772" style="zoom:50%;" />
</li>
<li><p>可用選擇-置換的方法　替換掉每組2G的平均分組，就減了少組數，也就是K的大小更小，跑起來更快；每條長度不等就是</p>
<p><a href="https://www.bilibili.com/video/av69423198/" target="_blank" rel="noopener">https://www.bilibili.com/video/av69423198/</a></p>
<ul>
<li>搭配最佳歸併樹，讓IO次數最少的==&gt;帶權路徑最小：Huffman Tree</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>之前write 过程的去重就是在merge过程将重复的key中老的数据去除就好了对吧。<ul>
<li>Yes</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="GFS-amp-BigTable"><a href="#GFS-amp-BigTable" class="headerlink" title="GFS &amp; BigTable"></a>GFS &amp; BigTable</h2><p>Disk vs Excel</p>
<h2 id="B-Tree-–-Balance-Tree"><a href="#B-Tree-–-Balance-Tree" class="headerlink" title="B+ Tree – Balance+ Tree"></a>B+ Tree – Balance+ Tree</h2><ul>
<li>BST 如果有10億數據怎辦？1Gx4Byte == 4GB<ul>
<li>一顆樹就要4GB，多棵樹肯定不行在內存，長期只能在disk</li>
<li>一次尋軌10ms</li>
<li>順序讀取 80MB/S</li>
</ul>
</li>
</ul>
<p>Methods:</p>
<ol>
<li><p>找一次就要4GB/80MB的時間，不可行</p>
</li>
<li><p>只讀取訪問路徑上的數，就是30多個元素 即 30x10ms = 300ms</p>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge0j7utyd2j314q0eogpr.jpg" alt="image-20200420210210409" style="zoom:67%;" />
</li>
<li><p>把二叉變多叉讓樹高降低！</p>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge0j9nfovbj31460ggk0s.jpg" alt="image-20200420210355659" style="zoom:67%;" />

<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200420211217773.png" alt="image-20200420211217773" style="zoom:67%;" />

<p>17是key, data是一堆的其他的feature；B-Tree 為了存硬盤中的數據設計</p>
</li>
<li><p>B+ </p>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200420211622972.png" alt="image-20200420211622972" style="zoom:67%;" />



</li>
</ol>
<h2 id="Bloom-Filter-vs-Hash-Table"><a href="#Bloom-Filter-vs-Hash-Table" class="headerlink" title="Bloom Filter vs Hash Table"></a>Bloom Filter vs Hash Table</h2><h3 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h3><img src="/Users/joe/Library/Application Support/typora-user-images/image-20200804213257638.png" alt="image-20200804213257638" style="zoom: 33%;" />

<ul>
<li>衝突時多是用拉鏈法</li>
</ul>
<h3 id="Bloom-Filter-1"><a href="#Bloom-Filter-1" class="headerlink" title="Bloom Filter"></a>Bloom Filter</h3><p>散射到二進制向量來，用一個很長的二進製向量</p>
<ul>
<li><p>eg，Int ==&gt; 32位二進製</p>
</li>
<li><p>空間、時間遠超過一般算法</p>
</li>
<li><p>說沒有時，一定沒有；說有時，不見得真的有</p>
<p>把不存在的先擋掉了，在後面要跟一個真正的db或是file就是文件存儲系統這類的權威機構</p>
</li>
</ul>
<h4 id="Case1"><a href="#Case1" class="headerlink" title="Case1"></a>Case1</h4><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghf42j9a9zj310m0ca44f.jpg" alt="image-20200804214226956" style="zoom:67%;" />

<h4 id="Case2"><a href="#Case2" class="headerlink" title="Case2"></a>Case2</h4><ul>
<li>他說有時，還是要去數據庫查詢一次看是不是真的在</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghf43yx4orj30u00ig44x.jpg" alt="image-20200804214352821" style="zoom:67%;" />

<h4 id="Case3"><a href="#Case3" class="headerlink" title="Case3"></a>Case3</h4><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghf4jy16hwj30vs0himz0.jpg" alt="image-20200804215814464"></p>
<h4 id="Case4"><a href="#Case4" class="headerlink" title="Case4"></a>Case4</h4><p>時間上強過 Trie, Hash, Array, LinkedList</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghf4playf0j31980u0are.jpg" alt="image-20200804220418586"></p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghf4o2uajsj31cc0oqtkd.jpg" alt="image-20200804220255205"></p>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200804220547109.png" alt="image-20200804220547109" style="zoom:67%;" />

<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><ol>
<li>比特幣<ul>
<li>Redis(內存的緩存，表示把元素暫存在內存，直接返回更快) VS BloomFilter</li>
<li><img src="/Users/joe/Library/Application Support/typora-user-images/image-20200804214916954.png" alt="image-20200804214916954" style="zoom:50%;" />
- 全節點
- SPV節點，sample payment verification，帳戶可以在這個節點很快判斷是否存在就用到BF
- ![image-20200804215035897](https://tva1.sinaimg.cn/large/007S8ZIlgy1ghf4ayb54mj30rw0gcdmb.jpg)
- 存在的話再去相應區塊找</li>
</ul>
</li>
<li>分布式系統</li>
</ol>
<p>一種數據結構，跟hash table類似，檢測一個元素在一個集合有沒有出現。</p>
<ul>
<li>區別在 BF 更省空間。Hash還是比較費內存。BloomFilter沒有鏈表，主要是用0/1數組，叫<strong>Bit Array</strong>，沒有鏈表操作，用到多個hash function。</li>
<li>Hash fn 也不是愈多愈好，這會讓0/1消耗愈快；一般取4~16個，有理論結果。</li>
<li>快速檢測一條紀錄有沒有在某一個大塊之中。</li>
<li>在big table中查大多時候都是沒在某一個小塊，不希望每個小塊都去查二分，小塊其實不小。</li>
<li>hash不是等長結構因為有linked list, 無法直接存出；BF可以存出去，就是個bit array了。</li>
</ul>
<p>當要在兩個超過內存的大file裡找交集的urls時，相比hash一長字串就可以節省很多很多空間；但可能小誤報啦。</p>
<p>正常是不删除的</p>
<ul>
<li><strong>Counting BF vs Standard BF</strong></li>
<li>數組動態膨脹，依據被標為1超過的比例；但BF不存key, 所以複製不過去，膨脹時就是新舊的bit array都要查。效率不是特別好。。短的話誤報率高</li>
</ul>
<blockquote>
<ul>
<li>一个bit 怎么做加法？<ul>
<li><strong>如果是 Counting bloom filter 的话，每一位就用 int 不用 bit 了。</strong></li>
</ul>
</li>
<li>Bloom filter自动膨胀的时候，能不能把原来的bit array丢掉，把所有数据全部拿来重算一遍？我不理解老师说的不能重算一遍这个点。<ul>
<li>不能。比如你把单词 hello world 放到 bloomfilter 里以后，得到的 bit array 是 <code>[1,0,0,1,0,1,0,0,0,0,1,0,0]</code>，难道你可以根据这些0和1反向推导出是 Hello 和 World 这两个单词么？BF 不可逆。</li>
</ul>
</li>
</ul>
</blockquote>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge0l4frsejj311m0fqgpt.jpg" alt="image-20200420214218446" style="zoom:50%;" />







<h2 id="跳跃表-Skip-List"><a href="#跳跃表-Skip-List" class="headerlink" title="跳跃表 Skip List"></a>跳跃表 Skip List</h2><img src="/Users/joe/Library/Application Support/typora-user-images/image-20200420215801422.png" alt="image-20200420215801422" style="zoom:67%;" />

<ul>
<li>為什麼要用跳表？<ul>
<li>是個有序鏈表</li>
<li>可提取一些元素，加一層引索</li>
</ul>
</li>
</ul>
<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200420220446625.png" alt="image-20200420220446625" style="zoom:67%;" />



<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge0l405klnj311m0fqgpt.jpg" alt="image-20200420220653019"></p>
<ul>
<li>本質是一個分層鏈錶</li>
</ul>
<h1 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h1><img src="/Users/joe/Library/Application Support/typora-user-images/image-20200420123257444.png" alt="image-20200420123257444" style="zoom:50%;" />

<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200420163656675.png" alt="image-20200420163656675" style="zoom:50%;" />

<img src="/Users/joe/Library/Application Support/typora-user-images/image-20200420163734278.png" alt="image-20200420163734278" style="zoom:50%;" />



</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/58/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/58/">58</a><span class="page-number current">59</span><a class="page-number" href="/page/60/">60</a><span class="space">&hellip;</span><a class="page-number" href="/page/73/">73</a><a class="extend next" rel="next" href="/page/60/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By Joe Huang</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>