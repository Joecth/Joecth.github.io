<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Joe Huang"><meta name="copyright" content="Joe Huang"><title>Awaken Desparado</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-180692466-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Joe Huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">395</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">26</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">69</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Awaken Desparado</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Awaken Desparado</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/30/Concurrency/2022-05-30%20High%20Traffic%20&amp;%20High%20Concurrency/">Concurrency/2022-05-30 High Traffic &amp; High Concurrency</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-30</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/Concurrency/">Concurrency</a></span><div class="content"><h1 id="High-Concurrency"><a href="#High-Concurrency" class="headerlink" title="High Concurrency"></a>High Concurrency</h1><p><img src="https://p.ipic.vip/oeedft.png" alt="image-20230530103719241"></p>
<h2 id="High-Concurrency-1"><a href="#High-Concurrency-1" class="headerlink" title="High Concurrency"></a>High Concurrency</h2><ul>
<li>System design faces the ultimate challenge of handling high-concurrency traffic.</li>
<li>System is divided into four layers, with the top layer experiencing the highest pressure and the bottom layer having the weakest capacity.</li>
<li>System architecture should be hierarchical, with flow control implemented at each level.</li>
</ul>
<h3 id="Service-Gateway-Layer"><a href="#Service-Gateway-Layer" class="headerlink" title="Service Gateway Layer:"></a>Service Gateway Layer:</h3><ul>
<li>Acts as the entry point for all user traffic and handles load balancing to distribute the load across multiple physical nodes.</li>
<li>Implements user authentication and rate limiting to filter out invalid traffic.</li>
<li>Includes security measures to protect against DDoS attacks.</li>
</ul>
<h3 id="Business-Layer"><a href="#Business-Layer" class="headerlink" title="Business Layer:"></a>Business Layer:</h3><ul>
<li>Provides various business functionalities to users.</li>
<li>Implements “separation of concerns” or “frontend-backend separation” to improve user interface rendering and user experience through page caching.</li>
<li>Receives user requests and delegates the relevant operations to backend service layer.</li>
<li>Uses asynchronous design and message queues to handle user requests, reducing the pressure on the service layer.</li>
<li>Implements circuit breaker mechanisms and service degradation to prevent system cascading failures.</li>
</ul>
<h3 id="Service-Layer"><a href="#Service-Layer" class="headerlink" title="Service Layer:"></a>Service Layer:</h3><ul>
<li>Handles business operations and database interactions.</li>
<li>Deploys on multiple nodes using cloud-based deployment for horizontal scaling to handle complex business operations.</li>
<li>Utilizes elastic scaling to automatically adjust the number of nodes based on the workload, reducing operational costs.</li>
<li>Implements service degradation by returning fallback data instead of querying the database under high pressure situations.</li>
<li>Uses distributed caching to alleviate pressure on the database.</li>
</ul>
<h3 id="Database-Layer"><a href="#Database-Layer" class="headerlink" title="Database Layer:"></a>Database Layer:</h3><ul>
<li>Implements read-write separation by separating production and query databases for optimized performance.</li>
<li>Implements sharding to distribute the write workload across multiple databases and mitigate disk I/O bottlenecks.</li>
<li>Utilizes NoSQL databases and big data platforms for data analysis and optimization.</li>
</ul>
<p><strong>高併發</strong></p>
<p>在面對億級流盤時，系統設計的每一個環節都是一個終極考驗，必預做到極致，我們通過分層將系統劃分成了四個</p>
<p>層次，然而這時我們發現，上層抗壓能力強，底層抗壓能力弱，形成了一個倒三角的態勢。因此，對於系統整體架</p>
<p>構來說，應當做到系統分層、逐級限流</p>
<p>在這四個層次中，最上層的服務網關，系統壓力是最大的，所有用戶壓力都要經過它。這時，服務網關首先要做的</p>
<p>是負載均衡，將所有壓力均勻地分布到許多物理節點上來共同扛佳壓力。然而，服務網關不能將所有的流量直接轉</p>
<p>發給下游，它常要通過限流，將最終有效的流量轉發給下游。因此，它常要用戶身份鑒權，陽止不合法的用戶流</p>
<p>量；還需要有限流措施，當業務流量超過系統設計能力時，將過載的那部分流量拒絕掉，以保護下游的穩定運行；</p>
<p>還需要有安全防護，保護系統免受DDos等互聯網攻擊。</p>
<p>接著就到了業務層，面向的是為用戶提供的各項業務功能。這個層次要承擔用戶界面繪制，展現UI界面，因此需</p>
<p>要”動靜分離”或”前後端分離〞，通過頁面緩存更加流暢地展現用戶界面，提高用戶體驗。同時，當用戶在界面中進</p>
<p>行各種操作時，由它來接收用戶請求，但不由它完成相關操作，而是調用後台服務層的服務去完成。所以，前端業</p>
<p>務層的抗壓能力是比較強的，而後端服務層的抗壓能力比較弱，因為它們除了完成各種業務操作，還要讀寫數據</p>
<p>庫。因此，業務層通過異步化設計，先受理用戶請求，然後發送給消息隊列。這樣的設計，既可以讓業務層獲得更</p>
<p>大的吞吐量，又可以降低服務層的壓力，讓服務層能從容地完成各項業務，當下游的服務層快扛不住流量壓力而大</p>
<p>量超時的時候，業務層通過熔斷機制及時進行」服務降級」來防止系統雪崩。</p>
<p>下游的服務層，除了要完成各種業務操作以外，還需要讀寫數據庫，因此讀寫數據庫成了它們最大的瓶頸。為了扛</p>
<p>住複雜業務給服務層帶來的系統壓力，服務層通過雲端部署，將業務分散於更多的節點中進行橫向擴容，從而扛街</p>
<p>業務壓力。通過雲平台的彈性可伸縮，當壓力大時自動擴展到更多節點，而當壓力小時自動收縮，就能很好地應對</p>
<p>互聯網壓力的彈性變化，從而降低系統的運營成本。</p>
<p>此外，服務層的最大瓶頸是對數據庫的讀寫。當系統壓力過大、數據庫扛不住時，服務層就會啓動服務降級。查詢</p>
<p>的服務降級，就是通過不查詢數據而返回兜底數據來降低數據庫壓力；寫操作的服務降級，就是不再去寫數據庫，</p>
<p>而是切換為寫Redis內存數據庫加異步寫庫，從而扛住系統壓力。此外，分布式緩存也是服務層降低數據庫壓力的</p>
<p>有效措施之一。</p>
<p>最後一層是抗壓能力最差的數據庫。通過讀寫分離將數據庫分為生產庫與查詢庫，分別予以系統優化；通過橫向、</p>
<p>縱向的數據分庫分散生產庫的寫入壓力，緩解磁盤1/0的瓶頸；通過NoSQL數據庫與大數據平台實現數據分析與查</p>
<p>詢的優化。這些都是解決數據層系統壓力、提升吞吐量的有效措施。</p>
<p>一主多從</p>
<p>表分庫抵抗寫的壓力，TIDB</p>
<p>TDB是一個開源的NewSQL資料庫，可作為mysq的從服務，作橫向分庫分表</p>
<h2 id="High-Availability"><a href="#High-Availability" class="headerlink" title="High Availability"></a>High Availability</h2><ul>
<li>System design should be able to tolerate single point failures.</li>
<li>Implement multiple data centers and utilize DNS round-robin for gateway access to ensure availability even if one data center goes down.</li>
<li>Service gateways should achieve high availability through load balancing (e.g. Nginx master-slave synchronization) and distribution across multiple gateways.</li>
<li>Application and service layers should deploy on multiple nodes using Kubernetes for cloud-based deployment.</li>
<li>Failed nodes should be replaced, and unfinished tasks should be transferred to other nodes through failover to maintain high availability.</li>
<li>Data nodes (caches, message queues, databases) should utilize master-slave replication for high availability.</li>
<li></li>
</ul>
<h2 id="High-Reliability"><a href="#High-Reliability" class="headerlink" title="High Reliability"></a>High Reliability</h2><ul>
<li>Ensure non-loss operation of data in high-concurrency systems.</li>
<li>Strengthen design to prevent data loss during automatic master-slave switching moments.</li>
<li>Move towards decentralized architectures to eliminate the distinction between master and slave nodes and enable data replication across multiple nodes.</li>
<li>Increase capacity or allow dynamic resource allocation to improve reliability.</li>
</ul>
<p><strong>高可用</strong></p>
<p>高可用要求，即使在面對高井發時個別節點宕機，整個系統對於用戶來說仍是可用的，用戶的所有請求都將予以逃</p>
<p>理，並最終反饋給用戶。在系統面對高併發時，任何一個節點任何時候都可能出現宕機。因此系統設計應當具備</p>
<p>“單點故障可容忍”的特性，並將該特性體現在系統設計的每一個環節。</p>
<p>首先，網關層在面對互聯網的時候，可能因為網絡故障而造成整個機房不可用。因此，系統建設必須是多機房，並</p>
<p>且通過DNS的輪詢實現多機房的訪問。這樣，即使一個機房出了問題，還有另一個機房可用。接著，服務網關也</p>
<p>要實現高可用，即首先保證負載均街的高可用（如Nginx的主從同步），然後負載到多個服務網關。這樣，即使一</p>
<p>個股務網關不可用，還有其他服務網關，系統依然保持高可用。</p>
<p>然後是應用層與服務層的高可用。通過Kubernetes雲端部香，每個服務都至少部零在兩個以上節點。如果系統運</p>
<p>行過程中一個節點不可用，那麼就在另一個地方再啓動一個節點。失效的那個節點沒有完成的任務，通過故障轉移</p>
<p>交給另一個節點，雖然會增加一點延遲，但任務最終會完成並返回給用戶，系統還是高可用的。</p>
<p>最後是數據節點，包括緩存、消息隊列、數據庫。這些節點的高可用主要是通過主從同步來實現的，當主節點失效</p>
<p>以後就會自動切換到從節點，將從節點升級為主節點，就能保證高可用。</p>
<p><strong>高可靠</strong></p>
<p>這裡的高可靠，特指數據的高可菲運行不丟失，這對於億級高併發系統來說也是非常重要的。在面對高併發壓力</p>
<p>時，個別節點宕機時常發生。但是，節點宕機而自動進行主從切換的瞬間，容易造成數據的丟失。因此，就需要通</p>
<p>過加強設計保證數據的可靠。問題多發生於主從切換，所以未來會越來越多地朝若「去中心化」”的設計發展，即未來</p>
<p>的集群不再有主從之分，或者互為主從，我備份你的數據的同時，你也在備份我的數據，實現數據的多節點複製。</p>
<p>有了這樣的機制，集群中即使某個節點失效，數據也不會丟失，就能更好地保障數據的高可靠運營。</p>
<p>可以多買capacity、或需要時，讓系統自己分配</p>
<h1 id="Second-Kill"><a href="#Second-Kill" class="headerlink" title="Second Kill"></a><strong>Second Kill</strong></h1><p>前端靜態、cache、</p>
<p>讀多寫少時別去db查，因為db的連接資源有限，用cache去擋</p>
<p><strong>cache iussue</strong></p>
<p>在redis放info，但這裡是不完全可靠的，用戶是要傳商品id，在redis裡被查</p>
<p><strong>cache</strong> <strong>擊穿</strong></p>
<p>後來又造成db掛、加鎖</p>
<p><strong>cache**</strong>預熱**</p>
<p><strong>cache**</strong>穿透**</p>
<p>加鎖的處理性能不好呀! 有無更好的解決方案？ –&gt; 布隆過濾器先查商品id看有沒有存在；但redis如果一更新，要跟著更新，這是個新議題</p>
<p><img src="https://p.ipic.vip/nzekgc.png" alt="image-20230530110803915"></p>
<h2 id="Redis分布式锁"><a href="#Redis分布式锁" class="headerlink" title="Redis分布式锁"></a>Redis分布式锁</h2><p>Ref: </p>
<p><a href="https://www.bilibili.com/video/BV1fk4y1p7na/?spm_id_from=333.999.0.0&vd_source=a446d08c42a016c121a1c8007fc3ce42" target="_blank" rel="noopener">亿级流量架构设计-高可用，高可靠_哔哩哔哩_bilibili</a></p>
<p><a href="https://www.bilibili.com/video/BV1dP411w7Wt/?spm_id_from=333.788&vd_source=a446d08c42a016c121a1c8007fc3ce42" target="_blank" rel="noopener">阿里三面：秒杀系统如何设计？竟然败在这题了。。。_哔哩哔哩_bilibili</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/29/Deeplearning/2022-05-29-AWS%20GPU%20usage/">Deeplearning/2022-05-29-AWS GPU usage</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-29</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/DevOps/">DevOps</a></span><div class="content"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2  sudo apt-get update</span><br><span class="line"> 3  wget https://developer.download.nvidia.com/compute/cuda/11.7.0/local_installers/cuda_11.7.0_515.43.04_linux.run	  </span><br><span class="line"> 6  sudo sh cuda_11.7.0_515.43.04_linux.run</span><br><span class="line">11  wget https://repo.anaconda.com/miniconda/Miniconda3-py39_4.12.0-Linux-x86_64.sh</span><br><span class="line">13  sh Miniconda3-py39_4.12.0-Linux-x86_64.sh</span><br><span class="line">16  vi ~/.bashrc	<span class="comment"># LD_LIBRARY_PATH=/usr/local/cuda-11.7/lib64</span></span><br><span class="line">18  <span class="built_in">source</span> ~/.bashrc</span><br><span class="line">19  conda create -n dl37 python=3.7 pip</span><br><span class="line">20  conda activate dl37</span><br><span class="line">21  pip3 install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu113</span><br><span class="line"><span class="comment"># 可看到 pytorch 2G，比 cuda還要大! 也是相當厲害…</span></span><br><span class="line">22  wget https://zh-v2.d2l.ai/d2l-zh.zip</span><br><span class="line">23  sudo apt-get install unzip</span><br><span class="line">33  pip install -U d2l jupyter</span><br><span class="line">34  jupyter notebook</span><br></pre></td></tr></table></figure>





<h2 id="jupyter-notebook"><a href="#jupyter-notebook" class="headerlink" title="jupyter notebook"></a>jupyter notebook</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i ~/.ssh/emr-key-A.pem -L8888:localhost:8888 ubuntu@ec2-54-159-193-111.compute-1.amazonaws.com</span><br></pre></td></tr></table></figure>





<h2 id="nvidia-smi"><a href="#nvidia-smi" class="headerlink" title="nvidia-smi"></a>nvidia-smi</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">(base) ubuntu@ip-192-168-81-198:~$ nvidia-smi</span><br><span class="line">Mon May 30 09:58:50 2022</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 515.43.04    Driver Version: 515.43.04    CUDA Version: 11.7     |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                               |                      |               MIG M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  Tesla T4            Off  | 00000000:00:1E.0 Off |                    0 |</span><br><span class="line">| N/A   32C    P0    27W /  70W |   2751MiB / 15360MiB |      0%      Default |</span><br><span class="line">|                               |                      |                  N/A |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line"></span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                  |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br><span class="line">|        ID   ID                                                   Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0   N/A  N/A     11902      C   ...nda3/envs/dl37/bin/python     2747MiB |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">(base) ubuntu@ip-192-168-81-198:~$ nvidia-smi</span><br><span class="line">Mon May 30 09:59:31 2022</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 515.43.04    Driver Version: 515.43.04    CUDA Version: 11.7     |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                               |                      |               MIG M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  Tesla T4            Off  | 00000000:00:1E.0 Off |                    0 |</span><br><span class="line">| N/A   33C    P0    27W /  70W |    335MiB / 15360MiB |      6%      Default |</span><br><span class="line">|                               |                      |                  N/A |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line"></span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                  |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br><span class="line">|        ID   ID                                                   Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0   N/A  N/A     12017      C   ...nda3/envs/dl37/bin/python      331MiB |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">(base) ubuntu@ip-192-168-81-198:~$ nvidia-smi</span><br><span class="line">Mon May 30 09:59:38 2022</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 515.43.04    Driver Version: 515.43.04    CUDA Version: 11.7     |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                               |                      |               MIG M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  Tesla T4            Off  | 00000000:00:1E.0 Off |                    0 |</span><br><span class="line">| N/A   37C    P0    79W /  70W |   2749MiB / 15360MiB |     98%      Default |</span><br><span class="line">|                               |                      |                  N/A |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line"></span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                  |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br><span class="line">|        ID   ID                                                   Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0   N/A  N/A     12017      C   ...nda3/envs/dl37/bin/python     2745MiB |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">(base) ubuntu@ip-192-168-81-198:~$ nvidia-smi</span><br><span class="line">Mon May 30 09:59:42 2022</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 515.43.04    Driver Version: 515.43.04    CUDA Version: 11.7     |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                               |                      |               MIG M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  Tesla T4            Off  | 00000000:00:1E.0 Off |                    0 |</span><br><span class="line">| N/A   38C    P0    68W /  70W |   2749MiB / 15360MiB |     97%      Default |</span><br><span class="line">|                               |                      |                  N/A |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line"></span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                  |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br><span class="line">|        ID   ID                                                   Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0   N/A  N/A     12017      C   ...nda3/envs/dl37/bin/python     2745MiB |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>





<h2 id="InfoGPU"><a href="#InfoGPU" class="headerlink" title="InfoGPU"></a>InfoGPU</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line">torch.cuda.current_device()</span><br><span class="line">torch.cuda.device_count()</span><br><span class="line">torch.cuda.get_device_name(<span class="number">0</span>)</span><br><span class="line">torch.cuda.is_available()</span><br></pre></td></tr></table></figure>

<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38arz9jvxj20u00ue42e.jpg" alt="image-20220530192309711" style="zoom:50%;" />

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>torch.version.cuda</span><br><span class="line"><span class="string">'11.3'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2qots3vvfj213c0ac3zt.jpg" alt="image-20220530200847113" style="zoom:50%;" />

<p>​                </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dl37rmbg) ubuntu@ip<span class="number">-192</span><span class="number">-168</span><span class="number">-81</span><span class="number">-198</span>:~/codes/rm-bg-test$ pip list | grep onnx</span><br><span class="line">onnxruntime                  <span class="number">1.11</span><span class="number">.1</span></span><br><span class="line">(dl37rmbg) ubuntu@ip<span class="number">-192</span><span class="number">-168</span><span class="number">-81</span><span class="number">-198</span>:~/codes/rm-bg-test$</span><br></pre></td></tr></table></figure>





<h3 id="Before"><a href="#Before" class="headerlink" title="Before"></a>Before</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"> * Debug mode: off</span><br><span class="line">2022-05-30 12:01:59 INFO      * Running on all addresses (0.0.0.0)</span><br><span class="line">   WARNING: This is a development server. Do not use it in a production deployment.</span><br><span class="line"> * Running on http://127.0.0.1:5005</span><br><span class="line"> * Running on http://192.168.81.198:5005 (Press CTRL+C to quit)</span><br><span class="line">2022-05-30 12:02:06 INFO     49.216.44.45 - - [30/May/2022 12:02:06] "GET / HTTP/1.1" 200 -</span><br><span class="line">2022-05-30 12:02:06 INFO     49.216.44.45 - - [30/May/2022 12:02:06] "GET /favicon.ico HTTP/1.1" 404 -</span><br><span class="line">2022-05-30 12:02:14 INFO     49.216.44.45 - - [30/May/2022 12:02:14] "OPTIONS /predict/u2 HTTP/1.1" 200 -</span><br><span class="line">2022-05-30 12:02:15 INFO     Using algorithm -- u2</span><br><span class="line">2022-05-30 12:02:15 INFO     in get_prediction!!!!</span><br><span class="line">2022-05-30 12:02:15 INFO     dict_keys(['image'])</span><br><span class="line">2022-05-30 12:02:15 INFO     Time spent for successfully uploaded usr img img4predict_20220530-12:02:15.jpeg to S3 : 0.7874946594238281</span><br><span class="line">2022-05-30 12:02:15 INFO     Acquiring U2 Lock... Waiting...</span><br><span class="line">2022-05-30 12:02:15 INFO     Time spent for Acquiring U2 Lock: 6.9141387939453125e-06</span><br><span class="line">2022-05-30 12:02:15 INFO     Start predicting with U2</span><br><span class="line">2022-05-30 12:02:15 INFO     Acquired Lock for U2!</span><br><span class="line">2022-05-30 12:02:15 INFO     Time spent for reading image from S3 by cv2! : 0.06653761863708496</span><br><span class="line">Downloading...</span><br><span class="line">From: https://drive.google.com/uc?id=1tCU5MM1LhRgGou5OpmpjBQbSrYIUoYab</span><br><span class="line">To: /home/ubuntu/.u2net/u2net.onnx</span><br><span class="line"><span class="meta">100%</span><span class="bash">|████████████████████████████████████████████| 176M/176M [00:01&lt;00:00, 104MB/s]</span></span><br><span class="line">2022-05-30 12:02:19 INFO     &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Time spent for U2 model.detect: 3.3960742950439453</span><br><span class="line">2022-05-30 12:02:19 INFO     Time spent for U2: 3.4032671451568604</span><br><span class="line">2022-05-30 12:02:19 INFO     uploaded_name: removed_back_U2_20220530-12:02:15.png</span><br><span class="line">2022-05-30 12:02:19 INFO     Time spent for upload_file to S3: 0.09176993370056152</span><br><span class="line">2022-05-30 12:02:19 INFO     &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Time spent for U2 model: 3.5619876384735107</span><br><span class="line">2022-05-30 12:02:19 INFO     Released Lock for U2!</span><br><span class="line">2022-05-30 12:02:19 INFO     49.216.44.45 - - [30/May/2022 12:02:19] "POST /predict/u2 HTTP/1.1" 200 -</span><br><span class="line">2022-05-30 12:02:37 INFO     49.216.44.45 - - [30/May/2022 12:02:37] "OPTIONS /predict/u2 HTTP/1.1" 200 -</span><br><span class="line">2022-05-30 12:02:37 INFO     Using algorithm -- u2</span><br><span class="line">2022-05-30 12:02:37 INFO     in get_prediction!!!!</span><br><span class="line">2022-05-30 12:02:40 INFO     dict_keys(['image'])</span><br><span class="line">2022-05-30 12:02:41 INFO     Time spent for successfully uploaded usr img img4predict_20220530-12:02:40.jpeg to S3 : 3.314974784851074</span><br><span class="line">2022-05-30 12:02:41 INFO     Acquiring U2 Lock... Waiting...</span><br><span class="line">2022-05-30 12:02:41 INFO     Time spent for Acquiring U2 Lock: 5.245208740234375e-06</span><br><span class="line">2022-05-30 12:02:41 INFO     Start predicting with U2</span><br><span class="line">2022-05-30 12:02:41 INFO     Acquired Lock for U2!</span><br><span class="line">2022-05-30 12:02:41 INFO     Time spent for reading image from S3 by cv2! : 0.13377881050109863</span><br><span class="line">2022-05-30 12:02:43 INFO     &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Time spent for U2 model.detect: 2.55837082862854</span><br><span class="line">2022-05-30 12:02:43 INFO     Time spent for U2: 2.6617114543914795</span><br><span class="line">2022-05-30 12:02:43 INFO     uploaded_name: removed_back_U2_20220530-12:02:40.png</span><br><span class="line">2022-05-30 12:02:44 INFO     Time spent for upload_file to S3: 0.1535935401916504</span><br><span class="line">2022-05-30 12:02:44 INFO     &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Time spent for U2 model: 2.9496042728424072</span><br><span class="line">2022-05-30 12:02:44 INFO     Released Lock for U2!</span><br><span class="line">2022-05-30 12:02:44 INFO     49.216.44.45 - - [30/May/2022 12:02:44] "POST /predict/u2 HTTP/1.1" 200 -</span><br><span class="line">2022-05-30 12:04:49 INFO     49.216.44.45 - - [30/May/2022 12:04:49] "OPTIONS /predict/u2 HTTP/1.1" 200 -</span><br><span class="line">2022-05-30 12:04:49 INFO     Using algorithm -- u2</span><br><span class="line">2022-05-30 12:04:49 INFO     in get_prediction!!!!</span><br><span class="line">2022-05-30 12:04:51 INFO     dict_keys(['image'])</span><br><span class="line">2022-05-30 12:04:52 INFO     Time spent for successfully uploaded usr img img4predict_20220530-12:04:51.jpeg to S3 : 2.766263723373413</span><br><span class="line">2022-05-30 12:04:52 INFO     Acquiring U2 Lock... Waiting...</span><br><span class="line">2022-05-30 12:04:52 INFO     Time spent for Acquiring U2 Lock: 6.67572021484375e-06</span><br><span class="line">2022-05-30 12:04:52 INFO     Start predicting with U2</span><br><span class="line">2022-05-30 12:04:52 INFO     Acquired Lock for U2!</span><br><span class="line">2022-05-30 12:04:52 INFO     Time spent for reading image from S3 by cv2! : 0.07762646675109863</span><br><span class="line">2022-05-30 12:04:54 INFO     &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Time spent for U2 model.detect: 1.9941890239715576</span><br><span class="line">2022-05-30 12:04:54 INFO     Time spent for U2: 2.0525596141815186</span><br><span class="line">2022-05-30 12:04:54 INFO     uploaded_name: removed_back_U2_20220530-12:04:51.png</span><br><span class="line">2022-05-30 12:04:54 INFO     Time spent for upload_file to S3: 0.11681175231933594</span><br><span class="line">2022-05-30 12:04:54 INFO     &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Time spent for U2 model: 2.2475361824035645</span><br><span class="line">2022-05-30 12:04:54 INFO     Released Lock for U2!</span><br><span class="line">2022-05-30 12:04:54 INFO     49.216.44.45 - - [30/May/2022 12:04:54] "POST /predict/u2 HTTP/1.1" 200 -</span><br></pre></td></tr></table></figure>



<h3 id="After"><a href="#After" class="headerlink" title="After"></a>After</h3><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2qoyzgd0cj20xo0d876d.jpg" alt="image-20220530201339682" style="zoom:50%;" />

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> * Debug mode: off</span><br><span class="line">2022-05-30 12:14:18 INFO      * Running on all addresses (0.0.0.0)</span><br><span class="line">   WARNING: This is a development server. Do not use it in a production deployment.</span><br><span class="line"> * Running on http://127.0.0.1:5005</span><br><span class="line"> * Running on http://192.168.81.198:5005 (Press CTRL+C to quit)</span><br><span class="line">2022-05-30 12:14:59 INFO     49.216.44.45 - - [30/May/2022 12:14:59] "OPTIONS /predict/u2 HTTP/1.1" 200 -</span><br><span class="line">2022-05-30 12:15:00 INFO     Using algorithm -- u2</span><br><span class="line">2022-05-30 12:15:00 INFO     in get_prediction!!!!</span><br><span class="line">2022-05-30 12:15:02 INFO     dict_keys(['image'])</span><br><span class="line">2022-05-30 12:15:03 INFO     Time spent for successfully uploaded usr img img4predict_20220530-12:15:02.jpeg to S3 : 3.0525119304656982</span><br><span class="line">2022-05-30 12:15:03 INFO     Acquiring U2 Lock... Waiting...</span><br><span class="line">2022-05-30 12:15:03 INFO     Time spent for Acquiring U2 Lock: 6.198883056640625e-06</span><br><span class="line">2022-05-30 12:15:03 INFO     Start predicting with U2</span><br><span class="line">2022-05-30 12:15:03 INFO     Acquired Lock for U2!</span><br><span class="line">2022-05-30 12:15:03 INFO     Time spent for reading image from S3 by cv2! : 0.10718274116516113</span><br><span class="line">2022-05-30 12:15:03.755888640 [W:onnxruntime:Default, onnxruntime_pybind_state.cc:526 CreateExecutionProviderInstance] Failed to create TensorrtExecutionProvider. Please reference https://onnxruntime.ai/docs/execution-providers/TensorRT-ExecutionProvider.html#requirements to ensure all dependencies are met.</span><br><span class="line">2022-05-30 12:15:03.755924162 [W:onnxruntime:Default, onnxruntime_pybind_state.cc:552 CreateExecutionProviderInstance] Failed to create CUDAExecutionProvider. Please reference https://onnxruntime.ai/docs/reference/execution-providers/CUDA-ExecutionProvider.html#requirements to ensure all dependencies are met.</span><br><span class="line">2022-05-30 12:15:05 INFO     &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Time spent for U2 model.detect: 2.503098249435425</span><br><span class="line">2022-05-30 12:15:05 INFO     Time spent for U2: 2.5608794689178467</span><br><span class="line">2022-05-30 12:15:05 INFO     uploaded_name: removed_back_U2_20220530-12:15:02.png</span><br><span class="line">2022-05-30 12:15:05 INFO     Time spent for upload_file to S3: 0.0716698169708252</span><br><span class="line">2022-05-30 12:15:05 INFO     &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Time spent for U2 model: 2.740231990814209</span><br><span class="line">2022-05-30 12:15:05 INFO     Released Lock for U2!</span><br><span class="line">2022-05-30 12:15:05 INFO     49.216.44.45 - - [30/May/2022 12:15:05] "POST /predict/u2 HTTP/1.1" 200 -</span><br><span class="line">2022-05-30 12:15:50 INFO     49.216.44.45 - - [30/May/2022 12:15:50] "OPTIONS /predict/u2 HTTP/1.1" 200 -</span><br><span class="line">2022-05-30 12:15:50 INFO     Using algorithm -- u2</span><br><span class="line">2022-05-30 12:15:50 INFO     in get_prediction!!!!</span><br><span class="line">2022-05-30 12:15:53 INFO     dict_keys(['image'])</span><br><span class="line">2022-05-30 12:15:53 INFO     Time spent for successfully uploaded usr img img4predict_20220530-12:15:53.jpeg to S3 : 2.71683931350708</span><br><span class="line">2022-05-30 12:15:53 INFO     Acquiring U2 Lock... Waiting...</span><br><span class="line">2022-05-30 12:15:53 INFO     Time spent for Acquiring U2 Lock: 6.67572021484375e-06</span><br><span class="line">2022-05-30 12:15:53 INFO     Start predicting with U2</span><br><span class="line">2022-05-30 12:15:53 INFO     Acquired Lock for U2!</span><br><span class="line">2022-05-30 12:15:53 INFO     Time spent for reading image from S3 by cv2! : 0.09477829933166504</span><br><span class="line">2022-05-30 12:15:54.261673705 [W:onnxruntime:Default, onnxruntime_pybind_state.cc:526 CreateExecutionProviderInstance] Failed to create TensorrtExecutionProvider. Please reference https://onnxruntime.ai/docs/execution-providers/TensorRT-ExecutionProvider.html#requirements to ensure all dependencies are met.</span><br><span class="line">2022-05-30 12:15:54.261700073 [W:onnxruntime:Default, onnxruntime_pybind_state.cc:552 CreateExecutionProviderInstance] Failed to create CUDAExecutionProvider. Please reference https://onnxruntime.ai/docs/reference/execution-providers/CUDA-ExecutionProvider.html#requirements to ensure all dependencies are met.</span><br><span class="line">2022-05-30 12:15:55 INFO     &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Time spent for U2 model.detect: 1.9362876415252686</span><br><span class="line">2022-05-30 12:15:55 INFO     Time spent for U2: 2.035747528076172</span><br><span class="line">2022-05-30 12:15:55 INFO     uploaded_name: removed_back_U2_20220530-12:15:53.png</span><br><span class="line">2022-05-30 12:15:56 INFO     Time spent for upload_file to S3: 0.16250967979431152</span><br><span class="line">2022-05-30 12:15:56 INFO     &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Time spent for U2 model: 2.2935831546783447</span><br><span class="line">2022-05-30 12:15:56 INFO     Released Lock for U2!</span><br><span class="line">2022-05-30 12:15:56 INFO     49.216.44.45 - - [30/May/2022 12:15:56] "POST /predict/u2 HTTP/1.1" 200 -</span><br></pre></td></tr></table></figure>

<h4 id="To-be-Debugged…"><a href="#To-be-Debugged…" class="headerlink" title="To be Debugged…"></a>To be Debugged…</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(dl37) ubuntu@ip-192-168-81-198:~/codes/rm-bg-test$ nvcc</span><br><span class="line">Command 'nvcc' not found, but can be installed with:</span><br><span class="line">sudo apt install nvidia-cuda-toolkit</span><br><span class="line">(dl37) ubuntu@ip-192-168-81-198:~/codes/rm-bg-test$ sudo apt install nvidia-cuda-toolkit</span><br></pre></td></tr></table></figure>

<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2qwhz0066j21bg0r6wk6.jpg" alt="image-20220531003424795" style="zoom:50%;" />



<p>still issue:</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2qxq59vu7j21l60u0q9d.jpg" alt="image-20220531011651588"></p>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2ribc6nnkj21jl0u0tdh.jpg" alt="image-20220531130858981" style="zoom:80%;" />





<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2rrsnyp4cj22280pgtev.jpg" alt="image-20220531183707169" style="zoom:67%;" />





<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38as3hkw7j20zq03swet.jpg" alt="image-20220601201815869" style="zoom:70%;" />



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38as53kxxj21om0te0z5.jpg" alt="image-20220602130731483" style="zoom:67%;" />





<h3 id="Fixed"><a href="#Fixed" class="headerlink" title="Fixed!"></a>Fixed!</h3><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2tuku93g7j21a70u0n2c.jpg" alt="image-20220602134439595"  />



<h3 id="T4-8TFLOPS"><a href="#T4-8TFLOPS" class="headerlink" title="T4: 8TFLOPS"></a>T4: 8TFLOPS</h3><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38as95071j20ws0f80tt.jpg" alt="image-20220530175459347" style="zoom:50%;" />





<p>vs </p>
<h2 id="Desktop"><a href="#Desktop" class="headerlink" title="Desktop"></a>Desktop</h2><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38asbbp5qj21060u041a.jpg" alt="image-20220530190225031" style="zoom:67%;" />



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2qmxf3k38j213g0mmwg7.jpg" alt="image-20220530190314249" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38asf5hnbj215e0l4q7e.jpg" alt="image-20220530190425812" style="zoom:67%;" />

<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38ash054dj20zy0l6juc.jpg" alt="image-20220530190343502" style="zoom:67%;" />





<h2 id="Others-白嫖平台"><a href="#Others-白嫖平台" class="headerlink" title="Others 白嫖平台"></a>Others 白嫖平台</h2><p>Colab</p>
<p>Kabble</p>
<p>AI Studio</p>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2qn0jg4rhj21090u0din.jpg" alt="image-20220530190615177" style="zoom:67%;" />







<p>ref: <a href="https://www.bilibili.com/video/BV1MA411L78X?t=493" target="_blank" rel="noopener">https://www.bilibili.com/video/BV1MA411L78X?t=493</a></p>
<h2 id="CUDAs"><a href="#CUDAs" class="headerlink" title="CUDAs"></a>CUDAs</h2><p>2</p>
<p><code>torch.version.cuda</code> is just defined as a string. It doesn’t query anything. It doesn’t tell you which version of CUDA you have installed. It only tells you that the PyTorch you have installed is meant for that (<code>10.2</code>) version of CUDA. But the version of CUDA you are actually running on your system is <code>11.4</code>.</p>
<p>If you installed PyTorch with, say,</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install pytorch torchvision torchaudio cudatoolkit=<span class="number">11.1</span> -c pytorch -c nvidia</span><br></pre></td></tr></table></figure>

<p>then you should also have the necessary libraries (<code>cudatoolkit</code>) in your Anaconda directory, which may be different from your system-level libraries.</p>
<p>However, note that these depend on the NVIDIA display drivers:</p>
<p><a href="https://i.stack.imgur.com/lKSLg.png" target="_blank" rel="noopener"><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2qxb8m3snj20dw0auwf5.jpg" alt="enter image description here"></a></p>
<p>Installing <code>cudatoolkit</code> does not install the drivers (<code>nvidia.ko</code>), which you need to install separately on your system.</p>
<p><a href="https://stackoverflow.com/questions/69497328/why-are-torch-version-cuda-and-devicequery-reporting-different-versions" target="_blank" rel="noopener">https://stackoverflow.com/questions/69497328/why-are-torch-version-cuda-and-devicequery-reporting-different-versions</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/28/ParallelProg/Parallel%20Acceleration%20--%20Laws%20&amp;%20PerfStat%20&amp;%20AVX/">ParallelProg/Parallel Acceleration -- Laws &amp; PerfStat &amp; AVX</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-28</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SIMD/">SIMD</a></span><div class="content"><p>Numerical Algs –&gt; Optimizing for Performance –&gt; Writing Parallel Algs</p>
<h1 id="Law"><a href="#Law" class="headerlink" title="Law"></a>Law</h1><h2 id="1-Amdahl’s-Law"><a href="#1-Amdahl’s-Law" class="headerlink" title="1. Amdahl’s Law"></a>1. Amdahl’s Law</h2><p>   阿姆达尔定律是一个计算机科学界的经验法则，因IBM公司计算机架构师吉恩·阿姆达尔而得名。吉恩·阿姆达尔在1967年发表的论文中提出了这个重要定律。<br>   阿姆达尔定律主要用于发现仅仅系统的部分得到改进，整体系统可以得到的最大期望改进。它经常用于并行计算领域，用来预测适用多个处理器时理论上的最大加速比。在我们的性能调优领域，我们利用此定律有助于我们解决或者缓解性能瓶颈问题。<br>   阿姆达尔定律的模型阐释了我们现实生产中串行资源争用时候的现象。如下图模型，一个系统中，不可避免有一些资源必须串行访问，这限制了我们的加速比，即使我们增加了并发数（横轴），但取得效果并不理想，难以获得线性扩展能力(图中直线)。</p>
<h2 id="2-Gustafson’s-Law"><a href="#2-Gustafson’s-Law" class="headerlink" title="2. Gustafson’s Law"></a>2. Gustafson’s Law</h2><p>   Gustafson定律(Gustafson’s law)阐述了数据并行带来的影响。Gustafson 定律是由 John L. Gustafson 在1988年提出的。是并行计算领域除了 Amdahl 定律之后又一个重要定律。Gustafson定律看待加速比的角度会有所不同，其站在对于大量数据流处理过程中，针对重复工作的分布式运算带来的加速特性，而不仅仅局限在一个单一的程序进程&amp;单一的计算机上，串行的部分主要在于数据的分配预处理以及计算结果的收集汇总处理上。</p>
<p>compiler optimization </p>
<p>Options: -O1~ -O3, Ofast</p>
<p><img src="https://p.ipic.vip/qb9bbd.png" alt="image-20230606203406991"></p>
<p><img src="https://p.ipic.vip/8gn0if.png" alt="image-20230606203539104"></p>
<p><img src="https://p.ipic.vip/njwuzm.png" alt="Visual representation of latencies"></p>
<p>Pipeline and HW oriented Design</p>
<ul>
<li>sudo apt install linux-tools-generic</li>
</ul>
<h1 id="Perf-Stat"><a href="#Perf-Stat" class="headerlink" title="Perf Stat"></a>Perf Stat</h1><p>Branch prediction failed if unpredictable pattern in code would make the task-clock longer</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">(venv-py311) jo@fossa4gb:~/repo/V10793_C/Section 3/video2$ sudo perf <span class="built_in">stat</span> ./spec</span><br><span class="line"></span><br><span class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">'./spec'</span>:</span><br><span class="line"></span><br><span class="line">            342.40 msec task-clock                <span class="comment">#    0.996 CPUs utilized          </span></span><br><span class="line">                16      context-switches          <span class="comment">#    0.047 K/sec                  </span></span><br><span class="line">                 0      cpu-migrations            <span class="comment">#    0.000 K/sec                  </span></span><br><span class="line">             19574      page-faults               <span class="comment">#    0.057 M/sec                  </span></span><br><span class="line">   &lt;not supported&gt;      cycles                                                      </span><br><span class="line">   &lt;not supported&gt;      instructions                                                </span><br><span class="line">   &lt;not supported&gt;      branches                                                    </span><br><span class="line">   &lt;not supported&gt;      branch-misses                                               </span><br><span class="line"></span><br><span class="line">       0.343925345 seconds time elapsed</span><br><span class="line"></span><br><span class="line">       0.243236000 seconds user</span><br><span class="line">       0.099686000 seconds sys</span><br><span class="line">       </span><br><span class="line">(venv-py311) jo@fossa4gb:~/repo/V10793_C/Section 3/video2$ sudo perf <span class="built_in">stat</span> ./spec2</span><br><span class="line"></span><br><span class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">'./spec2'</span>:</span><br><span class="line"></span><br><span class="line">            465.56 msec task-clock                <span class="comment">#    0.986 CPUs utilized          </span></span><br><span class="line">                53      context-switches          <span class="comment">#    0.114 K/sec                  </span></span><br><span class="line">                 2      cpu-migrations            <span class="comment">#    0.004 K/sec                  </span></span><br><span class="line">             19574      page-faults               <span class="comment">#    0.042 M/sec                  </span></span><br><span class="line">   &lt;not supported&gt;      cycles                                                      </span><br><span class="line">   &lt;not supported&gt;      instructions                                                </span><br><span class="line">   &lt;not supported&gt;      branches                                                    </span><br><span class="line">   &lt;not supported&gt;      branch-misses                                               </span><br><span class="line"></span><br><span class="line">       0.472287268 seconds time elapsed</span><br><span class="line"></span><br><span class="line">       0.348851000 seconds user</span><br><span class="line">       0.117635000 seconds sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(j=0;j&lt;MAX;j++) &#123;</span><br><span class="line">        // i = rand() % 3;</span><br><span class="line">        i = j % 3;      //spec1</span><br><span class="line">        i = rand() % 3; //spec2</span><br><span class="line">        switch(i) &#123;</span><br></pre></td></tr></table></figure>



<ul>
<li>unroll also makes faster</li>
</ul>
<h1 id="AVX"><a href="#AVX" class="headerlink" title="AVX"></a>AVX</h1><p><a href="https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html" target="_blank" rel="noopener">Intel® Intrinsics Guide</a></p>
<p>x86 SIMD History</p>
<ul>
<li>MMX-SSE4 (1997-2006)<br>O Early SIMD was integer-only, later extended to floating point</li>
<li>AVX (2008)<br>O 128 and 256 bit SIMD instructions with 16 new registers</li>
<li>AVX2 (2013)<br>O Introduced with Haswell, extends AVX to 256 bit, adds FMA</li>
<li>AVX-512 (2015)<br>O Originally in Xeon Phi KNL, extended to Skylake+: 512 bit extensions</li>
</ul>
<p><img src="https://p.ipic.vip/s60b9d.png" alt="image-20230606211435215"></p>
<p>Explore caches, branching, and memory speeds</p>
<p>Superscalar &amp; pipelining</p>
<p>Staying out of the compiler’s way</p>
<p>Vectorization code</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/28/ParallelProg/SIMD%20on%20x86_64/">ParallelProg/SIMD on x86_64</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-28</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SIMD/">SIMD</a></span><div class="content"><h1 id="SIMD-on-X86-64"><a href="#SIMD-on-X86-64" class="headerlink" title="SIMD on X86_64"></a>SIMD on X86_64</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">/content/drive/MyDrive/mySIMD<span class="comment"># lscpu </span></span><br><span class="line">Architecture:                    x86_64</span><br><span class="line">CPU op-mode(s):                  32-bit, 64-bit</span><br><span class="line">Byte Order:                      Little Endian</span><br><span class="line">Address sizes:                   46 bits physical, 48 bits virtual</span><br><span class="line">CPU(s):                          2</span><br><span class="line">On-line CPU(s) list:             0,1</span><br><span class="line">Thread(s) per core:              2</span><br><span class="line">Core(s) per socket:              1</span><br><span class="line">Socket(s):                       1</span><br><span class="line">NUMA node(s):                    1</span><br><span class="line">Vendor ID:                       GenuineIntel</span><br><span class="line">CPU family:                      6</span><br><span class="line">Model:                           79</span><br><span class="line">Model name:                      Intel(R) Xeon(R) CPU @ 2.20GHz</span><br><span class="line">Stepping:                        0</span><br><span class="line">CPU MHz:                         2199.998</span><br><span class="line">BogoMIPS:                        4399.99</span><br><span class="line">Hypervisor vendor:               KVM</span><br><span class="line">Virtualization <span class="built_in">type</span>:             full</span><br><span class="line">L1d cache:                       32 KiB</span><br><span class="line">L1i cache:                       32 KiB</span><br><span class="line">L2 cache:                        256 KiB</span><br><span class="line">L3 cache:                        55 MiB</span><br><span class="line">NUMA node0 CPU(s):               0,1</span><br><span class="line">Vulnerability Itlb multihit:     Not affected</span><br><span class="line">Vulnerability L1tf:              Mitigation; PTE Inversion</span><br><span class="line">Vulnerability Mds:               Vulnerable; SMT Host state unknown</span><br><span class="line">Vulnerability Meltdown:          Vulnerable</span><br><span class="line">Vulnerability Mmio stale data:   Vulnerable</span><br><span class="line">Vulnerability Retbleed:          Vulnerable</span><br><span class="line">Vulnerability Spec store bypass: Vulnerable</span><br><span class="line">Vulnerability Spectre v1:        Vulnerable: __user pointer sanitization and usercopy </span><br><span class="line">                                 barriers only; no swapgs barriers</span><br><span class="line">Vulnerability Spectre v2:        Vulnerable, IBPB: disabled, STIBP: disabled, PBRSB-eI</span><br><span class="line">                                 BRS: Not affected</span><br><span class="line">Vulnerability Srbds:             Not affected</span><br><span class="line">Vulnerability Tsx async abort:   Vulnerable</span><br><span class="line">Flags:                           fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge </span><br><span class="line">                                 mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht sy</span><br><span class="line">                                 scall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl</span><br><span class="line">                                  xtopology nonstop_tsc cpuid tsc_known_freq pni pclmu</span><br><span class="line">                                 lqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe p</span><br><span class="line">                                 opcnt aes xsave avx f16c rdrand hypervisor lahf_lm ab</span><br><span class="line">                                 m 3dnowprefetch invpcid_single ssbd ibrs ibpb stibp f</span><br><span class="line">                                 sgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpc</span><br><span class="line">                                 id rtm rdseed adx smap xsaveopt arat md_clear arch_ca</span><br><span class="line">                                 pabilities</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># gcc -march=native -c -Q --help=target</span></span><br><span class="line">The following options are target specific:</span><br><span class="line">  -m128bit-long-double                  [enabled]</span><br><span class="line">  -m16                                  [disabled]</span><br><span class="line">  -m32                                  [disabled]</span><br><span class="line">  -m3dnow                               [disabled]</span><br><span class="line">  -m3dnowa                              [disabled]</span><br><span class="line">  -m64                                  [enabled]</span><br><span class="line">  -m80387                               [enabled]</span><br><span class="line">  -m8bit-idiv                           [disabled]</span><br><span class="line">  -m96bit-long-double                   [disabled]</span><br><span class="line">  -mabi=                                sysv</span><br><span class="line">  -mabm                                 [enabled]</span><br><span class="line">  -maccumulate-outgoing-args            [disabled]</span><br><span class="line">  -maddress-mode=                       long</span><br><span class="line">  -madx                                 [enabled]</span><br><span class="line">  -maes                                 [enabled]</span><br><span class="line">  -malign-data=                         compat</span><br><span class="line">  -malign-double                        [disabled]</span><br><span class="line">  -malign-functions=                    0</span><br><span class="line">  -malign-jumps=                        0</span><br><span class="line">  -malign-loops=                        0</span><br><span class="line">  -malign-stringops                     [enabled]</span><br><span class="line">  -mandroid                             [disabled]</span><br><span class="line">  -march=                               broadwell</span><br><span class="line">  -masm=                                att</span><br><span class="line">  -mavx                                 [enabled]</span><br><span class="line">  -mavx2                                [enabled]</span><br><span class="line">  -mavx256-split-unaligned-load         [disabled]</span><br><span class="line">  -mavx256-split-unaligned-store        [disabled]</span><br><span class="line">  -mavx5124fmaps                        [disabled]</span><br><span class="line">  -mavx5124vnniw                        [disabled]</span><br><span class="line">  -mavx512bitalg                        [disabled]</span><br><span class="line">  -mavx512bw                            [disabled]</span><br><span class="line">  -mavx512cd                            [disabled]</span><br><span class="line">  -mavx512dq                            [disabled]</span><br><span class="line">  -mavx512er                            [disabled]</span><br><span class="line">  -mavx512f                             [disabled]</span><br><span class="line">  -mavx512ifma                          [disabled]</span><br><span class="line">  -mavx512pf                            [disabled]</span><br><span class="line">  -mavx512vbmi                          [disabled]</span><br><span class="line">  -mavx512vbmi2                         [disabled]</span><br><span class="line">  -mavx512vl                            [disabled]</span><br><span class="line">  -mavx512vnni                          [disabled]</span><br><span class="line">  -mavx512vpopcntdq                     [disabled]</span><br><span class="line">  -mbionic                              [disabled]</span><br><span class="line">  -mbmi                                 [enabled]</span><br><span class="line">  -mbmi2                                [enabled]</span><br><span class="line">  -mbranch-cost=&lt;0,5&gt;                   3</span><br><span class="line">  -mcall-ms2sysv-xlogues                [disabled]</span><br><span class="line">  -mcet-switch                          [disabled]</span><br><span class="line">  -mcld                                 [disabled]</span><br><span class="line">  -mcldemote                            [disabled]</span><br><span class="line">  -mclflushopt                          [disabled]</span><br><span class="line">  -mclwb                                [disabled]</span><br><span class="line">  -mclzero                              [disabled]</span><br><span class="line">  -mcmodel=                             [default]</span><br><span class="line">  -mcpu=                      </span><br><span class="line">  -mcrc32                               [disabled]</span><br><span class="line">  -mcx16                                [enabled]</span><br><span class="line">  -mdispatch-scheduler                  [disabled]</span><br><span class="line">  -mdump-tune-features                  [disabled]</span><br><span class="line">  -mf16c                                [enabled]</span><br><span class="line">  -mfancy-math-387                      [enabled]</span><br><span class="line">  -mfentry                              [disabled]</span><br><span class="line">  -mfentry-name=              </span><br><span class="line">  -mfentry-section=           </span><br><span class="line">  -mfma                                 [enabled]</span><br><span class="line">  -mfma4                                [disabled]</span><br><span class="line">  -mforce-drap                          [disabled]</span><br><span class="line">  -mforce-indirect-call                 [disabled]</span><br><span class="line">  -mfp-ret-in-387                       [enabled]</span><br><span class="line">  -mfpmath=                             sse</span><br><span class="line">  -mfsgsbase                            [enabled]</span><br><span class="line">  -mfunction-return=                    keep</span><br><span class="line">  -mfused-madd                </span><br><span class="line">  -mfxsr                                [enabled]</span><br><span class="line">  -mgeneral-regs-only                   [disabled]</span><br><span class="line">  -mgfni                                [disabled]</span><br><span class="line">  -mglibc                               [enabled]</span><br><span class="line">  -mhard-float                          [enabled]</span><br><span class="line">  -mhle                                 [enabled]</span><br><span class="line">  -miamcu                               [disabled]</span><br><span class="line">  -mieee-fp                             [enabled]</span><br><span class="line">  -mincoming-stack-boundary=            0</span><br><span class="line">  -mindirect-branch-register            [disabled]</span><br><span class="line">  -mindirect-branch=                    keep</span><br><span class="line">  -minline-all-stringops                [disabled]</span><br><span class="line">  -minline-stringops-dynamically        [disabled]</span><br><span class="line">  -minstrument-return=                  none</span><br><span class="line">  -mintel-syntax              </span><br><span class="line">  -mlarge-data-threshold=&lt;number&gt;       65536</span><br><span class="line">  -mlong-double-128                     [disabled]</span><br><span class="line">  -mlong-double-64                      [disabled]</span><br><span class="line">  -mlong-double-80                      [enabled]</span><br><span class="line">  -mlwp                                 [disabled]</span><br><span class="line">  -mlzcnt                               [enabled]</span><br><span class="line">  -mmanual-endbr                        [disabled]</span><br><span class="line">  -mmemcpy-strategy=          </span><br><span class="line">  -mmemset-strategy=          </span><br><span class="line">  -mmitigate-rop                        [disabled]</span><br><span class="line">  -mmmx                                 [enabled]</span><br><span class="line">  -mmovbe                               [enabled]</span><br><span class="line">  -mmovdir64b                           [disabled]</span><br><span class="line">  -mmovdiri                             [disabled]</span><br><span class="line">  -mmpx                                 [disabled]</span><br><span class="line">  -mms-bitfields                        [disabled]</span><br><span class="line">  -mmusl                                [disabled]</span><br><span class="line">  -mmwaitx                              [disabled]</span><br><span class="line">  -mno-align-stringops                  [disabled]</span><br><span class="line">  -mno-default                          [disabled]</span><br><span class="line">  -mno-fancy-math-387                   [disabled]</span><br><span class="line">  -mno-push-args                        [disabled]</span><br><span class="line">  -mno-red-zone                         [disabled]</span><br><span class="line">  -mno-sse4                             [disabled]</span><br><span class="line">  -mnop-mcount                          [disabled]</span><br><span class="line">  -momit-leaf-frame-pointer             [disabled]</span><br><span class="line">  -mpc32                                [disabled]</span><br><span class="line">  -mpc64                                [disabled]</span><br><span class="line">  -mpc80                                [disabled]</span><br><span class="line">  -mpclmul                              [enabled]</span><br><span class="line">  -mpcommit                             [disabled]</span><br><span class="line">  -mpconfig                             [disabled]</span><br><span class="line">  -mpku                                 [disabled]</span><br><span class="line">  -mpopcnt                              [enabled]</span><br><span class="line">  -mprefer-avx128             </span><br><span class="line">  -mprefer-vector-width=                none</span><br><span class="line">  -mpreferred-stack-boundary=           0</span><br><span class="line">  -mprefetchwt1                         [disabled]</span><br><span class="line">  -mprfchw                              [enabled]</span><br><span class="line">  -mptwrite                             [disabled]</span><br><span class="line">  -mpush-args                           [enabled]</span><br><span class="line">  -mrdpid                               [disabled]</span><br><span class="line">  -mrdrnd                               [enabled]</span><br><span class="line">  -mrdseed                              [enabled]</span><br><span class="line">  -mrecip                               [disabled]</span><br><span class="line">  -mrecip=                    </span><br><span class="line">  -mrecord-mcount                       [disabled]</span><br><span class="line">  -mrecord-return                       [disabled]</span><br><span class="line">  -mred-zone                            [enabled]</span><br><span class="line">  -mregparm=                            6</span><br><span class="line">  -mrtd                                 [disabled]</span><br><span class="line">  -mrtm                                 [enabled]</span><br><span class="line">  -msahf                                [enabled]</span><br><span class="line">  -msgx                                 [disabled]</span><br><span class="line">  -msha                                 [disabled]</span><br><span class="line">  -mshstk                               [disabled]</span><br><span class="line">  -mskip-rax-setup                      [disabled]</span><br><span class="line">  -msoft-float                          [disabled]</span><br><span class="line">  -msse                                 [enabled]</span><br><span class="line">  -msse2                                [enabled]</span><br><span class="line">  -msse2avx                             [disabled]</span><br><span class="line">  -msse3                                [enabled]</span><br><span class="line">  -msse4                                [enabled]</span><br><span class="line">  -msse4.1                              [enabled]</span><br><span class="line">  -msse4.2                              [enabled]</span><br><span class="line">  -msse4a                               [disabled]</span><br><span class="line">  -msse5                      </span><br><span class="line">  -msseregparm                          [disabled]</span><br><span class="line">  -mssse3                               [enabled]</span><br><span class="line">  -mstack-arg-probe                     [disabled]</span><br><span class="line">  -mstack-protector-guard-offset= </span><br><span class="line">  -mstack-protector-guard-reg= </span><br><span class="line">  -mstack-protector-guard-symbol= </span><br><span class="line">  -mstack-protector-guard=              tls</span><br><span class="line">  -mstackrealign                        [disabled]</span><br><span class="line">  -mstringop-strategy=                  [default]</span><br><span class="line">  -mstv                                 [enabled]</span><br><span class="line">  -mtbm                                 [disabled]</span><br><span class="line">  -mtls-dialect=                        gnu</span><br><span class="line">  -mtls-direct-seg-refs                 [enabled]</span><br><span class="line">  -mtune-ctrl=                </span><br><span class="line">  -mtune=                               broadwell</span><br><span class="line">  -muclibc                              [disabled]</span><br><span class="line">  -mvaes                                [disabled]</span><br><span class="line">  -mveclibabi=                          [default]</span><br><span class="line">  -mvect8-ret-in-mem                    [disabled]</span><br><span class="line">  -mvpclmulqdq                          [disabled]</span><br><span class="line">  -mvzeroupper                          [enabled]</span><br><span class="line">  -mwaitpkg                             [disabled]</span><br><span class="line">  -mwbnoinvd                            [disabled]</span><br><span class="line">  -mx32                                 [disabled]</span><br><span class="line">  -mxop                                 [disabled]</span><br><span class="line">  -mxsave                               [enabled]</span><br><span class="line">  -mxsavec                              [disabled]</span><br><span class="line">  -mxsaveopt                            [enabled]</span><br><span class="line">  -mxsaves                              [disabled]</span><br><span class="line"></span><br><span class="line">  Known assembler dialects (<span class="keyword">for</span> use with the -masm= option):</span><br><span class="line">    att intel</span><br><span class="line"></span><br><span class="line">  Known ABIs (<span class="keyword">for</span> use with the -mabi= option):</span><br><span class="line">    ms sysv</span><br><span class="line"></span><br><span class="line">  Known code models (<span class="keyword">for</span> use with the -mcmodel= option):</span><br><span class="line">    32 kernel large medium small</span><br><span class="line"></span><br><span class="line">  Valid arguments to -mfpmath=:</span><br><span class="line">    387 387+sse 387,sse both sse sse+387 sse,387</span><br><span class="line"></span><br><span class="line">  Known indirect branch choices (<span class="keyword">for</span> use with the -mindirect-branch=/-mfunction-return= options):</span><br><span class="line">    keep thunk thunk-extern thunk-inline</span><br><span class="line"></span><br><span class="line">  Known choices <span class="keyword">for</span> <span class="built_in">return</span> instrumentation with -minstrument-return=:</span><br><span class="line">    call none nop5</span><br><span class="line"></span><br><span class="line">  Known data alignment choices (<span class="keyword">for</span> use with the -malign-data= option):</span><br><span class="line">    abi cacheline compat</span><br><span class="line"></span><br><span class="line">  Known vectorization library ABIs (<span class="keyword">for</span> use with the -mveclibabi= option):</span><br><span class="line">    acml svml</span><br><span class="line"></span><br><span class="line">  Known address mode (<span class="keyword">for</span> use with the -maddress-mode= option):</span><br><span class="line">    long short</span><br><span class="line"></span><br><span class="line">  Known preferred register vector length (to use with the -mprefer-vector-width= option):</span><br><span class="line">    128 256 512 none</span><br><span class="line"></span><br><span class="line">  Known stack protector guard (<span class="keyword">for</span> use with the -mstack-protector-guard= option):</span><br><span class="line">    global tls</span><br><span class="line"></span><br><span class="line">  Valid arguments to -mstringop-strategy=:</span><br><span class="line">    byte_loop libcall loop rep_4byte rep_8byte rep_byte unrolled_loop vector_loop</span><br><span class="line"></span><br><span class="line">  Known TLS dialects (<span class="keyword">for</span> use with the -mtls-dialect= option):</span><br><span class="line">    gnu gnu2</span><br><span class="line"></span><br><span class="line">  Known valid arguments <span class="keyword">for</span> -march= option:</span><br><span class="line">    i386 i486 i586 pentium lakemont pentium-mmx winchip-c6 winchip2 c3 samuel-2 c3-2 nehemiah c7 esther i686 pentiumpro pentium2 pentium3 pentium3m pentium-m pentium4 pentium4m prescott nocona core2 nehalem corei7 westmere sandybridge corei7-avx ivybridge core-avx-i haswell core-avx2 broadwell skylake skylake-avx512 cannonlake icelake-client icelake-server cascadelake tigerlake bonnell atom silvermont slm goldmont goldmont-plus tremont knl knm intel geode k6 k6-2 k6-3 athlon athlon-tbird athlon-4 athlon-xp athlon-mp x86-64 eden-x2 nano nano-1000 nano-2000 nano-3000 nano-x2 eden-x4 nano-x4 k8 k8-sse3 opteron opteron-sse3 athlon64 athlon64-sse3 athlon-fx amdfam10 barcelona bdver1 bdver2 bdver3 bdver4 znver1 znver2 btver1 btver2 generic native</span><br><span class="line"></span><br><span class="line">  Known valid arguments <span class="keyword">for</span> -mtune= option:</span><br><span class="line">    generic i386 i486 pentium lakemont pentiumpro pentium4 nocona core2 nehalem sandybridge haswell bonnell silvermont goldmont goldmont-plus tremont knl knm skylake skylake-avx512 cannonlake icelake-client icelake-server cascadelake tigerlake intel geode k6 athlon k8 amdfam10 bdver1 bdver2 bdver3 bdver4 btver1 btver2 znver1 znver2</span><br></pre></td></tr></table></figure>





<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">/content/drive/MyDrive/mySIMD#</span><span class="bash"> g++ -o build_vec_avx2 -mavx2 build_vec.cc</span></span><br><span class="line"><span class="meta">/content/drive/MyDrive/mySIMD#</span><span class="bash"> ./build_vec_avx2 </span></span><br><span class="line">v0: [ 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ]</span><br><span class="line">v1: [ 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ]</span><br><span class="line">v0 = v0 + 1: [ 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 ]</span><br><span class="line">v1 = v1 + 2: [ 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 ]</span><br><span class="line">v0 = v0 + v1: [ 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 ]</span><br><span class="line">v1 = v0 * v1: [ 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 ]</span><br><span class="line"></span><br><span class="line">v16si a = &#123;0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15&#125;;</span><br><span class="line">v16si b = &#123;0, 2, 4, 6, 8, 1, 3, 5, 7, 9, 10, 11, 12, 13, 14, 15&#125;;</span><br><span class="line">c = a &gt; b: [ 0 0 0 0 0 -1 -1 -1 -1 0 0 0 0 0 0 0 ]</span><br><span class="line">d = (a &gt; b) ? v0 : v1: [ 6 6 6 6 6 3 3 3 3 6 6 6 6 6 6 6 ]</span><br><span class="line"><span class="meta">/content/drive/MyDrive/mySIMD#</span><span class="bash"> g++ -o build_vec_avx512f -mavx512f build_vec.cc</span></span><br><span class="line"><span class="meta">/content/drive/MyDrive/mySIMD#</span><span class="bash"> ./build_vec_avx512f </span></span><br><span class="line">v0: [ 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ]</span><br><span class="line">v1: [ 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ]</span><br><span class="line">Illegal instruction (core dumped)</span><br><span class="line"><span class="meta">/content/drive/MyDrive/mySIMD#</span><span class="bash"> </span></span><br><span class="line"></span><br><span class="line">Other options: -mmmx、-msse、-msse2、-msse3、-mssse3、-msse4.1、-msse4.2、-msse4、-mavx、-mavx2、-mavx512f、-mavx512pf、-mavx512er、-mavx512cd、-mavx512vl、-mavx512bw、-mavx512dq、-mavx512ifma、-mavx512vbmi。</span><br></pre></td></tr></table></figure>





<p><a href="https://www.intel.com/content/www/us/en/docs/cpp-compiler/developer-guide-reference/2021-8/intrinsics.html" target="_blank" rel="noopener">Intel Manual</a></p>
<p><img src="https://p.ipic.vip/nblx24.jpg" alt="img"></p>
<h2 id="Hardware-Aspects"><a href="#Hardware-Aspects" class="headerlink" title="Hardware Aspects"></a>Hardware Aspects</h2><p><img src="https://p.ipic.vip/98sfm8.png" alt="image-20230524114039763"></p>
<p><img src="https://p.ipic.vip/0ba5i2.png" alt="image-20230524114127909"></p>
<p><img src="https://p.ipic.vip/4i3ul1.png" alt="image-20230524114230862"></p>
<blockquote>
<p>•性能提升更多依赖体系结构改进<br>•提高流水线效率<br>提高Cache效率<br>向量指令，提高向量长度<br>引入多核<br>以Intel为例<br>MMx 11993<br>MMX (64-bit)<br>wl vector re<br>supports<br>SSE、 SSE2、 (128-bit)<br>indeger ope<br>•<br>AVX. AVx2 (256-bit)<br>AVX-512 (512-bit)<br>ARM Neon指令集<br>当前ARM V8的向量化指令集<br>128-bit向量宽度<br>ARM SVE指令集<br>• ARM下-代向量化指令集<br>向量长度可伸缩，从128-bit 到2048-bit<br>与RISC-V V扩展类似<br>RISC-V ISA指令集架构，<br>精简的基础指令集，RV321 , RV641<br>•扩展指令集<br>• M,A,F,D,QC<br>讨论状态：V，B，J等等<br>RISC-V “V” Vector Extension<br>•当前版本1.0<br><a href="https://github.com/riscv/riscv-V-spec" target="_blank" rel="noopener">https://github.com/riscv/riscv-V-spec</a></p>
</blockquote>
<h2 id="Software-Aspects"><a href="#Software-Aspects" class="headerlink" title="Software Aspects"></a>Software Aspects</h2><p><img src="https://p.ipic.vip/nd1dy4.png" alt="image-20230524114212963"></p>
<p>VS</p>
<h2 id="AVX512-VS-GPU"><a href="#AVX512-VS-GPU" class="headerlink" title="AVX512 VS GPU"></a>AVX512 VS GPU</h2><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>CPU + AVX512</td>
<td>big RAM, low Latency, Cache strong</td>
<td>High Power, Bandwidth low..</td>
</tr>
<tr>
<td>GPU</td>
<td>Scaling! CUDA</td>
<td></td>
</tr>
</tbody></table>
<ul>
<li>Intel want “generalization” + “super high computing power”… many other people instead seek solution in ASIC or more core HW</li>
</ul>
<h2 id="AVX-amp-SSE"><a href="#AVX-amp-SSE" class="headerlink" title="AVX &amp; SSE"></a>AVX &amp; SSE</h2><p><a href="https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#text=_mm256_loadu_pd&amp;ig_expand=4122" target="_blank" rel="noopener">https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#text=_mm256_loadu_pd&amp;ig_expand=4122</a></p>
<p>in 2007, AMD announced SSE5 (previously SSE1~SSE4 all announced by Intel), so in 2008, Intel announced AVX, which owns some more distinct features</p>
<p>1 Float length doubled</p>
<p>2 Support 3OPs instruction for old version SSEs</p>
<p><img src="https://p.ipic.vip/qomm14.png" alt="image-20230606224503357"></p>
<p><img src="https://p.ipic.vip/n6fj6m.png" alt="image-20230606224622809"></p>
<blockquote>
<p>誰是最有效率就是軟件遊戲沒有動力學優化軟體覺得我花費大量的人力物理優化提升30%的性能還不如直接等1年後的我根本就沒有用畫的東西很多錢可能會想和背景新市區有直接等過兩天是一個新的提醒我就可能是目前也不好多錢目前來看他用你</p>
</blockquote>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/25/Deeplearning/2022-05-25-M1%20GPU%20usage/">Deeplearning/2022-05-25-M1 GPU usage</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-25</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/DevOps/">DevOps</a></span><div class="content"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">10103  chmod +x Miniforge3-MacOSX-arm64.sh</span><br><span class="line">10104  ./Miniforge3-MacOSX-arm64.sh</span><br><span class="line">10119  conda --version &lt;--- must be osx-arm64 for "platform"</span><br><span class="line">10120  python</span><br><span class="line">10121  conda create --name env_arm_py38torch python=3.8</span><br><span class="line">10122  conda activate env_arm_py38torch</span><br></pre></td></tr></table></figure>

<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38arfxr23j21x20scn05.jpg" alt="image-20220525155414871" style="zoom:50%;" />







<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38arizezpj21em0u00x5.jpg" alt="image-20220525160030684" style="zoom:50%;" />





<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h2kplalpvpj21ba0fwq56.jpg" alt="image-20220525160201912"></p>
<p><code>mps: Apple&#39;s Metal Performance Shaders</code></p>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38arm7ywnj218w0qc0vi.jpg" alt="image-20220528103507819" style="zoom:67%;" />

<p><a href="https://pytorch.org/blog/introducing-accelerated-pytorch-training-on-mac/" target="_blank" rel="noopener">https://pytorch.org/blog/introducing-accelerated-pytorch-training-on-mac/</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> python</span><br><span class="line">Python <span class="number">3.8</span><span class="number">.13</span> | packaged by conda-forge | (default, Mar <span class="number">25</span> <span class="number">2022</span>, <span class="number">06</span>:<span class="number">05</span>:<span class="number">16</span>)</span><br><span class="line">[Clang <span class="number">12.0</span><span class="number">.1</span> ] on darwin</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> torch</span><br><span class="line">torch.device()^[[D&gt;&gt;&gt; torch.device(<span class="string">'mps'</span>)</span><br><span class="line">KeyboardInterrupt</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>torch.__version__</span><br><span class="line"><span class="string">'1.13.0.dev20220524'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>torch.device(<span class="string">'mps'</span>)</span><br><span class="line">device(type=<span class="string">'mps'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = torch.randn(<span class="number">10</span>).to(<span class="string">"mps"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">/Users/joe/miniforge3/envs/env_arm_py38torch/lib/python3<span class="number">.8</span>/site-packages/torch/_tensor_str.py:<span class="number">103</span>: UserWarning: The operator <span class="string">'aten::bitwise_and.Tensor_out'</span> <span class="keyword">is</span> <span class="keyword">not</span> currently supported on the MPS backend <span class="keyword">and</span> will fall back to run on the CPU. This may have performance implications. (Triggered internally at  /Users/runner/work/pytorch/pytorch/pytorch/aten/src/ATen/mps/MPSFallback.mm:<span class="number">11.</span>)</span><br><span class="line">  nonzero_finite_vals = torch.masked_select(tensor_view, torch.isfinite(tensor_view) &amp; tensor_view.ne(<span class="number">0</span>))</span><br><span class="line">tensor([ <span class="number">0.5814</span>,  <span class="number">1.1789</span>,  <span class="number">2.8108</span>, <span class="number">-0.5239</span>, <span class="number">-0.5657</span>, <span class="number">-0.1814</span>, <span class="number">-0.1226</span>,  <span class="number">0.1378</span>,</span><br><span class="line">         <span class="number">0.0298</span>,  <span class="number">0.4484</span>], device=<span class="string">'mps:0'</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>





<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pip install jupyter</span><br></pre></td></tr></table></figure>



<h2 id="Perm-Test"><a href="#Perm-Test" class="headerlink" title="Perm Test"></a>Perm Test</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pip install asitop</span></span><br></pre></td></tr></table></figure>









<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><p><a href="https://www.gushiciku.cn/pl/gXrk/zh-tw" target="_blank" rel="noopener">https://www.gushiciku.cn/pl/gXrk/zh-tw</a></p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/79/">79</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By Joe Huang</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>