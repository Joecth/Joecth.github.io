<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Joe Huang"><meta name="copyright" content="Joe Huang"><title>Awaken Desparado</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.1.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Joe Huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">298</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">25</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">44</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Awaken Desparado</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Awaken Desparado</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/21/SQL/2020-02-21-SQL-Churn%20Rate%20with%20Case/">SQL/2020-02-21-SQL-Churn Rate with Case</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SQL/">SQL</a></span><div class="content"><blockquote>
<p>Codeflix, a streaming video startup, is interested in measuring their user churn rate. In this project, you’ll be helping them answer these questions about their churn:</p>
<p>\1. Get familiar with the company.</p>
<ul>
<li>How many months has the company been operating? Which months do you have enough information to calculate a churn rate?</li>
<li>What segments of users exist?</li>
</ul>
<p>\2. What is the overall churn trend since the company started?</p>
<p>\3. Compare the churn rates between user segments.</p>
<ul>
<li>Which segment of users should the company focus on expanding?</li>
</ul>
<hr>
<p>Start the following project, which will guide you through the queries you need to answer the above questions. Make sure to save your queries and results — you’ll be using them as well.</p>
<p>Then, create a set of slides using <a href="https://www.google.com/slides/about/" target="_blank" rel="noopener">Google Slides</a>, Microsoft Powerpoint, or some other presentation software. Your presentation should answer all of the questions listed above. Each answer should include a text explanation and data to support your claim. The queries used to find that data should be included in a separate <strong>.sql</strong> file.</p>
<ul>
<li><strong><a href="https://s3.amazonaws.com/codecademy-content/programs/learn-sql-from-scratch/SQL+Templates+ADwSQL.pptx" target="_blank" rel="noopener">Template:</a></strong> We recommend that you use the template linked here. This template contains examples of the types of slides you’ll want to use.</li>
<li><strong><a href="https://s3.amazonaws.com/codecademy-content/programs/learn-sql-from-scratch/calc-churn-proj/churn-rubric-for-learners-ADwSQL.pdf" target="_blank" rel="noopener">Rubric:</a></strong> You can share your work with your peers on Codecademy, who can give you feedback based on this rubric. Make sure to check your work before submitting!</li>
</ul>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- select * from subscriptions limit 20;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- select min(subscription_start), max(subscription_start)</span></span><br><span class="line"><span class="comment">-- from subscriptions;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">months</span> <span class="keyword">AS</span></span><br><span class="line">(<span class="keyword">SELECT</span></span><br><span class="line">   <span class="string">'2017-01-01'</span> <span class="keyword">as</span> first_day,</span><br><span class="line">   <span class="string">'2017-01-31'</span> <span class="keyword">as</span> <span class="keyword">last_day</span></span><br><span class="line"> <span class="keyword">UNION</span></span><br><span class="line"> <span class="keyword">SELECT</span></span><br><span class="line">   <span class="string">'2017-02-01'</span> <span class="keyword">as</span> first_day,</span><br><span class="line">   <span class="string">'2017-02-28'</span> <span class="keyword">as</span> <span class="keyword">last_day</span></span><br><span class="line"> <span class="keyword">UNION</span></span><br><span class="line"> <span class="keyword">SELECT</span></span><br><span class="line">   <span class="string">'2017-03-01'</span> <span class="keyword">as</span> first_day,</span><br><span class="line">   <span class="string">'2017-03-31'</span> <span class="keyword">as</span> <span class="keyword">last_day</span></span><br><span class="line">),</span><br><span class="line">cross_join <span class="keyword">AS</span></span><br><span class="line">(<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> subscriptions <span class="keyword">CROSS</span> <span class="keyword">JOIN</span> <span class="keyword">months</span></span><br><span class="line">),</span><br><span class="line"><span class="keyword">status</span> <span class="keyword">AS</span></span><br><span class="line">(<span class="keyword">SELECT</span> <span class="keyword">id</span>, first_day <span class="keyword">as</span> <span class="keyword">month</span>, </span><br><span class="line">  <span class="keyword">CASE</span></span><br><span class="line">   <span class="keyword">WHEN</span> <span class="keyword">segment</span> = <span class="number">87</span> <span class="keyword">AND</span> </span><br><span class="line">     (subscription_start &lt; first_day</span><br><span class="line">        <span class="keyword">AND</span></span><br><span class="line">        (</span><br><span class="line">          subscription_end &gt; first_day</span><br><span class="line">          <span class="keyword">OR</span></span><br><span class="line">          subscription_end <span class="keyword">is</span> <span class="literal">null</span></span><br><span class="line">        )</span><br><span class="line">     ) <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">   <span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line"> <span class="keyword">END</span> <span class="keyword">AS</span> is_active_87</span><br><span class="line"> ,</span><br><span class="line"> <span class="keyword">CASE</span></span><br><span class="line">   <span class="keyword">WHEN</span> <span class="keyword">segment</span> = <span class="number">30</span> <span class="keyword">AND</span> </span><br><span class="line">     (subscription_start &lt; first_day</span><br><span class="line">        <span class="keyword">AND</span></span><br><span class="line">        (</span><br><span class="line">          subscription_end &gt; first_day</span><br><span class="line">          <span class="keyword">OR</span></span><br><span class="line">          subscription_end <span class="keyword">is</span> <span class="literal">null</span></span><br><span class="line">        )</span><br><span class="line">     ) <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">   <span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line"> <span class="keyword">END</span> <span class="keyword">AS</span> is_active_30</span><br><span class="line"> ,</span><br><span class="line"> <span class="keyword">CASE</span> </span><br><span class="line">   <span class="keyword">WHEN</span> <span class="keyword">segment</span> = <span class="number">87</span> <span class="keyword">AND</span></span><br><span class="line">     (</span><br><span class="line">       subscription_end <span class="keyword">BETWEEN</span> first_day <span class="keyword">AND</span> <span class="keyword">last_day</span></span><br><span class="line">     ) <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">   <span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line"> <span class="keyword">END</span> <span class="keyword">AS</span> is_canceled_87</span><br><span class="line"> ,</span><br><span class="line"> <span class="keyword">CASE</span> </span><br><span class="line">   <span class="keyword">WHEN</span> <span class="keyword">segment</span> = <span class="number">30</span> <span class="keyword">AND</span></span><br><span class="line">     (</span><br><span class="line">       subscription_end <span class="keyword">BETWEEN</span> first_day <span class="keyword">AND</span> <span class="keyword">last_day</span></span><br><span class="line">     ) <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">   <span class="keyword">ELSE</span> <span class="number">0</span></span><br><span class="line"> <span class="keyword">END</span> <span class="keyword">AS</span> is_canceled_30</span><br><span class="line"> <span class="keyword">FROM</span> cross_join </span><br><span class="line">),</span><br><span class="line">status_aggregate <span class="keyword">AS</span></span><br><span class="line">(</span><br><span class="line">  <span class="keyword">SELECT</span>  <span class="keyword">month</span>, </span><br><span class="line">          <span class="keyword">SUM</span>(is_active_87) <span class="keyword">AS</span> sum_active_87,</span><br><span class="line">          <span class="keyword">SUM</span>(is_active_30) <span class="keyword">AS</span> sum_active_30,       </span><br><span class="line">          <span class="keyword">SUM</span>(is_canceled_87) <span class="keyword">AS</span> sum_canceled_87, </span><br><span class="line">          <span class="keyword">SUM</span>(is_canceled_30) <span class="keyword">AS</span> sum_canceled_30</span><br><span class="line">  <span class="keyword">FROM</span> <span class="keyword">status</span></span><br><span class="line">  <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> status_aggregate <span class="keyword">limit</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Query-Results-status-aggregate"><a href="#Query-Results-status-aggregate" class="headerlink" title="Query Results - status_aggregate"></a>Query Results - status_aggregate</h3><table>
<thead>
<tr>
<th align="center">month</th>
<th align="center">sum_active_87</th>
<th align="center">sum_active_30</th>
<th align="center">sum_canceled_87</th>
<th align="center">sum_canceled_30</th>
</tr>
</thead>
<tbody><tr>
<td align="center">2017-01-01</td>
<td align="center">278</td>
<td align="center">291</td>
<td align="center">70</td>
<td align="center">22</td>
</tr>
<tr>
<td align="center">2017-02-01</td>
<td align="center">462</td>
<td align="center">518</td>
<td align="center">148</td>
<td align="center">38</td>
</tr>
<tr>
<td align="center">2017-03-01</td>
<td align="center">531</td>
<td align="center">716</td>
<td align="center">258</td>
<td align="center">84</td>
</tr>
</tbody></table>
<p><strong>8.</strong></p>
<p>Calculate the churn rates for the two segments over the three month period. Which segment has a lower churn rate?</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- select * from status_aggregate limit 10;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span>  a.month, </span><br><span class="line">        <span class="number">1.0</span> * a.sum_canceled_87 / a.sum_active_87 <span class="keyword">AS</span> churn_87, </span><br><span class="line">        <span class="number">1.0</span> * a.sum_canceled_30 / a.sum_active_30 <span class="keyword">AS</span> churn_30</span><br><span class="line"><span class="keyword">FROM</span> status_aggregate <span class="keyword">as</span> a;</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/21/SQL/2020-02-21-SQL-UTM%20with%20Case/">SQL/2020-02-21-SQL-UTM with Case</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SQL/">SQL</a></span><div class="content"><h2 id="The-Attribution-Query-II"><a href="#The-Attribution-Query-II" class="headerlink" title="The Attribution Query II"></a>The Attribution Query II</h2><p>To get the UTM parameters, we’ll need to <code>JOIN</code> these results back with the original table.</p>
<p>We’ll join tables <code>first_touch</code>, aka<code>ft</code>, and <code>page_visits</code>, aka <code>pv</code>, on <code>user_id</code> and <code>timestamp</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ft.user_id &#x3D; pv.user_id</span><br><span class="line">AND ft.first_touch_at &#x3D; pv.timestamp</span><br></pre></td></tr></table></figure>

<p>Remember that <code>first_touch_at</code> is the earliest timestamp for each user. Here’s the simplified query:</p>
<img src="https://tva1.sinaimg.cn/large/0082zybpgy1gc4dkxtc5wj31640tgdjo.jpg" alt="image-20200221220840486" style="zoom:67%;" />

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> first_touch <span class="keyword">AS</span> (</span><br><span class="line">   <span class="keyword">SELECT</span> user_id,</span><br><span class="line">      <span class="keyword">MIN</span>(<span class="built_in">timestamp</span>) <span class="keyword">AS</span> <span class="string">'first_touch_at'</span></span><br><span class="line">   <span class="keyword">FROM</span> page_visits</span><br><span class="line">   <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id)</span><br><span class="line"><span class="keyword">SELECT</span> ft.user_id,</span><br><span class="line">  ft.first_touch_at,</span><br><span class="line">  pv.utm_source</span><br><span class="line"><span class="keyword">FROM</span> first_touch <span class="keyword">AS</span> <span class="string">'ft'</span></span><br><span class="line"><span class="keyword">JOIN</span> page_visits <span class="keyword">AS</span> <span class="string">'pv'</span></span><br><span class="line">  <span class="keyword">ON</span> ft.user_id = pv.user_id</span><br><span class="line">  <span class="keyword">AND</span> ft.first_touch_at = pv.timestamp;</span><br></pre></td></tr></table></figure>



<h2 id="The-Attribution-Query-III"><a href="#The-Attribution-Query-III" class="headerlink" title="The Attribution Query III"></a>The Attribution Query III</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> last_touch <span class="keyword">AS</span></span><br><span class="line">(</span><br><span class="line">  <span class="keyword">SELECT</span> user_id,</span><br><span class="line">     <span class="keyword">MAX</span>(<span class="built_in">timestamp</span>) <span class="keyword">AS</span> <span class="string">'last_touch_at'</span></span><br><span class="line">  <span class="keyword">FROM</span> page_visits</span><br><span class="line">  <span class="comment">-- WHERE user_id = 10069</span></span><br><span class="line">  <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- select * from last_touch limit 10;</span></span><br><span class="line"><span class="keyword">SELECT</span> lt.user_id, lt.last_touch_at, pv.utm_source</span><br><span class="line"><span class="keyword">FROM</span> last_touch <span class="keyword">as</span> <span class="string">'lt'</span></span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> page_visits <span class="keyword">as</span> <span class="string">'pv'</span></span><br><span class="line">  <span class="keyword">ON</span> lt.user_id = pv.user_id </span><br><span class="line">  <span class="keyword">AND</span> lt.last_touch_at = pv.timestamp</span><br><span class="line"><span class="keyword">WHERE</span> lt.user_id = <span class="number">10069</span>;</span><br></pre></td></tr></table></figure>





<img src="https://tva1.sinaimg.cn/large/0082zybpgy1gc4dypt1xnj30ps03aaa8.jpg" alt="image-20200221222149765" style="zoom:67%;" />

<h1 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h1><p>You can now wield SQL to find where, when, and how users are visiting a website. Well done! Here’s a summary of what you learned:</p>
<ul>
<li><em>UTM parameters</em> are a way of tracking visits to a website. Developers, marketers, and analysts use them to capture information like the time, attribution source, and attribution medium for each user visit.</li>
<li><em>First-touch attribution</em> only considers the first source for each customer. This is a good way of knowing how visitors initially discover a website.</li>
<li><em>Last-touch attribution</em> only considers the last source for each customer. This is a good way of knowing how visitors are drawn back to a website, especially for making a final purchase.</li>
<li>Find first and last touches by grouping <code>page_visits</code> by <code>user_id</code> and finding the <code>MIN</code> and <code>MAX</code> of <code>timestamp</code>.</li>
<li>To find first- and last-touch attribution, join that table back with the original <code>page_visits</code> table on <code>user_id</code> and <code>timestamp</code>.</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/20/Codecademies/2020-02-22-SQL-Advanced_Aggregate_&amp;_Count_Metrics/">Codecademies/2020-02-22-SQL-Advanced_Aggregate_&amp;_Count_Metrics</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-20</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SQL/">SQL</a></span><div class="content"><h1 id="Advanced-Aggregate"><a href="#Advanced-Aggregate" class="headerlink" title="Advanced Aggregate"></a>Advanced Aggregate</h1><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gcv26l5ilkj31bm0jcn1v.jpg" alt="image-20200316000428263" style="zoom:67%;" />



<h2 id="Database-Schema"><a href="#Database-Schema" class="headerlink" title="Database Schema"></a>Database Schema</h2><table>
<thead>
<tr>
<th align="center">orders4999 rows</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="center">id</td>
<td>int</td>
</tr>
<tr>
<td align="center">ordered_at</td>
<td>text</td>
</tr>
<tr>
<td align="center">delivered_at</td>
<td>text</td>
</tr>
<tr>
<td align="center">delivered_to</td>
<td>int</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center">order_items20000 rows</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="center">id</td>
<td>int</td>
</tr>
<tr>
<td align="center">order_id</td>
<td>int</td>
</tr>
<tr>
<td align="center">name</td>
<td>text</td>
</tr>
<tr>
<td align="center">amount_paid</td>
<td>real</td>
</tr>
</tbody></table>
<h2 id="Percentage"><a href="#Percentage" class="headerlink" title="Percentage"></a>Percentage</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span>, <span class="keyword">round</span>(<span class="keyword">sum</span>(amount_paid)/</span><br><span class="line">(</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">sum</span>(amount_paid) <span class="keyword">from</span> order_items</span><br><span class="line">) *<span class="number">100.0</span>, <span class="number">2</span>) <span class="keyword">as</span> pct</span><br><span class="line"><span class="keyword">from</span> order_items</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">name</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span> <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Query-Results"><a href="#Query-Results" class="headerlink" title="Query Results"></a>Query Results</h3><table>
<thead>
<tr>
<th align="center">name</th>
<th align="center">%</th>
</tr>
</thead>
<tbody><tr>
<td align="center">tikka-masala</td>
<td align="center">31.7</td>
</tr>
<tr>
<td align="center">grilled-cheese</td>
<td align="center">21.6</td>
</tr>
<tr>
<td align="center">chicken-parm</td>
<td align="center">19.95</td>
</tr>
<tr>
<td align="center">blt</td>
<td align="center">14.75</td>
</tr>
<tr>
<td align="center">soda</td>
<td align="center">5.48</td>
</tr>
<tr>
<td align="center">orange-juice</td>
<td align="center">2.94</td>
</tr>
<tr>
<td align="center">cake</td>
<td align="center">2.71</td>
</tr>
<tr>
<td align="center">banana-smoothie</td>
<td align="center">0.53</td>
</tr>
<tr>
<td align="center">kale-smoothie</td>
<td align="center">0.35</td>
</tr>
</tbody></table>
<h2 id="Grouping-with-Case-Statements"><a href="#Grouping-with-Case-Statements" class="headerlink" title="Grouping with Case Statements"></a>Grouping with Case Statements</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  <span class="comment">/**/</span></span><br><span class="line">  <span class="keyword">case</span> <span class="keyword">name</span></span><br><span class="line">    <span class="keyword">when</span> <span class="string">'kale-smoothie'</span>    <span class="keyword">then</span> <span class="string">'smoothie'</span></span><br><span class="line">    <span class="keyword">when</span> <span class="string">'banana-smoothie'</span>  <span class="keyword">then</span> <span class="string">'smoothie'</span></span><br><span class="line">    <span class="keyword">when</span> <span class="string">'orange-juice'</span>     <span class="keyword">then</span> <span class="string">'drink'</span></span><br><span class="line">    <span class="keyword">when</span> <span class="string">'soda'</span>             <span class="keyword">then</span> <span class="string">'drink'</span></span><br><span class="line">    <span class="keyword">when</span> <span class="string">'blt'</span>              <span class="keyword">then</span> <span class="string">'sandwich'</span></span><br><span class="line">    <span class="keyword">when</span> <span class="string">'grilled-cheese'</span>   <span class="keyword">then</span> <span class="string">'sandwich'</span></span><br><span class="line">    <span class="keyword">when</span> <span class="string">'tikka-masala'</span>     <span class="keyword">then</span> <span class="string">'dinner'</span></span><br><span class="line">    <span class="keyword">when</span> <span class="string">'chicken-parm'</span>     <span class="keyword">then</span> <span class="string">'dinner'</span></span><br><span class="line">     <span class="keyword">else</span> <span class="string">'other'</span></span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">as</span> <span class="keyword">category</span>, </span><br><span class="line">  <span class="keyword">round</span>(<span class="number">1.0</span> * <span class="keyword">sum</span>(amount_paid) / </span><br><span class="line">          (</span><br><span class="line">            <span class="keyword">select</span> <span class="keyword">sum</span>(amount_paid) <span class="keyword">from</span> order_items</span><br><span class="line">          ) * <span class="number">100</span>, <span class="number">2</span></span><br><span class="line">       ) <span class="keyword">as</span> <span class="string">'%'</span></span><br><span class="line"><span class="keyword">from</span> order_items</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span> <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Query-Results-1"><a href="#Query-Results-1" class="headerlink" title="Query Results"></a>Query Results</h3><table>
<thead>
<tr>
<th align="center">category</th>
<th align="center">round(1.0 * sum(amount_paid) / ( select sum(amount_paid) from order_items ) * 100, 2 )</th>
</tr>
</thead>
<tbody><tr>
<td align="center">dinner</td>
<td align="center">51.64</td>
</tr>
<tr>
<td align="center">sandwich</td>
<td align="center">36.34</td>
</tr>
<tr>
<td align="center">drink</td>
<td align="center">8.42</td>
</tr>
<tr>
<td align="center">other</td>
<td align="center">2.71</td>
</tr>
<tr>
<td align="center">smoothie</td>
<td align="center">0.88</td>
</tr>
</tbody></table>
<h2 id="Reorder-Rates"><a href="#Reorder-Rates" class="headerlink" title="Reorder Rates"></a>Reorder Rates</h2><p>“While we do know that kale smoothies (and drinks overall) are not driving a lot of revenue, we don’t know why. A big part of data analysis is implementing your own metrics to get information out of the piles of data in your database.</p>
<p>In our case, the reason could be that no one likes kale, but it could be something else entirely. To find out, we’ll create a metric called <em>reorder rate</em> and see how that compares to the other products at SpeedySpoon.</p>
<p>We’ll define <em>reorder rate</em> as the ratio of the total number of orders to the number of people making those orders. A higher ratio means most of the orders are reorders. A lower ratio means more of the orders are first purchases.”</p>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gcvlv4b5ldj327o0s4wkh.jpg" alt="image-20200316112531249"></p>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gcvm0mdyqsj324j0u0k30.jpg" alt="image-20200316113051990"></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><h2 id="Conclusion-1"><a href="#Conclusion-1" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Wow! That’s unexpected. While smoothies aren’t making a lot of money for SpeedySpoon, they have a very high reorder rate. That means these smoothie customers are strong repeat customers.</p>
<p>Instead of recommending smoothies be taken off the menu, we should talk to the smoothie customers and see what they like so much about these smoothies. There could be an opportunity here to expand the product line, or get other customers as excited as these kale fanatics. Nice work!</p>
<p>Let’s generalize what we’ve learned so far:</p>
<ul>
<li><em>Data aggregation</em> is the grouping of data in summary form.</li>
<li><em>Daily Count</em> is the count of orders in a day.</li>
<li><em>Daily Revenue Count</em> is the revenue on orders per day.</li>
<li><em>Product Sum</em> is the total revenue of a product.</li>
<li><em>Subqueries</em> can be used to perform complicated calculations and create filtered or aggregate tables on the fly.</li>
<li><em>Reorder Rate</em> is the ratio of the total number of orders to the number of people making orders.</li>
</ul>
<h1 id="Count-Metrics"><a href="#Count-Metrics" class="headerlink" title="Count Metrics"></a>Count Metrics</h1><h3 id="Query-Results-2"><a href="#Query-Results-2" class="headerlink" title="Query Results"></a>Query Results</h3><table>
<thead>
<tr>
<th align="center">id</th>
<th align="center">user_id</th>
<th align="center">price</th>
<th align="center">refunded_at</th>
<th align="center">created_at</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">255</td>
<td align="center">1.5</td>
<td align="center"></td>
<td align="center">2015-10-04 14:39:46</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">448</td>
<td align="center">0.5</td>
<td align="center"></td>
<td align="center">2015-09-11 17:33:06</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">237</td>
<td align="center">4.5</td>
<td align="center"></td>
<td align="center">2015-08-17 23:13:32</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">468</td>
<td align="center">3.5</td>
<td align="center"></td>
<td align="center">2015-08-08 16:25:59</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">50</td>
<td align="center">4.5</td>
<td align="center"></td>
<td align="center">2015-08-18 02:36:17</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">86</td>
<td align="center">1.5</td>
<td align="center">2015-11-19 10:02:31</td>
<td align="center">2015-11-19 05:16:54</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">384</td>
<td align="center">4.5</td>
<td align="center"></td>
<td align="center">2015-08-21 14:35:02</td>
</tr>
<tr>
<td align="center">7</td>
<td align="center">490</td>
<td align="center">1.5</td>
<td align="center"></td>
<td align="center">2015-10-08 01:09:32</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">454</td>
<td align="center">1.5</td>
<td align="center"></td>
<td align="center">2015-10-24 12:26:39</td>
</tr>
<tr>
<td align="center">9</td>
<td align="center">280</td>
<td align="center">1.5</td>
<td align="center"></td>
<td align="center">2015-08-24 15:19:00</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center">id</th>
<th align="center">user_id</th>
<th align="center">created_at</th>
<th align="center">platform</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">225</td>
<td align="center">2015-11-25 20:06:36</td>
<td align="center">Web</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">175</td>
<td align="center">2015-08-08 12:39:30</td>
<td align="center">iOS</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">453</td>
<td align="center">2015-11-11 05:44:58</td>
<td align="center">Web</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">438</td>
<td align="center">2015-10-27 07:26:07</td>
<td align="center">Android</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">413</td>
<td align="center">2015-11-12 19:47:57</td>
<td align="center">iOS</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">424</td>
<td align="center">2015-11-10 23:23:49</td>
<td align="center">Android</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">55</td>
<td align="center">2015-09-13 14:49:09</td>
<td align="center">iOS</td>
</tr>
<tr>
<td align="center">7</td>
<td align="center">285</td>
<td align="center">2015-08-31 18:32:49</td>
<td align="center">Web</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">28</td>
<td align="center">2015-08-16 00:34:09</td>
<td align="center">iOS</td>
</tr>
<tr>
<td align="center">9</td>
<td align="center">22</td>
<td align="center">2015-08-11 23:53:11</td>
<td align="center">iOS</td>
</tr>
</tbody></table>
<h3 id="Database-Schema-1"><a href="#Database-Schema-1" class="headerlink" title="Database Schema"></a>Database Schema</h3><table>
<thead>
<tr>
<th align="center">purchases2000 rows</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="center">id</td>
<td>int</td>
</tr>
<tr>
<td align="center">user_id</td>
<td>int</td>
</tr>
<tr>
<td align="center">price</td>
<td>real</td>
</tr>
<tr>
<td align="center">refunded_at</td>
<td>text</td>
</tr>
<tr>
<td align="center">created_at</td>
<td>text</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center">gameplays14000 rows</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td align="center">id</td>
<td>int</td>
</tr>
<tr>
<td align="center">user_id</td>
<td>int</td>
</tr>
<tr>
<td align="center">created_at</td>
<td>text</td>
</tr>
<tr>
<td align="center">platform</td>
<td>text</td>
</tr>
</tbody></table>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gcvmo5pnolj32660lugq8.jpg" alt="image-20200316115322516"></p>
<h2 id="Daily-Active-Users"><a href="#Daily-Active-Users" class="headerlink" title="Daily Active Users"></a>Daily Active Users</h2><p>Mineblocks is a game, and one of the core metrics to any game is the number of people who play each day. That KPI is called <em>Daily Active Users</em>, or <em>DAU</em>.</p>
<p><em>DAU</em> is defined as the number of unique players seen in-game each day. It’s important not to double count users who played multiple times, so we’ll use <code>distinct</code> in our <code>count</code> function.</p>
<p>Likewise, Weekly Active Users (WAU) and Monthly Active Users (MAU) are in the same family.</p>
<ol>
<li><p>For Mineblocks, we’ll use the <code>gameplays</code> table to calculate DAU. Each time a user plays the game, their session is recorded in <code>gameplays</code>. Thus, a distinct count of users per day from gameplays will give us DAU.</p>
<p>Calculate Daily Active Users for Mineblocks. Complete the query’s <code>count</code> function by passing in the <code>distinct</code> keyword and the <code>user_id</code> column name.</p>
</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  <span class="built_in">date</span>(created_at), </span><br><span class="line">  <span class="keyword">count</span>(<span class="keyword">distinct</span> user_id<span class="comment">/**/</span>) <span class="keyword">as</span> dau</span><br><span class="line"><span class="keyword">from</span> gameplays</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<h2 id="Daily-Active-Users-2"><a href="#Daily-Active-Users-2" class="headerlink" title="Daily Active Users 2"></a>Daily Active Users 2</h2><p><strong>1.</strong></p>
<p>Previously we calculated DAU only per day, so the output we wanted was <code>[date, dau_count]</code>. Now we want DAU per platform, making the desired output <code>[date, platform, dau_count]</code>.</p>
<p>Calculate DAU for Mineblocks per-platform. Complete the query below. You will need to select the <code>platform</code> column and add a <code>count</code> function by passing in the <code>distinct</code> keyword and the <code>user_id</code> column name.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  <span class="built_in">date</span>(created_at), </span><br><span class="line">  platform,</span><br><span class="line">  <span class="keyword">count</span>(<span class="keyword">distinct</span> user_id<span class="comment">/**/</span>) <span class="keyword">as</span> dau</span><br><span class="line"><span class="keyword">from</span> gameplays</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>, <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">P.S. IF NO 2nd group by , diff platforms collapse into the same day</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>date(created_at)</th>
<th>platform</th>
<th>dau</th>
</tr>
</thead>
<tbody><tr>
<td>2015-08-08</td>
<td>Android</td>
<td>39</td>
</tr>
<tr>
<td>2015-08-08</td>
<td>Web</td>
<td>43</td>
</tr>
<tr>
<td>2015-08-08</td>
<td>iOS</td>
<td>25</td>
</tr>
<tr>
<td>2015-08-09</td>
<td>Android</td>
<td>55</td>
</tr>
<tr>
<td>2015-08-09</td>
<td>Web</td>
<td>44</td>
</tr>
<tr>
<td>2015-08-09</td>
<td>iOS</td>
<td>37</td>
</tr>
<tr>
<td>2015-08-10</td>
<td>Android</td>
<td>38</td>
</tr>
</tbody></table>
<h2 id="Daily-Average-Revenue-Per-Purchasing-User"><a href="#Daily-Average-Revenue-Per-Purchasing-User" class="headerlink" title="Daily Average Revenue Per Purchasing User"></a>Daily Average Revenue Per Purchasing User</h2><p>We’ve looked at DAU and Daily Revenue in Mineblocks. Now we must understand the purchasing habits of our users.</p>
<p>Mineblocks, like every freemium game, has two types of users:</p>
<ul>
<li>purchasers: users who have bought things in the game</li>
<li>players: users who play the game but have not yet purchased</li>
</ul>
<p>The next KPI we’ll look at <em>Daily ARPPU</em> - Average Revenue Per Purchasing User. This metric shows if the average amount of money spent by purchasers is going up over time.</p>
<p><em>Daily ARPPU</em> is defined as the sum of revenue divided by the number of purchasers per day.</p>
<p><strong>1.</strong></p>
<p>To get Daily ARPPU, modify the daily revenue query from earlier to divide by the number of purchasers.</p>
<p>Complete the query by adding a numerator and a denominator. The numerator will display daily revenue, or <code>sum</code> the <code>price</code> columns. The denominator will display the number of purchasers by passing the <code>distinct</code> keyword and the <code>user_id</code> column name into the <code>count</code> function.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  <span class="built_in">date</span>(created_at),</span><br><span class="line">  <span class="keyword">round</span>(<span class="comment">/**/</span><span class="keyword">sum</span>(price) / <span class="keyword">count</span>(<span class="keyword">distinct</span> user_id<span class="comment">/**/</span>), <span class="number">2</span>) <span class="keyword">as</span> arppu</span><br><span class="line"><span class="keyword">from</span> purchases</span><br><span class="line"><span class="keyword">where</span> refunded_at <span class="keyword">is</span> <span class="literal">null</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">date(created_at)</th>
<th align="center">arppu</th>
</tr>
</thead>
<tbody><tr>
<td align="center">2015-08-04</td>
<td align="center">3.46</td>
</tr>
<tr>
<td align="center">2015-08-05</td>
<td align="center">2.65</td>
</tr>
<tr>
<td align="center">2015-08-06</td>
<td align="center">1.44</td>
</tr>
<tr>
<td align="center">2015-08-07</td>
<td align="center">2.32</td>
</tr>
<tr>
<td align="center">2015-08-08</td>
<td align="center">2.53</td>
</tr>
<tr>
<td align="center">2015-08-09</td>
<td align="center">1.75</td>
</tr>
<tr>
<td align="center">2015-08-10</td>
<td align="center">3.0</td>
</tr>
<tr>
<td align="center">2015-08-11</td>
<td align="center">2.25</td>
</tr>
<tr>
<td align="center">2015-08-12</td>
<td align="center">2.78</td>
</tr>
<tr>
<td align="center">2015-08-13</td>
<td align="center">2.83</td>
</tr>
<tr>
<td align="center">2015-08-14</td>
<td align="center">2.7</td>
</tr>
</tbody></table>
<h2 id="Daily-Average-Revenue-Per-User"><a href="#Daily-Average-Revenue-Per-User" class="headerlink" title="Daily Average Revenue Per User"></a>Daily Average Revenue Per User</h2><p>The more popular (and difficult) cousin to Daily ARPPU is <em>Daily ARPU</em>, Average Revenue Per User. ARPU measures the average amount of money we’re getting across all players, <strong><em>whether or not they’ve purchased.</em></strong></p>
<p>ARPPU increases if purchasers are spending more money. ARPU increases if more players are choosing to purchase, even if the purchase size stays consistent.</p>
<p><strong><em>No one metric can tell the whole story.</em></strong> That’s why it’s so helpful to have many KPIs on the same dashboard.</p>
<h2 id="ARPU-2"><a href="#ARPU-2" class="headerlink" title="ARPU 2"></a>ARPU 2</h2><p>Daily ARPU is defined as revenue divided by the number of players, per-day. To get that, we’ll need to calculate the daily revenue and daily active users separately, and then join them on their dates.</p>
<p>One way to easily create and organize temporary results in a query is with <em>CTEs</em>, <em>Common Table Expressions</em>, also known as <code>with</code> clauses. The <code>with</code> clauses make it easy to define and use results in a more organized way than subqueries.</p>
<p>These clauses usually look like this:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**/</span><span class="keyword">with</span>  daily_revenue <span class="keyword">as</span> (</span><br><span class="line">  <span class="keyword">select</span></span><br><span class="line">    <span class="built_in">date</span>(created_at) <span class="keyword">as</span> dt,</span><br><span class="line">    <span class="keyword">round</span>(<span class="keyword">sum</span>(price), <span class="number">2</span>) <span class="keyword">as</span> rev</span><br><span class="line">  <span class="keyword">from</span> purchases</span><br><span class="line">  <span class="keyword">where</span> refunded_at <span class="keyword">is</span> <span class="literal">null</span></span><br><span class="line">  <span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> daily_revenue <span class="keyword">order</span> <span class="keyword">by</span> dt;</span><br></pre></td></tr></table></figure>

<p><strong>2.</strong></p>
<p>Now that we have the revenue and DAU, join them on their dates and calculate daily ARPU. Complete the query by adding the keyword <code>using</code> in the <code>join</code> clause.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**/</span> <span class="keyword">with</span>  daily_revenue <span class="keyword">as</span> (</span><br><span class="line">  <span class="keyword">select</span></span><br><span class="line">    <span class="built_in">date</span>(created_at) <span class="keyword">as</span> dt,</span><br><span class="line">    <span class="keyword">round</span>(<span class="keyword">sum</span>(price), <span class="number">2</span>) <span class="keyword">as</span> rev</span><br><span class="line">  <span class="keyword">from</span> purchases</span><br><span class="line">  <span class="keyword">where</span> refunded_at <span class="keyword">is</span> <span class="literal">null</span></span><br><span class="line">  <span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line">),</span><br><span class="line">daily_players <span class="keyword">as</span> (</span><br><span class="line">  <span class="keyword">select</span></span><br><span class="line">    <span class="comment">/**/</span><span class="built_in">date</span>(created_at) <span class="keyword">as</span> dt,</span><br><span class="line">    <span class="comment">/**/</span><span class="keyword">count</span>(<span class="keyword">distinct</span> user_id) <span class="keyword">as</span> players</span><br><span class="line">  <span class="keyword">from</span> gameplays</span><br><span class="line">  <span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  daily_revenue.dt, </span><br><span class="line">  daily_revenue.rev / daily_players.players</span><br><span class="line"><span class="keyword">from</span> daily_revenue</span><br><span class="line">  <span class="keyword">join</span> daily_players <span class="keyword">using</span> (dt);</span><br></pre></td></tr></table></figure>

<p>In the final <code>select</code> statement, <code>daily_revenue.dt</code> represents the date, while <code>daily_revenue.rev / daily_players.players</code> is the daily revenue divided by the number of players that day. In full, it represents how much the company is making per player, per day.</p>
<p>When the columns to join have the same name in both tables you can use <code>using</code> instead of <code>on</code>. Our use of the <code>using</code> keyword is in this case equivalent to this clause:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from daily_revenue</span><br><span class="line">  join daily_players on</span><br><span class="line">    daily_revenue.dt = daily_players.dt;</span><br></pre></td></tr></table></figure>



<h2 id="1Day-Retention"><a href="#1Day-Retention" class="headerlink" title="1Day Retention"></a>1Day Retention</h2><h1 id="1-Day-Retention"><a href="#1-Day-Retention" class="headerlink" title="1 Day Retention"></a>1 Day Retention</h1><p>Now let’s find out what percent of Mineblock players are returning to play the next day. This KPI is called <em>1 Day Retention</em>.</p>
<p><em>Retention</em> can be defined many different ways, but we’ll stick to the most basic definition. For all players on Day N, we’ll consider them retained if they came back to play again on Day N+1.</p>
<p>This will let us track whether or not Mineblocks is getting “stickier” over time. The stickier our game, the more days players will spend in-game.</p>
<p>And more time in-game means more opportunities to monetize and grow our business.</p>
<h4 id="Cont"><a href="#Cont" class="headerlink" title="Cont."></a>Cont.</h4><p>Before we can calculate retention we need to get our data formatted in a way where we can determine if a user returned.</p>
<p>Currently the <code>gameplays</code> table is a list of when the user played, and it’s not easy to see if any user came back.</p>
<p>By using a <code>self-join</code>, we can make multiple gameplays available on the same row of results. This will enable us to calculate retention.</p>
<p>The power of <code>self-join</code> comes from joining every row to every other row. This makes it possible to compare values from two different rows in the new result set. In our case, we’ll compare rows that are one date apart from each user.</p>
<p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gcw6v3ohoqj30dj0a3q3j.jpg" alt="SQL join types"></p>
<p>Now that we have our <code>gameplays</code> table joined to itself, we can start to calculate retention.</p>
<p>1 Day Retention is defined as the number of players who returned the next day divided by the number of original players, per day. Suppose 10 players played Mineblocks on Dec 10th. If 4 of them play on Dec 11th, the 1 day retention for Dec 10th is 40%.</p>
<p>Instructions</p>
<p><strong>1.</strong></p>
<p>The previous query joined all rows in gameplays against all other rows for each user, making a massive result set that we don’t need.</p>
<p>We’ll need to modify this query.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  <span class="built_in">date</span>(g1.created_at) <span class="keyword">as</span> dt,</span><br><span class="line">  g1.user_id, </span><br><span class="line">  g2.user_id</span><br><span class="line"><span class="keyword">from</span> gameplays <span class="keyword">as</span> g1</span><br><span class="line">  <span class="comment">/**/</span> <span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">    gameplays <span class="keyword">as</span> g2 <span class="keyword">on</span></span><br><span class="line">    g1.user_id = g2.user_id</span><br><span class="line">    <span class="keyword">and</span> <span class="built_in">date</span>(g1.created_at) = <span class="built_in">date</span>(datetime(g2.created_at, <span class="string">'-1 day'</span>))</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure>



<p><strong>2.</strong></p>
<p>The query above won’t return meaningful results because we’re using an <code>inner join</code>. This type of join requires that the condition be met for all rows, effectively limiting our selection to only the users that have returned.</p>
<p>Instead, we want to use a <code>left join</code>, this way all rows in <code>g1</code> are preserved, leaving nulls in the rows from <code>g2</code> where users did not return to play the next day.</p>
<p>Change the <code>join</code> clause to use <code>left join</code> and count the distinct number of users from <code>g1</code> and <code>g2</code> per date.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  <span class="built_in">date</span>(g1.created_at) <span class="keyword">as</span> dt,</span><br><span class="line">  <span class="comment">-- g1.user_id, </span></span><br><span class="line">  <span class="comment">-- g2.user_id</span></span><br><span class="line">  <span class="keyword">count</span>(<span class="keyword">distinct</span> g1.user_id) <span class="keyword">as</span> total_users,</span><br><span class="line">  <span class="keyword">count</span>(<span class="keyword">distinct</span> g2.user_id) <span class="keyword">as</span> retained_users </span><br><span class="line"><span class="keyword">from</span> gameplays <span class="keyword">as</span> g1</span><br><span class="line">  <span class="comment">/**/</span> <span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">    gameplays <span class="keyword">as</span> g2 <span class="keyword">on</span></span><br><span class="line">    g1.user_id = g2.user_id</span><br><span class="line">    <span class="keyword">and</span> <span class="built_in">date</span>(g1.created_at) = <span class="built_in">date</span>(datetime(g2.created_at, <span class="string">'-1 day'</span>))</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>dt</th>
<th>total_users</th>
<th>retained_users</th>
</tr>
</thead>
<tbody><tr>
<td>2015-08-19</td>
<td>111</td>
<td>26</td>
</tr>
<tr>
<td>2015-08-20</td>
<td>117</td>
<td>31</td>
</tr>
<tr>
<td>2015-08-21</td>
<td>112</td>
<td>27</td>
</tr>
<tr>
<td>2015-08-22</td>
<td>117</td>
<td>24</td>
</tr>
<tr>
<td>2015-08-23</td>
<td>94</td>
<td>23</td>
</tr>
<tr>
<td>2015-08-24</td>
<td>108</td>
<td>23</td>
</tr>
<tr>
<td>2015-08-25</td>
<td>120</td>
<td>23</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  <span class="built_in">date</span>(g1.created_at) <span class="keyword">as</span> dt,</span><br><span class="line">  <span class="comment">-- g1.user_id, </span></span><br><span class="line">  <span class="comment">-- g2.user_id</span></span><br><span class="line">  <span class="keyword">round</span>(<span class="number">100</span> * <span class="keyword">count</span>(<span class="keyword">distinct</span> g1.user_id) <span class="keyword">as</span> total_users /</span><br><span class="line">  <span class="keyword">count</span>(<span class="keyword">distinct</span> g2.user_id)) <span class="keyword">as</span> <span class="keyword">retention</span></span><br><span class="line"><span class="keyword">from</span> gameplays <span class="keyword">as</span> g1</span><br><span class="line">  <span class="comment">/**/</span> <span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">    gameplays <span class="keyword">as</span> g2 <span class="keyword">on</span></span><br><span class="line">    g1.user_id = g2.user_id</span><br><span class="line">    <span class="keyword">and</span> <span class="built_in">date</span>(g1.created_at) = <span class="built_in">date</span>(datetime(g2.created_at, <span class="string">'-1 day'</span>))</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  <span class="built_in">date</span>(g1.created_at) <span class="keyword">as</span> dt,</span><br><span class="line">  <span class="keyword">round</span>(<span class="number">100</span> * <span class="keyword">count</span>(<span class="keyword">distinct</span> g2.user_id) /</span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">distinct</span> g1.user_id)) <span class="keyword">as</span> <span class="keyword">retention</span></span><br><span class="line"><span class="keyword">from</span> gameplays <span class="keyword">as</span> g1</span><br><span class="line">  <span class="keyword">left</span> <span class="keyword">join</span> gameplays <span class="keyword">as</span> g2 <span class="keyword">on</span></span><br><span class="line">    g1.user_id = g2.user_id</span><br><span class="line">    <span class="keyword">and</span> <span class="built_in">date</span>(g1.created_at) = <span class="built_in">date</span>(datetime(g2.created_at, <span class="string">'-1 day'</span>))</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure>



<h2 id="Common-Metrics-Conclusion"><a href="#Common-Metrics-Conclusion" class="headerlink" title="Common Metrics Conclusion"></a>Common Metrics Conclusion</h2><p>While every business has different metrics to track their success, most are based on revenue and usage.</p>
<p>The metrics in this lesson are merely a starting point, and from here you’ll be able to create and customize metrics to track whatever is most important to your company.</p>
<p>And remember, data science is exploratory! The current set of metrics can always be improved and there’s usually more to any spike or dip than what immediately meets the eye.</p>
<p>Let’s generalize what we’ve learned so far:</p>
<ul>
<li><em>Key Performance Indicators</em> are high level health metrics for a business.</li>
<li><em>Daily Revenue</em> is the sum of money made per day.</li>
<li><em>Daily Active Users</em> are the number of unique users seen each day</li>
<li><em>Daily Average Revenue Per Purchasing User (ARPPU)</em> is the average amount of money spent by purchasers each day.</li>
<li><em>Daily Average Revenue Per User (ARPU)</em> is the average amount of money across all users.</li>
<li><em>1 Day Retention</em> is defined as the number of players from Day N who came back to play again on Day N+1.</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/20/SQL/2020-02-20-SQL-Create%20Table/">SQL/2020-02-20-SQL-Create Table</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-20</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SQL/">SQL</a></span><div class="content"><p><a href="https://www.codecademy.com/courses/learn-sql/projects/learn_sql_create_table" target="_blank" rel="noopener">https://www.codecademy.com/courses/learn-sql/projects/learn_sql_create_table</a></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> friends(</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">INTEGER</span>,</span><br><span class="line">  <span class="keyword">name</span> <span class="built_in">TEXT</span>,</span><br><span class="line">  birthday <span class="built_in">DATE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- alter table friends</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> friends (<span class="keyword">id</span>, <span class="keyword">name</span>, birthday)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'Jane Doe'</span>, <span class="string">'1990-05-30'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> friends;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> friends (<span class="keyword">id</span>, <span class="keyword">name</span>, birthday)</span><br><span class="line"><span class="keyword">values</span> (<span class="number">2</span>, <span class="string">'Alex'</span>, <span class="string">'1986-06-06'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> friends (<span class="keyword">id</span>, <span class="keyword">name</span>, birthday)</span><br><span class="line"><span class="keyword">values</span> (<span class="number">3</span>, <span class="string">'Tina'</span>, <span class="string">'1984-12-12'</span>);</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> friends;</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> friends</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">name</span> = <span class="string">'Jane Smith'</span></span><br><span class="line"><span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> friends;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLe</span> friends</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">COLUMN</span> email <span class="built_in">TEXT</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> friends</span><br><span class="line"><span class="keyword">set</span> email = <span class="string">'jane@codecademy.com'</span></span><br><span class="line"><span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> friends;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> friends</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">id</span>  = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> friends;</span><br><span class="line"><span class="comment">-- alter table friends (name)</span></span><br><span class="line"><span class="comment">-- values (1, )</span></span><br></pre></td></tr></table></figure>



<img src="https://tva1.sinaimg.cn/large/0082zybpgy1gc2ud71ragj30oe0vwtbb.jpg" alt="image-20200220141807884" style="zoom:50%;" /></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/20/SQL/2020-02-21-SQL-analyzation/">SQL/2020-02-21-SQL-analyzation</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-20</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/SQL/">SQL</a></span><div class="content"><h1 id="Analyze-Data-with-SQL"><a href="#Analyze-Data-with-SQL" class="headerlink" title="Analyze Data with SQL"></a>Analyze Data with SQL</h1><h3 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h3><p>The UX Research team wants to see a distribution of watch durations. They want the result to contain:</p>
<ul>
<li><code>duration</code>, which is the watch event duration, rounded to the closest minute</li>
<li><code>count</code>, the number of watch events falling into this “bucket”</li>
</ul>
<p>Your result should look like:</p>
<table>
<thead>
<tr>
<th>duration</th>
<th>count</th>
</tr>
</thead>
<tbody><tr>
<td>1.0</td>
<td>9</td>
</tr>
<tr>
<td>2.0</td>
<td>21</td>
</tr>
<tr>
<td>3.0</td>
<td>19</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>Use <code>COUNT()</code>, <code>GROUP BY</code>, and <code>ORDER BY</code> to create this result and order this data by increasing <code>duration</code>.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">round</span>(watch_duration_in_minutes, <span class="number">0</span>) </span><br><span class="line"><span class="keyword">from</span> watch_history </span><br><span class="line"><span class="keyword">limit</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  <span class="keyword">ROUND</span>(watch_duration_in_minutes, <span class="number">0</span>) <span class="keyword">as</span> <span class="keyword">duration</span>,</span><br><span class="line">  <span class="keyword">COUNT</span>(*) <span class="keyword">as</span> <span class="keyword">count</span></span><br><span class="line"><span class="keyword">FROM</span> watch_history</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">duration</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">duration</span> <span class="keyword">ASC</span> <span class="keyword">limit</span> <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">round</span>(watch_duration_in_minutes, <span class="number">0</span>) <span class="keyword">as</span> <span class="keyword">duration</span>, </span><br><span class="line"><span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">count</span></span><br><span class="line"><span class="keyword">from</span> watch_history</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">duration</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">duration</span> <span class="keyword">asc</span> <span class="keyword">limit</span> <span class="number">20</span>;</span><br><span class="line"><span class="comment">-- order by count(*) asc limit 20;</span></span><br></pre></td></tr></table></figure>



<h3 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h3><p>Find all the users that have successfully made a payment to Codeflix and find their total amount paid.</p>
<p>Sort them by their total payments (from high to low).</p>
<p>Use <code>SUM()</code>, <code>WHERE</code>, <code>GROUP BY</code>, and <code>ORDER BY</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id, <span class="keyword">SUM</span>(amount)</span><br><span class="line"><span class="keyword">FROM</span> payments</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">status</span> = <span class="string">'paid'</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">SUM</span>(amount) <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id, <span class="keyword">SUM</span>(amount) <span class="keyword">AS</span> <span class="string">'total'</span></span><br><span class="line"><span class="keyword">FROM</span> payments</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">status</span> = <span class="string">'paid'</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="number">2</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>



<p>The <code>watch_history</code> table has the following columns:</p>
<ul>
<li><code>id</code></li>
<li><code>user_id</code></li>
<li><code>watch_date</code></li>
<li><code>watch_duration_in_minutes</code></li>
</ul>
<p>Click <a href="https://s3.amazonaws.com/codecademy-content/courses/learn-sql-aggregates-code-challenge/user-payments-history.png" target="_blank" rel="noopener">here</a> for the table diagram.</p>
<p>Instructions</p>
<p>Generate a table of user ids and total watch duration for users who watched more than 400 minutes of content.</p>
<p>Use <code>SUM()</code>, <code>GROUP BY</code>, and <code>HAVING</code> to achieve this.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> user_id, <span class="keyword">SUM</span>(watch_duration_in_minutes) </span><br><span class="line"><span class="keyword">from</span> watch_history </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">SUM</span>(watch_duration_in_minutes) &gt; <span class="number">400</span>;</span><br></pre></td></tr></table></figure>



<h3 id="3"><a href="#3" class="headerlink" title="3."></a>3.</h3><p>Which days in this period did Codeflix collect the most money?</p>
<p>Your result should have two columns, <code>pay_date</code> and total <code>amount</code>, sorted by the latter descending.</p>
<p>This should only include successful payments (<code>status = &#39;paid&#39;</code>).</p>
<p>Use <code>SUM()</code>, <code>GROUP BY</code>, and <code>ORDER BY</code>.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pay_date, <span class="keyword">sum</span>(amount)</span><br><span class="line"><span class="keyword">from</span> payments</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">status</span> = <span class="string">'paid'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> pay_date</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">sum</span>(amount) <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>





<h1 id="The-Metropolitan-Museum-of-Art"><a href="#The-Metropolitan-Museum-of-Art" class="headerlink" title="The Metropolitan Museum of Art"></a>The Metropolitan Museum of Art</h1><p>First, let’s find the “lowest” year:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT MIN(date)</span><br><span class="line">FROM met;</span><br></pre></td></tr></table></figure>

<p>The result is 1600-1700.</p>
<p>Now, let’s try this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT date, title, medium</span><br><span class="line">FROM met</span><br><span class="line">WHERE date LIKE &#39;%1600%&#39;;</span><br></pre></td></tr></table></figure>

<p>Woah! <a href="https://www.metmuseum.org/art/collection/search/507" target="_blank" rel="noopener">Betty Lamp</a>, <a href="https://www.metmuseum.org/art/collection/search/1194" target="_blank" rel="noopener">Candlestick</a>, and <a href="https://www.metmuseum.org/art/collection/search/1458" target="_blank" rel="noopener">Casement Window</a> are among the oldest pieces in the collection.</p>
<p><strong>7.</strong></p>
<p>Lastly, let’s look at some bling!</p>
<p>Count the number of pieces where the <code>medium</code> contains ‘gold’ or ‘silver’.</p>
<p>And sort in descending order.</p>
<p>Hint</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ★★★ 7 </span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">medium</span>, <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">from</span> met</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">medium</span> <span class="keyword">like</span> <span class="string">'%gold%'</span> <span class="keyword">or</span> <span class="string">'%silver%'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">medium</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>;</span><br><span class="line"><span class="comment">-- 可以做得再更往大分類去，要用到 CASE!如這裡</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">CASE</span></span><br><span class="line">    <span class="keyword">WHEN</span> <span class="keyword">medium</span> <span class="keyword">like</span> <span class="string">'%gold%'</span> <span class="keyword">THEN</span> <span class="string">'GOLD'</span></span><br><span class="line">    <span class="keyword">WHEN</span> <span class="keyword">medium</span> <span class="keyword">like</span> <span class="string">'%silver%'</span> <span class="keyword">THEN</span> <span class="string">'SILVER'</span></span><br><span class="line">    <span class="keyword">ELSE</span> <span class="literal">NULL</span></span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">AS</span> <span class="string">'Bling'</span>, </span><br><span class="line">  <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">from</span> met</span><br><span class="line"><span class="comment">-- where medium like '%gold%' or '%silver%'</span></span><br><span class="line"><span class="comment">-- group by medium</span></span><br><span class="line"><span class="keyword">where</span> Bling <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> Bling</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>



<h1 id="Hacker-News"><a href="#Hacker-News" class="headerlink" title="Hacker News"></a>Hacker News</h1><h3 id="Which-sites-feed-Hacker-News"><a href="#Which-sites-feed-Hacker-News" class="headerlink" title="Which sites feed Hacker News?"></a>Which sites feed Hacker News?</h3><p><strong>6.</strong></p>
<p>Hacker News stories are essentially links that take users to other websites.</p>
<p><em>Which of these sites feed Hacker News the most</em>:</p>
<p><em><a href="https://www.github.com/" target="_blank" rel="noopener">GitHub</a>, <a href="https://www.medium.com/" target="_blank" rel="noopener">Medium</a>, or <a href="https://www.nytimes.com/" target="_blank" rel="noopener">New York Times</a>?</em></p>
<p>First, we want to categorize each story based on their source.</p>
<p>We can do this using a <code>CASE</code> statement:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT CASE</span><br><span class="line">   WHEN url LIKE &#39;%github.com%&#39; THEN &#39;GitHub&#39;</span><br><span class="line">   -- WHEN statement here</span><br><span class="line">   -- WHEN statement here</span><br><span class="line">   -- ELSE statement here</span><br><span class="line">  END AS &#39;Source&#39;</span><br><span class="line">FROM hacker_news;</span><br></pre></td></tr></table></figure>

<p>Fill in the other <code>WHEN</code> statements and the <code>ELSE</code> statement.</p>
<p>Stuck? Get a hint</p>
<p><strong>7.</strong></p>
<p>Next, build on the previous query:</p>
<p>Add a column for the number of stories from each URL using <code>COUNT()</code>.</p>
<p>Also, <code>GROUP BY</code> the <code>CASE</code> statement.</p>
<p>Remember that you can refer to a column in <code>GROUP BY</code> using a number.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 6, 7</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CASE</span></span><br><span class="line">  <span class="keyword">WHEN</span> <span class="keyword">url</span> <span class="keyword">LIKE</span> <span class="string">'%github%'</span> <span class="keyword">THEN</span> <span class="string">'GitHub'</span></span><br><span class="line">  <span class="keyword">WHEN</span> <span class="keyword">url</span> <span class="keyword">LIKE</span> <span class="string">'%medium.com%'</span> <span class="keyword">THEN</span> <span class="string">'Medium'</span></span><br><span class="line">  <span class="keyword">WHEN</span> <span class="keyword">url</span> <span class="keyword">LIKE</span> <span class="string">'%nytimes.com%'</span> <span class="keyword">THEN</span> <span class="string">'New York Times'</span></span><br><span class="line">  <span class="keyword">ELSE</span> <span class="string">'Other'</span></span><br><span class="line"><span class="keyword">END</span> <span class="keyword">AS</span> three_urls, <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">from</span> hacker_news </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> three_urls</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*);</span><br></pre></td></tr></table></figure>



<h3 id="What’s-the-best-time-to-post-a-story"><a href="#What’s-the-best-time-to-post-a-story" class="headerlink" title="What’s the best time to post a story?"></a>What’s the best time to post a story?</h3><p><strong>8.</strong></p>
<p>Every submitter wants their story to get a high score so that the story makes it to the front page, but…</p>
<p><em>What’s the best time of the day to post a story on Hacker News?</em></p>
<p>Before we get started, let’s run this query and take a look at the <code>timestamp</code> column:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT timestamp</span><br><span class="line">FROM hacker_news</span><br><span class="line">LIMIT 10;</span><br></pre></td></tr></table></figure>

<p>Notice that the values are formatted like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-05-08T12:30:00Z</span><br></pre></td></tr></table></figure>

<p>If you ignore the <code>T</code> and <code>Z</code>, the format is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">YYYY-MM-DD HH:MM:SS</span><br></pre></td></tr></table></figure>

<p>Stuck? Get a hint</p>
<p><strong>9.</strong></p>
<p>SQLite comes with a <code>strftime()</code> function - a very powerful function that allows you to return a formatted date.</p>
<p>It takes two arguments:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strftime(format, column)</span><br></pre></td></tr></table></figure>

<p>Let’s test this function out:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT timestamp,</span><br><span class="line">   strftime(&#39;%H&#39;, timestamp)</span><br><span class="line">FROM hacker_news</span><br><span class="line">GROUP BY 1</span><br><span class="line">LIMIT 20;</span><br></pre></td></tr></table></figure>

<p>What do you think this does? Open the hint if you’d like to learn more.</p>
<p>Stuck? Get a hint</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 8, 9</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">timestamp</span></span><br><span class="line"><span class="keyword">from</span> hacker_news</span><br><span class="line"><span class="keyword">limit</span> <span class="number">15</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">timestamp</span>,</span><br><span class="line">  strftime(<span class="string">'%H'</span>, <span class="built_in">timestamp</span>)</span><br><span class="line"><span class="keyword">from</span> hacker_news</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="comment">-- order by </span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">15</span>;</span><br><span class="line"><span class="comment">-- This returns the hour, HH, of the timestamp column!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- For strftime(__, timestamp):</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- %Y returns the year (YYYY)</span></span><br><span class="line"><span class="comment">-- %m returns the month (01-12)</span></span><br><span class="line"><span class="comment">-- %d returns the day of the month (1-31)</span></span><br><span class="line"><span class="comment">-- %H returns 24-hour clock (00-23)</span></span><br><span class="line"><span class="comment">-- %M returns the minute (00-59)</span></span><br><span class="line"><span class="comment">-- %S returns the seconds (00-59)</span></span><br><span class="line"><span class="comment">-- if timestamp format is YYYY-MM-DD HH:MM:SS.</span></span><br></pre></td></tr></table></figure>



<p><strong>10.</strong></p>
<p>Okay, now we understand how <code>strftime()</code> works. Let’s write a query that returns three columns:</p>
<ol>
<li>The hours of the <code>timestamp</code></li>
<li>The <em>average</em> <code>score</code> for each hour</li>
<li>The <em>count</em> of stories for each hour</li>
</ol>
<p>Stuck? Get a hint</p>
<p><strong>11.</strong></p>
<p>Let’s edit a few things in the previous query:</p>
<ul>
<li>Round the average <code>score</code>s (<code>ROUND()</code>).</li>
<li>Rename the columns to make it more readable (<code>AS</code>).</li>
<li>Add a <code>WHERE</code> clause to filter out the <code>NULL</code> values in <code>timestamp</code>.</li>
</ul>
<p>Take a look at the result again:</p>
<p>What are the best hours to post a story on Hacker News?</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 10 ●○●○● </span></span><br><span class="line"><span class="keyword">select</span> strftime(<span class="string">'%H'</span>, <span class="built_in">timestamp</span>), <span class="keyword">avg</span>(score) ,<span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">from</span> hacker_news</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span> </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- limit 15;</span></span><br><span class="line"><span class="comment">-- having sum(score)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 11</span></span><br><span class="line"><span class="keyword">select</span> strftime(<span class="string">'%H'</span>, <span class="built_in">timestamp</span>) <span class="keyword">AS</span> <span class="keyword">Hour</span>, <span class="keyword">round</span>(<span class="keyword">avg</span>(score), <span class="number">2</span>) <span class="keyword">AS</span> <span class="string">'Average Score'</span>,<span class="keyword">count</span>(*) <span class="keyword">AS</span> <span class="string">'# of Stories'</span></span><br><span class="line"><span class="keyword">from</span> hacker_news</span><br><span class="line"><span class="keyword">where</span> <span class="built_in">timestamp</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>  <span class="comment">-- 注意！！　這裡不能寫１，而要用本來的column名</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span> </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<img src="https://tva1.sinaimg.cn/large/0082zybpgy1gc5jrvpb7ij30fi0bq3yv.jpg" alt="image-20200222222825218" style="zoom:50%;" />

<img src="https://tva1.sinaimg.cn/large/0082zybpgy1gc5k2mxbs4j31520hitmq.jpg" alt="image-20200222223832094" style="zoom:67%;" />



<img src="https://tva1.sinaimg.cn/large/0082zybpgy1gc5ka80insj31b00caqf3.jpg" alt="image-20200222224606164" style="zoom:67%;" /></div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/60/">60</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Joe Huang</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>