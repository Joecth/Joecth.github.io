<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Web/2019-06-07-Requests' secret: pool_connections and pool_maxsize"><meta name="keywords" content=""><meta name="author" content="Joe Huang"><meta name="copyright" content="Joe Huang"><title>Web/2019-06-07-Requests' secret: pool_connections and pool_maxsize | Awaken Desparado</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-180692466-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Requests’-secret-pool-connections-and-pool-maxsize"><span class="toc-number">1.</span> <span class="toc-text">Requests’ secret: pool_connections and pool_maxsize</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Appendix"><span class="toc-number">1.1.</span> <span class="toc-text">Appendix</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Joe Huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">363</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">25</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">60</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Awaken Desparado</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Web/2019-06-07-Requests' secret: pool_connections and pool_maxsize</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-06-07</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Web/">Web</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>from: <a href="https://www.cnblogs.com/pengyusong/p/5802929.html" target="_blank" rel="noopener">https://www.cnblogs.com/pengyusong/p/5802929.html</a></p>
<p>and <a href="https://laike9m.com/blog/requests-secret-pool_connections-and-pool_maxsize,89/" target="_blank" rel="noopener">https://laike9m.com/blog/requests-secret-pool_connections-and-pool_maxsize,89/</a></p>
<h1 id="Requests’-secret-pool-connections-and-pool-maxsize"><a href="#Requests’-secret-pool-connections-and-pool-maxsize" class="headerlink" title="Requests’ secret: pool_connections and pool_maxsize"></a><strong>Requests’ secret: pool_connections and pool_maxsize</strong></h1><p><a href="http://docs.python-requests.org/en/latest/" target="_blank" rel="noopener">Requests</a> 是一个python开发者众所周知的第三方库。因其简单的API和高性能，大多数人倾向于使用requests而不是urllib2作为访问http的标准库。然而很多使用requests库的人可能不知道内部原因，今天我就来解释以下俩个概念: <code>pool_connections</code> 和<code>pool_maxsize</code>.</p>
<p>从 <code>Session 开始</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">s.get(<span class="string">'https://www.google.com'</span>)</span><br></pre></td></tr></table></figure>

<p>这很简单，你可能知道requests’ <code>Session</code> 持有cookie. 但你知道 <code>Session</code> 有一个 <a href="http://docs.python-requests.org/en/latest/api/#requests.Session.mount" target="_blank" rel="noopener"><code>mount</code></a> 方法吗?</p>
<blockquote>
<p><code>mount(prefix, adapter)</code><br>Registers a connection adapter to a prefix.<br>Adapters are sorted in descending order by key length.</p>
</blockquote>
<p>不知道？很好，实际上你已经使用了这个方法当你初始化一个session对象时:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span><span class="params">(SessionRedirectMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment"># Default connection adapters.</span></span><br><span class="line">        self.adapters = OrderedDict()</span><br><span class="line">        self.mount(<span class="string">'https://'</span>, HTTPAdapter())</span><br><span class="line">        self.mount(<span class="string">'http://'</span>, HTTPAdapter())</span><br></pre></td></tr></table></figure>

<p>现在，到了有趣的部分。如果你阅读过 Ian Cordasco’s 文章 <a href="http://www.coglib.com/~icordasc/blog/2014/12/retries-in-requests.html" target="_blank" rel="noopener">Retries in Requests</a>, 你应该知道 <code>HTTPAdapter</code> 可以提供重试功能. 但一个 <code>HTTPAdapter</code> 真实是什么? Quoted from <a href="http://docs.python-requests.org/en/latest/api/#requests.adapters.HTTPAdapter" target="_blank" rel="noopener">doc</a>:</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">requests</span>.<span class="title">adapters</span>.<span class="title">HTTPAdapter</span><span class="params">(pool_connections=<span class="number">10</span>, pool_maxsize=<span class="number">10</span>, max_retries=<span class="number">0</span>, pool_block=False)</span></span></span><br></pre></td></tr></table></figure>

<p>The built-in HTTP Adapter for urllib3.</p>
<p>Provides a general-case interface for Requests sessions to contact HTTP and HTTPS urls by implementing the Transport Adapter interface. This class will usually be created by the Session class under the covers.</p>
<p>Parameters:</p>
<ul>
<li><code>pool_connections</code> – The number of urllib3 connection pools to cache.</li>
<li><code>pool_maxsize</code> – The maximum number of connections to save in the pool.</li>
<li><code>max_retries(int)</code> – The maximum number of retries each connection should attempt. Note, this applies only to failed DNS lookups, socket connections and connection timeouts, never to requests where data has made it to the server. By default, Requests does not retry failed connections. If you need granular control over the conditions under which we retry a request, import urllib3’s Retry class and pass that instead.</li>
<li><code>pool_block</code> – Whether the connection pool should block for connections. Usage:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; <span class="keyword">import</span> requests</span><br><span class="line">&gt;&gt; s = requests.Session()</span><br><span class="line">&gt;&gt; a = requests.adapters.HTTPAdapter(max_retries=<span class="number">3</span>)</span><br><span class="line">&gt;&gt; s.mount(<span class="string">'http://'</span>, a)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>如果上面的文档使你迷惑，这里是我的解释: HTTP Adapter 所做的就是：根据不同的目标url，对每个不同的请求提供不同的配置，还记得上面的代码吗？</p>
<p>　　　　what HTTP Adapter does is simply <strong>providing different configurations for different requests according to target url</strong>. Remember the code above?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.mount(<span class="string">'https://'</span>, HTTPAdapter())</span><br><span class="line">self.mount(<span class="string">'http://'</span>, HTTPAdapter())</span><br></pre></td></tr></table></figure>

<p>它创建了俩个 <code>HTTPAdapter</code> 对象使用默认的参数：<code>pool_connections=10, pool_maxsize=10, max_retries=0, pool_block=False</code>, 并且挂载到 <code>https://</code> 和 <code>http:// 相对路径</code>, 意思是第一个配置在你访问 <code>http://xxx 会使用到， 第二个会在你访问 ``https://xxx</code>. 尽管上面俩个配置是相同的，请求http和https仍然是隔离的。我们会在下面看到说明。</p>
<p>就像我说的，这篇文章的目的主要是解释 <code>pool_connections</code> and <code>pool_maxsize</code>.</p>
<p>首先，让我们看看 <code>pool_connections</code>. 昨天我在stackoverflow提出了一个问题：<a href="http://stackoverflow.com/questions/34837026/whats-the-meaning-of-pool-connections-in-requests-adapters-httpadapter" target="_blank" rel="noopener">question</a> ，因为我不确定我是否理解正确，这个问题的回答消除了我的不确定性。HTTP，众所周知，是基于TCP协议，一个HTTP连接也是一个TCP连接，它是由一个五元组唯一标识:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&lt;protocol&gt;, &lt;src addr&gt;, &lt;src port&gt;, &lt;dest addr&gt;, &lt;dest port&gt;)</span><br></pre></td></tr></table></figure>

<p>就是说，你针对 <code>www.example.com 建立了一个HTTP/TCP连接</code>, 假设服务器支持 <code>Keep-Alive</code>, 下一次你发送请求到 <code>www.example.com/a</code> or <code>www.example.com/b</code>, 你可以使用相同的连接，因为五元组没有改变. 实际上, <a href="http://docs.python-requests.org/en/latest/user/advanced/#keep-alive" target="_blank" rel="noopener">requests’ Session 自动会帮你处理</a> 并且重用连接，只要它能.</p>
<p>这个问题是，什么决定了你是否可以重用老的连接？是的，就是 <code>pool_connections</code>!</p>
<blockquote>
<p>pool_connections – The number of urllib3 connection pools to cache.</p>
</blockquote>
<p>我知道，我知道，我也不想引入很多术语, 这是最后一个，我发誓. 简单的理解它， 一个host对应的一个连接池：<strong>one connection pool corresponds to one host</strong>, 嗯，就是这个意思.</p>
<p>这是一个例子，无关的行已被忽略:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">s = requests.Session()</span><br><span class="line">s.mount(<span class="string">'https://'</span>, HTTPAdapter(pool_connections=1))</span><br><span class="line">s.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line">s.get(<span class="string">'https://www.zhihu.com'</span>)</span><br><span class="line">s.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">""</span><span class="string">"output</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.baidu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 None</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.zhihu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 2621</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.baidu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 None</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>

<p><code>HTTPAdapter(pool_connections=1)</code> 被映射到 <code>https://</code>, 他意思是在同一时间仅有一个连接池. 在调用 <code>s.get(&#39;https://www.baidu.com&#39;)</code>, 缓存的连接池是 <code>connectionpool(&#39;https://www.baidu.com&#39;)</code>. 现在 <code>s.get(&#39;https://www.zhihu.com&#39;)</code> 来了，这个session发现他不能使用缓存的连接，因为他不是相同的host(one connection pool corresponds to one host, remember?). 因此session不得不创建一个新的连接池. 因为 <code>pool_connections=1</code>, session不能在同一时间持有俩个连接池, 因此他丢弃了旧的连接池： <code>connectionpool(&#39;https://www.baidu.com&#39;)</code> 并且保存了新的：<code>connectionpool(&#39;https://www.zhihu.com&#39;)</code>. 下一次get同样如此Next <code>get</code> is the same. 这就是我们看见三个 <code>Starting new HTTPS connection</code> 日志行的原因</p>
<p>如果我们设置 <code>pool_connections</code> 为 2:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">s = requests.Session()</span><br><span class="line">s.mount(<span class="string">'https://'</span>, HTTPAdapter(pool_connections=2))</span><br><span class="line">s.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line">s.get(<span class="string">'https://www.zhihu.com'</span>)</span><br><span class="line">s.get(<span class="string">'https://www.baidu.com'</span>)</span><br><span class="line"><span class="string">""</span><span class="string">"output</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.baidu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 None</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.zhihu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 2623</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 None</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>很好，现在我们可以创建连接俩次了并且保持连接活跃</p>
<p>最后, <code>pool_maxsize</code>.</p>
<p>首先, 仅当你在多线程环境下使用session，你才应该关心 <code>pool_maxsize</code> , 例如，从多个线程使用同一个session发出并发请求.</p>
<p>实际上，<code>pool_maxsize</code> 是一个用来初始化urllib3’s <code>HTTPConnectionPool的参数</code>, 它才是真正含义上的连接池. <code>HTTPConnectionPool</code> 是一个容器，针对于特定的host保存连接的集合, 且 <code>pool_maxsize</code> 是这个集合的最大值. 如果你运行你的代码在同一个线程，它是不可能针对多个主机创建多个连接的，因为 requests library 是阻塞的, 因此HTTP请求总是一个接着一个发送.</p>
<p>如果使用多线程就会不一样.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">def thread_get(url):</span><br><span class="line">    s.get(url)</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">s.mount(<span class="string">'https://'</span>, HTTPAdapter(pool_connections=1, pool_maxsize=2))</span><br><span class="line">t1 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com'</span>,))</span><br><span class="line">t2 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/36612174'</span>,))</span><br><span class="line">t1.start();t2.start()</span><br><span class="line">t1.join();t2.join()</span><br><span class="line">t3 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/39420364'</span>,))</span><br><span class="line">t4 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/21362402'</span>,))</span><br><span class="line">t3.start();t4.start()</span><br><span class="line"><span class="string">""</span><span class="string">"output</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.zhihu.com</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (2): www.zhihu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/36612174 HTTP/1.1<span class="string">" 200 21906</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 2606</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/21362402 HTTP/1.1<span class="string">" 200 57556</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/39420364 HTTP/1.1<span class="string">" 200 28739</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>看见了吗? 它为相同的host建立了俩个连接： <code>www.zhihu.com</code>, 就像我说的, 这个仅发生在多线程环境下. 在这个例子中，我们创建了一个连接池，使用了参数 <code>pool_maxsize=2</code>, 发现同一时间不会超过俩个连接，因此这是足够的，我们看到<code>t3</code> 和 <code>t4</code> 没有创建新的连接，他们重用了就的连接.</p>
<p>如果没有足够的大小呢?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">s = requests.Session()</span><br><span class="line">s.mount(<span class="string">'https://'</span>, HTTPAdapter(pool_connections=1, pool_maxsize=1))</span><br><span class="line">t1 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com'</span>,))</span><br><span class="line">t2 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/36612174'</span>,))</span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br><span class="line">t1.join();t2.join()</span><br><span class="line">t3 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/39420364'</span>,))</span><br><span class="line">t4 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/21362402'</span>,))</span><br><span class="line">t3.start();t4.start()</span><br><span class="line">t3.join();t4.join()</span><br><span class="line"><span class="string">""</span><span class="string">"output</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.zhihu.com</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (2): www.zhihu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/36612174 HTTP/1.1<span class="string">" 200 21906</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 2606</span></span><br><span class="line"><span class="string">WARNING:requests.packages.urllib3.connectionpool:Connection pool is full, discarding connection: www.zhihu.com</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (3): www.zhihu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/39420364 HTTP/1.1<span class="string">" 200 28739</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/21362402 HTTP/1.1<span class="string">" 200 57556</span></span><br><span class="line"><span class="string">WARNING:requests.packages.urllib3.connectionpool:Connection pool is full, discarding connection: www.zhihu.com</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>现在, <code>pool_maxsize=1</code>，会打印警告日志如下，就像下面的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection pool is full, discarding connection: www.zhihu.com</span><br></pre></td></tr></table></figure>

<p>可以注意到仅有一个连接被保存在连接池中, 为t3或者t4创建一个新的连接. 很明显这是不够的. 这就是为什么在 urllib3’s 文档中说明如下:</p>
<blockquote>
<p>如果你计划在连接池环境下使用一个连接池, 你应该设置连接池最大数量为一个比较高的值，例如和线程的数量相同.</p>
</blockquote>
<p>最后, <code>HTTPAdapter</code> 实例映射到不同的前缀是相互独立的.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">s = requests.Session()</span><br><span class="line">s.mount(<span class="string">'https://'</span>, HTTPAdapter(pool_connections=1, pool_maxsize=2))</span><br><span class="line">s.mount(<span class="string">'https://baidu.com'</span>, HTTPAdapter(pool_connections=1, pool_maxsize=1))</span><br><span class="line">t1 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com'</span>,))</span><br><span class="line">t2 =Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/36612174'</span>,))</span><br><span class="line">t1.start();t2.start()</span><br><span class="line">t1.join();t2.join()</span><br><span class="line">t3 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/39420364'</span>,))</span><br><span class="line">t4 = Thread(target=thread_get, args=(<span class="string">'https://www.zhihu.com/question/21362402'</span>,))</span><br><span class="line">t3.start();t4.start()</span><br><span class="line">t3.join();t4.join()</span><br><span class="line"><span class="string">""</span><span class="string">"output</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): www.zhihu.com</span></span><br><span class="line"><span class="string">INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (2): www.zhihu.com</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/36612174 HTTP/1.1<span class="string">" 200 21906</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET / HTTP/1.1<span class="string">" 200 2623</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/39420364 HTTP/1.1<span class="string">" 200 28739</span></span><br><span class="line"><span class="string">DEBUG:requests.packages.urllib3.connectionpool:"</span>GET /question/21362402 HTTP/1.1<span class="string">" 200 57669</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>上面的代码很容易，不需要再次解释了.</p>
<p>就这样了，希望这篇文章帮助你更好的理解requests库. 顺便说一下，我创建了一个gist <a href="https://gist.github.com/laike9m/ead19c65a416c7022c00" target="_blank" rel="noopener">here</a> 这里包含这篇文章的测试代码. 随便下载并尝试吧</p>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><ol>
<li><p>For https, requests uses urllib3’s <a href="http://urllib3.readthedocs.org/en/latest/pools.html#urllib3.connectionpool.HTTPSConnectionPool" target="_blank" rel="noopener">HTTPSConnectionPool</a>, but it’s pretty much the same as HTTPConnectionPool so I didn’t differeniate them in this article.</p>
</li>
<li><p><code>Session</code>‘s <code>mount</code> method ensures the longest prefix gets matched first. Its implementation is pretty interesting so I posted it here.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mount</span><span class="params">(self, prefix, adapter)</span>:</span></span><br><span class="line">    <span class="string">"""Registers a connection adapter to a prefix.</span></span><br><span class="line"><span class="string">    Adapters are sorted in descending order by key length."""</span></span><br><span class="line">    self.adapters[prefix] = adapter</span><br><span class="line">    keys_to_move = [k <span class="keyword">for</span> k <span class="keyword">in</span> self.adapters <span class="keyword">if</span> len(k) &lt; len(prefix)]</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> keys_to_move:</span><br><span class="line">        self.adapters[key] = self.adapters.pop(key)</span><br></pre></td></tr></table></figure>

<p>Note that <code>self.adapters</code> is an <code>OrderedDict</code>.</p>
</li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Joe Huang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2019/06/07/Web/2019-06-07-Requests'%20secret:%20pool_connections%20and%20pool_maxsize/">http://yoursite.com/2019/06/07/Web/2019-06-07-Requests'%20secret:%20pool_connections%20and%20pool_maxsize/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/06/09/Algo.%20Ult./seminar_4&amp;5/"><i class="fa fa-chevron-left">  </i><span>Algo. Ult./seminar_4&amp;5</span></a></div><div class="next-post pull-right"><a href="/2019/05/30/Algo.%20Ult./seminar_2%20&amp;%203/"><span>Algo. Ult./seminar_2 &amp; 3</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By Joe Huang</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>