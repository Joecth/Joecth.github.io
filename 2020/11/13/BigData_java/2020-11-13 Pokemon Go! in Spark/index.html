<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="BigData_java/2020-11-13 Pokemon Go! in Spark"><meta name="keywords" content=""><meta name="author" content="Joe Huang"><meta name="copyright" content="Joe Huang"><title>BigData_java/2020-11-13 Pokemon Go! in Spark | Awaken Desparado</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-180692466-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前情"><span class="toc-number">1.</span> <span class="toc-text">前情</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pokemon-Go"><span class="toc-number"></span> <span class="toc-text">Pokemon Go!</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RDD-vs-Dataset-vs-DataFrame"><span class="toc-number">1.</span> <span class="toc-text">RDD vs. Dataset vs. DataFrame</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RDD"><span class="toc-number">1.1.</span> <span class="toc-text">RDD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DataFrame"><span class="toc-number">1.2.</span> <span class="toc-text">DataFrame</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Code"><span class="toc-number">1.3.</span> <span class="toc-text">Code</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Type-issue-when-Error-–-Semi-Structural"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">Type issue when Error – Semi-Structural</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DF"><span class="toc-number">1.3.1.</span> <span class="toc-text">DF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DF-VS-RDD"><span class="toc-number">1.3.2.</span> <span class="toc-text">DF VS. RDD</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Delimiter-的-‘-’-在讀進來時已經分好了"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">Delimiter 的 ‘,’ 在讀進來時已經分好了</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL-Table-其實更像-View"><span class="toc-number">1.3.3.</span> <span class="toc-text">SQL Table, 其實更像 View</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DF-VS-Dataset"><span class="toc-number">1.3.4.</span> <span class="toc-text">DF VS. Dataset</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DF-RE-vs-Dataset-Compiling-Error"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">DF RE vs. Dataset Compiling Error</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sum"><span class="toc-number">1.4.</span> <span class="toc-text">Sum</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DF-APIs"><span class="toc-number">2.</span> <span class="toc-text">DF APIs</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Bug"><span class="toc-number">2.0.0.0.1.</span> <span class="toc-text">Bug</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Union-vs-Join"><span class="toc-number">2.1.</span> <span class="toc-text">Union vs Join</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Union"><span class="toc-number">2.1.1.</span> <span class="toc-text">Union</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#先-filter-or-先-sort"><span class="toc-number">2.1.1.0.1.</span> <span class="toc-text">先 filter or 先 sort()?</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Intersection"><span class="toc-number">2.1.2.</span> <span class="toc-text">Intersection</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shuffle"><span class="toc-number">2.2.</span> <span class="toc-text">Shuffle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Transformation"><span class="toc-number">2.3.</span> <span class="toc-text">Transformation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Coalesce"><span class="toc-number">2.3.1.</span> <span class="toc-text">Coalesce</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Repartition"><span class="toc-number">2.3.2.</span> <span class="toc-text">Repartition</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Action"><span class="toc-number">2.4.</span> <span class="toc-text">Action</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Joe Huang</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">400</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">26</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">70</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Awaken Desparado</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">BigData_java/2020-11-13 Pokemon Go! in Spark</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-13</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/BigData-java/">BigData_java</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="前情"><a href="#前情" class="headerlink" title="前情"></a>前情</h2><ul>
<li>Spark VS. Flync, 阿里promote、ckin</li>
<li>Spark’s RDD<ul>
<li>partitioning</li>
<li>lazy evaluation<ul>
<li>不需直接全塞進 memory</li>
</ul>
</li>
<li>lazy initilization 讀檔</li>
</ul>
</li>
<li>Persistence – 因為知道它會被多次利用，所以不要殺了</li>
<li>Immutability - 不能修改，只能被重創建</li>
<li>Failure recovery – 不需要多設置</li>
<li>Transformation<ul>
<li>Narrow</li>
<li>Wide – 多個分區間的data轉移跟交換<ul>
<li>RDD往回找dependency 之間的關係</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="Pokemon-Go"><a href="#Pokemon-Go" class="headerlink" title="Pokemon Go!"></a>Pokemon Go!</h1><h2 id="RDD-vs-Dataset-vs-DataFrame"><a href="#RDD-vs-Dataset-vs-DataFrame" class="headerlink" title="RDD vs. Dataset vs. DataFrame"></a>RDD vs. Dataset vs. DataFrame</h2><h3 id="RDD"><a href="#RDD" class="headerlink" title="RDD"></a>RDD</h3><ul>
<li>data每一row是個黑盒，具體的row裡的schema的info是被藏起來的<ul>
<li>對於Spark也是個黑盒，不只對我而言</li>
<li>Spark 讀RDD只能按位置讀data, 性能、可讀性都不好</li>
<li>當想get col時只能row.get()然後用index去看</li>
</ul>
</li>
</ul>
<h3 id="DataFrame"><a href="#DataFrame" class="headerlink" title="DataFrame"></a>DataFrame</h3><ul>
<li>Catalyst可以捨棄data, spark內部執行分析的method，去優化query、filter掉 col 之類</li>
<li>有schema，可以更好優化</li>
<li>Partition 一定以row作劃分，十萬row分到三個機器上去<ul>
<li>col 的概念，分叫sharding或schema也可以</li>
</ul>
</li>
<li>當type錯時，因為非強關係型的full structural data, 所以讀進來時dataframe無法去辨認的，問題會在read、iterate時<ul>
<li>在 foreach每一個row時，在parse long時，要是讀到個string，會RE</li>
</ul>
</li>
<li>半結構化的數據，允許只在精靈第一代存在，第二代卻不存在了的問題</li>
<li>支持 SparkSQL 的訪問</li>
<li>in memory當data很大很大時，很占資源, job就跑得慢</li>
</ul>
<h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a6ojgvqj20xe0k0tdl.jpg" alt="image-20201114095137792" style="zoom:50%;" />





<h5 id="Type-issue-when-Error-–-Semi-Structural"><a href="#Type-issue-when-Error-–-Semi-Structural" class="headerlink" title="Type issue when Error – Semi-Structural"></a>Type issue when Error – Semi-Structural</h5><p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkoh4qznu9j313i0jetn9.jpg" alt="image-20201114100533902"></p>
<h4 id="DF"><a href="#DF" class="headerlink" title="DF"></a>DF</h4><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkohau8ub1j315g0mo1av.jpg" alt="image-20201114101124260" style="zoom:50%;" />

<ul>
<li>Catalyst 幫處理了DAG上的路徑、DF裡的議題</li>
</ul>
<h4 id="DF-VS-RDD"><a href="#DF-VS-RDD" class="headerlink" title="DF VS. RDD"></a>DF VS. RDD</h4><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkohd0z53mj30si09s41x.jpg" alt="image-20201114101332175" style="zoom:50%;" />



<ul>
<li>★★ DF裡的info 我們可以直接去select某一個column，因為它知道這個table裡有幾個Column; 但是，當我去select這個table的如第一row當下，想去得到這個row的某個value也只能用index 了，就是也還是得去解析了。。</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkohj1l8amj30d803m74u.jpg" alt="image-20201114101918675" style="zoom: 50%;" />。</p>
<h5 id="Delimiter-的-‘-’-在讀進來時已經分好了"><a href="#Delimiter-的-‘-’-在讀進來時已經分好了" class="headerlink" title="Delimiter 的 ‘,’ 在讀進來時已經分好了"></a>Delimiter 的 ‘,’ 在讀進來時已經分好了</h5><h4 id="SQL-Table-其實更像-View"><a href="#SQL-Table-其實更像-View" class="headerlink" title="SQL Table, 其實更像 View"></a>SQL Table, 其實更像 View</h4><ul>
<li><p>因為只有abstraction layer of view, 讓別人在access時覺得是個table, 只是data都存成了schema的database的型式</p>
</li>
<li><p>String of query much EASIER than cascade of APIs</p>
</li>
<li><p>易有人為失誤</p>
</li>
</ul>
<h4 id="DF-VS-Dataset"><a href="#DF-VS-Dataset" class="headerlink" title="DF VS. Dataset"></a>DF VS. Dataset</h4><ul>
<li>Dataset讀進來時已經是個Pokemon class 的obj了；DF讀進來時是個Row class 的obj</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a6thisuj20s40go0u6.jpg" alt="image-20201114103553415" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a6vt75hj20vk0ao759.jpg" alt="image-20201114104120385" style="zoom:50%;" />



<h5 id="DF-RE-vs-Dataset-Compiling-Error"><a href="#DF-RE-vs-Dataset-Compiling-Error" class="headerlink" title="DF RE vs. Dataset Compiling Error"></a>DF RE vs. Dataset Compiling Error</h5><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkoi7nfn3jj313e0e2ds9.jpg" alt="image-20201114104257475" style="zoom:50%;" />



<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkoi8du8f2j30hm03igm5.jpg" alt="image-20201114104340363" style="zoom: 50%;" />

<ul>
<li>方法名錯就叫不了，因為class裡沒定義</li>
<li>但readability 強</li>
</ul>
<h3 id="Sum"><a href="#Sum" class="headerlink" title="Sum"></a>Sum</h3><ul>
<li>RDD for 完全沒結構化時的好工具</li>
<li>DSet 缺點 不希望code base存幾十種不同的class且還要去跟遠程access</li>
<li>DF 可能比較平均<ul>
<li>如果data不是很raw，已被先處理過了有很強的schema的了，已sanitize了的schema存儲，那read-in的data就不用去擔心型態問題，只是這個col對應到的val可能是個NA的問題，DF既不用自定義一堆class 又有Catalyst的優化</li>
</ul>
</li>
</ul>
<h2 id="DF-APIs"><a href="#DF-APIs" class="headerlink" title="DF APIs"></a>DF APIs</h2><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h38a70hh71j20xy0iw411.jpg" alt="image-20201114105806698" style="zoom:50%;" />



<h6 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h6><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkoips6ol5j30xk04otaj.jpg" alt="image-20201114110022848" style="zoom:50%;" />



<h3 id="Union-vs-Join"><a href="#Union-vs-Join" class="headerlink" title="Union vs Join"></a>Union vs Join</h3><h4 id="Union"><a href="#Union" class="headerlink" title="Union"></a>Union</h4><ul>
<li>when identical schema btw diff tables</li>
<li>append tableB to the tail of tableA</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkoj13vebwj30w007kwhp.jpg" alt="image-20201114111115758" style="zoom:50%;" />



<h6 id="先-filter-or-先-sort"><a href="#先-filter-or-先-sort" class="headerlink" title="先 filter or 先 sort()?"></a>先 filter or 先 sort()?</h6><ul>
<li>Spark 會做優化，先filter了後好，所以就算我寫反，也沒差</li>
</ul>
<h4 id="Intersection"><a href="#Intersection" class="headerlink" title="Intersection"></a>Intersection</h4><p><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkq6ht80x9j317g0bwgs3.jpg" alt="image-20201115212831583"></p>
<h3 id="Shuffle"><a href="#Shuffle" class="headerlink" title="Shuffle"></a>Shuffle</h3><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkq78xf644j311s0jygt7.jpg" alt="image-20201115215442243" style="zoom:50%;" />





<h3 id="Transformation"><a href="#Transformation" class="headerlink" title="Transformation"></a>Transformation</h3><h4 id="Coalesce"><a href="#Coalesce" class="headerlink" title="Coalesce"></a>Coalesce</h4><ul>
<li>寫出時候變少</li>
<li>以挪動最小的數據為代價，幫把partition個數降低，會以平均的方式挪過去</li>
</ul>
<h4 id="Repartition"><a href="#Repartition" class="headerlink" title="Repartition"></a>Repartition</h4><ul>
<li>會嘗試以平均分配的方式，把當前的partition全部進行重新分配</li>
</ul>
<h3 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h3></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Joe Huang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/11/13/BigData_java/2020-11-13%20Pokemon%20Go!%20in%20Spark/">http://yoursite.com/2020/11/13/BigData_java/2020-11-13%20Pokemon%20Go!%20in%20Spark/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/11/20/BigData_java/2020-11-20%20Movie%20Recommendation%20System/"><i class="fa fa-chevron-left">  </i><span>BigData_java/2020-11-20 Movie Recommendation System</span></a></div><div class="next-post pull-right"><a href="/2020/11/06/BigData_java/2020-11-6%20Spark%20Architecture%20&amp;%20Exercise%20on%20AWS/"><span>BigData_java/2020-11-6 Spark Architecture &amp; Exercise on AWS</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By Joe Huang</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>